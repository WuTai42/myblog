<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>C++ ä¸­ const çš„ä½¿ç”¨è¦ç‚¹</title>
    <url>/myblog/2020/10/13/C/C++%20%E4%B8%AD%20const%20%E7%9A%84%E4%BD%BF%E7%94%A8%E8%A6%81%E7%82%B9/</url>
    <content><![CDATA[<h1 id="C-ä¸­-const-çš„ä½¿ç”¨è¦ç‚¹"><a href="#C-ä¸­-const-çš„ä½¿ç”¨è¦ç‚¹" class="headerlink" title="C++ ä¸­ const çš„ä½¿ç”¨è¦ç‚¹"></a>C++ ä¸­ const çš„ä½¿ç”¨è¦ç‚¹</h1><hr>
<p>constè¯­æ³•å˜åŒ–å¤šç«¯ï¼Œä½†æ˜¯å´å¹¶éé«˜æ·±è«æµ‹</p>
<p>1ã€æ³¨æ„ä»¥ä¸‹çš„å‡ ä¸ª <code>const</code> ç”¨æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">char</span> *greeting[] = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> *p = greeting; 			<span class="comment">//non-const pointer, non-const data</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * p = greeting;  	 <span class="comment">//non-const pointer, const data</span></span><br><span class="line"><span class="keyword">char</span> * <span class="keyword">const</span> p = greeting;		 <span class="comment">//const pointer, non-const data</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> p = greeting; <span class="comment">//const pointer, const data;</span></span><br></pre></td></tr></table></figure>

<p><strong>const åœ¨æ˜Ÿå·å·¦è¾¹è¡¨ç¤ºè¢«æŒ‡ç‰©æ˜¯å¸¸é‡ï¼Œconst åœ¨æ˜Ÿå·å³è¾¹è¡¨ç¤ºæŒ‡é’ˆè‡ªèº«æ˜¯å¸¸é‡</strong></p>
<p>2ã€å¦‚æœè¢«æŒ‡ç‰©æ˜¯å¸¸é‡ï¼Œconst åœ¨ç±»å‹åçš„å‰åæ„ä¹‰éƒ½ç›¸åŒ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f1</span><span class="params">(<span class="keyword">const</span> Widget* pw)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f2</span><span class="params">(Widget <span class="keyword">const</span>* pw)</span></span>;</span><br><span class="line"><span class="comment">// ä¸¤è€…æ²¡æœ‰åŒºåˆ«</span></span><br></pre></td></tr></table></figure>

<p>3ã€STLè¿­ä»£å™¨æ˜¯ä»¥æŒ‡é’ˆä¸ºæ ¹æ®å¡‘è†œå‡ºæ¥çš„</p>
<p>å£°æ˜è¿­ä»£å™¨ä¸º const å’Œ å£°æ˜ æŒ‡é’ˆä¸º const çš„å¤§è‡´æ–¹æ³•ç›¸åŒ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::iterator iter = vec.begin();</span><br><span class="line"><span class="comment">//iter çš„ä½œç”¨å’Œ T* const ç±»ä¼¼</span></span><br><span class="line">*iter = <span class="number">10</span>; <span class="comment">// å¯ä»¥æ”¹å˜æŒ‡å‘ç‰©</span></span><br><span class="line">++iter; <span class="comment">// é”™è¯¯ï¼ ä¸å¯ä»¥æ”¹å˜ iter, å®ƒæ˜¯ä¸€ä¸ªå¸¸é‡</span></span><br><span class="line"></span><br><span class="line">str::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::const_iterator cIter = vec.begin();</span><br><span class="line"><span class="comment">//cIter çš„ä½œç”¨å’Œ const T* ç±»ä¼¼</span></span><br><span class="line">*cIter = <span class="number">10</span>; <span class="comment">// é”™è¯¯ï¼ä¸å¯ä»¥æ”¹å˜ *cIter, å®ƒæ˜¯ä¸€ä¸ªå¸¸é‡</span></span><br><span class="line">++cIter; <span class="comment">// å¯ä»¥æ”¹å˜ cIter çš„æŒ‡å‘</span></span><br></pre></td></tr></table></figure>



<h3 id="ä¸€ã€const-æˆå‘˜å‡½æ•°"><a href="#ä¸€ã€const-æˆå‘˜å‡½æ•°" class="headerlink" title="ä¸€ã€const æˆå‘˜å‡½æ•°"></a>ä¸€ã€const æˆå‘˜å‡½æ•°</h3><p>å°† const å®æ–½äºæˆå‘˜å‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å°†å…¶ç”¨äº const å¯¹è±¡èº«ä¸Š</p>
<p>const æˆå‘˜å‡½æ•°çš„é‡è¦æ€§ä½“ç°åœ¨ä¸‹é¢ä¸¤ä¸ªæ–¹å‘ï¼š</p>
<ul>
<li>ä½¿ class æ¥å£æ›´åŠ ä¾¿äºç†è§£(å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å“ªä¸ªå‡½æ•°èƒ½å¤Ÿæ”¹å˜å¯¹è±¡å†…å®¹è€Œå“ªä¸€ä¸ªä¸è¡Œ)</li>
<li>ä½¿â€æ“ä½œ const å¯¹è±¡â€å˜ä¸ºå¯èƒ½</li>
</ul>
<p><em>ä¸¤ä¸ªæˆå‘˜å‡½æ•°å¦‚æœå¸¸é‡æ€§(constness)ä¸åŒï¼Œé‚£ä¹ˆå¯ä»¥è¢«é‡è½½</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">class <span class="title">TextBlock</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	......</span><br><span class="line">    	<span class="keyword">const</span> chat&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    	&#123;</span><br><span class="line">        	<span class="keyword">return</span> text[position];</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">char</span>&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> position)</span><br><span class="line">    	&#123;</span><br><span class="line">        	<span class="keyword">return</span> text[position];</span><br><span class="line">    	&#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="built_in">std</span>::<span class="built_in">string</span> text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯¹å…¶åšä¸€ä¸‹å¤„ç†</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; tb[<span class="number">0</span>]; <span class="comment">//è¯»ä¸€ä¸ª non-const TextBlock</span></span><br><span class="line">tb[<span class="number">0</span>] = <span class="string">&#x27;x&#x27;</span>;	    <span class="comment">//å†™ä¸€ä¸ª non-const TextBlock</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ctb[<span class="number">0</span>];<span class="comment">//è¯»ä¸€ä¸ª const TextBlock</span></span><br><span class="line">ctb[<span class="number">0</span>] = <span class="string">&#x27;x&#x27;</span>;       <span class="comment">//é”™è¯¯ï¼Œ ä¸èƒ½å†™ä¸€ä¸ª const TextBlock</span></span><br></pre></td></tr></table></figure>

<p>é”™è¯¯çš„åŸå› æ˜¯ä¼å›¾å¯¹ä¸€ä¸ªâ€const operator[]â€è¿”å›çš„ const char&amp; å®æ–½èµ‹å€¼æ“ä½œ</p>
<p>ç°åœ¨å¯¹äºæˆå‘˜å‡½æ•°çš„ç†è§£æœ‰ä¸¤ä¸ªä¸»æµç†è§£ï¼š</p>
<ul>
<li><p>bitwise constness(Physcial constness)</p>
<p>æˆå‘˜å‡½æ•°åªæœ‰åœ¨ä¸æ”¹å˜å¯¹è±¡çš„ä»»ä½•çš„ä»»ä½•æˆå‘˜å˜é‡(static é™¤å¤–)æ—¶æ‰èƒ½è¯´æ˜¯constã€‚</p>
</li>
<li><p>logical constness</p>
<p>ä¸€ä¸ª const æˆå‘˜å‡½æ•°å¯ä»¥ä¿®æ”¹å®ƒæ‰€å¤„ç†çš„å¯¹è±¡å†…çš„æŸäº› bitsï¼Œä½†æ˜¯åªæœ‰åœ¨å®¢æˆ·ç«¯æ£€æµ‹ä¸å‡ºæ¥çš„æƒ…å†µä¸‹æ‰èƒ½è¿™æ ·å¤„ç†</p>
</li>
</ul>
<h5 id="1ã€bitwise-constness"><a href="#1ã€bitwise-constness" class="headerlink" title="1ã€bitwise constness"></a>1ã€bitwise constness</h5><p>è¿™ç§ç†è§£çš„å¥½å¤„æ˜¯éå¸¸å®¹æ˜“å»æ£€æµ‹æ˜¯å¦éµå®ˆäº† bitwise constness å‡†åˆ™ï¼šåªéœ€è¦å¯»æ‰¾æˆå‘˜å˜é‡çš„èµ‹å€¼åŠ¨ä½œã€‚</p>
<p>ä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè®¸å¤šä¸å…·å¤‡ const æ€§è´¨çš„æˆå‘˜å‡½æ•°ä¹Ÿèƒ½é€šè¿‡ bitwise æµ‹è¯•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¸€ä¸ªéœ€è¦äº C API æ²Ÿé€šçš„ TextBlock-like class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTextBlock</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	...</span><br><span class="line">    	<span class="keyword">char</span>&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    	&#123;	<span class="keyword">return</span> pText[position];	&#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="keyword">char</span>* pText;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ‰€ç¤ºçš„ class ä¸æ°å½“çš„å°†å…¶ operator[] å£°æ˜ä¸º const æˆå‘˜å‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª referrence æŒ‡å‘å¯¹è±¡å†…éƒ¨å€¼ã€‚</p>
<p>å½“ç¼–è¯‘å™¨è®¤ä¸ºå®ƒæ˜¯ bitwise constness æ—¶</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> CTextBlock <span class="title">cctb</span><span class="params">(<span class="string">&quot;Hello&quot;</span>)</span></span>;</span><br><span class="line"><span class="keyword">char</span>* pc = &amp;cctb[<span class="number">0</span>]; <span class="comment">// è°ƒç”¨ const operator[] å–å¾—ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘cctb[0]</span></span><br><span class="line">*pc = <span class="string">&#x27;J&#x27;</span>; <span class="comment">// ä¿®æ”¹äº† cctb[0]</span></span><br></pre></td></tr></table></figure>

<h5 id="2ã€logical-constness"><a href="#2ã€logical-constness" class="headerlink" title="2ã€logical constness"></a>2ã€logical constness</h5><p>æœ‰æ—¶å€™ TextBlock class è¦ cache æ–‡æœ¬åŒºå—çš„é•¿åº¦ï¼Œä»¥ä¾¿åé¢ä½¿ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextBlock</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	...</span><br><span class="line">    	<span class="function"><span class="built_in">std</span>::<span class="keyword">size_t</span> <span class="title">length</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="keyword">char</span>* pText;</span><br><span class="line">    	<span class="built_in">std</span>::<span class="keyword">size_t</span> textLength;</span><br><span class="line">    	<span class="keyword">bool</span> lengthIsValid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="keyword">size_t</span> <span class="title">CTextBlock::length</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!lengthIsVailid)</span><br><span class="line">    &#123;</span><br><span class="line">        textLength = <span class="built_in">std</span>::<span class="built_in">strlen</span>(pText);</span><br><span class="line">        lengthIsValid = <span class="literal">true</span>; <span class="comment">// è¿™ç§æ”¹åŠ¨å¾ˆé‡è¦ï¼Œä½†æ˜¯ä¸è¢«ç¼–è¯‘å™¨æ¥å—ã€‚ç¼–è¯‘å™¨åšæŒ bitwise constness</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> textLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ <code>mutable</code> å…³é”®å­—</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mutable</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> textLength;</span><br><span class="line"><span class="keyword">mutable</span> <span class="keyword">bool</span> lengthIsValid;</span><br></pre></td></tr></table></figure>



<h3 id="äºŒã€åœ¨-const-å’Œ-non-const-æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤"><a href="#äºŒã€åœ¨-const-å’Œ-non-const-æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤" class="headerlink" title="äºŒã€åœ¨ const å’Œ non-const æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤"></a>äºŒã€åœ¨ const å’Œ non-const æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤</h3><p>å¯¹äºåœ¨ ä¸Šä¸€èŠ‚æåˆ°çš„ç”¨ mutable è§£å†³ bitwise-const é”™è¯¯ç†è§£çš„é—®é¢˜ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„è§£æ³•ï¼Œä½†æ˜¯ä¸èƒ½é€‚ç”¨äºæ‰€æœ‰çš„ const ç›¸å…³éš¾é¢˜ã€‚</p>
<p>å½“ operator[] æ“ä½œè¿‡äºå¤æ‚çš„æ—¶å€™ï¼Œä»£ç çš„é‡å¤é‡ä¼šé€ æˆå¾ˆå¤§çš„å›°æ‰°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextBlock</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">    ...;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...; <span class="comment">// bounding checking</span></span><br><span class="line">        ...; <span class="comment">// log access data</span></span><br><span class="line">        ...; <span class="comment">// verify data integrity</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) </span><br><span class="line">    &#123;</span><br><span class="line">        ...; <span class="comment">// bounding checking</span></span><br><span class="line">        ...; <span class="comment">// log access data</span></span><br><span class="line">        ...; <span class="comment">// verify data integrity</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span>: </span><br><span class="line">    	<span class="built_in">std</span>::<span class="built_in">string</span> text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šçš„ä»£ç é‡å¤å‘ï¼Œç¼–è¯‘æ—¶é—´ï¼Œç»´æŠ¤ï¼Œä»£ç è†¨èƒ€â€¦â€¦é—®é¢˜ä¼šè®©äººå¤´å¤§</p>
<p>è¿™æ—¶éœ€è¦åšçš„æ˜¯ï¼š <strong>å®ç° operator[] æœºåˆ¶ä¸€æ¬¡ï¼Œ å¹¶ä¸¤æ¬¡ä½¿ç”¨</strong></p>
<p>éœ€è¦ä½¿ç”¨çš„æ–¹æ³•æ˜¯: **casting away constness **      Tips: é™¤éæ˜¯æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€èˆ¬ä¸ä¼šæ¨èä½¿ç”¨ casting æ“ä½œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextBlock</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">    ...;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...; <span class="comment">// bounding checking</span></span><br><span class="line">        ...; <span class="comment">// log access data</span></span><br><span class="line">        ...; <span class="comment">// verify data integrity</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>&amp;&gt;( <span class="comment">// ç¬¬äºŒæ¬¡castingå°† op[] çš„ const æ€§è´¨æ¶ˆé™¤</span></span><br><span class="line">            	<span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> TextBlock&amp;&gt;(*<span class="keyword">this</span>) <span class="comment">// ç¬¬ä¸€æ¬¡castingï¼Œå°†*thisçš„åŸå§‹ç±»å‹ä»TextBlock&amp; è½¬å‹ä¸º const TextBlock&amp; </span></span><br><span class="line">            		[position]</span><br><span class="line">        	)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span>: </span><br><span class="line">    	<span class="built_in">std</span>::<span class="built_in">string</span> text;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç é•¿å°è¯•ç”¨ <code>non-cost operator[]</code> è°ƒç”¨å®ƒçš„ <code>const</code> å…„å¼Ÿ</p>
<p>è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼š<strong>ä¸è¦ç”¨ const ç‰ˆæœ¬è°ƒç”¨ non-const ç‰ˆæœ¬æ¥é¿å…é‡å¤</strong> </p>
<p>å¦åˆ™ä½ ä¹‹å‰çš„æ‰¿è¯ºï¼š <strong>const æˆå‘˜å‡½æ•°æ‰¿è¯ºä¸æ”¹å˜å…¶å¯¹è±¡çš„é€»è¾‘çŠ¶æ€</strong> ä¾¿æ²¡æœ‰ä»»ä½•ä»·å€¼ï¼ï¼ï¼ğŸ’”ğŸ’”ğŸ’”</p>
<p>const åœ¨ç¼–ç¨‹çš„æ—¶å€™æ˜¯ä¸€ä¸ªå¼ºæœ‰åŠ›çš„å¸®æ‰‹ï¼Œä½†æ˜¯è¦å°å¿ƒå…¶ä½¿ç”¨ ğŸ’– ğŸ’– ğŸ’–</p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>å°†æŸäº›ä¸œè¥¿å£°æ˜ä¸º const å¯ä»¥å¸®åŠ©ç¼–è¯‘å™¨æ£€æµ‹é”™è¯¯ç”¨æ³•ã€‚const å¯ä»¥æ–½åŠ äºä»»ä½•ä½œç”¨åŸŸå†…çš„å¯¹è±¡ã€å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›ç±»å‹ã€æˆå‘˜å‡½æ•°æœ¬ä½“</li>
<li>ç¼–è¯‘å™¨ä¼šå¼ºåˆ¶å®æ–½ bitwise constnessï¼Œä½†æ˜¯è‡ªå·±åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™è¦ä½¿ç”¨ â€œæ¦‚å¿µä¸Šçš„å¸¸é‡â€ conceptual constness</li>
<li>å½“const å’Œ non-const æˆå‘˜å‡½æ•°æœ‰ç›¸åŒçš„å®ç°çš„æ—¶å€™ï¼Œè¦ç”¨ non-const  ç‰ˆæœ¬æ¥è°ƒç”¨ const ç‰ˆæœ¬</li>
</ul>
<p>â€‹<center><font face="å®‹ä½“" size=20 color=#8B008B>FINE</font></center></p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>Linkers and loaders (1)</title>
    <url>/myblog/2020/10/24/C/Linkers%20and%20Loads/</url>
    <content><![CDATA[<h1 id="Linkers-and-Loads"><a href="#Linkers-and-Loads" class="headerlink" title="Linkers and Loads"></a>Linkers and Loads</h1><font size = 4.5>

<h3 id="ä¸€ã€INTRODUCTION"><a href="#ä¸€ã€INTRODUCTION" class="headerlink" title="ä¸€ã€INTRODUCTION"></a>ä¸€ã€INTRODUCTION</h3><hr>
<p>Translating high-level language into a properly formatted binary string before it can be executed is necessary. In most basic form this transformation process occurs in two stages:</p>
<ol>
<li>A userâ€™s (source) program is translated into machine language.</li>
<li>The translated program is stored for immediate or future execution</li>
</ol>
<p><strong>loading</strong>: storing into main memory</p>
<p><strong>linking</strong>: combine subprograms into a composite program</p>
<h3 id="äºŒã€LOADERS"><a href="#äºŒã€LOADERS" class="headerlink" title="äºŒã€LOADERS"></a>äºŒã€LOADERS</h3><hr>
<p>Loading a translated program into memory is logically distinct from the translation of that program, separate software modules, called loaders, have been developed to accomplish the loading operation. </p>
<p>There are two types:</p>
<ol>
<li>Binary loaders</li>
<li>Relocating loaders</li>
</ol>
<p>The relocating loader is responsible for loading into main memory a program in relocatable binary form and updating (relocation) all relative addresses.</p>
<h3 id="ä¸‰ã€LINKERS"><a href="#ä¸‰ã€LINKERS" class="headerlink" title="ä¸‰ã€LINKERS"></a>ä¸‰ã€LINKERS</h3><hr>
<p>Linking could be carried out at 7 different times:</p>
<ul>
<li>source program coding time</li>
<li>after coding but before translation time</li>
<li>at translation time</li>
<li>after translation but before loading time</li>
<li>at loading time</li>
<li>after loading but before execute time</li>
<li>at execute time</li>
</ul>
<p><strong>Address binding</strong>: translation  or mapping of a logical into a physical address.</p>
<p><strong>Linking process</strong>: binding (combining) independent logical spaces into one composite logical space.</p>
<h3 id="å››ã€THE-LINKAGE-EDITOR"><a href="#å››ã€THE-LINKAGE-EDITOR" class="headerlink" title="å››ã€THE LINKAGE EDITOR"></a>å››ã€THE LINKAGE EDITOR</h3><hr>
<p>On the IBM System/360, there exist a sophisticated linker, called the <code>Linkage Eeditor</code> , and a simple relocating loader referred to as <code>Program Fetch</code> .</p>
<p>Linkage Editor is responsible for the following functions:</p>
<ul>
<li><p>Primary function: (1) Linking together independently translated modules.</p>
</li>
<li><p>Secondary function: (1) Overlaying processing.</p>
<p>â€‹                                 (2) Program modification.</p>
<p>â€‹                                 (3) Library access.</p>
</li>
</ul>
<p>The inputs accepted  can be divided into two groups: <code>input modules</code> &amp; <code>Linkage Editor control statements</code>. </p>
<p>Input modules are further classified as being either <code>Object Modules</code> or <code>Load modules</code>. These two are similar in structure.</p>
<p>Object module: The output  produced by the language translators(IBM System/360). This output consists of the machine language code for the translated program, relocation information, and a table indicating the definition and use of external symbols.</p>
<p>Linking Together a Set of Modules:</p>
<p>â€‹        In linking together a set of modules, the Linkage Editor is primarily responsible for:</p>
<p>â€‹            (1) assigning address.</p>
<p>â€‹            (2) relocating Address Constants.</p>
<p>â€‹            (3) create an output module (Load Module).</p>
<h3 id="å››ã€SUMMARY"><a href="#å››ã€SUMMARY" class="headerlink" title="å››ã€SUMMARY"></a>å››ã€SUMMARY</h3><hr>
<p>The linking together of independently translated programs is the responsibility of the <strong>Linkage Editor</strong> , and a major part of the language processing burden is on the language translators whose responsibility is not only to translate source programs into a form which is very close to machine language, but also to format addresses in a base plus displacement form and to create the Object Module.</p>
<p>If the various stages of the language transformation process are viewed as a function of time, it is generally true that <strong>early binding allows more efficient implementations</strong> while <strong>late binding facilitates program debugging and modification.</strong></p>
<p>Features as elaborate editing capabilities and overlay processing, which produce a powerful and sophisticated linker, are at a high cost. So flexibility provided by simple linkers and relocating loaders has a definite place in modern OS.</p>
</font>




<div align = "right">Computing Surveys Vol 4, No 3, Sep 1972</div>


]]></content>
      <categories>
        <category>Operating Systems</category>
      </categories>
      <tags>
        <tag>Linkers and loaders</tag>
        <tag>Operation Systems</tag>
      </tags>
  </entry>
  <entry>
    <title>C/C++ å†…å­˜å¸ƒå±€</title>
    <url>/myblog/2020/09/22/C/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<hr>
<h2 id="C-C-å†…å­˜å¸ƒå±€"><a href="#C-C-å†…å­˜å¸ƒå±€" class="headerlink" title="C/C++ å†…å­˜å¸ƒå±€"></a>C/C++ å†…å­˜å¸ƒå±€</h2><h4 id="ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ"><a href="#ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ" class="headerlink" title="ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ"></a>ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ</h4><p>&emsp;&emsp;å½“ç”ŸæˆC/C++ç¨‹åºçš„æ—¶å€™ï¼Œé“¾æ¥å™¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨UNIXå’Œå¤§å¤šæ•°æ¸¸æˆä¸»æœºä¸Šé¢ä½¿ç”¨ä¸€ç§ <strong><em>å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼(executable and linkable format, ELF)</em></strong> ã€‚åœ¨è¿™äº›å¹³å°ä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨åç¼€ <strong><em>.elf</em></strong> ã€‚åœ¨Windowsä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶åŒæ„ç±»ä¼¼ä¸ELFï¼Œä½¿ç”¨ <strong><em>.exe</em></strong> ä½œä¸ºæ‰©å±•åã€‚</p>
<p>æ˜ åƒæ–‡ä»¶ä¸€èˆ¬æœ€å°‘ç”±ä¸€ä¸‹å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼š</p>
<ul>
<li><p>ä»£ç æ®µ(text/code segement)</p>
<blockquote>
<p>ç¨‹åºä¸­å®šä¹‰çš„å‡½æ•°çš„å…¨éƒ¨æœºæ¢°ç </p>
</blockquote>
</li>
<li><p>æ•°æ®æ®µ(data segment)</p>
<blockquote>
<p>å·²ç»åˆå§‹åŒ–çš„å…¨éƒ¨é™æ€å˜é‡<br>å°†ç”±è¿æ¥å™¨ä¸ºå…¶åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”å¡«å¦‚é€‚å½“çš„åˆå§‹å€¼</p>
</blockquote>
</li>
<li><p>BBS æ®µ(BBS segement)</p>
<blockquote>
<p>BBSæ˜¯ä¸€ç§è€æ—§çš„å«æ³•ï¼Œæ„ä¸º <strong><em>â€œç”±ç¬¦å·å¼€å§‹çš„å—(block started by symbol)â€</em></strong>ã€‚åŒ…å«ç¨‹åºå®šä¹‰ä¸­æ‰€æœ‰çš„æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œåœ¨C/C++ä¸­æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡å…¨ä¸ºé›¶ã€‚</p>
</blockquote>
</li>
<li><p>åªè¯»æ•°æ®æ®µ(read only data segement)</p>
<blockquote>
<p> åˆç§°ä¸º <strong><em>rodata</em></strong> æ®µ,åŒ…å«ç¨‹åºä¸­å®šä¹‰çš„åªè¯»(å¸¸é‡)å…¨å±€å˜é‡ã€‚<br> æ¯”å¦‚ï¼šæµ®ç‚¹å¸¸é‡ï¼Œç”¨constå…³é”®å­—å£°åçš„å…¨å±€å¯¹è±¡å®ä¾‹â€¦â€¦</p>
<blockquote>
<p>tips: ç¼–è¯‘å™¨é€šå¸¸ä¼šæŠŠæ•´æ•°å¸¸é‡è§†ä¸º<strong>æ˜ç¤ºå¸¸é‡</strong>(manifast constant)ï¼Œå¹¶ä¸”ç›´æ¥æŠŠæ˜ç¤ºå¸¸é‡æ’å…¥æœºå™¨ç ä¸­ï¼Œç›´æ¥å ç”¨ä»£ç æ®µçš„å­˜å‚¨ç©ºé—´è€Œä¸å­˜å‚¨äºåªè¯»æ•°æ®æ®µã€‚</p>
</blockquote>
</blockquote>
</li>
</ul>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>Memory Management</tag>
        <tag>GameDev</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨æ±‡ç¼–æ·±å…¥å­¦ä¹ C++</title>
    <url>/myblog/2020/09/26/C/%E5%88%A9%E7%94%A8%E6%B1%87%E7%BC%96%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0C++/</url>
    <content><![CDATA[<h1 id="ä¸€ã€åŸºç¡€å†…å®¹"><a href="#ä¸€ã€åŸºç¡€å†…å®¹" class="headerlink" title="ä¸€ã€åŸºç¡€å†…å®¹"></a>ä¸€ã€åŸºç¡€å†…å®¹</h1><h3 id="1ã€æ‚é¡¹"><a href="#1ã€æ‚é¡¹" class="headerlink" title="1ã€æ‚é¡¹"></a>1ã€æ‚é¡¹</h3><hr>
<h5 id="ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€"><a href="#ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€" class="headerlink" title="ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€"></a>ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€</h5><p><code>æ±‡ç¼–è¯­è¨€</code>ä¸<code>æœºå™¨è¯­è¨€</code>ä¸€ä¸€å¯¹åº”ï¼Œæ¯ä¸€æ¡æœºå™¨æŒ‡ä»¤éƒ½æœ‰ä¸ä¹‹ç›¸å¯¹çš„æ±‡ç¼–æŒ‡ä»¤</p>
<p><code>æ±‡ç¼–è¯­è¨€</code>å¯ä»¥é€šè¿‡ç¼–è¯‘å¾—åˆ°<code>æœºå™¨è¯­è¨€</code>ï¼Œ<code>æœºå™¨è¯­è¨€</code>å¯ä»¥é€šè¿‡åæ±‡ç¼–å¾—åˆ°<code>æ±‡ç¼–è¯­è¨€</code></p>
<p><code>é«˜çº§è¯­è¨€</code>å¯ä»¥é€šè¿‡ç¼–è¯‘å¾—åˆ°<code>æ±‡ç¼–è¯­è¨€\æœºå™¨è¯­è¨€</code>ï¼Œä½†æ˜¯<code>æ±‡ç¼–è¯­è¨€\æœºå™¨è¯­è¨€</code>å‡ ä¹ä¸å¯èƒ½è¿˜åŸæˆ<code>é«˜çº§è¯­è¨€</code></p>
<p>â€‹&emsp;&emsp;&emsp;&emsp;&emsp;ç¼–è¯‘        </p>
<p>â€‹&emsp;æ±‡ç¼–è¯­è¨€ â€”â€”&gt; æœºå™¨è¯­è¨€</p>
<p>â€‹            mov ax, bx&lt;â€”â€” 0010101011</p>
<p>â€‹&emsp;&emsp;&emsp;&emsp;åç¼–è¯‘</p>
<p>egï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> year;</span><br><span class="line">    <span class="keyword">int</span> month;</span><br><span class="line">    <span class="keyword">int</span> day;</span><br><span class="line">&#125;;</span><br><span class="line">Date d = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">C7 <span class="number">45</span> F0 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-10</span>h],<span class="number">1</span></span><br><span class="line">C7 <span class="number">45</span> F4 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">2</span></span><br><span class="line">C7 <span class="number">45</span> F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-8</span>],<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">C7 <span class="number">45</span> F0 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-10</span>h],<span class="number">1</span></span><br><span class="line">C7 <span class="number">45</span> F4 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">2</span></span><br><span class="line">C7 <span class="number">45</span> F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-8</span>],<span class="number">3</span></span><br><span class="line"><span class="comment">/*æ³¨æ„åˆ°ä¸¤è€…çš„æœºå™¨ç å’Œæ±‡ç¼–ç å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥åªç¡®å®šæ±‡ç¼–\æœºå™¨è¯­è¨€ä¸èƒ½è¿˜åŸä¸ºå”¯ä¸€ç¡®å®šçš„é«˜çº§è¯­è¨€ï¼Œå¦‚æœä¸€å®šéœ€è¦</span></span><br><span class="line"><span class="comment">ç›¸å…³é«˜çº§è¯­è¨€ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶è¿˜åŸä¸ºä¼ªä»£ç ï¼Œåœ¨äººä¸ºè¿˜åŸä¸ºé«˜çº§è¯­è¨€ã€‚*/</span></span><br></pre></td></tr></table></figure>

<p>â€‹    <strong>åœ¨ä¸åŒæ¶æ„çš„CPUä¸‹ï¼Œç”Ÿæˆçš„æ±‡ç¼–ç ä¸ä¸€æ ·</strong></p>
<h5 id="ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«"><a href="#ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«" class="headerlink" title="ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«"></a>ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«</h5><ul>
<li><p>C++</p>
<blockquote>
<p>è½»æ˜“åæ±‡ç¼–</p>
</blockquote>
<p>ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç ï¼Œå¯ä»¥å’Œæœºå™¨ç è¿›è¡Œè½¬æ¢</p>
</li>
<li><p>JavaScript</p>
<blockquote>
<p>è„šæœ¬è¯­è¨€ï¼Œç”±æµè§ˆå™¨è¿›è¡Œè§£æ</p>
</blockquote>
</li>
<li><p>PHP</p>
<blockquote>
<p>è„šæœ¬è¯­è¨€ï¼Œç”±Zend Engine(ZE)è¿›è¡Œè§£æ</p>
</blockquote>
<p>JS å’Œ PHP åœ¨é€šè¿‡å¼•æ“è§£æåå˜ä¸ºä¸­é—´ä»£ç ï¼Œç„¶åè½¬ä¸º<code>æœºå™¨ç (ä¸åŒè¯­è¨€çš„æœºå™¨ç ä¸åŒ)</code>ï¼Œæ‰€ä»¥ä¸å¥½æ¥è§¦åˆ°åº•å±‚</p>
</li>
<li><p>Java</p>
<blockquote>
<p>ç”±JVMè¿›è¡Œè£…è½½å­—èŠ‚ç </p>
</blockquote>
<p>ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºclassï¼ˆå­—èŠ‚ç ï¼‰ï¼Œç„¶åé€šè¿‡JVMè™šæ‹Ÿæœºå½¢è½¬ä¸ºå™¨ç </p>
</li>
</ul>
<p>æ— è®ºç”¨ä»€ä¹ˆè¯­è¨€ç¼–å†™ä»£ç ï¼Œæœ€ç»ˆä¼šå½¢æˆå‡ ä¹ç›¸åŒçš„æœºå™¨ç ã€‚</p>
<h3 id="2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰"><a href="#2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰" class="headerlink" title="2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰"></a>2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰</h3><hr>
<ul>
<li><p>è§„åˆ™</p>
<blockquote>
<p>å‡½æ•°åç›¸åŒ</p>
<p>å‚æ•°ä¸ªæ•°ä¸åŒã€å‚æ•°ç±»å‹ä¸åŒã€å‚æ•°é¡ºåºä¸åŒ</p>
</blockquote>
</li>
<li><p>æ³¨æ„</p>
<blockquote>
<p>è¿”å›å€¼ç±»å‹ä¸å‡½æ•°é‡è½½æ— å…³</p>
<p>è°ƒç”¨å‡½æ•°æ—¶ï¼Œå®å‚çš„éšå¼ç±»å‹è½¬æ¢å¯èƒ½ä¼šäº§ç”ŸäºŒä¹‰æ€§</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>æœ¬è´¨</p>
<blockquote>
<p>é‡‡ç”¨äº†name manglingæˆ–è€…å«name decorationçš„æŠ€æœ¯ï¼ŒC++ç¼–è¯‘å™¨é»˜è®¤ä¼šå¯¹ç¬¦å·åï¼ˆæ¯”å¦‚å‡½æ•°åï¼‰è¿›è¡Œæ”¹å˜ï¼Œä¿®é¥°ã€‚</p>
<p>é‡è½½æ—¶äº§ç”Ÿçš„å‡½æ•°åå­—å’Œç¼–è¯‘å™¨æœ‰å…³ï¼Œä¸åŒç¼–è¯‘å™¨ä¸åŒï¼Œäº§ç”Ÿçš„åå­—ä¸åŒã€‚</p>
</blockquote>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;        			 		<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA1429h)</span>		</span></span><br><span class="line"><span class="function">    <span class="comment">//...</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;					<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA13F7h)</span></span></span><br><span class="line"><span class="function">    <span class="comment">//...</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">long</span> a)</span></span>&#123;					<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA1230h)</span></span></span><br><span class="line"><span class="function">    <span class="comment">//...</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(doble a)</span></span>&#123;					<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA10B4h)</span>	</span></span><br><span class="line"><span class="function">    <span class="comment">//...																</span></span></span><br><span class="line">&#125;</span><br><span class="line">VSç®€åŒ–äº†å‡½æ•°åï¼Œä½¿å…¶çœ‹ä¸Šå»ä¸€æ ·ï¼Œä½†å‡½æ•°åé¢æ‹¬å·é‡Œçš„ä¸åŒæ•°å€¼è¡¨ç¤ºè°ƒç”¨çš„å‡½æ•°åœ°å€å¹¶ä¸ç›¸åŒã€‚</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨IDAè¿›è¡Œé€†å‘å·¥ç¨‹ï¼Œåœ¨mainæ–‡ä»¶é‡ŒæŸ¥çœ‹æ±‡ç¼–ç ï¼š</p>
<blockquote>
<p>è®°å¾—å°†ç¨‹åºä»¥releaseç‰ˆæœ¬ç”Ÿæˆï¼Œå»é™¤è°ƒè¯•ä¿¡æ¯ï¼Œä½¿æ–‡ä»¶ç²¾ç®€ã€‚ä½†æ˜¯ç›¸å¯¹çš„releaseä¼šå¯¹ç¨‹åºè¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¸Šé¢4ä¸ªæ‰“å°å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥å°†4ä¸ªå‡½æ•°æ”¹ä¸º4ä¸ªç›´æ¥è¾“å‡ºï¼Œä¸å†è¿›è¡Œå‡½æ•°è°ƒç”¨ã€‚æ‰€ä»¥è¦å°†ç¼–è¯‘å™¨çš„ä¼˜åŒ–é€‰é¡¹å…³é—­ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call		display</span><br><span class="line">call		display_1</span><br><span class="line">call		display_2</span><br><span class="line">call		display_3			å¯è§çš„ç¡®è¿›è¡Œäº†name manglingä½¿å‡½æ•°é‡è½½å¾—ä»¥å®ç°</span><br></pre></td></tr></table></figure>



<h3 id="3ã€é»˜è®¤å‚æ•°"><a href="#3ã€é»˜è®¤å‚æ•°" class="headerlink" title="3ã€é»˜è®¤å‚æ•°"></a>3ã€é»˜è®¤å‚æ•°</h3><hr>
<p>C++å…è®¸å‡½æ•°è®¾ç½®é»˜è®¤å‚æ•°ï¼Œåœ¨è°ƒç”¨æ—¶å¯ä»¥æ ¹æ®æƒ…å†µçœç•¥å®å‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1 = <span class="number">5</span>, <span class="keyword">int</span> v2 = <span class="number">6</span>)</span></span>&#123; <span class="comment">// é»˜è®¤å‚æ•°å€¼å¿…é¡»ä»å³è¾¹å¼€å§‹ int v1 = 10, int v2 ---&gt; ç¼–è¯‘ä¸é€šè¿‡</span></span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum() &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 11</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>) &lt;&lt;<span class="built_in">endl</span>;<span class="comment">// 16</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>, <span class="number">20</span>) &lt;&lt; <span class="built_in">endl</span>;<span class="comment">// 30</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//åŒæ—¶æœ‰å£°æ˜å’Œå®ç°çš„æ—¶å€™ï¼Œåªèƒ½åœ¨å£°æ˜å¤„å¡«é»˜è®¤å‚æ•°</span></span><br></pre></td></tr></table></figure>



<p>é»˜è®¤å‚æ•°çš„å€¼å¯ä»¥æ˜¯å¸¸é‡ã€å…¨å±€ç¬¦å·ï¼ˆå…¨å±€å˜é‡ã€å‡½æ•°åï¼‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1 = <span class="number">5</span>, <span class="keyword">int</span> v2 = <span class="number">6</span>)</span></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;test(int) - &quot;</span> &lt;&lt; a &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">void</span>(*p)(<span class="keyword">int</span>) = test)</span></span>&#123; <span class="comment">//å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    p(v1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>(*p)(<span class="keyword">int</span>) = test;</span><br><span class="line">    p(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum() &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 11</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>) &lt;&lt;<span class="built_in">endl</span>;<span class="comment">// 16</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>, <span class="number">20</span>) &lt;&lt; <span class="built_in">endl</span>;<span class="comment">// 30</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœå‡½æ•°çš„å‚æ•°ç»å¸¸ä½¿ç”¨åŒä¸€ä¸ªå€¼ï¼Œæ¨èä½¿ç”¨é»˜è®¤å‚æ•°</strong></p>
<p>å‡½æ•°é‡è½½å’Œé»˜è®¤å‚æ•°å…±åŒä½¿ç”¨çš„æ—¶å€™ä¼šäº§ç”Ÿå†²çªã€äºŒä¹‰æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹å»ºè®®ä¼˜å…ˆé€‰æ‹©é»˜è®¤å‚æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b = <span class="number">10</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    display(<span class="number">10</span>); <span class="comment">//æŠ¥é”™ï¼Œç¼–è¯‘ä¸é€šè¿‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤å‚æ•°çš„æœ¬è´¨ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line">sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">push		<span class="number">2</span></span><br><span class="line">push		<span class="number">1</span>    <span class="comment">//ä¼ å‚</span></span><br><span class="line"><span class="function">call		<span class="title">sum</span><span class="params">(<span class="number">0F</span>E1424h)</span></span></span><br><span class="line">add			esp,8</span><br><span class="line"></span><br><span class="line">sum(<span class="number">2</span>, <span class="number">4</span>); </span><br><span class="line">push		<span class="number">4</span></span><br><span class="line">push		<span class="number">2</span></span><br><span class="line"><span class="function">call		<span class="title">sum</span><span class="params">(<span class="number">0F</span>E1424h)</span> <span class="comment">//è°ƒç”¨ç›¸åŒçš„å‡½æ•°åœ°å€</span></span></span><br><span class="line">add			esp,8</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ é»˜è®¤å‚æ•°</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2 = <span class="number">4</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line">sum(<span class="number">1</span>);</span><br><span class="line">push		<span class="number">4</span></span><br><span class="line">push		<span class="number">1</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¹Ÿå°±æ˜¯è¯´ sum(1); å’Œ sum(1, 4); æ˜¯å®Œå…¨ä¸€æ ·çš„åŠŸèƒ½ï¼Œç»éªŒè¯æœºå™¨ç ä¹Ÿæ˜¯å‡ ä¹ä¸€æ ·ã€‚</span></span><br><span class="line"><span class="function">E8 A3 F2 FF FF			call		<span class="title">sum</span><span class="params">(<span class="number">01271424</span>h)</span></span></span><br><span class="line">E8 97 F2 FF FF			call		sum(01271424h)  ä»…æœ‰E8 åé¢è®¡ç®—å‡ºçš„åœ°å€å€¼æœ‰ç»†å¾®åŒºåˆ« (è¯¦è§Intelæœºå™¨ç ç™½çš®ä¹¦)</span><br></pre></td></tr></table></figure>



<h3 id="4ã€extern-â€œCâ€"><a href="#4ã€extern-â€œCâ€" class="headerlink" title="4ã€extern â€œCâ€"></a>4ã€extern â€œCâ€</h3><hr>
<p>è¢«<code>extern &quot;C&quot;</code>ä¿®é¥°çš„ä»£ç ä¼šæŒ‰ç…§Cè¯­è¨€çš„è§„èŒƒå»ç¼–è¯‘</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line">exterm <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> v)</span></span>&#123; <span class="comment">//æŠ¥é”™ï¼Œå› ä¸ºCä¸æ”¯æŒé‡è½½</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå‡½æ•°åŒæ—¶æœ‰å£°æ˜ä¸å®ç°ï¼Œè¦åœ¨å£°æ˜å¤„ä½¿ç”¨<code>extern &quot;C&quot;</code>ï¼Œåœ¨å®ç°å¤„å¯ä»¥ä¸ç”¨æ·»åŠ ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> v)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä¸ºæ–¹ä¾¿ä½¿ç”¨ç›´æ¥åœ¨å¤´æ–‡ä»¶ä½¿ç”¨</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;****.h&quot;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ç”¨Cè¯­è¨€å¼€å‘çš„ç¬¬ä¸‰æ–¹æ¡†æ¶\åº“</li>
</ul>
<p>åœ¨C\C++æ··åˆå¼€å‘çš„æ—¶å€™ä¼šå‡ºç°å¤§é‡é—®é¢˜ï¼Œæ¨èæŒ‰ä¸€ä¸‹æ–¹å¼ä½¿ç”¨<code>extern &quot;C&quot;</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus <span class="comment">//ä½¿ç”¨å®</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†é¿å…é‡å¤å¼•ç”¨ï¼Œç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ***</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ***</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸€å®šè¦ä¿è¯æ¯ä¸€ä¸ªæ–‡ä»¶é‡Œçš„å®éƒ½ä¸ç›¸åŒï¼Œæ¨èå°†å®å’Œæ–‡ä»¶åå­—ç›¸åŒã€‚<code>#pragma once</code> å¯ä»¥ä¿è¯æ•´ä¸ªæ–‡ä»¶å†…å®¹åªè¢«ç¼–è¯‘ä¸€æ¬¡ï¼Œé¿å…é‡å¤åŒ…å«ï¼Œä½†æ˜¯ <code>#pragma once</code>ä¸è¢«æŸäº›ç¼–è¯‘å™¨æ”¯æŒã€‚</p>
<h3 id="5ã€å†…è”å‡½æ•°"><a href="#5ã€å†…è”å‡½æ•°" class="headerlink" title="5ã€å†…è”å‡½æ•°"></a>5ã€å†…è”å‡½æ•°</h3><hr>
<p>ä½¿ç”¨<code>inline</code>å…³é”®å­—å°†å…¶å˜ä¸ºå†…è”å‡½æ•°ã€‚ç¼–è¯‘å™¨ç›´æ¥å°†å‡½æ•°è°ƒç”¨å±•å¼€ä¸ºå‡½æ•°ä½“ä»£ç ã€‚</p>
<p>åœ¨å‡½æ•°å¼€å§‹çš„æ—¶å€™ä¼šå¼€è¾Ÿæ ˆç©ºé—´ï¼Œå‡½æ•°ç»“æŸçš„æ—¶å€™å›æ”¶æ ˆç©ºé—´ã€‚å†…è”å‡½æ•°åœ¨ä»£ç ä½“ç§¯ä¸å¤§å’Œä½¿ç”¨æ¬¡æ•°è¿‡å¤šçš„æ—¶å€™æ¨èä½¿ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">    run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    func();</span><br><span class="line">    <span class="keyword">int</span> c = sum(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    ä¸å†…è”</span><br><span class="line">    push		<span class="number">14</span>h</span><br><span class="line">    push		<span class="number">0</span>Ah</span><br><span class="line">    <span class="function">call		<span class="title">sum</span><span class="params">(<span class="number">08110</span>A0h)</span></span></span><br><span class="line">    åœ¨releaseæ¨¡å¼ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥å°†sumå‡½æ•°ä¼˜åŒ–ï¼Œç›´æ¥ç»™å‡ºè¿”å›å€¼ï¼Œä¸å†è°ƒç”¨å‡½æ•°ã€‚</span><br><span class="line">    æŠŠä¼˜åŒ–å…³é—­ï¼Œè¿›è¡Œç›¸å…³è°ƒæ•´å</span><br><span class="line">    mov			eax,<span class="number">0</span>Ah</span><br><span class="line">   	add 		eax,<span class="number">14</span>h</span><br><span class="line">    mov			dword ptr [c],eax  <span class="comment">//ç­‰åŒäºç›´æ¥å®ç° 10 + 20 </span></span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; c &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    </span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…è”å‡½æ•°ä¸å®å¯¹æ¯”ï¼š</p>
<ul>
<li>ä¸¤è€…éƒ½èƒ½å‡å°‘å‡½æ•°è°ƒç”¨</li>
<li>ç›¸æ¯”äºå®å†…è”å‡½æ•°å…·æœ‰å‡½æ•°ç‰¹æ€§ï¼Œæ‹¥æœ‰è¯­æ³•æ£€æµ‹å’Œä»£ç æç¤ºåŠŸèƒ½</li>
</ul>
<h3 id="6ã€è¡¨è¾¾å¼"><a href="#6ã€è¡¨è¾¾å¼" class="headerlink" title="6ã€è¡¨è¾¾å¼"></a>6ã€è¡¨è¾¾å¼</h3><hr>
<ul>
<li><p>C++æœ‰äº›è¡¨è¾¾å¼èƒ½è¢«èµ‹å€¼</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">(a = b) = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// a = 4; b = 2;</span></span><br><span class="line">(a &gt; b ? a : b) = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// b = 4</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="7ã€const"><a href="#7ã€const" class="headerlink" title="7ã€const"></a>7ã€const</h3><hr>
<ul>
<li><p>constæ˜¯å¸¸é‡çš„æ„æ€ï¼Œè¢«ä¿®é¥°çš„å˜é‡ä¸å¯ä¿®æ”¹</p>
<p>å¦‚æœä¿®é¥°çš„æ˜¯ç±»ã€ç»“æ„ä½“(çš„æŒ‡é’ˆ)ï¼Œæˆå‘˜å‡½æ•°ä¸å¯ä»¥æ›´æ”¹</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> *p0 = &amp;age;</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> *p1 = &amp;age; <span class="comment">// p0 p1 ç­‰ä»·ï¼Œéƒ½è¢«constä¿®é¥°</span></span><br><span class="line"><span class="keyword">int</span> * <span class="keyword">const</span> p2 = &amp;age;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> * <span class="keyword">const</span> p3 = &amp;age;</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> * <span class="keyword">const</span> p4 = &amp;age; <span class="comment">// p3 p4 ç­‰ä»·</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºconstæœ‰ä»¥ä¸‹ç»“è®ºï¼š</p>
<ul>
<li><p>constä¿®é¥°çš„æ˜¯å…¶å³è¾¹çš„å†…å®¹ </p>
<blockquote>
<p>const int * <code>const p3</code> = &age;  æ„å‘³ç€p3ä¸ºå¸¸é‡ä½†æ˜¯*p3ä¸æ˜¯å¸¸é‡ï¼Œå¯ä»¥å¯¹ *p3è¿›è¡Œä¿®æ”¹</p>
</blockquote>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span>&#123;</span> <span class="keyword">int</span> age; &#125;;</span><br><span class="line">Student stu1 = &#123;<span class="number">20</span>&#125;;</span><br><span class="line">Student stu2 = &#123;<span class="number">20</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Student *pStu1 = &amp;stu1;</span><br><span class="line">*pStu1 = stu2; <span class="comment">// æŠ¥é”™ï¼Œconstä¿®é¥°*pStu1ä¸èƒ½è¢«èµ‹å€¼</span></span><br><span class="line">(*pStu1).age = <span class="number">30</span>; </span><br><span class="line">pStu1-&gt;age = <span class="number">30</span>; <span class="comment">// æŠ¥é”™ï¼Œä¸ºäº†ä¿è¯constçš„ä¸¥è°¨æ€§ï¼Œä¸å…è®¸é€šè¿‡æŒ‡é’ˆè®¿é—®æˆå‘˜å±æ€§</span></span><br><span class="line">pStu1 = &amp;stu2;</span><br><span class="line"></span><br><span class="line">Student * <span class="keyword">const</span> pStu2 = &amp;stu2;</span><br><span class="line">*pStu2 = stu1;</span><br><span class="line">(*pStu2).age = <span class="number">30</span>;</span><br><span class="line">pStu2-&gt;age = <span class="number">30</span>;</span><br><span class="line">pStu2 = &amp;stu1; <span class="comment">// æŠ¥é”™ï¼Œä¸èƒ½ä¿®æ”¹pStu2çš„å†…å®¹</span></span><br></pre></td></tr></table></figure>

<h3 id="8ã€å¼•ç”¨-Reference"><a href="#8ã€å¼•ç”¨-Reference" class="headerlink" title="8ã€å¼•ç”¨(Reference)"></a>8ã€å¼•ç”¨(Reference)</h3><hr>
<p>åœ¨Cè¯­è¨€ä¸­ï¼Œä½¿ç”¨<code>æŒ‡é’ˆ(Pointer)</code>å¯ä»¥é—´æ¥è·å–ã€ä¿®æ”¹æŸä¸ªå˜é‡çš„å€¼</p>
<p>åœ¨C++ä¸­ï¼Œä½¿ç”¨<code>å¼•ç”¨(Reference)</code>å¯ä»¥èµ·åˆ°æ›´æŒ‡é’ˆç±»ä¼¼çš„åŠŸèƒ½</p>
<p>å¼•ç”¨çš„æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>å¼•ç”¨ç›¸å½“äºå˜é‡çš„åˆ«å</li>
<li>å¯¹å¼•ç”¨åšè®¡ç®—ç­‰äºå¯¹å…¶æŒ‡å‘çš„å˜é‡åšè¿ç®—</li>
<li>å¿…é¡»åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ï¼Œè€Œä¸”ä¸€æ—¦æŒ‡å‘æŸä¸ªå˜é‡å°±ä¸å¯ä»¥å†æ”¹å˜</li>
<li>å¯ä»¥åˆ©ç”¨ä¸€ä¸ªå¼•ç”¨åˆå§‹åŒ–å¦ä¸€ä¸ªå¼•ç”¨ï¼Œç›¸å½“äºä¸€ä¸ªå˜é‡æœ‰å¤šä¸ªåˆ«å</li>
<li>ä¸å­˜åœ¨<code>å¼•ç”¨çš„å¼•ç”¨</code>ã€<code>æŒ‡å‘å¼•ç”¨çš„æŒ‡é’ˆ</code>ã€<code>å¼•ç”¨æ•°ç»„</code></li>
</ul>
<p>å¼•ç”¨çš„ä»·å€¼ï¼šæ¯”æŒ‡é’ˆæ›´å®‰å…¨ã€å‡½æ•°è¿”å›å€¼å¯ä»¥è¢«èµ‹å€¼</p>
<h5 id="å¼•ç”¨çš„æœ¬è´¨"><a href="#å¼•ç”¨çš„æœ¬è´¨" class="headerlink" title="å¼•ç”¨çš„æœ¬è´¨"></a>å¼•ç”¨çš„æœ¬è´¨</h5><ul>
<li>å¼•ç”¨çš„æœ¬è´¨å°±æ˜¯æŒ‡é’ˆï¼Œåªæ˜¯ç¼–è¯‘å™¨å‰Šå¼±äº†å®ƒçš„åŠŸèƒ½ï¼Œå¼•ç”¨å°±æ˜¯å¼±åŒ–äº†çš„æŒ‡é’ˆ</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> &amp;age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="keyword">sizeof</span>(student) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 8 X64ç¯å¢ƒ ä¹Ÿå°±æ˜¯ä»ä¾§é¢è¯æ˜äº†å¼•ç”¨çš„å¤§å°ä¸º8bit</span></span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ±‡ç¼–ç (å…³é—­æ˜¾ç¤ºç¬¦å·):</p>
<ul>
<li>æŒ‡é’ˆ</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> *p = &amp;age;</span><br><span class="line">lea			eax,[ebp<span class="number">-18</span>h],eax</span><br><span class="line">mov			dword ptr [ebp<span class="number">-18</span>h],eax</span><br><span class="line">*p = <span class="number">30</span>;</span><br><span class="line">mov 		eax,dword ptr [ebp<span class="number">-18</span>h]</span><br><span class="line">mov 		dword ptr [eax],<span class="number">1</span>Eh</span><br></pre></td></tr></table></figure>

<ul>
<li>å¼•ç”¨</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> &amp;ref = age;</span><br><span class="line">lea			eax,[ebp<span class="number">-18</span>h],eax</span><br><span class="line">mov			dword ptr [ebp<span class="number">-18</span>h],eax</span><br><span class="line">ref = <span class="number">30</span>;</span><br><span class="line">mov 		eax,dword ptr [ebp<span class="number">-18</span>h]</span><br><span class="line">mov 		dword ptr [eax],<span class="number">1</span>Eh</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å¯¹æ¯”å‘ç°ä¸¤è€…çš„æ±‡ç¼–ç å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥ä¸€ä¸ªå¼•ç”¨ä¹Ÿå°±å ç”¨ä¸€ä¸ªæŒ‡é’ˆçš„å¤§å°</p>
<h1 id="äºŒã€åŸºç¡€è¯­æ³•"><a href="#äºŒã€åŸºç¡€è¯­æ³•" class="headerlink" title="äºŒã€åŸºç¡€è¯­æ³•"></a>äºŒã€åŸºç¡€è¯­æ³•</h1><h3 id="1ã€x86ï¼Œx64æ±‡ç¼–"><a href="#1ã€x86ï¼Œx64æ±‡ç¼–" class="headerlink" title="1ã€x86ï¼Œx64æ±‡ç¼–"></a>1ã€x86ï¼Œx64æ±‡ç¼–</h3><hr>
<p>æ±‡ç¼–è¯­è¨€çš„ç§ç±»</p>
<ul>
<li>8086æ±‡ç¼–</li>
<li>x86æ±‡ç¼–</li>
<li>x64æ±‡ç¼–</li>
<li>ï¼¡ï¼²ï¼­æ±‡ç¼–</li>
<li>ï¼ï¼ï¼ï¼ï¼ï¼</li>
</ul>
<p>æ ¹æ®ç¼–è¯‘å™¨ä¸åŒï¼Œæœ‰ä¸¤ç§ä¹¦å†™æ ¼å¼</p>
<ul>
<li>Intel(Visual Studio)</li>
<li>AT&amp;T(Mac)</li>
</ul>
<h5 id="x64æ±‡ç¼–-å¯„å­˜å™¨"><a href="#x64æ±‡ç¼–-å¯„å­˜å™¨" class="headerlink" title="x64æ±‡ç¼–- å¯„å­˜å™¨"></a>x64æ±‡ç¼–- å¯„å­˜å™¨</h5><p>ä¸åŒæ±‡ç¼–çš„å¯„å­˜å™¨ä¸åŒ</p>
<p>å¸¸ç”¨å¯„å­˜å™¨ï¼š</p>
<table>
<thead>
<tr>
<th align="left">æ ‡è¯†ç¬¦</th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>RAX\RBX\RCX\RDX</strong></td>
<td align="left"><strong>(64bitä¸‹å¸¸è§)é€šç”¨å¯„å­˜å™¨</strong></td>
</tr>
<tr>
<td align="left"><strong>EAX\EBXECX\EDX</strong></td>
<td align="left"><strong>(32bitä¸‹å¸¸è§))é€šç”¨å¯„å­˜å™¨</strong></td>
</tr>
<tr>
<td align="left"><strong>AX\BX\CX\DX</strong></td>
<td align="left"><strong>(16bitä¸‹å¸¸è§)é€šç”¨å¯„å­˜å™¨</strong></td>
</tr>
</tbody></table>
<p>tipsï¼š</p>
<blockquote>
<ul>
<li><p>ä¸€ä¸ªå¯„å­˜å™¨èƒ½å­˜8ä¸ªå­—èŠ‚(x64)</p>
</li>
<li><p>ä¸ºäº†ä½¿æ–°çš„å¯„å­˜å™¨å…¼å®¹è€æ—§çš„å¯„å­˜å™¨å°†æ–°å¯„å­˜å™¨åˆ†æˆæ›´å°çš„åŒºå—æ¥å­˜å‚¨æ—§çš„å¯„å­˜å™¨</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>63â€¦32</th>
<th>31â€¦16</th>
<th>15â€¦8</th>
<th>7â€¦0</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td><strong>AHâ€¦</strong></td>
<td><strong>ALâ€¦</strong></td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>AXâ€¦</strong></td>
<td><strong>â€¦</strong></td>
</tr>
<tr>
<td></td>
<td><strong>EAXâ€¦</strong></td>
<td><strong>â€¦</strong></td>
<td><strong>â€¦</strong></td>
</tr>
<tr>
<td><strong>RAXâ€¦</strong></td>
<td><strong>â€¦</strong></td>
<td><strong>â€¦</strong></td>
<td><strong>â€¦</strong></td>
</tr>
</tbody></table>
<p>AH H high</p>
<p>AL  L low</p>
</blockquote>
<h3 id="2ã€å†…è”æ±‡ç¼–"><a href="#2ã€å†…è”æ±‡ç¼–" class="headerlink" title="2ã€å†…è”æ±‡ç¼–"></a>2ã€å†…è”æ±‡ç¼–</h3><hr>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    __asm&#123; <span class="comment">//x86</span></span><br><span class="line">        mov eax, a  <span class="comment">//çœŸå®çš„æ±‡ç¼–ä¸ä¼šå­˜åœ¨aè¿™ä¸ªç¬¦å·  å®é™…çš„æ±‡ç¼–ç ä¸º eax,dword ptr[ebp-oCh]</span></span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;		</span><br></pre></td></tr></table></figure>

<h3 id="3ã€å¸¸è§æŒ‡ä»¤"><a href="#3ã€å¸¸è§æŒ‡ä»¤" class="headerlink" title="3ã€å¸¸è§æŒ‡ä»¤"></a>3ã€å¸¸è§æŒ‡ä»¤</h3><hr>
<ul>
<li><p>mov              dest, src</p>
<blockquote>
<p>å°†srcå†…å®¹èµ‹å€¼ç»™destï¼Œç±»ä¼¼äºdest = src</p>
</blockquote>
</li>
<li><p>[åœ°å€å€¼]</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">int</span> b = a + <span class="number">1</span>ï¼›</span><br><span class="line">    </span><br><span class="line">mov           dword ptr [ebp<span class="number">-8</span>], <span class="number">3</span></span><br><span class="line"><span class="comment">//mov [1122h], 3 æ„å‘³ç€å°†3æ”¾å…¥[1122h]æ‰€åœ¨çš„åœ°å€ç©ºé—´</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><strong>mov                 [1128h], 3</strong></p>
<p><strong><code>word</code>æ˜¯2ä¸ªå­—èŠ‚ï¼Œ<code>dword</code>æ˜¯4ä¸ªå­—èŠ‚ï¼Œ<code>qword</code>æ˜¯8ä¸ªå­—èŠ‚</strong></p>
<p><strong>mov                 dword ptr [1128h], 3</strong>  //å°†3æ”¾åˆ°åœ°å€ä»¥1128hå¼€å§‹çš„å†…å­˜ä¸­ï¼Œå¹¶å ç”¨dwordä¸ªå†…å­˜åœ°å€**(å‘é«˜åœ°å€åˆå¹¶)**</p>
<p>4ä¸ªå­—èŠ‚å­˜å‚¨3ï¼š</p>
<blockquote>
<p>16è¿›åˆ¶: 00 00 00 03H </p>
<p>2è¿›åˆ¶: 00000000 00000000 00000000 00000011</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å†…å­˜åœ°å€</th>
<th align="center">å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1122h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1123h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1124h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1125h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1126h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1127h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1128h</td>
<td align="center">3     (00 00 00 11) å°ç«¯æ¨¡å¼</td>
</tr>
<tr>
<td align="center">1129h</td>
<td align="center">|      (00 00 00 00)</td>
</tr>
<tr>
<td align="center">112Ah</td>
<td align="center">|      (00 00 00 00)</td>
</tr>
<tr>
<td align="center">112Bh</td>
<td align="center">|      (00 00 00 00)</td>
</tr>
</tbody></table>
<p>å¤§éƒ¨åˆ†æ—¶å€™æ˜¯å°ç«¯æ¨¡å¼(é«˜å­—èŠ‚æ”¾é«˜åœ°å€ï¼Œä½å­—èŠ‚æ”¾ä½åœ°å€)ï¼Œæ³¨æ„åœ¨è¯»åœ°å€çš„æ—¶å€™ä¸è®ºå¤§å°ç«¯æ¨¡å¼ï¼Œéƒ½æ˜¯ä»ä½åœ°å€å¼€å§‹è¯»ï¼Œè¯»å–è®¾å®šçš„å­—èŠ‚åï¼Œå¦‚ä½•æ’åˆ—é¡ºåºå†è€ƒè™‘å¤§å°ç«¯æ¨¡å¼é—®é¢˜</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">4</span>;</span><br><span class="line"><span class="number">0x007DF968</span>		<span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> cc cc cc cc <span class="comment">//8ä¸ªå­—èŠ‚ï¼Œ aå ç”¨äº†4ä¸ªå­—èŠ‚</span></span><br><span class="line"><span class="number">0x007DF970</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªå˜é‡çš„åœ°å€å€¼ï¼Œæ˜¯ä»–æ‰€æœ‰å­—èŠ‚åœ°å€ä¸­çš„æœ€å°å€¼</p>
</li>
</ul>
  <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line">mov 	dword ptr [ebp<span class="number">-8</span>], <span class="number">3</span></span><br><span class="line"><span class="comment">//[ebp-8] å³ä¸ºå˜é‡açš„åœ°å€</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;ã€€&amp;a &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">//açš„åœ°å€ä¸º 010FFE4C</span></span><br><span class="line">æ±‡ç¼–ç ä¸º:</span><br><span class="line">mov		dword ptr [ebp<span class="number">-0</span>Ch], <span class="number">3</span> <span class="comment">//è¿™é‡Œçš„å€¼ä¸èƒ½å†™æ­»ï¼Œå› ä¸ºæ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶å¼€è¾Ÿæ ˆç©ºé—´</span></span><br><span class="line">    						 <span class="comment">//è€Œä¸”æ¯ä¸€æ¬¡åˆ†é…çš„åœ°å€ä¸åŒï¼Œé‡Œé¢çš„å±€éƒ¨å˜é‡çš„åœ°å€ä¼šä¸€ç›´æ”¹å˜</span></span><br><span class="line">    						 <span class="comment">//æ¯æ¬¡è°ƒç”¨éƒ½ä¸åŒï¼Œ -0ch åˆ™æ¶‰åŠåˆ°å‡½æ•°æ ˆçš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="comment">//ebpçš„å€¼ä¸º 010FFE58</span></span><br><span class="line">a - ebp = c (<span class="number">16</span>è¿›åˆ¶)</span><br><span class="line">    </span><br><span class="line">å¦‚æœæ˜¯å…¨å±€å˜é‡çš„åœ°å€å€¼,è¯¥å˜é‡çš„åœ°å€å€¼æ˜¯å†™æ­»çš„</span><br><span class="line">age = <span class="number">3</span>;</span><br><span class="line">mov			dword ptr ds:[<span class="number">00F</span>DA008h] <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">å¸¸é‡çš„è¯åœ°å€å€¼ä¹Ÿä¼šå˜åŠ¨</span><br></pre></td></tr></table></figure>

<ul>
<li>call å‡½æ•°åœ°å€</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"> 	test();   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">é¦–å…ˆ:</span><br><span class="line">call		<span class="number">003713</span>A2 <span class="comment">//å¹¶éçœŸæ­£å‡½æ•°åœ°å€ æŒ‰F11</span></span><br><span class="line"></span><br><span class="line">jmp			<span class="number">00371780</span> <span class="comment">//è·³è½¬åˆ°çœŸæ­£çš„å‡½æ•°åœ°å€ è¿›å…¥è¿™ä¸ªåœ°å€</span></span><br><span class="line">    </span><br><span class="line"><span class="number">00371780</span> <span class="number">55</span>			push		ebp</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ul>
<li>lea               eax, [1122h]     //load effect address è£…è½½ä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€å€¼</li>
</ul>
<blockquote>
<p>ç­‰åŒäº mov             eax, 1122h</p>
</blockquote>
<ul>
<li>ret</li>
</ul>
<blockquote>
<p>å‡½æ•°è¿”å›</p>
</blockquote>
<ul>
<li>xor</li>
</ul>
<blockquote>
<p>å¼‚æˆ– xor            op1, op2å°†op1å’Œop2å¼‚æˆ–çš„ç»“æœèµ‹å€¼ç»™op1</p>
</blockquote>
<ul>
<li>addï¼Œsub</li>
</ul>
<blockquote>
<p>åŠ æ³•ï¼Œå‡æ³•</p>
</blockquote>
<ul>
<li>incï¼Œdec</li>
</ul>
<blockquote>
<p>è‡ªå¢ï¼Œè‡ªå‡</p>
</blockquote>
<ul>
<li>jmp</li>
</ul>
<blockquote>
<p>jmp             å†…å­˜åœ°å€      è·³è½¬åˆ°æŒ‡å®šçš„å†…å­˜åœ°å€å¼€å§‹æ‰§è¡Œ(æ— æ¡ä»¶è·³è½¬)</p>
<p>ä»¥ j å¼€å¤´çš„æ±‡ç¼–æŒ‡ä»¤ä¸€èˆ¬éƒ½æ˜¯è·³è½¬ï¼Œä¸€èˆ¬è·Ÿtestã€cmpç­‰æŒ‡ä»¤é…åˆä½¿ç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(a == b)&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="number">007118F</span>8  mov         dword ptr [ebp<span class="number">-8</span>],<span class="number">0</span>Ah  </span><br><span class="line">	<span class="keyword">int</span> b = <span class="number">20</span>;</span><br><span class="line"><span class="number">007118F</span>F  mov         dword ptr [ebp<span class="number">-14</span>h],<span class="number">14</span>h  </span><br><span class="line"><span class="keyword">if</span> (a == b) &#123;</span><br><span class="line"><span class="number">00711906</span>  mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line"><span class="number">00711909</span>  cmp         eax,dword ptr [ebp<span class="number">-14</span>h]  </span><br><span class="line"><span class="number">0071190</span>C  jne         <span class="number">0071191</span>D  </span><br><span class="line"><span class="comment">// jump not equal</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="number">0071190</span>E  push        <span class="number">717B</span>30h  </span><br><span class="line"><span class="number">00711913</span>  call        <span class="number">00711046</span>  </span><br><span class="line"><span class="number">00711918</span>  add         esp,<span class="number">4</span>  </span><br><span class="line">	&#125;</span><br><span class="line"><span class="number">0071191B</span>  jmp         <span class="number">0071192</span>A  </span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="number">0071191</span>D  push        <span class="number">717B</span>34h  <span class="comment">// jne è·³è½¬çš„åœ°å€</span></span><br><span class="line"><span class="number">00711922</span>  call        <span class="number">00711046</span>  </span><br><span class="line"><span class="number">00711927</span>  add         esp,<span class="number">4</span>  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0071192</span>A  <span class="keyword">xor</span>         eax,eax <span class="comment">// jmp è·³è½¬çš„åœ°å€</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>æ±‡ç¼–æƒå¨å‚è€ƒï¼š Intel ç™½çš®ä¹¦</strong></p>
<h3 id="4ã€å¼•ç”¨"><a href="#4ã€å¼•ç”¨" class="headerlink" title="4ã€å¼•ç”¨"></a>4ã€å¼•ç”¨</h3><hr>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> age = <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">int</span> *p = &amp;age;</span><br><span class="line">	*p = <span class="number">5</span>;</span><br><span class="line">	</span><br><span class="line"><span class="number">007</span>D17F2  mov         dword ptr [ebp<span class="number">-0</span>C h],<span class="number">3</span>  </span><br><span class="line"><span class="number">007</span>D17F9  lea         eax,[ebp<span class="number">-0</span>Ch]  <span class="comment">// eax å­˜æ”¾ageçš„åœ°å€å€¼</span></span><br><span class="line"><span class="number">007</span>D17FC  mov         dword ptr [ebp<span class="number">-18</span>h],eax  </span><br><span class="line"><span class="comment">//å°†ageçš„åœ°å€å€¼å­˜æ”¾åˆ°æŒ‡é’ˆå˜é‡pæ‰€åœ¨çš„å­˜å‚¨ç©ºé—´</span></span><br><span class="line"><span class="number">007</span>D17FF  mov         eax,dword ptr [ebp<span class="number">-18</span>h]  </span><br><span class="line"><span class="comment">//å°†ageçš„åœ°å€å€¼å­˜æ”¾åˆ° eax</span></span><br><span class="line"><span class="number">007</span>D1802  mov         dword ptr [eax],<span class="number">5</span>  </span><br><span class="line"><span class="comment">//å°†5æ”¾åˆ°ageçš„åœ°å€å€¼</span></span><br><span class="line"><span class="number">007</span>D1808  mov         esi,esp  </span><br><span class="line">    </span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¦‚æœä»£ç ç‰µæ‰¯åˆ°æŒ‡é’ˆï¼Œé‚£ä¹ˆä¸€å®šä¼šç‰µæ‰¯åˆ°æ±‡ç¼–çš„ <code>lea</code> æŒ‡ä»¤</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">lea 		eax,[ebp<span class="number">-0</span>Ch] <span class="comment">// [ebp-0Ch]æ•°æ®åœ°å€å€¼</span></span><br><span class="line">mov 		dword ptr [ebp<span class="number">-18</span>h],eax <span class="comment">//[ebp-18h]æŒ‡é’ˆå˜é‡è‡ªå·±çš„åœ°å€å€¼</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯å¼•ç”¨çš„è¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">3</span></span><br><span class="line"><span class="keyword">int</span> &amp;ref = age;</span><br><span class="line">ref = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">00B</span>817F2  mov         dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">3</span>  </span><br><span class="line"><span class="number">00B</span>817F9  lea         eax,[ebp<span class="number">-0</span>Ch]  </span><br><span class="line"><span class="number">00B</span>817FC  mov         dword ptr [ebp<span class="number">-18</span>h],eax  </span><br><span class="line"><span class="number">00B</span>817FF  mov         eax,dword ptr [ebp<span class="number">-18</span>h]  </span><br><span class="line"><span class="number">00B</span>81802  mov         dword ptr [eax],<span class="number">5</span></span><br><span class="line"><span class="comment">// å’ŒæŒ‡é’ˆçš„æ±‡ç¼–ç å®Œå…¨ä¸€æ ·</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‡é’ˆå¼•ç”¨</span></span><br><span class="line">*<span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> *p = &amp;age;</span><br><span class="line"><span class="keyword">int</span> *&amp;ref = p;</span><br><span class="line">*ref = <span class="number">30</span>; <span class="comment">// ref == f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> height = <span class="number">30</span>;</span><br><span class="line">ref = &amp;height; <span class="comment">// p = 30;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„å¼•ç”¨</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> (&amp;ref)[<span class="number">3</span>] = <span class="built_in">array</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line"><span class="keyword">int</span> *arr[<span class="number">3</span>]; <span class="comment">//æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„å†…éƒ¨èƒ½æ”¾3ä¸ªint*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> (*arr)[<span class="number">3</span>]; <span class="comment">//æ•°ç»„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ  ----&gt;  æ¨å‡ºæ•°ç»„æŒ‡é’ˆçš„ä¸€ç§å†™æ³• int (&amp;arr)[3] = array;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="å¸¸å¼•ç”¨"><a href="#å¸¸å¼•ç”¨" class="headerlink" title="å¸¸å¼•ç”¨"></a>å¸¸å¼•ç”¨</h5><p>constå¿…é¡»å†™åœ¨&amp;ç¬¦å·çš„å·¦è¾¹æ‰æ˜¯å¸¸é¥®ç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> &amp; <span class="keyword">const</span> ref = age;</span><br><span class="line">ref = <span class="number">30</span>;</span><br><span class="line"><span class="comment">//ref ä¸èƒ½ä¿®æ”¹æŒ‡å‘ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡refé—´æ¥ä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹æ¯”æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">int</span> * <span class="keyword">const</span> p1 = &amp;age; <span class="comment">// p1 = &amp;height</span></span><br><span class="line">*p1 = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// p2å¯ä»¥ä¿®æ”¹æŒ‡å‘ï¼Œä¸å¯ä»¥åˆ©ç”¨p2é—´æ¥ä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> *p2 = &amp;age;</span><br></pre></td></tr></table></figure>

<h5 id="const-å¼•ç”¨çš„ç‰¹ç‚¹"><a href="#const-å¼•ç”¨çš„ç‰¹ç‚¹" class="headerlink" title="const å¼•ç”¨çš„ç‰¹ç‚¹"></a>const å¼•ç”¨çš„ç‰¹ç‚¹</h5><ul>
<li>constå¼•ç”¨å¯ä»¥æŒ‡å‘ä¸´æ—¶æ•°æ®(å¸¸é‡ã€è¡¨è¾¾å¼ã€å‡½æ•°è¿”å›å€¼ç­‰ç­‰)</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = <span class="number">30</span>; <span class="comment">//å¸¸é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = a + b; <span class="comment">// è¡¨è¾¾å¼</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = func(); <span class="comment">// å‡½æ•°è¿”å›å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½œä¸ºå‡½æ•°å‚æ•°æ—¶(åŒæ—¶é€‚ç”¨äºconstæŒ‡é’ˆ)</li>
</ul>
<blockquote>
<p>å¯ä»¥æ¥å—constå’Œéconstå®å‚(éconstå¼•ç”¨ï¼Œåªèƒ½æ¥å—éconstå®å‚)</p>
<p>å¯ä»¥è·Ÿéconstå¼•ç”¨æ„æˆé‡è½½</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;v1, <span class="keyword">const</span> <span class="keyword">int</span> &amp;v2)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> v1 + v2;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> &amp;v1, <span class="keyword">int</span> &amp;v2)</span></span>&#123; <span class="comment">// æ„æˆé‡è½½</span></span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// éconstå®å‚</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">20</span>;</span><br><span class="line">    <span class="comment">//constå®å‚</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> c = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> d = <span class="number">20</span></span><br><span class="line">    sum(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    sum(c, d);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å¸¸å¼•ç”¨æŒ‡å‘äº†ä¸åŒçš„æ•°æ®æ—¶ï¼Œä¼šäº§ç”Ÿ<code>ä¸´æ—¶å˜é‡</code>ï¼Œå³å¼•ç”¨æŒ‡å‘çš„å¹¶ä¸æ˜¯åˆå§‹åŒ–æ—¶çš„é‚£ä¸ªå˜é‡</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> &amp;rAge = age;</span><br><span class="line">age = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; age; <span class="comment">// 30</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; rAge; <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="number">00</span>CB17F2  mov         dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">0</span>Ah  <span class="comment">// </span></span><br><span class="line"><span class="number">00</span>CB17F9  mov         eax,dword ptr [ebp<span class="number">-0</span>Ch]  <span class="comment">// 10 æ”¾åˆ° eax</span></span><br><span class="line"><span class="number">00</span>CB17FC  mov         dword ptr [ebp<span class="number">-24</span>h],eax  <span class="comment">// 10 æ”¾åˆ°å¦å¤–ä¸€ä¸ªå­˜å‚¨ç©ºé—´</span></span><br><span class="line">ç›¸å½“äº <span class="keyword">const</span> <span class="keyword">long</span> &amp;rAge = temp;</span><br><span class="line"><span class="number">00</span>CB17FF  lea         ecx,[ebp<span class="number">-24</span>h]  </span><br><span class="line"><span class="number">00</span>CB1802  mov         dword ptr [ebp<span class="number">-18</span>h],ecx  </span><br><span class="line"><span class="number">00</span>CB1805  mov         dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">1</span>Eh  </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> arr[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> (&amp;ref)[<span class="number">3</span>]arr = arr;</span><br><span class="line"><span class="keyword">int</span> * <span class="keyword">const</span> &amp;ref = arr;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>æ±‡ç¼–</tag>
      </tags>
  </entry>
  <entry>
    <title>å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°</title>
    <url>/myblog/2020/10/07/C/%E5%B9%B6%E5%8F%91%EF%BC%9A%E4%BA%92%E6%96%A5%E4%B8%8E%E5%90%8C%E6%AD%A5%E7%9A%84%E5%90%84%E7%A7%8D%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°"><a href="#å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°" class="headerlink" title="å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°"></a>å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°</h1><hr>
<p>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œæ ¸å¿ƒçš„è®¾è®¡é—®é¢˜åœ¨ä¸è¿›ç¨‹å’Œçº¿ç¨‹çš„ç®¡ç†ã€‚è€Œåœ¨å¯¹äºåœ¨<code>å¤šé“ç¨‹åºå¤„ç†</code>, <code>å¤šå¤„ç†å™¨ç¯å¢ƒ</code>ï¼Œ<code>åˆ†å¸ƒå¼ç³»ç»Ÿ</code>ç­‰ç›¸å…³é¢†åŸŸçš„åº”ç”¨ï¼Œä»¥åŠæ“ä½œç³»ç»Ÿè®¾è®¡çš„æœ¬èº«ï¼Œæœ€åŸºç¡€çš„é—®é¢˜å°±æ˜¯å¹¶å‘(Concurrency)ã€‚</p>
<p><em>ç”±äºç¯‡å¹…é—®é¢˜ï¼Œåœ¨è¿™é‡Œåªè®¨è®ºå„ç§å®ç°ï¼Œä¸å¯¹å…¶å„ç§æ–¹æ¡ˆçš„ä¼˜åŠ£è¿›è¡Œè¿‡å¤šè®¨è®ºï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒ ã€Šæ“ä½œç³»ç»Ÿ ç²¾é«“ä¸è®¾è®¡åŸç†ã€‹</em></p>
<h3 id="ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ"><a href="#ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ" class="headerlink" title="ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ"></a>ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ</h3><hr>
<h5 id="1ã€å…³ä¸­æ–­"><a href="#1ã€å…³ä¸­æ–­" class="headerlink" title="1ã€å…³ä¸­æ–­"></a>1ã€å…³ä¸­æ–­</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* disable interrupts */</span></span><br><span class="line">    <span class="comment">/* critical section */</span>  ä¸´ç•ŒåŒºæ‰§è¡Œ</span><br><span class="line">    <span class="comment">/* enable interrupts */</span></span><br><span class="line">    <span class="comment">/* remainder */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡é‡‡ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åŸè¯­çš„æ–¹å¼å¯ä»¥ä½¿ä¸´ç•ŒåŒºçš„æ‰§è¡Œä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œè¾¾åˆ°äº†äº’æ–¥çš„æ•ˆæœã€‚</p>
<p>ä½†æ˜¯è¯¥æ–¹æ¡ˆæœ‰ä¸¤ä¸ªæ˜æ˜¾ç¼ºé™·ï¼š</p>
<ul>
<li>ç”±äºä¸´ç•ŒåŒºçš„æ‰§è¡Œï¼Œå¯¼è‡´å¤„ç†å™¨ä¸èƒ½éšæ„ç©¿æ’æ‰§è¡Œè¿›ç¨‹ï¼Œå¯¼è‡´å¤„ç†å™¨æ•ˆç‡æ˜æ˜¾é™ä½</li>
<li>è¯¥æ–¹æ¡ˆä¸èƒ½ç›´æ¥ç”¨äºå¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå› ä¸ºåœ¨åŒä¸€æ—¶é—´é‡Œï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªè¿›ç¨‹åœ¨åŒæ—¶è¿›è¡Œï¼Œåªå¯¹ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå…³ä¸­æ®µä¸ä¸€å®šèƒ½ä¿è¯äº’æ–¥</li>
</ul>
<h5 id="2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤"><a href="#2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤" class="headerlink" title="2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤"></a>2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤</h5><p>å½“å¤„ç†å™¨è®¿é—®æŸä¸€å†…å­˜åœ°å€çš„æ—¶å€™ï¼Œä¸ºäº†é€šè¿‡ç¡¬ä»¶æ‰‹æ®µé¿å…å…¶ä»–å¤„ç†å™¨å¯¹è¯¥å†…å­˜åœ°å€çš„è®¿é—®ï¼Œè®¾è®¡äº†å‡ æ¡æœºå™¨æŒ‡ä»¤æ¥å®ç°ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸ŠåŠ¨ä½œçš„åŸå­æ€§ã€‚</p>
<p>1&gt; æ¯”è¾ƒæ›¿æ¢æŒ‡ä»¤</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">compare_and_swap</span><span class="params">(<span class="keyword">int</span> *word, <span class="keyword">int</span> testVal, <span class="keyword">int</span> newVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oldVal;</span><br><span class="line">    oldVal = *word;</span><br><span class="line">    <span class="keyword">if</span>(oldVal == testVal)</span><br><span class="line">    &#123;</span><br><span class="line">        *word = testVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldVal;</span><br><span class="line">&#125; <span class="comment">// è¿™ä¸ªå‡½æ•°çš„æ“ä½œä¸å¯è¢«å¹²æ‰°æˆ–è€…æ‰“æ–­ï¼Œå…·æœ‰åŸå­æ€§ã€‚</span></span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusion */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n = <span class="comment">/* number of process */</span> è¿›ç¨‹çš„æ•°é‡</span><br><span class="line"><span class="keyword">int</span> bolt; å…±äº«å˜é‡åˆå€¼ä¸º <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(compare_and_swap(bolt, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>) åªæœ‰å½“å‘ç°boltä¸º<span class="number">0</span>çš„è¿›ç¨‹æ‰èƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼Œè€Œå…¶ä»–çš„è¿›ç¨‹ä¸åœçš„æ¯”è¾ƒæ›¿æ¢ç”³è¯·è¿›å…¥ä¸´ç•ŒåŒº</span><br><span class="line">            								  ä¼šé€ æˆå¿™ç­‰ç°è±¡</span><br><span class="line">            <span class="comment">/* do nothing */</span>;</span><br><span class="line">        <span class="comment">/* critical section */</span>;</span><br><span class="line">        bolt = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* remainder */</span>; boltè¢«ç½®é›¶åå…¶ä»–è¿›ç¨‹æ‰æœ‰ä¸€ä¸ªæœºä¼šå°†boltç½®<span class="number">1</span>è¿›å…¥ä¸´ç•ŒåŒº</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bolt = <span class="number">0</span>;</span><br><span class="line">    parbeging( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>) ......);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2&gt; äº¤æ¢æŒ‡ä»¤</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exchange</span><span class="params">(<span class="keyword">int</span> *<span class="keyword">register</span>, <span class="keyword">int</span> *memory)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    temp = *memory;</span><br><span class="line">    *memory = *<span class="keyword">register</span>;</span><br><span class="line">    *<span class="keyword">register</span> = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusin */</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> n = <span class="comment">/* number of process */</span>;</span><br><span class="line"><span class="keyword">int</span> bolt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> keyi = <span class="number">1</span>;</span><br><span class="line">        do exchange(&amp;key1, &amp;bolt) å¦‚æœäº¤æ¢åkey = 1, é‚£ä¹ˆå°±è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¦åˆ™åœ¨ä¸´ç•ŒåŒºå¤–å¿™ç­‰</span><br><span class="line">        <span class="keyword">while</span>(keyi != <span class="number">0</span>);</span><br><span class="line">        <span class="comment">/* critical section */</span></span><br><span class="line">        bolt = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* remainder */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bolt = <span class="number">0</span>;</span><br><span class="line">    parbegin( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>) ......);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºå…±äº«å˜é‡å’Œå±€éƒ¨å˜é‡çš„äº¤æ¢æ–¹å¼ï¼Œä»¥ä¸‹çš„è¡¨è¾¾å¼å§‹ç»ˆæˆç«‹<br>$$<br>bolt + \sum_ikey_{i} = 1<br>$$<br>bolt = 0 æ²¡æœ‰è¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œblot = 1 æœ‰ä¸”åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸´ç•ŒåŒº</p>
<h3 id="äºŒã€ä¿¡å·ç¯-Semaphore"><a href="#äºŒã€ä¿¡å·ç¯-Semaphore" class="headerlink" title="äºŒã€ä¿¡å·ç¯(Semaphore)"></a>äºŒã€ä¿¡å·ç¯(Semaphore)</h3><hr>
<p>ä¿¡å·ç¯æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•´å‹å˜é‡ã€‚å‘ä¿¡å·ç¯ <code>s</code> å‘é€ä¿¡å·ï¼Œè¿›ç¨‹å¯ä»¥è°ƒç”¨ <code>semSignal(s)</code> åŸè¯­ã€‚ä»ä¿¡å·ç¯å¤„æ¥æ”¶ä¿¡å·ï¼Œè¿›ç¨‹å¯ä»¥è°ƒç”¨<code>semWait(s)</code> åŸè¯­ã€‚å¦‚æœè¿›ç¨‹æ‰“ç®—æ¥å—æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¶ˆæ¯å°šæœªåˆ°è¾¾ï¼Œåˆ™è¯¥è¿›ç¨‹å¿…é¡»åœ¨ä¿¡å·ç¯ä¸Šç­‰å¾…ã€‚å› æ­¤å¯¹ä¿¡å·ç¯åšä»¥ä¸‹å®šä¹‰ï¼š</p>
<ol>
<li><strong>ä¿¡å·ç¯åˆå€¼ä¸ºéè´Ÿæ•´æ•°ã€‚</strong></li>
<li><strong>semWait æ“ä½œå°†ä¿¡å·ç¯çš„å€¼å‡1ã€‚å¦‚æœå…¶å€¼ä¸ºè´Ÿæ•°ï¼Œè°ƒç”¨semWaitçš„è¿›ç¨‹æ‰§è¡Œå°†è¢«é˜»å¡ã€‚å¦åˆ™è¿›ç¨‹å°†ç»§ç»­æ‰§è¡Œã€‚</strong></li>
<li><strong>semSignalæ“ä½œå°†ä¿¡å·ç¯çš„å€¼åŠ 1ã€‚å¦‚æœä¹‹åå…¶å€¼å°äºç­‰äº0ï¼Œåˆ™è¿›ç¨‹å”¤é†’åœ¨è¯¥ä¿¡å·ç¯ä¸Šç­‰å¾…çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ç»§ç»­è‡ªå·±çš„æ‰§è¡Œã€‚</strong></li>
</ol>
<p>ï¼ˆé™¤äº†ä»¥ä¸Šçš„3ç§æ“ä½œä»¥å¤–ä¸å…è®¸å¯¹ä¿¡å·ç¯åšå…¶ä»–çš„æ“ä½œï¼‰</p>
<p>ä¿¡å·ç¯çš„å®šä¹‰å’Œæ“ä½œçš„å®šä¹‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    queueType <span class="built_in">queue</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semWait</span><span class="params">(semaphore s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s.count--;</span><br><span class="line">    <span class="keyword">if</span>(count &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span>;</span><br><span class="line">        <span class="comment">/* block this process */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semSignal</span><span class="params">(semaphore s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s.count++;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">/* remove a process P from s.queue */</span>;</span><br><span class="line">        <span class="comment">/* palce process P on ready list */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>01ä¿¡å·ç¯ï¼Œ01ä¿¡å·ç¯åªæœ‰ä¸¤ä¸ªå–å€¼ï¼š0å’Œ1ï¼Œå…¶æ“ä½œåŸè¯­å®šä¹‰å¦‚ä¸‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binary_semaphore</span>&#123;</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;zero, oen&#125; value; åˆå€¼å¯ä»¥å–<span class="number">0</span>æˆ–<span class="number">1</span></span><br><span class="line">    queueType <span class="built_in">queue</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semWaitB</span><span class="params">(binary_semaphore s)</span> <span class="comment">//æ£€æµ‹ä¿¡å·ç¯çš„å–å€¼ï¼Œå¦‚æœå€¼ä¸º0ï¼Œæ‰§è¡ŒsemWaitBæ“ä½œçš„è¿›ç¨‹å°†è¢«é˜»å¡ã€‚å¦‚æœå€¼ä¸º1ï¼Œä¿¡å·ç¯çš„å€¼å°†è¢«ç½®0ï¼Œå¹¶ä¸”è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s.value == one)</span><br><span class="line">        s.value = zero;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span></span><br><span class="line">        <span class="comment">/* block this process */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> semSignalB(semaphore s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(s.<span class="built_in">queue</span> is empty()) <span class="comment">//æ£€æµ‹æ˜¯å¦æœ‰è¿›ç¨‹è¢«é˜»å¡åœ¨ä¿¡å·ç¯ä¸Šï¼Œå¦‚æœæœ‰å°†å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„è¿›ç¨‹ã€‚å¦‚æœæ²¡æœ‰åˆ™å°†ä¿¡å·ç¯çš„å€¼ç½®1ã€‚</span></span><br><span class="line">        s.value = one;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">/* remove a process P from s.queue */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1ã€äº’æ–¥çš„å®ç°"><a href="#1ã€äº’æ–¥çš„å®ç°" class="headerlink" title="1ã€äº’æ–¥çš„å®ç°"></a>1ã€äº’æ–¥çš„å®ç°</h5><p>é‡‡ç”¨ä¿¡å·ç¯å®ç°äº’æ–¥çš„ä¾‹å­</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusion */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n = <span class="comment">/* number of processes */</span>;</span><br><span class="line">semaphore s = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(s); <span class="comment">//è¿›ç¨‹åœ¨è¿›å…¥critical sectionå‰è°ƒç”¨semWait(s)åŸè¯­ï¼Œå¦‚æœs&lt;0,è¿›ç¨‹é˜»å¡ã€‚å¦‚æœs=1, s-1åï¼Œè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºè®¿é—®å…¬å…±èµ„æº</span></span><br><span class="line">        <span class="comment">/* critical section */</span>;</span><br><span class="line">        semSignal(s); <span class="comment">//æœ€å¼€å§‹è¿›å…¥çš„è¿›ç¨‹æ‰§è¡Œå®Œä¸´ç•ŒåŒºåå°†ä¿¡å·ç¯çš„å€¼åŠ 1ï¼Œå¹¶å°†ä¿¡å·ç¯ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„ä¸€ä¸ªç­‰å¾…è¿›ç¨‹å”¤é†’ï¼Œå¹¶ç½®ä¸ºå°±ç»ªæ€</span></span><br><span class="line">        <span class="comment">/* remainder */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>)...... );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸºäºä»¥ä¸Šçš„å®ç°ï¼Œä¿¡å·ç¯çš„å–å€¼ <code>s.count</code> å¯ä»¥è¿™æ ·ç†è§£ï¼š</p>
<ul>
<li>s.count &gt;= 0ï¼šèƒ½å¤Ÿé€šè¿‡è°ƒç”¨semWait(s)åŸè¯­ï¼Œè€Œæ— éœ€é˜»å¡å°±èƒ½è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹ä¸ªæ•°ã€‚ä¿¡å·ç¯çš„è¿™ä¸€ç‰¹æ€§ï¼Œè¿˜èƒ½ç”¨äºå®ç°è¿›ç¨‹åä½œã€‚</li>
<li>s.count &lt; 0ï¼šå…¶ç»å¯¹å€¼å°±æ˜¯åœ¨s.queueä¸Šç­‰å¾…ä¿¡å·ç¯çš„è¿›ç¨‹çš„ä¸ªæ•°ã€‚</li>
</ul>
<h5 id="2ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#2ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="2ã€ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜"></a>2ã€ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜</h5><p>ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…å°†æ•°æ®ä»ç¼“å†²åŒºå–å‡ºï¼Œä¸€æ¬¡å–ä¸€ä¸ªï¼Œä¸å…è®¸ä¸¤è€…å¯¹ç¼“å†²åŒºåŒæ—¶æ“ä½œã€‚</p>
<p>å‡è®¾ç¼“å†²åŒºçš„ç»“æ„æ˜¯ä¸€ä¸ªçº¿æ€§è¡¨ã€‚</p>
<p>é‡‡ç”¨01ä¿¡å·ç¯å’Œæ— çº¿ç¼“å†²æ¥è§£å†³ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„ï¼ˆ<strong>é”™è¯¯</strong>ï¼‰æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program producer&amp;consumer */</span></span><br><span class="line"><span class="keyword">int</span> n; <span class="comment">//è®°å½•ç¼“å†²åŒºä¸­â€œäº§å“â€çš„ä¸ªæ•° n = in - out</span></span><br><span class="line">binary_semaphore s = <span class="number">1</span>, delay = <span class="number">0</span>; <span class="comment">//é‡‡ç”¨delayç”¨äºåœ¨ç¼“å†²åŒºä¸º0çš„æ—¶å€™è¿«ä½¿æ¶ˆè´¹è€…ç­‰å¾…</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWaitB(s); <span class="comment">//ç”Ÿäº§è€…å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å‘ç¼“å†²åŒºæ”¾å…¥ç”Ÿäº§çš„æ•°æ®</span></span><br><span class="line">       	append();</span><br><span class="line">        n++;</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>) semSignalB(delay); <span class="comment">//n = 1, ä¹‹å‰ç¼“å†²åŒºä¸º0ï¼Œå”¤é†’æ¶ˆè´¹è€…</span></span><br><span class="line">        semSignalB(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semWaitB(delay); <span class="comment">//ç­‰å¾…ç¬¬ä¸€ä¸ªå¯ä»¥â€œæ¶ˆè´¹â€çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(B); </span><br><span class="line">        take();</span><br><span class="line">        n--;</span><br><span class="line">        semSignalB(B);</span><br><span class="line">        consume();</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>) semWaitB(delay);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    parbegin(producer, consumer);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é”™è¯¯ç‚¹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">semWait(B); <span class="comment">//æ¶ˆè´¹è€…æ¶ˆè´¹å®Œæ‰€æœ‰çš„æ•°æ®åï¼Œéœ€è¦é‡ç½®delayä¿¡å·ï¼Œåœ¨ç”Ÿäº§è€…æœªäº§ç”Ÿå‡ºæ–°çš„æ•°æ®å‰ç­‰å¾…</span></span><br><span class="line">		   <span class="comment">//å°±æ˜¯ if(n == 0) semWaitB(delay); è¯­å¥çš„ä½œç”¨ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶æ²¡æœ‰æ‰§è¡Œè¯¥è¯­å¥ï¼Œå¯¼è‡´æ¶ˆè´¹è€…æ¶ˆè´¹äº†ä¸å­˜åœ¨çš„æ•°æ®</span></span><br><span class="line">take();</span><br><span class="line">n--;</span><br><span class="line">semSignalB(B);</span><br></pre></td></tr></table></figure>

<p>åŸå› æ˜¯ç”Ÿäº§è€…åœ¨æ¶ˆè´¹è€…å¯¹nå†æ¬¡åˆ¤æ–­ä¹‹å‰å¯¹nè¿›è¡Œäº†åŠ 1æ“ä½œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">n++;</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">1</span>) semSignalB(delay); <span class="comment">//è¯¯ä»¥ä¸ºæ˜¯æ”¾å…¥çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œå…¶å®æ˜¯å‰©ä½™çš„æœ€åä¸€ä¸ªæ•°æ® </span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡è°ƒç”¨äº†semSignal(delay)å‘delayä¿¡å·ç¯å‘é€äº†ä¿¡å·ï¼Œè€Œåœ¨è¿™ä¹‹å‰æ²¡æœ‰ä¸ä¹‹é…å¯¹çš„semWait(delay)è°ƒç”¨ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ­£ç¡®æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program producer&amp;consumer */</span></span><br><span class="line"><span class="keyword">int</span> n; </span><br><span class="line">binary_semaphore s = <span class="number">1</span>, delay = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWaitB(s); </span><br><span class="line">       	append(); </span><br><span class="line">        n++; </span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>) semSignalB(delay); </span><br><span class="line">        semSignalB(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m; <span class="comment">/* a local variable */</span></span><br><span class="line">    semWaitB(delay); </span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(B); </span><br><span class="line">        take(); </span><br><span class="line">        n--; </span><br><span class="line">        m = n;</span><br><span class="line">        semSignalB(B);</span><br><span class="line">        consume();</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>) semWaitB(delay);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    parbegin(producer, consumer);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡‡ç”¨<code>ä¿¡å·ç¯å’Œæ— çº¿ç¼“å†²</code>æ¥è§£å†³ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program producer&amp;consumer */</span></span><br><span class="line">semphore n = <span class="number">0</span>, s = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWait(s);</span><br><span class="line">        append();</span><br><span class="line">        semSignal(s); <span class="comment">//ç”Ÿäº§è€…çš„semSignal(s)å’ŒsemSignal(n)å¯¹æ¢ï¼Œå°†å¯¼è‡´ç”Ÿäº§è€…åœ¨ä¸´ç•ŒåŒºå†…å¯¹nä¿¡å·ç¯è¿›è¡ŒsemSignalæ“ä½œï¼Œä¸ä¼šæœ‰ä¸å¥½çš„å½±å“</span></span><br><span class="line">        semSignal(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            semWait(n);</span><br><span class="line">            semWait(s); <span class="comment">//å¦‚æœå°†semWait(s)ä¸semWait(n)å¯¹æ¢çš„è¯ï¼Œå¦‚æœnä¸º0ï¼Œç¼“å†²åŒºä¸ºç©ºé‚£ä¹ˆä¼šé˜»å¡åœ¨ä¿¡å·ç¯nä¸Šï¼ŒåŒæ—¶ç”Ÿäº§è€…çš„æ‰§è¡Œä¹Ÿè¢«é˜»å¡ï¼Œå¯¼è‡´æ­»é”ã€‚</span></span><br><span class="line">            take();</span><br><span class="line">            semSignal(s);</span><br><span class="line">            consume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin (producer, consumer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åè€ƒè™‘å®é™…æƒ…å†µï¼Œå½“ç¼“å†²åŒºæœ‰é™çš„æ—¶å€™ï¼Œå°†ç¼“å†²åŒºè®¾ç½®ä¸ºä¸€ä¸ªç¯å½¢çš„ç»“æ„ï¼ŒæŒ‡é’ˆçš„å€¼ä¸ºå¯¹ç¼“å†²åŒºå¤§å°å–æ¨¡çš„å€¼ï¼Œå¹¶ä¸”è€ƒè™‘ä»¥ä¸‹çš„é˜»å¡å”¤é†’å…³ç³»</p>
<table>
<thead>
<tr>
<th align="center">é˜»å¡æ—¶æœº</th>
<th align="center">å”¤é†’æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç”Ÿäº§è€…ï¼šå¾€æ»¡çš„ç¼“å†²åŒºä¸­æ”¾æ•°æ®</td>
<td align="center">æ¶ˆè´¹è€…ï¼šæ•°æ®è¢«æ”¾å…¥</td>
</tr>
<tr>
<td align="center">æ¶ˆè´¹è€…ï¼šä»ç©ºçš„ç¼“å†²åŒºä¸­åŒºæ•°æ®</td>
<td align="center">ç”Ÿäº§è€…ï¼šæ•°æ®è¢«å–å‡º</td>
</tr>
</tbody></table>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program boundedBuffer */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> sizeofbuffer = <span class="comment">/* buffer size */</span>;</span><br><span class="line">semaphore s = <span class="number">1</span>, n = <span class="number">0</span>, e = sizeofbuffer; <span class="comment">//ç”¨ä¿¡å·ç¯eæ¥ä»£è¡¨ç¼“å†²åŒºçš„å¤§å°</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWait(e);</span><br><span class="line">        semWait(s);</span><br><span class="line">        append();</span><br><span class="line">        semSignal(s);</span><br><span class="line">        semSignal(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(n);</span><br><span class="line">        semWait(s);</span><br><span class="line">        take();</span><br><span class="line">        semSignal(s);</span><br><span class="line">        semSignal(e);</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin( producer, consumer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3ã€ä¿¡å·ç¯çš„å®ç°"><a href="#3ã€ä¿¡å·ç¯çš„å®ç°" class="headerlink" title="3ã€ä¿¡å·ç¯çš„å®ç°"></a>3ã€ä¿¡å·ç¯çš„å®ç°</h5><p>æ¯”è¾ƒå’Œæ›¿æ¢æŒ‡ä»¤å®ç°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">semWait(s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(compare_and_swap(s.flag, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">    	<span class="comment">/* do nothing */</span>;</span><br><span class="line">    s.count--;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span>;</span><br><span class="line">        <span class="comment">/* block this process(must also set s.flag to 0) */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s.flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">semSignal(s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(compare_and_swap(s.flag, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">        <span class="comment">/* do nothing */</span>;</span><br><span class="line">    s.count++;</span><br><span class="line">   	<span class="keyword">if</span>(s.count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* remove a process in form s.queue */</span>;</span><br><span class="line">        <span class="comment">/* place a process P on ready list */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s.flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸­æ–­å®ç°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">semWait(s)</span><br><span class="line">&#123;</span><br><span class="line">    inhibit interrupts;</span><br><span class="line">    s.count--;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span>;</span><br><span class="line">        <span class="comment">/* block this process and allow interrupts */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        allow interrupts;</span><br><span class="line">&#125;</span><br><span class="line">semSignal(s)</span><br><span class="line">&#123;</span><br><span class="line">    inhibit interrupts;</span><br><span class="line">    s.count++;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* remove a process P from s.queue */</span>;</span><br><span class="line">        <span class="comment">/* place process P on ready list */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    allow interrupts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ä¸‰ã€ç®¡ç¨‹-Monitor"><a href="#ä¸‰ã€ç®¡ç¨‹-Monitor" class="headerlink" title="ä¸‰ã€ç®¡ç¨‹(Monitor)"></a>ä¸‰ã€ç®¡ç¨‹(Monitor)</h3><hr>
<p>é‡‡ç”¨ä¿¡å·ç¯çš„æ–¹å¼å®ç°æ­£ç¡®çš„ç¨‹åºå¹¶ä¸å®¹æ˜“ï¼Œå› ä¸ºsemWaitå’ŒsemSignalæ“ä½œåˆ†å¸ƒäºæ“ä½œç³»ç»Ÿçš„å„ä¸ªåœ°æ–¹ï¼Œä»è€Œå¾ˆéš¾çœ‹åˆ°è¿™äº›ä¿¡å·ç¯æ“ä½œçš„æ•´ä½“æ•ˆæœæ‰€å¯¼è‡´çš„ã€‚</p>
<p><code>ç®¡ç¨‹</code> çš„æå‡ºå°±æ˜¯å¸Œæœ›è®¾è®¡ä¸€ç§ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå®ƒèƒ½å¤Ÿæä¾›å’Œä¿¡å·ç¯ç›¸åŒçš„åŠŸèƒ½ä¸”æ˜“äºæ§åˆ¶ã€‚</p>
<h5 id="1ã€ç®¡ç¨‹å’Œä¿¡å·"><a href="#1ã€ç®¡ç¨‹å’Œä¿¡å·" class="headerlink" title="1ã€ç®¡ç¨‹å’Œä¿¡å·"></a>1ã€ç®¡ç¨‹å’Œä¿¡å·</h5><p>ç®¡ç¨‹å¯ä»¥çœ‹ä½œæ˜¯åŒ…å«äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‡½æ•°ï¼Œä¸€ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œä»¥åŠæœ¬åœ°æ•°æ®çš„è½¯ä»¶æ¨¡å—ã€‚ä¸»è¦ç‰¹å¾å¦‚ä¸‹</p>
<ul>
<li>æœ¬åœ°æ•°æ®åªèƒ½å¤Ÿè¢«ç®¡ç¨‹çš„å†…éƒ¨å‡½æ•°æ‰€è®¿é—®ï¼Œå¤–éƒ¨å‡½æ•°æ— æ³• è®¿é—®å…¶æœ¬åœ°</li>
<li>è¿›ç¨‹åªèƒ½é€šè¿‡è°ƒç”¨ç®¡ç¨‹è‡ªå·±å®šä¹‰çš„å‡½æ•°æ¥è¿›å…¥ç®¡ç¨‹</li>
<li>åœ¨ç®¡ç¨‹å†…æ‰§è¡Œçš„è¿›ç¨‹ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªï¼›å½“ç®¡ç¨‹è¢«å ç”¨ï¼Œå…¶ä»–è¯•å›¾è¿›å…¥çš„è¿›ç¨‹å°†è¢«é˜»å¡ï¼Œç­‰å¾…ç®¡ç¨‹é‡æ–°å¯ç”¨åæ‰èƒ½è¿›å…¥ã€‚</li>
</ul>
<p>ç®¡ç¨‹å®šä¹‰äº†ä¸€ä¸ªåŒæ­¥å·¥å…·ç”¨æ¥æ›´å¥½åœ°æ”¯æŒå¹¶å‘å¤„ç†ã€‚å½“æŸä¸€ä¸ªè¿›å…¥ç®¡ç¨‹çš„è¿›ç¨‹å› ä¸ºä¸æ»¡è¶³æŸä¸ªæ‰§è¡Œæ¡ä»¶è€Œå¿…é¡»è¢«é˜»å¡çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¾¿éœ€è¦æŸç§æœºåˆ¶(åŒæ­¥å·¥å…·)ä½¿å¾—è¯¥è¿›ç¨‹åœ¨è¢«é˜»å¡åé‡Šæ”¾ç®¡ç¨‹ï¼Œä¹‹ååœ¨å…¶æ»¡è¶³è¿è¡Œæ¡ä»¶åï¼Œè¯¥è¿›ç¨‹èƒ½å¤Ÿé‡æ–°å›åˆ°ç®¡ç¨‹ä¸­ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ç®¡ç¨‹é‡‡ç”¨äº† <code>æ¡ä»¶å˜é‡(Condition Variables)</code> æ–¹æ³•æ¥å®ç°è¿™ç§åŒæ­¥å·¥å…·ï¼Œå¹¶ä¸”åªèƒ½ç”¨ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°æ¥è®¿é—®ã€‚</p>
<ul>
<li>cwait(c)ï¼šå°†è°ƒç”¨è¯¥å‡½æ•°è®¿é—®æ¡ä»¶å˜é‡cçš„è¿›ç¨‹é˜»å¡ï¼Œå¹¶ä¸”é‡Šæ”¾ç®¡ç¨‹ç»™å…¶ä»–çš„è¿›ç¨‹ä½¿ç”¨ã€‚</li>
<li>csignal(c)ï¼šç»§ç»­æ‰§è¡Œä¹‹å‰å› ä¸ºè°ƒç”¨cwaitå‡½æ•°è®¿é—®æ¡ä»¶å˜é‡cè€Œé˜»å¡çš„è¿›ç¨‹ã€‚å¦‚æœè¿™ç±»è¿›ç¨‹æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆé€‰æ‹©å…¶ä¸­ä¹‹ä¸€ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œã€‚</li>
</ul>
<p>é‡‡ç”¨ç®¡ç¨‹æ¥è§£å†³æœ‰é™ç¼“å†²åŒºç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program production&amp;consumer */</span></span><br><span class="line">monitor bunderbuffer;</span><br><span class="line"><span class="keyword">char</span> buffer [N];</span><br><span class="line"><span class="keyword">int</span> nextin, next out;</span><br><span class="line"><span class="keyword">int</span> count;</span><br><span class="line">cond notfull, notempty;</span><br><span class="line"><span class="comment">//notfull: ç¼“å†²åŒºæœ‰å‰©ä½™ç©ºé—´æ—¶ä¸ºçœŸ notemptyï¼šç¼“å†²åŒºä¸­æœ‰æœ‰æ•ˆè®¡ç®—ç»“æœæ—¶ä¸ºçœŸ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">append</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(count == N) cwait(notfull); <span class="comment">// bufferæ»¡äº†ï¼Œè¦é¿å…overflow</span></span><br><span class="line">    buffer[nextin] = x;</span><br><span class="line">    nextin = (nextin + <span class="number">1</span>) % N;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="comment">/* one more item in buffer */</span></span><br><span class="line">    csignal(notempty); <span class="comment">// resume any waiting consumer</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">take</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(count == <span class="number">0</span>) cwait(notempty); <span class="comment">//bufferç©ºï¼Œé¿å…underflow</span></span><br><span class="line">    x = buffer[nextout];</span><br><span class="line">    nextout = (nextout + <span class="number">1</span>) % N;</span><br><span class="line">    count--;</span><br><span class="line">    csignal(notfull); <span class="comment">//resume any waiting producer</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    nextin = <span class="number">0</span>; nextout = <span class="number">0</span>; count = <span class="number">0</span>; <span class="comment">//buffer åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce(x);</span><br><span class="line">        append(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        take(x);</span><br><span class="line">        consume(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin( producer, consumer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®¡ç¨‹çš„çœŸæ­£ä¼˜åŠ¿å°±åœ¨äºå®ƒæ‰€æœ‰çš„æ“ä½œéƒ½è¢«é™åˆ¶åœ¨ç®¡ç¨‹å†…éƒ¨ï¼Œè¿™æ ·å°±æ›´å®¹æ˜“æ£€æŸ¥è®¾è®¡æ˜¯å¦æ­£ç¡®ã€‚</p>
<h5 id="2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹"><a href="#2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹" class="headerlink" title="2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹"></a>2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹</h5><p>åœ¨ <code>Mesa</code> è¯­è¨€ä¸­ï¼ŒcsignalåŸè¯­è¢«cnotifyåŸè¯­æ›¿ä»£ï¼Œå½“ç®¡ç¨‹è°ƒç”¨äº†cnotify(x)åŸè¯­åï¼Œå®ƒå°†å¯¼è‡´æ¡ä»¶å˜é‡xçš„ç­‰å¾…é˜Ÿåˆ—æ”¶åˆ°é€šçŸ¥ï¼Œä¸”è°ƒç”¨cnotify(x)åŸè¯­çš„è¿›ç¨‹å°†ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ç”¨whileè¯­å¥æ›¿æ¢ifè¯­å¥ï¼Œè¿™æ ·å°±ä¿è¯äº†æ¡ä»¶å˜é‡çš„é‡æ–°æ£€æµ‹ã€‚åŒæ—¶é¿å…äº†è¿›ç¨‹çš„é¢å¤–åˆ‡æ¢</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">append</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(count == N) cwait(notfull); <span class="comment">/* buffer is full avoid overflow */</span></span><br><span class="line">    buffer[nextin] = x;</span><br><span class="line">    nextin = &#123;nextin + <span class="number">1</span>&#125; % N;</span><br><span class="line">    count++;</span><br><span class="line">    cnotify(notempty); <span class="comment">/* notify any waiting consumer */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">take</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(count == <span class="number">0</span>) cwait(notempty); <span class="comment">/* buffer is empty; avoid underflow */</span></span><br><span class="line">    x = buffer[nextout];</span><br><span class="line">    nextout = (nextout + <span class="number">1</span>) % N; <span class="comment">/* one fewer item in buffer */</span></span><br><span class="line">    cnotify[notfull]; <span class="comment">/* notify ant waiting producer */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å››ã€æ¶ˆæ¯é€šä¿¡"><a href="#å››ã€æ¶ˆæ¯é€šä¿¡" class="headerlink" title="å››ã€æ¶ˆæ¯é€šä¿¡"></a>å››ã€æ¶ˆæ¯é€šä¿¡</h3><hr>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿›ç¨‹çš„äº¤äº’å’Œåä½œéœ€è¦ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ï¼šåŒæ­¥å’Œé€šä¿¡ã€‚åŒæ­¥ç”¨äºè¿›ç¨‹çš„äº’æ–¥ï¼Œé€šä¿¡åˆ™ç”¨äºè¿›ç¨‹é—´çš„åä½œã€‚ <code> æ¶ˆæ¯é€šä¿¡</code> å°±èƒ½æä¾›è¿™ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ï¼Œè€Œä¸”åº”ç”¨èŒƒå›´å¾ˆå¹¿ã€‚ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯¹æ¶ˆæ¯é€šä¿¡çš„å®ç°çš„ç»†èŠ‚ä¸Šæœ‰æ‰€å‡ºå…¥ã€‚ä»¥ä¸‹å†…å®¹è®¨è®ºå…¶å®ç°çš„å…±æ€§çš„éƒ¨åˆ†ã€‚</p>
<p>æ¶ˆæ¯é€šä¿¡çš„åŸºæœ¬å½¢å¼ä¸ºä»¥ä¸‹ä¸¤ä¸ªåŸè¯­ï¼š</p>
<ul>
<li>send(destination, message)</li>
<li>receive(source, message)</li>
</ul>
<p>é‡‡ç”¨sendåŸè¯­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å°†æ¶ˆæ¯å‘é€ç»™å¦ä¸€ä¸ªè¿›ç¨‹(destination)ï¼›é‡‡ç”¨receiveåŸè¯­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ¥æ”¶æ¥è‡ªæ¶ˆæ¯æºçš„æ¶ˆæ¯ã€‚</p>
<h5 id="1ã€åŒæ­¥"><a href="#1ã€åŒæ­¥" class="headerlink" title="1ã€åŒæ­¥"></a>1ã€åŒæ­¥</h5><p>æ— è®ºæ¶ˆæ¯å‘é€è¿˜æ˜¯æ¶ˆæ¯æ¥å—éƒ½æœ‰é˜»å¡å’Œéé˜»å¡ä¸¤ç§å¯èƒ½ã€‚åœ¨å…·ä½“çš„ç³»ç»Ÿè®¾è®¡ä¸­æœ‰ä»¥ä¸‹3ä¸­ç»„åˆã€‚</p>
<ul>
<li><p>å‘é€ç«¯é˜»å¡ï¼Œæ¥æ”¶ç«¯é˜»å¡</p>
<p>ä¸¤ç«¯éƒ½é˜»å¡ï¼Œæ¶ˆæ¯è¢«æ¥æ”¶åå†å°†ä¸¤ç«¯å”¤é†’ã€‚è¿™ä¸€ç»„åˆåˆè¢«ç§°ä¸ºäº¤æ±‡ç‚¹(rendzvous)æ–¹æ¡ˆï¼Œå¸¸è¢«ç”¨äºè¦æ±‚è¿›ç¨‹å¼ºè¡ŒåŒæ­¥é€šä¿¡çš„åœºåˆ</p>
</li>
<li><p>å‘é€ç«¯ä¸é˜»å¡ï¼Œæ¥æ”¶ç«¯é˜»å¡</p>
<p>å‘é€ç«¯åœ¨å‘é€å®Œæ¶ˆæ¯åç»§ç»­æ‰§è¡Œï¼Œè€Œæ¥æ”¶ç«¯å¿…é¡»é˜»å¡ï¼Œç›´åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯åæ‰è¢«å”¤é†’ã€‚è¿™ä¸€æ–¹æ¡ˆæ˜¯æ˜¯è¢«æœ€å¹¿æ³›åº”ç”¨çš„ï¼Œèƒ½å¤Ÿæœ€å¿«çš„å°†æ¶ˆæ¯å‘é€ç»™å¤šä¸ªç›®çš„è¿›ç¨‹ï¼Œè€Œæ¥æ”¶ç«¯å¿…é¡»ç­‰å¾…æ¶ˆæ¯åˆ°è¾¾åæ‰èƒ½åšæœ‰ç”¨çš„å·¥ä½œã€‚</p>
</li>
<li><p>å‘é€ç«¯ä¸é˜»å¡ï¼Œæ¥æ”¶ç«¯é˜»å¡</p>
</li>
</ul>
<h5 id="2ã€äº’æ–¥çš„å®ç°"><a href="#2ã€äº’æ–¥çš„å®ç°" class="headerlink" title="2ã€äº’æ–¥çš„å®ç°"></a>2ã€äº’æ–¥çš„å®ç°</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusion */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n = <span class="comment">/* number of process */</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message msg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        receive(box, msg); <span class="comment">// ä»»ä½•å¸Œæœ›è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹éƒ½å¿…é¡»å…ˆè·å¾—ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¦‚æœé‚®ç®±ä¸ºç©º</span></span><br><span class="line">        <span class="comment">/* critical section */</span>;</span><br><span class="line">        send(box, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">create <span class="title">mailbox</span><span class="params">(box)</span></span>; <span class="comment">//åˆå§‹åŒ–é˜¶æ®µï¼Œé‚®ç®±ä¸­åªå­˜æ”¾äº†ä¸€ä¸ªå†…å®¹ä¸ºnullçš„æ¶ˆæ¯</span></span><br><span class="line">    send(box, null);</span><br><span class="line">    parbegin( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>)...... );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå¹¶å‘åœ°è°ƒç”¨æ¶ˆæ¯æ¥æ”¶åŸè¯­ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ï¼š</p>
<ul>
<li>å¦‚æœé‚®ç®±ä¸­æœ‰ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯å°†è¢«ä¸€ä¸ªè¿›ç¨‹æ¥æ”¶ï¼Œè€Œå…¶ä»–çš„è¿›ç¨‹éƒ½å°†é˜»å¡</li>
<li>å¦‚æœé‚®ç®±ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½å°†è¢«é˜»å¡ã€‚è€Œå½“ä¹‹åæœ‰ä¸€ä¸ªæ¶ˆæ¯ä¼ å…¥é‚®ç®±åï¼Œåªæœ‰ä¸€ä¸ªç­‰å¾…æ€çš„è¿›ç¨‹è¢«å”¤é†’ï¼Œå¹¶è·å¾—è¯¥æ¶ˆæ¯</li>
</ul>
<p>é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³æœ‰é™ç¼“å†²çš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span></span><br><span class="line">    capacity = <span class="comment">/* buffering capacity */</span>;</span><br><span class="line">	null = <span class="comment">/* empty message */</span>;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    message pmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        receive(mayproduce, pmsg); <span class="comment">//ç”Ÿäº§è€…æ¥æ”¶åˆ°ç”Ÿäº§çš„æ¶ˆæ¯</span></span><br><span class="line">        pmsg = produce(); <span class="comment">//pmsg è¡¨ç¤ºç”Ÿäº§å®Œæˆ,ç­‰åŒäºå®Œæˆä¸´ç•ŒåŒº</span></span><br><span class="line">        send(mayconsume, pmsg);  <span class="comment">//å‘æ¶ˆè´¹è€…å‘é€å‘æ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message cmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        receive(mayproduce, cmsg); <span class="comment">//ä»mayproduceæ¥æ”¶åˆ°æœ‰æ•°æ®çš„æ¶ˆæ¯cmsg</span></span><br><span class="line">        consume(cmsg); <span class="comment">//è¿›å…¥æ¶ˆè´¹çš„ä¸´ç•ŒåŒº</span></span><br><span class="line">        send(mayproduce, null); <span class="comment">//æ¶ˆè´¹å®Œæˆï¼Œå‘mayproduceå‘é€ç©ºæ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    create_mailbox(mayproduce); <span class="comment">//è¯¥æ–¹æ¡ˆè®¾è®¡äº†ä¸¤ä¸ªé‚®ç®±</span></span><br><span class="line">    create_mailbox(mayconsume);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; capacity; i++)	send(mayproduce, null);</span><br><span class="line">    parbegin( producer, consumer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ¡ˆéå¸¸çµæ´»ï¼Œå¯ä»¥å®¹çº³å¤šä¸ªç”Ÿäº§è€…ä»¥åŠå¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶å·¥ä½œã€‚å¦å¤–ï¼Œè¯¥æ–¹æ¡ˆä¹Ÿå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°æœ‰é™ç¼“å†²çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œå…¶ä¸­ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ä»¥åŠä¸¤ä¸ªé‚®ç®±éƒ½å¯ä»¥æ”¾ç½®åœ¨ä¸åŒçš„æœºå™¨ä¸Šé¢ã€‚</p>
<h3 id="äº”ã€è¯»è€…-å†™è€…é—®é¢˜"><a href="#äº”ã€è¯»è€…-å†™è€…é—®é¢˜" class="headerlink" title="äº”ã€è¯»è€…/å†™è€…é—®é¢˜"></a>äº”ã€è¯»è€…/å†™è€…é—®é¢˜</h3><hr>
<p>è¯»è€…/å†™è€…é—®é¢˜æ˜¯å¦ä¸€ä¸ªç»å…¸çš„åŒæ­¥å’Œå¹¶å‘é—®é¢˜ï¼Œæè¿°å¦‚ä¸‹ï¼š</p>
<p>æœ‰ä¸€å—å…±äº«çš„æ•°æ®åŒºåŸŸ(è¯¥åŒºåŸŸå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€å—å†…å­˜æˆ–å¤„ç†å™¨ä¸­çš„ä¸€ç»„å¯„å­˜å™¨)ï¼Œæœ‰ä¸€ç»„è¿›ç¨‹(è¯»è€…)ï¼Œå®ƒä»¬å¯¹è¯¥å…±äº«æ•°æ®åŒºçš„è®¿é—®éƒ½æ˜¯åªè¯»çš„ï¼Œå¦å¤–è¿˜æœ‰ä¸€ç»„è¿›ç¨‹(å†™è€…)ï¼Œå®ƒä»¬å¯¹è¯¥å…±äº«æ•°æ®çš„è®¿é—®åªæ˜¯åªå†™ã€‚è®¿é—®è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯ä»¥æœ‰ä»»æ„å¤šä¸ªè¯»è€…åŒæ—¶è¯»å–æ•°æ®åŒºçš„å†…å®¹ï¼›</li>
<li>ä¸€æ¬¡åªæœ‰ä¸€ä¸ªå†™è€…å…è®¸å‘æ•°æ®åŒºä¸­å†™ï¼›</li>
<li>å†™è€…åœ¨å‘æ•°æ®åŒºä¸­å†™æ—¶ï¼Œä¸å…è®¸è¯»è€…åŒæ—¶è¯»å–ï¼›</li>
</ol>
<p>è¯»è€…å¯¹å…±äº«æ•°æ®åŒºçš„è®¿é—®ä¸æ˜¯ç‹¬å çš„ï¼Œä½†å†™è€…å¯¹å…±äº«æ•°æ®åŒºçš„è®¿é—®æ˜¯ç‹¬å çš„ï¼Œæ— è®ºè¯»è€…æˆ–è€…å†™è€…éƒ½ä¸å…è®¸åŒæ—¶è®¿é—®è¯¥å…±äº«æ•°æ®åŒºã€‚</p>
<h5 id="1ã€è¯»è€…ä¼˜å…ˆ"><a href="#1ã€è¯»è€…ä¼˜å…ˆ" class="headerlink" title="1ã€è¯»è€…ä¼˜å…ˆ"></a>1ã€è¯»è€…ä¼˜å…ˆ</h5><p>é‡‡ç”¨ä¿¡å·ç¯è§£å†³è¯»è€…/å†™è€…é—®é¢˜çš„æ–¹æ¡ˆï¼šè¯»è€…ä¼˜å…ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program readers&amp;writers */</span></span><br><span class="line"><span class="keyword">int</span> readcount;</span><br><span class="line">semaphore x = <span class="number">1</span>, wsem = <span class="number">1</span>; <span class="comment">//ä¿¡å·ç¯wsemç”¨äºäº’æ–¥è®¿é—®ã€‚å½“æœ‰å†™è€…åœ¨è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œä¸å…è®¸è¯»è€…æˆ–è€…å†™è€…åŒæ—¶è®¿é—®å…±äº«æ•°æ®ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(x);</span><br><span class="line">        readcount++;</span><br><span class="line">        <span class="keyword">if</span>(readcount == <span class="number">1</span>) <span class="comment">//ä¸ºäº†ä½¿å¤šä¸ªè¯»è€…èƒ½å¤ŸåŒæ—¶è®¿é—®å…±äº«æ•°æ®è€Œä¸”ä¸ä¼šäºå†™è€…å†²çªï¼Œè¯¥æ–¹æ¡ˆè¦æ±‚ç¬¬ä¸€ä¸ªè¯»è€…å¿…é¡»ç­‰å¾…wsem</span></span><br><span class="line">   	    	semWait(wsem); <span class="comment">//ä¿¡å·ç¯ï¼Œä½†æ˜¯åç»­åˆ°è¾¾çš„è¯»è€…å¯ä»¥ä¸ç”¨ç­‰å¾…åˆ°è¾¾çš„ä¿¡å·ç¯å°±ç›´æ¥è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">        semSignal(x);</span><br><span class="line">        READUNIT();</span><br><span class="line">        semWait(x);</span><br><span class="line">        readcount--;</span><br><span class="line">        <span class="keyword">if</span>(readcount == <span class="number">0</span>)</span><br><span class="line">            semSignal(wsem);</span><br><span class="line">        semSignal(x); <span class="comment">// ä¿¡å·ç¯xç”¨äºä¿è¯å¯¹readcountçš„æ›´æ–°æ“ä½œçš„æ­£ç¡®æ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(wsem);</span><br><span class="line">        WRITEUNIT();</span><br><span class="line">        semSignal(wsem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    readcount = <span class="number">0</span>;</span><br><span class="line">    parbegin( reader, writer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ¡ˆçš„æœ€å¤§é—®é¢˜æ˜¯å¦‚æœè¯»è€…è¿‡å¤šçš„è¯ä¼šé€ æˆå†™è€…çš„é¥¥é¥¿é—®é¢˜ã€‚</p>
<p>é‡‡ç”¨å†™è€…ä¼˜å…ˆæ–¹æ¡ˆå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<h5 id="2ã€å†™è€…ä¼˜å…ˆ"><a href="#2ã€å†™è€…ä¼˜å…ˆ" class="headerlink" title="2ã€å†™è€…ä¼˜å…ˆ"></a>2ã€å†™è€…ä¼˜å…ˆ</h5><ul>
<li>åªè¦å†™è€…ç”³è¯·è®¿é—®æ•°æ®åŒºæ—¶ï¼Œé˜»æ­¢æ‰€æœ‰è¯»è€…å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼›</li>
<li>å…¨å±€å˜é‡writecountï¼Œç”¨äºæ§åˆ¶å¯¹rsemçš„è®¾ç½®</li>
<li>ä¿¡å·ç¯yï¼Œç”¨äºæ§åˆ¶å¯¹writecountçš„æ›´æ–°</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> readcount, writecount, semphore x = <span class="number">1</span>, y = <span class="number">1</span>, z = <span class="number">1</span>, wsem = <span class="number">1</span>, rsem = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(z);</span><br><span class="line">        	semWait(rsem); <span class="comment">// å†™è€…å¯¹rsemè¿›è¡Œäº†è®¾ç½®ï¼Œä¸€ä¸ªè¯»è€…åœ¨rsemä¸Šç­‰å¾…ï¼Œå…¶ä»–è¯»è€…å…¨åœ¨zä¸Šç­‰å¾…</span></span><br><span class="line">        		semWait(x);</span><br><span class="line">        			readcount++;</span><br><span class="line">        			<span class="keyword">if</span>(readcount == <span class="number">1</span>) <span class="comment">//æ–°çš„æ–¹æ¡ˆåªå…è®¸ä¸€ä¸ªè¯»è€…åœ¨rsemä¸Šç­‰å¾…ï¼Œåç»­åˆ°è¾¾çš„è¯»è€…å¿…é¡»åœ¨zä¸Šç­‰å¾…</span></span><br><span class="line">                 		semWait(wsem); </span><br><span class="line">        		semSignal(x);</span><br><span class="line">        	semSignal(rsem);</span><br><span class="line">        semSignal(z);</span><br><span class="line">        READUNIT();</span><br><span class="line">        semWait(x);</span><br><span class="line">        	readcount--;</span><br><span class="line">        	<span class="keyword">if</span>(readcount == <span class="number">0</span>) semSignal(wsem);</span><br><span class="line">        semSignal(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(y);</span><br><span class="line">        	writecount++;</span><br><span class="line">        	<span class="keyword">if</span>(writecount == <span class="number">1</span>) </span><br><span class="line">                semWait(rsem);</span><br><span class="line">        semSignal(y);</span><br><span class="line">        semWait(wsem); <span class="comment">// å†™è€…å…¨åœ¨wsemä¸Šæ’é˜Ÿ</span></span><br><span class="line">        WRITEUNIT();</span><br><span class="line">        semSignal(wsem);</span><br><span class="line">        semWait(y);</span><br><span class="line">        	writecount--;</span><br><span class="line">        	<span class="keyword">if</span>(writecount == <span class="number">0</span>)		semSignal (rsem); <span class="comment">//</span></span><br><span class="line">        semSignal(y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    readcount = writecount = <span class="number">0</span>;</span><br><span class="line">    parbegin( reader, writer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ç¤ºæ–¹æ¡ˆä¸­è¿›ç¨‹é˜Ÿåˆ—æƒ…å†µ</p>
<table>
<thead>
<tr>
<th align="center">è¯»å†™è€…æƒ…å†µ</th>
<th align="center">ä¿¡å·ç¯è®¾ç½®ä»¥åŠæ’é˜Ÿæƒ…å†µ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç³»ç»Ÿä¸­åªæœ‰è¯»è€…</td>
<td align="center">1ã€wsemè®¾ç½®  2ã€æ— æ’é˜Ÿ</td>
</tr>
<tr>
<td align="center">ç³»ç»Ÿä¸­åªæœ‰å†™è€…</td>
<td align="center">1ã€wsemå’Œrsemè®¾ç½®  2ã€å†™è€…åœ¨wsemä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center">æœ‰è¯»è€…å’Œå†™è€…ï¼Œè¯»è€…åœ¨å‰</td>
<td align="center">1ã€wsemè¢«è¯»è€…è®¾ç½®  2ã€rsemè¢«å†™è€…è®¾ç½®  3ã€æ‰€æœ‰å†™è€…åœ¨wsemä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">4ã€ä¸€ä¸ªè¯»è€…åœ¨resmä¸Šæ’é˜Ÿ  5ã€å…¶ä»–è¯»è€…åœ¨zä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center">æœ‰è¯»è€…å’Œå†™è€…ï¼Œå†™è€…åœ¨å‰</td>
<td align="center">1ã€wsemè¢«å†™è€…è®¾ç½®  2ã€rsemè¢«å†™è€…è®¾ç½®  3ã€å†™è€…åœ¨wsemä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">4ã€ä¸€ä¸ªè¯»è€…åœ¨rsemä¸Šæ’é˜Ÿ  5ã€å…¶ä»–è¯»è€…åœ¨zä¸Šæ’é˜Ÿ</td>
</tr>
</tbody></table>
<h5 id="3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…-å†™è€…é—®é¢˜-å†™è€…ä¼˜å…ˆ"><a href="#3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…-å†™è€…é—®é¢˜-å†™è€…ä¼˜å…ˆ" class="headerlink" title="3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…/å†™è€…é—®é¢˜(å†™è€…ä¼˜å…ˆ)"></a>3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…/å†™è€…é—®é¢˜(å†™è€…ä¼˜å…ˆ)</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message rmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send(readrequest, rmsg);</span><br><span class="line">        receive(mbox[i], rmsg);</span><br><span class="line">        READUNIT();</span><br><span class="line">        send(finished, rmsg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">(<span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message rmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send(writerequest, rmsg);</span><br><span class="line">        receive(mbox[j], rmsg);</span><br><span class="line">        WRITEUNIT();</span><br><span class="line">        rmsg = j;</span><br><span class="line">        send(finished, rmsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">controller</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(count &gt; <span class="number">0</span>) <span class="comment">// count&gt;0ï¼Œè¯´æ˜æ²¡æœ‰å†™è€…åœ¨ç­‰å¾…ï¼Œä¸”æœ‰è¯»è€…åœ¨ä¸´ç•ŒåŒºã€‚æ­¤æ—¶å…ˆå¤„ç†finishæ¶ˆæ¯ï¼Œç„¶åæ˜¯å†™è¯·æ±‚ï¼Œæœ€åæ˜¯è¯»è€…è¯·æ±‚</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!empty(finshed))</span><br><span class="line">            &#123;</span><br><span class="line">                recevie(finished, msg);</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!empty(writerequest))</span><br><span class="line">            &#123;</span><br><span class="line">                receive(writerequest, msg);</span><br><span class="line">                write_id = msg.id;</span><br><span class="line">                count = count - <span class="number">100</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!empty(readrequest))</span><br><span class="line">            &#123;</span><br><span class="line">                receive(readrequest, msg);</span><br><span class="line">                count--;</span><br><span class="line">                send(msg.id, <span class="string">&quot;OK&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="number">0</span>) <span class="comment">//count=0ï¼Œè¯´æ˜æ”¶åˆ°äº†å†™è€…çš„è¯·æ±‚ï¼Œå…è®¸å†™è€…è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¹¶ä¸”ç­‰å¾…â€œfinishâ€æ¶ˆæ¯</span></span><br><span class="line">        &#123;</span><br><span class="line">            send (write_id, <span class="string">&quot;OK&quot;</span>);</span><br><span class="line">            receive(finished, msg);</span><br><span class="line">            count = <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(count &lt; <span class="number">0</span>) <span class="comment">//count&lt;0ï¼Œè¯´æ˜æ”¶åˆ°äº†å†™è€…çš„è¯·æ±‚ï¼Œä½†æ­¤æ—¶æœ‰è¯»è€…æ­£åœ¨ä¸´ç•ŒåŒºä¸­ã€‚æ­¤æ—¶ï¼Œå°±åªå¤„ç†â€œfinishâ€æ¶ˆæ¯</span></span><br><span class="line">        &#123;</span><br><span class="line">            receive(finshed, msg);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; <strong>fine~~</strong></p>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>æ“ä½œç³»ç»Ÿ</tag>
      </tags>
  </entry>
</search>
