<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>C++ ä¸­ const çš„ä½¿ç”¨è¦ç‚¹</title>
    <url>/myblog/2020/10/13/C/C++%20%E4%B8%AD%20const%20%E7%9A%84%E4%BD%BF%E7%94%A8%E8%A6%81%E7%82%B9/</url>
    <content><![CDATA[<h1 id="C-ä¸­-const-çš„ä½¿ç”¨è¦ç‚¹"><a href="#C-ä¸­-const-çš„ä½¿ç”¨è¦ç‚¹" class="headerlink" title="C++ ä¸­ const çš„ä½¿ç”¨è¦ç‚¹"></a>C++ ä¸­ const çš„ä½¿ç”¨è¦ç‚¹</h1><hr>
<p>constè¯­æ³•å˜åŒ–å¤šç«¯ï¼Œä½†æ˜¯å´å¹¶éé«˜æ·±è«æµ‹</p>
<p>1ã€æ³¨æ„ä»¥ä¸‹çš„å‡ ä¸ª <code>const</code> ç”¨æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">char</span> *greeting[] = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> *p = greeting; 			<span class="comment">//non-const pointer, non-const data</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * p = greeting;  	 <span class="comment">//non-const pointer, const data</span></span><br><span class="line"><span class="keyword">char</span> * <span class="keyword">const</span> p = greeting;		 <span class="comment">//const pointer, non-const data</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> p = greeting; <span class="comment">//const pointer, const data;</span></span><br></pre></td></tr></table></figure>

<p><strong>const åœ¨æ˜Ÿå·å·¦è¾¹è¡¨ç¤ºè¢«æŒ‡ç‰©æ˜¯å¸¸é‡ï¼Œconst åœ¨æ˜Ÿå·å³è¾¹è¡¨ç¤ºæŒ‡é’ˆè‡ªèº«æ˜¯å¸¸é‡</strong></p>
<p>2ã€å¦‚æœè¢«æŒ‡ç‰©æ˜¯å¸¸é‡ï¼Œconst åœ¨ç±»å‹åçš„å‰åæ„ä¹‰éƒ½ç›¸åŒ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f1</span><span class="params">(<span class="keyword">const</span> Widget* pw)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f2</span><span class="params">(Widget <span class="keyword">const</span>* pw)</span></span>;</span><br><span class="line"><span class="comment">// ä¸¤è€…æ²¡æœ‰åŒºåˆ«</span></span><br></pre></td></tr></table></figure>

<p>3ã€STLè¿­ä»£å™¨æ˜¯ä»¥æŒ‡é’ˆä¸ºæ ¹æ®å¡‘è†œå‡ºæ¥çš„</p>
<p>å£°æ˜è¿­ä»£å™¨ä¸º const å’Œ å£°æ˜ æŒ‡é’ˆä¸º const çš„å¤§è‡´æ–¹æ³•ç›¸åŒ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::iterator iter = vec.begin();</span><br><span class="line"><span class="comment">//iter çš„ä½œç”¨å’Œ T* const ç±»ä¼¼</span></span><br><span class="line">*iter = <span class="number">10</span>; <span class="comment">// å¯ä»¥æ”¹å˜æŒ‡å‘ç‰©</span></span><br><span class="line">++iter; <span class="comment">// é”™è¯¯ï¼ ä¸å¯ä»¥æ”¹å˜ iter, å®ƒæ˜¯ä¸€ä¸ªå¸¸é‡</span></span><br><span class="line"></span><br><span class="line">str::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::const_iterator cIter = vec.begin();</span><br><span class="line"><span class="comment">//cIter çš„ä½œç”¨å’Œ const T* ç±»ä¼¼</span></span><br><span class="line">*cIter = <span class="number">10</span>; <span class="comment">// é”™è¯¯ï¼ä¸å¯ä»¥æ”¹å˜ *cIter, å®ƒæ˜¯ä¸€ä¸ªå¸¸é‡</span></span><br><span class="line">++cIter; <span class="comment">// å¯ä»¥æ”¹å˜ cIter çš„æŒ‡å‘</span></span><br></pre></td></tr></table></figure>



<h3 id="ä¸€ã€const-æˆå‘˜å‡½æ•°"><a href="#ä¸€ã€const-æˆå‘˜å‡½æ•°" class="headerlink" title="ä¸€ã€const æˆå‘˜å‡½æ•°"></a>ä¸€ã€const æˆå‘˜å‡½æ•°</h3><p>å°† const å®æ–½äºæˆå‘˜å‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å°†å…¶ç”¨äº const å¯¹è±¡èº«ä¸Š</p>
<p>const æˆå‘˜å‡½æ•°çš„é‡è¦æ€§ä½“ç°åœ¨ä¸‹é¢ä¸¤ä¸ªæ–¹å‘ï¼š</p>
<ul>
<li>ä½¿ class æ¥å£æ›´åŠ ä¾¿äºç†è§£(å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å“ªä¸ªå‡½æ•°èƒ½å¤Ÿæ”¹å˜å¯¹è±¡å†…å®¹è€Œå“ªä¸€ä¸ªä¸è¡Œ)</li>
<li>ä½¿â€æ“ä½œ const å¯¹è±¡â€å˜ä¸ºå¯èƒ½</li>
</ul>
<p><em>ä¸¤ä¸ªæˆå‘˜å‡½æ•°å¦‚æœå¸¸é‡æ€§(constness)ä¸åŒï¼Œé‚£ä¹ˆå¯ä»¥è¢«é‡è½½</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">class <span class="title">TextBlock</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	......</span><br><span class="line">    	<span class="keyword">const</span> chat&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    	&#123;</span><br><span class="line">        	<span class="keyword">return</span> text[position];</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">char</span>&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> position)</span><br><span class="line">    	&#123;</span><br><span class="line">        	<span class="keyword">return</span> text[position];</span><br><span class="line">    	&#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="built_in">std</span>::<span class="built_in">string</span> text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯¹å…¶åšä¸€ä¸‹å¤„ç†</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; tb[<span class="number">0</span>]; <span class="comment">//è¯»ä¸€ä¸ª non-const TextBlock</span></span><br><span class="line">tb[<span class="number">0</span>] = <span class="string">&#x27;x&#x27;</span>;	    <span class="comment">//å†™ä¸€ä¸ª non-const TextBlock</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ctb[<span class="number">0</span>];<span class="comment">//è¯»ä¸€ä¸ª const TextBlock</span></span><br><span class="line">ctb[<span class="number">0</span>] = <span class="string">&#x27;x&#x27;</span>;       <span class="comment">//é”™è¯¯ï¼Œ ä¸èƒ½å†™ä¸€ä¸ª const TextBlock</span></span><br></pre></td></tr></table></figure>

<p>é”™è¯¯çš„åŸå› æ˜¯ä¼å›¾å¯¹ä¸€ä¸ªâ€const operator[]â€è¿”å›çš„ const char&amp; å®æ–½èµ‹å€¼æ“ä½œ</p>
<p>ç°åœ¨å¯¹äºæˆå‘˜å‡½æ•°çš„ç†è§£æœ‰ä¸¤ä¸ªä¸»æµç†è§£ï¼š</p>
<ul>
<li><p>bitwise constness(Physcial constness)</p>
<p>æˆå‘˜å‡½æ•°åªæœ‰åœ¨ä¸æ”¹å˜å¯¹è±¡çš„ä»»ä½•çš„ä»»ä½•æˆå‘˜å˜é‡(static é™¤å¤–)æ—¶æ‰èƒ½è¯´æ˜¯constã€‚</p>
</li>
<li><p>logical constness</p>
<p>ä¸€ä¸ª const æˆå‘˜å‡½æ•°å¯ä»¥ä¿®æ”¹å®ƒæ‰€å¤„ç†çš„å¯¹è±¡å†…çš„æŸäº› bitsï¼Œä½†æ˜¯åªæœ‰åœ¨å®¢æˆ·ç«¯æ£€æµ‹ä¸å‡ºæ¥çš„æƒ…å†µä¸‹æ‰èƒ½è¿™æ ·å¤„ç†</p>
</li>
</ul>
<h5 id="1ã€bitwise-constness"><a href="#1ã€bitwise-constness" class="headerlink" title="1ã€bitwise constness"></a>1ã€bitwise constness</h5><p>è¿™ç§ç†è§£çš„å¥½å¤„æ˜¯éå¸¸å®¹æ˜“å»æ£€æµ‹æ˜¯å¦éµå®ˆäº† bitwise constness å‡†åˆ™ï¼šåªéœ€è¦å¯»æ‰¾æˆå‘˜å˜é‡çš„èµ‹å€¼åŠ¨ä½œã€‚</p>
<p>ä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè®¸å¤šä¸å…·å¤‡ const æ€§è´¨çš„æˆå‘˜å‡½æ•°ä¹Ÿèƒ½é€šè¿‡ bitwise æµ‹è¯•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¸€ä¸ªéœ€è¦äº C API æ²Ÿé€šçš„ TextBlock-like class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTextBlock</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	...</span><br><span class="line">    	<span class="keyword">char</span>&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    	&#123;	<span class="keyword">return</span> pText[position];	&#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="keyword">char</span>* pText;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ‰€ç¤ºçš„ class ä¸æ°å½“çš„å°†å…¶ operator[] å£°æ˜ä¸º const æˆå‘˜å‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª referrence æŒ‡å‘å¯¹è±¡å†…éƒ¨å€¼ã€‚</p>
<p>å½“ç¼–è¯‘å™¨è®¤ä¸ºå®ƒæ˜¯ bitwise constness æ—¶</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> CTextBlock <span class="title">cctb</span><span class="params">(<span class="string">&quot;Hello&quot;</span>)</span></span>;</span><br><span class="line"><span class="keyword">char</span>* pc = &amp;cctb[<span class="number">0</span>]; <span class="comment">// è°ƒç”¨ const operator[] å–å¾—ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘cctb[0]</span></span><br><span class="line">*pc = <span class="string">&#x27;J&#x27;</span>; <span class="comment">// ä¿®æ”¹äº† cctb[0]</span></span><br></pre></td></tr></table></figure>

<h5 id="2ã€logical-constness"><a href="#2ã€logical-constness" class="headerlink" title="2ã€logical constness"></a>2ã€logical constness</h5><p>æœ‰æ—¶å€™ TextBlock class è¦ cache æ–‡æœ¬åŒºå—çš„é•¿åº¦ï¼Œä»¥ä¾¿åé¢ä½¿ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextBlock</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	...</span><br><span class="line">    	<span class="function"><span class="built_in">std</span>::<span class="keyword">size_t</span> <span class="title">length</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="keyword">char</span>* pText;</span><br><span class="line">    	<span class="built_in">std</span>::<span class="keyword">size_t</span> textLength;</span><br><span class="line">    	<span class="keyword">bool</span> lengthIsValid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="keyword">size_t</span> <span class="title">CTextBlock::length</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!lengthIsVailid)</span><br><span class="line">    &#123;</span><br><span class="line">        textLength = <span class="built_in">std</span>::<span class="built_in">strlen</span>(pText);</span><br><span class="line">        lengthIsValid = <span class="literal">true</span>; <span class="comment">// è¿™ç§æ”¹åŠ¨å¾ˆé‡è¦ï¼Œä½†æ˜¯ä¸è¢«ç¼–è¯‘å™¨æ¥å—ã€‚ç¼–è¯‘å™¨åšæŒ bitwise constness</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> textLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ <code>mutable</code> å…³é”®å­—</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mutable</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> textLength;</span><br><span class="line"><span class="keyword">mutable</span> <span class="keyword">bool</span> lengthIsValid;</span><br></pre></td></tr></table></figure>



<h3 id="äºŒã€åœ¨-const-å’Œ-non-const-æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤"><a href="#äºŒã€åœ¨-const-å’Œ-non-const-æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤" class="headerlink" title="äºŒã€åœ¨ const å’Œ non-const æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤"></a>äºŒã€åœ¨ const å’Œ non-const æˆå‘˜å‡½æ•°ä¸­é¿å…é‡å¤</h3><p>å¯¹äºåœ¨ ä¸Šä¸€èŠ‚æåˆ°çš„ç”¨ mutable è§£å†³ bitwise-const é”™è¯¯ç†è§£çš„é—®é¢˜ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„è§£æ³•ï¼Œä½†æ˜¯ä¸èƒ½é€‚ç”¨äºæ‰€æœ‰çš„ const ç›¸å…³éš¾é¢˜ã€‚</p>
<p>å½“ operator[] æ“ä½œè¿‡äºå¤æ‚çš„æ—¶å€™ï¼Œä»£ç çš„é‡å¤é‡ä¼šé€ æˆå¾ˆå¤§çš„å›°æ‰°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextBlock</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">    ...;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...; <span class="comment">// bounding checking</span></span><br><span class="line">        ...; <span class="comment">// log access data</span></span><br><span class="line">        ...; <span class="comment">// verify data integrity</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) </span><br><span class="line">    &#123;</span><br><span class="line">        ...; <span class="comment">// bounding checking</span></span><br><span class="line">        ...; <span class="comment">// log access data</span></span><br><span class="line">        ...; <span class="comment">// verify data integrity</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span>: </span><br><span class="line">    	<span class="built_in">std</span>::<span class="built_in">string</span> text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šçš„ä»£ç é‡å¤å‘ï¼Œç¼–è¯‘æ—¶é—´ï¼Œç»´æŠ¤ï¼Œä»£ç è†¨èƒ€â€¦â€¦é—®é¢˜ä¼šè®©äººå¤´å¤§</p>
<p>è¿™æ—¶éœ€è¦åšçš„æ˜¯ï¼š <strong>å®ç° operator[] æœºåˆ¶ä¸€æ¬¡ï¼Œ å¹¶ä¸¤æ¬¡ä½¿ç”¨</strong></p>
<p>éœ€è¦ä½¿ç”¨çš„æ–¹æ³•æ˜¯: **casting away constness **      Tips: é™¤éæ˜¯æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€èˆ¬ä¸ä¼šæ¨èä½¿ç”¨ casting æ“ä½œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextBlock</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">    ...;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) <span class="keyword">const</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...; <span class="comment">// bounding checking</span></span><br><span class="line">        ...; <span class="comment">// log access data</span></span><br><span class="line">        ...; <span class="comment">// verify data integrity</span></span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>&amp; <span class="keyword">operator</span>[] (<span class="built_in">std</span>::<span class="keyword">size_t</span> position) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>&amp;&gt;( <span class="comment">// ç¬¬äºŒæ¬¡castingå°† op[] çš„ const æ€§è´¨æ¶ˆé™¤</span></span><br><span class="line">            	<span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> TextBlock&amp;&gt;(*<span class="keyword">this</span>) <span class="comment">// ç¬¬ä¸€æ¬¡castingï¼Œå°†*thisçš„åŸå§‹ç±»å‹ä»TextBlock&amp; è½¬å‹ä¸º const TextBlock&amp; </span></span><br><span class="line">            		[position]</span><br><span class="line">        	)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span>: </span><br><span class="line">    	<span class="built_in">std</span>::<span class="built_in">string</span> text;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç é•¿å°è¯•ç”¨ <code>non-cost operator[]</code> è°ƒç”¨å®ƒçš„ <code>const</code> å…„å¼Ÿ</p>
<p>è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼š<strong>ä¸è¦ç”¨ const ç‰ˆæœ¬è°ƒç”¨ non-const ç‰ˆæœ¬æ¥é¿å…é‡å¤</strong> </p>
<p>å¦åˆ™ä½ ä¹‹å‰çš„æ‰¿è¯ºï¼š <strong>const æˆå‘˜å‡½æ•°æ‰¿è¯ºä¸æ”¹å˜å…¶å¯¹è±¡çš„é€»è¾‘çŠ¶æ€</strong> ä¾¿æ²¡æœ‰ä»»ä½•ä»·å€¼ï¼ï¼ï¼ğŸ’”ğŸ’”ğŸ’”</p>
<p>const åœ¨ç¼–ç¨‹çš„æ—¶å€™æ˜¯ä¸€ä¸ªå¼ºæœ‰åŠ›çš„å¸®æ‰‹ï¼Œä½†æ˜¯è¦å°å¿ƒå…¶ä½¿ç”¨ ğŸ’– ğŸ’– ğŸ’–</p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>å°†æŸäº›ä¸œè¥¿å£°æ˜ä¸º const å¯ä»¥å¸®åŠ©ç¼–è¯‘å™¨æ£€æµ‹é”™è¯¯ç”¨æ³•ã€‚const å¯ä»¥æ–½åŠ äºä»»ä½•ä½œç”¨åŸŸå†…çš„å¯¹è±¡ã€å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›ç±»å‹ã€æˆå‘˜å‡½æ•°æœ¬ä½“</li>
<li>ç¼–è¯‘å™¨ä¼šå¼ºåˆ¶å®æ–½ bitwise constnessï¼Œä½†æ˜¯è‡ªå·±åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™è¦ä½¿ç”¨ â€œæ¦‚å¿µä¸Šçš„å¸¸é‡â€ conceptual constness</li>
<li>å½“const å’Œ non-const æˆå‘˜å‡½æ•°æœ‰ç›¸åŒçš„å®ç°çš„æ—¶å€™ï¼Œè¦ç”¨ non-const  ç‰ˆæœ¬æ¥è°ƒç”¨ const ç‰ˆæœ¬</li>
</ul>
<p>â€‹<center><font face="å®‹ä½“" size=20 color=#8B008B>FINE</font></center></p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>C/C++ å†…å­˜å¸ƒå±€</title>
    <url>/myblog/2020/09/22/C/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<hr>
<h2 id="C-C-å†…å­˜å¸ƒå±€"><a href="#C-C-å†…å­˜å¸ƒå±€" class="headerlink" title="C/C++ å†…å­˜å¸ƒå±€"></a>C/C++ å†…å­˜å¸ƒå±€</h2><h4 id="ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ"><a href="#ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ" class="headerlink" title="ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ"></a>ä¸€ã€å¯æ‰§è¡Œæ˜ åƒ</h4><p>&emsp;&emsp;å½“ç”ŸæˆC/C++ç¨‹åºçš„æ—¶å€™ï¼Œé“¾æ¥å™¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨UNIXå’Œå¤§å¤šæ•°æ¸¸æˆä¸»æœºä¸Šé¢ä½¿ç”¨ä¸€ç§ <strong><em>å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼(executable and linkable format, ELF)</em></strong> ã€‚åœ¨è¿™äº›å¹³å°ä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨åç¼€ <strong><em>.elf</em></strong> ã€‚åœ¨Windowsä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶åŒæ„ç±»ä¼¼ä¸ELFï¼Œä½¿ç”¨ <strong><em>.exe</em></strong> ä½œä¸ºæ‰©å±•åã€‚</p>
<p>æ˜ åƒæ–‡ä»¶ä¸€èˆ¬æœ€å°‘ç”±ä¸€ä¸‹å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼š</p>
<ul>
<li><p>ä»£ç æ®µ(text/code segement)</p>
<blockquote>
<p>ç¨‹åºä¸­å®šä¹‰çš„å‡½æ•°çš„å…¨éƒ¨æœºæ¢°ç </p>
</blockquote>
</li>
<li><p>æ•°æ®æ®µ(data segment)</p>
<blockquote>
<p>å·²ç»åˆå§‹åŒ–çš„å…¨éƒ¨é™æ€å˜é‡<br>å°†ç”±è¿æ¥å™¨ä¸ºå…¶åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”å¡«å¦‚é€‚å½“çš„åˆå§‹å€¼</p>
</blockquote>
</li>
<li><p>BBS æ®µ(BBS segement)</p>
<blockquote>
<p>BBSæ˜¯ä¸€ç§è€æ—§çš„å«æ³•ï¼Œæ„ä¸º <strong><em>â€œç”±ç¬¦å·å¼€å§‹çš„å—(block started by symbol)â€</em></strong>ã€‚åŒ…å«ç¨‹åºå®šä¹‰ä¸­æ‰€æœ‰çš„æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œåœ¨C/C++ä¸­æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡å…¨ä¸ºé›¶ã€‚</p>
</blockquote>
</li>
<li><p>åªè¯»æ•°æ®æ®µ(read only data segement)</p>
<blockquote>
<p> åˆç§°ä¸º <strong><em>rodata</em></strong> æ®µ,åŒ…å«ç¨‹åºä¸­å®šä¹‰çš„åªè¯»(å¸¸é‡)å…¨å±€å˜é‡ã€‚<br> æ¯”å¦‚ï¼šæµ®ç‚¹å¸¸é‡ï¼Œç”¨constå…³é”®å­—å£°åçš„å…¨å±€å¯¹è±¡å®ä¾‹â€¦â€¦</p>
<blockquote>
<p>tips: ç¼–è¯‘å™¨é€šå¸¸ä¼šæŠŠæ•´æ•°å¸¸é‡è§†ä¸º<strong>æ˜ç¤ºå¸¸é‡</strong>(manifast constant)ï¼Œå¹¶ä¸”ç›´æ¥æŠŠæ˜ç¤ºå¸¸é‡æ’å…¥æœºå™¨ç ä¸­ï¼Œç›´æ¥å ç”¨ä»£ç æ®µçš„å­˜å‚¨ç©ºé—´è€Œä¸å­˜å‚¨äºåªè¯»æ•°æ®æ®µã€‚</p>
</blockquote>
</blockquote>
</li>
</ul>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>Memory Management</tag>
        <tag>GameDev</tag>
      </tags>
  </entry>
  <entry>
    <title>Linkers and loaders (1)</title>
    <url>/myblog/2020/10/24/C/Linkers%20and%20Loads/</url>
    <content><![CDATA[<h1 id="Linkers-and-Loads"><a href="#Linkers-and-Loads" class="headerlink" title="Linkers and Loads"></a>Linkers and Loads</h1><font size = 4.5>

<h3 id="ä¸€ã€INTRODUCTION"><a href="#ä¸€ã€INTRODUCTION" class="headerlink" title="ä¸€ã€INTRODUCTION"></a>ä¸€ã€INTRODUCTION</h3><hr>
<p>Translating high-level language into a properly formatted binary string before it can be executed is necessary. In most basic form this transformation process occurs in two stages:</p>
<ol>
<li>A userâ€™s (source) program is translated into machine language.</li>
<li>The translated program is stored for immediate or future execution</li>
</ol>
<p><strong>loading</strong>: storing into main memory</p>
<p><strong>linking</strong>: combine subprograms into a composite program</p>
<h3 id="äºŒã€LOADERS"><a href="#äºŒã€LOADERS" class="headerlink" title="äºŒã€LOADERS"></a>äºŒã€LOADERS</h3><hr>
<p>Loading a translated program into memory is logically distinct from the translation of that program, separate software modules, called loaders, have been developed to accomplish the loading operation. </p>
<p>There are two types:</p>
<ol>
<li>Binary loaders</li>
<li>Relocating loaders</li>
</ol>
<p>The relocating loader is responsible for loading into main memory a program in relocatable binary form and updating (relocation) all relative addresses.</p>
<h3 id="ä¸‰ã€LINKERS"><a href="#ä¸‰ã€LINKERS" class="headerlink" title="ä¸‰ã€LINKERS"></a>ä¸‰ã€LINKERS</h3><hr>
<p>Linking could be carried out at 7 different times:</p>
<ul>
<li>source program coding time</li>
<li>after coding but before translation time</li>
<li>at translation time</li>
<li>after translation but before loading time</li>
<li>at loading time</li>
<li>after loading but before execute time</li>
<li>at execute time</li>
</ul>
<p><strong>Address binding</strong>: translation  or mapping of a logical into a physical address.</p>
<p><strong>Linking process</strong>: binding (combining) independent logical spaces into one composite logical space.</p>
<h3 id="å››ã€THE-LINKAGE-EDITOR"><a href="#å››ã€THE-LINKAGE-EDITOR" class="headerlink" title="å››ã€THE LINKAGE EDITOR"></a>å››ã€THE LINKAGE EDITOR</h3><hr>
<p>On the IBM System/360, there exist a sophisticated linker, called the <code>Linkage Eeditor</code> , and a simple relocating loader referred to as <code>Program Fetch</code> .</p>
<p>Linkage Editor is responsible for the following functions:</p>
<ul>
<li><p>Primary function: (1) Linking together independently translated modules.</p>
</li>
<li><p>Secondary function: (1) Overlaying processing.</p>
<p>â€‹                                 (2) Program modification.</p>
<p>â€‹                                 (3) Library access.</p>
</li>
</ul>
<p>The inputs accepted  can be divided into two groups: <code>input modules</code> &amp; <code>Linkage Editor control statements</code>. </p>
<p>Input modules are further classified as being either <code>Object Modules</code> or <code>Load modules</code>. These two are similar in structure.</p>
<p>Object module: The output  produced by the language translators(IBM System/360). This output consists of the machine language code for the translated program, relocation information, and a table indicating the definition and use of external symbols.</p>
<p>Linking Together a Set of Modules:</p>
<p>â€‹        In linking together a set of modules, the Linkage Editor is primarily responsible for:</p>
<p>â€‹            (1) assigning address.</p>
<p>â€‹            (2) relocating Address Constants.</p>
<p>â€‹            (3) create an output module (Load Module).</p>
<h3 id="å››ã€SUMMARY"><a href="#å››ã€SUMMARY" class="headerlink" title="å››ã€SUMMARY"></a>å››ã€SUMMARY</h3><hr>
<p>The linking together of independently translated programs is the responsibility of the <strong>Linkage Editor</strong> , and a major part of the language processing burden is on the language translators whose responsibility is not only to translate source programs into a form which is very close to machine language, but also to format addresses in a base plus displacement form and to create the Object Module.</p>
<p>If the various stages of the language transformation process are viewed as a function of time, it is generally true that <strong>early binding allows more efficient implementations</strong> while <strong>late binding facilitates program debugging and modification.</strong></p>
<p>Features as elaborate editing capabilities and overlay processing, which produce a powerful and sophisticated linker, are at a high cost. So flexibility provided by simple linkers and relocating loaders has a definite place in modern OS.</p>
</font>




<div align = "right">Computing Surveys Vol 4, No 3, Sep 1972</div>


]]></content>
      <categories>
        <category>Operating Systems</category>
      </categories>
      <tags>
        <tag>Linkers and loaders</tag>
        <tag>Operation Systems</tag>
      </tags>
  </entry>
  <entry>
    <title>Virtual Memory Series I</title>
    <url>/myblog/2020/10/25/C/Virtual%20Memory%EF%BC%9A%20Issues%20of%20Implementation/</url>
    <content><![CDATA[<h1 id="Virtual-Memoryï¼š-Issues-of-Implementation"><a href="#Virtual-Memoryï¼š-Issues-of-Implementation" class="headerlink" title="Virtual Memoryï¼š Issues of Implementation"></a>Virtual Memoryï¼š Issues of Implementation</h1><font size = 4.5>
---

<p>In 1998,  there has not been much agreement on the form that what kind of support should modern processors take for â€œVirtual Memoryâ€.</p>
<p>Thus in that time they have two ways for system-level software but seems somewhat unattractive:</p>
<ol>
<li>Writing software to fit many different architectures, which can compromise performance and reliabilities.</li>
<li>Inserting layers of software to emulate a particular hardware interface, which essentially forces one hardware design to look like another. Inserting this <strong>hardware abstraction layer</strong> hides hardware particulars from the higher levels of software but also compromise performance and compatibility.</li>
</ol>
<p>Todayâ€™s  OSs and microprocessor are geared toward demand-paged virtual memory.</p>
<h3 id="ä¸€ã€BASIC-CONCEPTS"><a href="#ä¸€ã€BASIC-CONCEPTS" class="headerlink" title="ä¸€ã€BASIC CONCEPTS"></a>ä¸€ã€BASIC CONCEPTS</h3><hr>
<p>A well-designed virtual-memory system system:</p>
<ul>
<li>The main memory holds only the most often used portions of a processâ€™s address space.</li>
<li>Other portions are stored on disk and retrieved as needed.</li>
</ul>
<p>The mapping is a function, a given virtual page can have only one physical location.  However, the inverse mapping is not necessarily a function. This allows several virtual pages mapped to the same page frame. This is called <code>virtual-address aliasing</code>, which lets processes or threads share memory and supports different â€˜viewsâ€™ of data with different protections or behaviors.</p>
<p>If an item can be paged, it implies that the item resides in virtual space. The OS allocates physical memory for the item itself only when the item is paged in.</p>
<h3 id="1ã€Page-table-entries"><a href="#1ã€Page-table-entries" class="headerlink" title="1ã€Page table entries"></a>1ã€Page table entries</h3><p>At the minimum, a PTE indicates whether its virtual page is in memory, on disk, or unallocated.</p>
<p>Form a PTE, the OS must be able to determine:</p>
<ul>
<li>the ID of the pageâ€™s owner </li>
<li>the virtual page number</li>
<li>the pageâ€™s location in memory (page frame number) or location on disk (an offset into a swap file)</li>
<li>a valid bit contains a valid translation or not</li>
<li>a reference bit, whether the page was recently accessed</li>
<li>a modify bit, whether the page was recently written</li>
<li>page-protection bits, read-writeã€read-only and so on</li>
</ul>
<p>However, for efficiency reasons, all of the information an OS needs <strong>is rarely stored explicitly in each PTE.</strong></p>
<h3 id="2ã€Translation-lookaside-buffers"><a href="#2ã€Translation-lookaside-buffers" class="headerlink" title="2ã€Translation lookaside buffers"></a>2ã€Translation lookaside buffers</h3><p>To speed translation, most hardware systems provide a cache for PTEs, called a translation lookaside buffer(TLB).</p>
<p>In some implementations the OS searches the page table after a TLB miss; in others, a hardware state machine conducts the search.</p>
<p>If a page fault interrupts the OS, which must then do one of three things:</p>
<ol>
<li>Retrieve the page from disk and place it into memory.</li>
<li>Create a new page if the page does not exist (as when a process allocates a new stack frame in virgin territory).</li>
<li>If the access is to illegal spaceâ€”â€”send the process an error signal.</li>
</ol>
<p>Faulting address: The virtual address causing a TLB miss. This is not meant to imply that all TLB misses result in page faults.</p>
<p>The inclusion between the TLB and main memory: If a page is in memory, its mapping <strong>may or may not be in the TLB</strong>, but if a pageâ€™s mapping is in the TLB, the page <strong>must be in physical memory.</strong> </p>
<h3 id="äºŒã€PAGE-TABLE-ORGANIZATION"><a href="#äºŒã€PAGE-TABLE-ORGANIZATION" class="headerlink" title="äºŒã€PAGE TABLE ORGANIZATION"></a>äºŒã€PAGE TABLE ORGANIZATION</h3><hr>
<p>Few generations ago, we use signal-level table, <strong>direct table</strong>.</p>
<p>Table walking: the search of the page table.</p>
<p>There are two primary types of page table organization: <code>forward-mapped or hierarchical page table</code> index by the virtual page number; and the <code>inverse mapped or inverted page table</code> index by the page frame number.</p>
<h3 id="1ã€-Hierarchical-page-tables"><a href="#1ã€-Hierarchical-page-tables" class="headerlink" title="1ã€ Hierarchical page tables"></a>1ã€ Hierarchical page tables</h3><p>Based on the idea: <strong>A large data array can be mapped by a smaller array, which can in turn be mapped be an even smaller array.</strong></p>
<p>Most OSs wire down root-level table in memory while the process is running.</p>
<p>There are two access methods for the hierarchical page table: <code>top-down</code> or <code>bottom-up</code>.</p>
<p>Top-down: uses physical address to reference the PTEs in the table.</p>
<p>Bottom-up: uses virtual address.</p>
<h3 id="2ã€Top-down-traversal"><a href="#2ã€Top-down-traversal" class="headerlink" title="2ã€Top-down traversal"></a>2ã€Top-down traversal</h3><p>Often used in hardware table-walking schemes(Interâ€™s IA-32 architecture).</p>
<h3 id="3ã€Bottom-up-traversal"><a href="#3ã€Bottom-up-traversal" class="headerlink" title="3ã€Bottom-up traversal"></a>3ã€Bottom-up traversal</h3><p>The top-down access method requires as many memory references as there are table levels.</p>
<p>On a TLB miss, the virtual address for this user PTE is used to load the PTE from the user page table.</p>
<p>The following pseudo-code briefly illustrates these steps:</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">load user data /* load misses TLB */</span><br><span class="line">    	/* invokes TLB-miss handler */</span><br><span class="line">    	construct virtual address for user PTE</span><br><span class="line">	    load user PTE /* load misses TLB */</span><br><span class="line">	    	/* invoke root TLB-miss handler: */</span><br><span class="line">		    construct physcial address for root PTE</span><br><span class="line">		    load root PTE /* can not cause TLB miss, because it uses a </span><br><span class="line">            				physical address*/</span><br><span class="line">             put root PTE into TLB</span><br><span class="line">             jump to faulting instruction</span><br><span class="line">        /* return to user TLB-miss handler: */</span><br><span class="line">        load user PTE /* this time load succeeds */</span><br><span class="line">        put user PTE into TLB</span><br><span class="line">        jump to faulting instruction</span><br><span class="line">/* return to user mode */</span><br><span class="line">load user data /* this time load succeeds */</span><br></pre></td></tr></table></figure>









<h3 id="4ã€Inverted-page-tables"><a href="#4ã€Inverted-page-tables" class="headerlink" title="4ã€Inverted page tables"></a>4ã€Inverted page tables</h3><p>Instead of one entry for every virtual page belonging to a process, the inverted page table has <strong>one entry for every page frame in main memory.</strong></p>
<p>The index of the PTE in the inverted table is equal to the page frame number of the page it maps. Thus, rather than scaling with the size of the virtual space, it <strong>scales with the size of physical memory.</strong> It compact in size, making it a good candidate for the hardware-managed mechanism that need the table to be wired down in memory.</p>
<p>Since different virtual page numbers might produce identical hash values, a <code>collision-chain</code> mechanism is used to let these mapping exist int the table simultaneously.</p>
<p>Noting that in classical inverted-table implementations, the PTE is too large compare to hierarchical table. As a trade-off to keep the table small, the designers of early systems increased the number of memory accesses per lookup. They added a level of indirection, the <strong>hash anchor table(HAT).</strong></p>
<p>Since the entries in the hash anchor table are smaller than the entries in the inverted table, it is more memory efficient <strong>to increase the size of the hash anchor table to reduce the average collision-chain length.</strong></p>
<p>the following steps briefly illustrate this mechanism:</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">Step 1:</span><br><span class="line">	faulting virtual page number is hashed, indexing the hash anchor table index.</span><br><span class="line">	Corresponding anchor-table entry is loaded and points to the chain head for that hash value.</span><br><span class="line">step 2:</span><br><span class="line">	The indecated PTE loaded.</span><br><span class="line">	Comparing its virtual page number to the faulting virtual page number.</span><br><span class="line">	if (marched) </span><br><span class="line">		step 3a:</span><br><span class="line">			Algorithm terminates, the mapping, composed of the virtual page number and the page 	frame numbers(PTE&#x27;s index), is placed into the TLB.</span><br><span class="line">	else</span><br><span class="line">		step 3b</span><br><span class="line">			The PTE referrences the next entry in the chain, or indicates that it is the last chain in the chain.</span><br><span class="line">If there is a next entry, it is loaded and compared.</span><br><span class="line">If the last entry fails to match, algorithm terminates and cases a page fault.</span><br><span class="line">			</span><br></pre></td></tr></table></figure>

<h3 id="ä¸‰ã€DETAILS-AND-THEIR-DEVILS"><a href="#ä¸‰ã€DETAILS-AND-THEIR-DEVILS" class="headerlink" title="ä¸‰ã€DETAILS (AND THEIR DEVILS)"></a>ä¸‰ã€DETAILS (AND THEIR DEVILS)</h3><hr>
<p>The choice between hierarchical and inverted page tables is not an obvious one: There are many trade-offs between performance and memory usage. Implementations of shared memory width vary widely in performance, <strong>especially with different hardware support</strong>. (i.e. virtual caches requires more consistency management than physical caches).</p>
<p>The address-space protection scheme is also heavily dependent on hardware support and has great impact on the shared-memory implementation.</p>
<p>Also, the TLB can be managed by the OS or managed in hardware, presenting a trade-off between flexibility and performance. </p>
<p>It is not surprising that <strong>the interactions are often subtle and  nonintuitive.</strong></p>
<h3 id="1ã€Share-memory"><a href="#1ã€Share-memory" class="headerlink" title="1ã€Share memory"></a>1ã€Share memory</h3><p>There are several implementation possibilities for shared memory. One of the most common is <code>virtual address aliasing</code>, or simply <code>aliasing</code>. In this scheme, each mapping to the same physical page requires its own logical PTE.</p>
<p>Maintaining multiple PTEs makes it possible for different processes:</p>
<ul>
<li>Using different virtual address for the same physical data.</li>
<li>Mapping the same physical data with different protections.</li>
<li>For different virtual references to the same physical data to cause different behaviors. </li>
</ul>
<p>primary disadvantage of aliasing: Increasing overhead of managing multiple mappings to the same physical page.</p>
<p>A variation on aliasing is to <strong>share portions of page tables whenever data is shared.</strong></p>
<p>Compared to the normal aliasing mechanism, this variation reduces the overhead of mapping PTEs and reduces the impact of multiple PTEs on the TLB.</p>
<p>Disadvantage: It can require sharing at large granularities (It can be overcome if the hardware translation mechanism is segmented and supports protection at the segment level).</p>
<p>Another alternative to aliasing is to have all processes share a global virtual address space. This space is often called a â€œflatâ€ address space because <strong>it is not divided into disjunct per-process spaces by address-space identifiers.</strong></p>
<p>Typically, these signal address-space OSs map the entire space of all processes with a single page table, which considerably reduces the management overhead. (Unix-based OSs and PA-RISC system use a global address space)</p>
<h3 id="2ã€Address-space-identifier-versus-segmentation"><a href="#2ã€Address-space-identifier-versus-segmentation" class="headerlink" title="2ã€Address-space identifier versus segmentation"></a>2ã€Address-space identifier versus segmentation</h3><p> Two common hardware assists for providing address-space protection are <code>address-space identifiers</code> and <code>page segmentation</code>.</p>
<p><strong>Address-space identifiers</strong> found in: <code>MIPS</code>, <code>Alpha</code>, and <code>sparc</code> architectures, extend virtual addresses and distinguish them form those generate by different processes. multiple processes can coexist, each thinking it owns the full extend of a 32-bit address space. Each process is unable to produce addresses that mimic those of other processes, because to do so it must control the contents of the protected register holding the address-space identifier.</p>
<p>The OS place a processâ€™s address-space identifier in a protected register, and every virtual address the process generates is concatenated with the address-space identifier.</p>
<p><strong>In page segmentation</strong>, (as implemented in the <code>PowerPC</code>, <code>PA-RISC</code> , and <code>X86</code> architectures), virtual-physical translation occurs in two steps: </p>
<ol>
<li>User addresses are mapped onto a global address at the granularity of segments.</li>
<li>Virtual addresses from the global space are mapped onto physical memory at the granularity of pages.</li>
</ol>
<p>A process address space is usually composed of many segments, so the OS maintains a set of segment identifiers for each process. It can also provide address-space protection.</p>
<p>Segment translation from the process address space to the global address is like the hardware scheme for address-space identifiers.</p>
<p>Segmentation is therefore analogous to having multiple address-space identifiers per processâ€”one for each segment in the user address space.</p>
<p>Address-space identifiers and segmentation interact with shared memory differently. Conceptually, shared memory acts in opposition to address-space protection schemes. </p>
<p>With address-space identifiers, this is often done by explicitly duplicating mapping information across page tables. Or by marking a shared page as visible to all processesâ€”explicitly turning off protection for that page.</p>
<p>Segments, in contrast, allow both protection and fine-grained sharing. Two processes can safely share a segment, and can do so without making segment visible to other processes.</p>
<h3 id="3ã€TLBs-revisited"><a href="#3ã€TLBs-revisited" class="headerlink" title="3ã€TLBs  revisited"></a>3ã€TLBs  revisited</h3><p>(tips: flushâ€“&gt;means to clean all.)</p>
<p>Either the OS or the hardware can refill the TLB when a TLB miss occurs.</p>
<p><strong>Hardware-managed TLB</strong>: a hardware state machine walks the page table, there is no interrupt or interaction with the instruction cache.</p>
<p><strong>Software-managed TLB</strong>: the general interrupt mechanism invokes a software TLB-miss handler â€” a primitive in the OS that is usually 10-100 instructions long. The use of the interrupt mechanism adds to the cost by flushing the pipeline, possibly removing many instructions from the reorder buffer. This can result in hundreds of cycles.</p>
<p>However, the software-managed TLB design allows the OS to choose any page table organization, whereas the hardware-managed scheme defines a page table organization for the OS. This flexibility in the software-managed scheme can outweigh its potentially higher per-miss cost .</p>
<p>The PA-7200 uses a hybrid approach,  implementing the initial probe of its hashed page table in hardware, and â€” if this initial probe fails â€” walking the rest of the page table in software.</p>
<p>TLB does not need to be flushed on process context switch unless there are globally shared pages. </p>
<p><strong>Flushing</strong> is typically required only whenever the OS reassigns an address-space identifier or segment identifier to a new process (such as at process creation), or when there are fewer address-space identifiers than currently active processes, which necessitates a temporary ID remapping. If the protection mechanism goes unused flushing is also required. </p>
<p>In most case, only those entries tagged with that address-space identifier need to be flushed.</p>
<p>OS must often <strong>invalidate the entire TLB contents</strong> or <strong>individually invalidate each entry that matches the address-space identifier.</strong> Typically, it is cheaper to invalidate all TLB contents than to maintain a list of entries to be flushed on context switch as this list will typically be large and expensive to maintain. </p>
<h3 id="å››ã€Foresight"><a href="#å››ã€Foresight" class="headerlink" title="å››ã€Foresight"></a>å››ã€Foresight</h3><p>There is wide diversity in how todayâ€™s commercial processors support memory management. However, the specific details of one processorâ€™s memory-management architecture do not seem to confer a clear performance advantage over anotherâ€™s. Why? <strong>incompatible</strong> from inadequate hardware support.</p>
<p>Virtual caches requires no address translation when the data is found in the caches are large enough, there is rarely a need to go to memory. Address translation would be performed only on the rare cache miss and could therefore afford to be expensive.</p>
<p>Instead of using hardware, the OS itself could perform virtual-memory functions â€” including address translation and protection checks â€” resulting in increased flexibility and simplifying the job of porting system software.</p>
<h3 id="äº”ã€Typical-architecture"><a href="#äº”ã€Typical-architecture" class="headerlink" title="äº”ã€Typical architecture"></a>äº”ã€Typical architecture</h3><h3 id="1ã€MIPS-Architecture"><a href="#1ã€MIPS-Architecture" class="headerlink" title="1ã€MIPS Architecture"></a>1ã€MIPS Architecture</h3><p>OS handles TLB misses entirely in software. The OS walks the page table, fills the TLB, and can implement virtually any TLB replacement policy.</p>
<p>The hardware supports a bottom-up hierarchical page table through the TLB context register, which holds a virtual address partitioned into a software-loaded segment and a hardware-loaded segment.</p>
</font>
]]></content>
      <categories>
        <category>Operating Systems</category>
      </categories>
      <tags>
        <tag>Memory Management</tag>
        <tag>Operation Systems</tag>
        <tag>Virtual Memory</tag>
      </tags>
  </entry>
  <entry>
    <title>EffectC++</title>
    <url>/myblog/2021/04/21/C/Effective%20C++%2055%20(04-12)/</url>
    <content><![CDATA[<hr>
<p>04 ç¡®å®šå¯¹è±¡ä½¿ç”¨å‰å·²ç»åˆå§‹åŒ–<br>ï¼ˆ1ï¼‰<br>ABEntry::ABEntry(const std::string&amp; name, const std::string&amp; address, const std::list<PhoneNumber>&amp; phones)<br>                :theName(name),<br>                theAddress(address),<br>                thePhones(phones),<br>                numTimesConsulted(0)<br>                {}</p>
<p>æ¯”èµ·ç»ç”±èµ‹å€¼æ“ä½œå®Œæˆçš„â€œä¼ªåˆå§‹åŒ–â€ï¼Œé€šè¿‡æˆå‘˜åˆ—åˆå€¼å®Œæˆçš„â€œçœŸæ­£åˆå§‹åŒ–â€æ›´åŠ å¯å–ã€‚ æ³¨æ„åœ¨<br>æˆå‘˜åˆå€¼åˆ—ä¸­ä½¿ç”¨æˆå‘˜æ—¶æœ€å¥½æŒ‰ç…§å…¶å£°åæ¬¡åºæ¥ä½¿ç”¨ã€‚</p>
<p>ï¼ˆ2ï¼‰<br>C++å¯¹ å®šä¹‰äºä¸åŒç¼–è¯‘å•å…ƒå†…çš„non-local staticå¯¹è±¡ çš„åˆå§‹åŒ–é¡ºåºæ²¡æœ‰æ˜ç¡®çš„å®šä¹‰</p>
<p>ä½†æ˜¯å› ä¸ºC++ä¿è¯ï¼Œå‡½æ•°å†…çš„local staticå¯¹è±¡ï¼Œåœ¨â€œå‡½æ•°è¢«è°ƒç”¨æœŸé—´â€ â€œç¬¬ä¸€æ¬¡é‡åˆ°è¯¥å¯¹è±¡çš„å®šä¹‰å¼â€ çš„æ—¶å€™<br>åˆå§‹åŒ–ï¼Œæ‰€ä»¥ç”¨å‡½æ•°è°ƒç”¨æ›¿æ¢æ‰ç›´æ¥è°ƒç”¨å¯¹è±¡å¯ä»¥ä¿è¯åˆå§‹åŒ–çš„é¡ºåºã€‚å¹¶ä¸”è¿™æ ·ä½¿ç”¨å¯ä»¥å‡å°‘æ„é€ å’Œææ„çš„æ¬¡æ•°<br>e.g.</p>
<p>class FileSystem<br>{<br>public:<br>    std::size_t numDisks() const;<br>};<br>extern FileSystem tfs;</p>
<p>class Directory<br>{<br>public:<br>    Directory(params);<br>};</p>
<p>Directory::Directory(params)<br>{<br>    std::size_t disks = tfs.numDisks();<br>}</p>
<p>æ­¤æ—¶ç”¨æˆ·åˆ›å»ºä¸€ä¸ª Directory å¯¹è±¡ï¼Œæ¥æ”¾ä¸´æ—¶æ–‡ä»¶<br>Directory tempDir(params);</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±æŒ‰ç…§å‰é¢æ‰€æè¿°çš„æƒ…å†µæ¥ä½¿ç”¨ï¼Œå¤§æ¦‚æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>class FileSystem {};<br>FileSystem &amp;tfs()  // ç±»ä¼¼ä¸€ç§ä»¿çœŸå‡½æ•°<br>{<br>    static FileSystem fs;<br>    return fs;<br>}<br>class Directory {};<br>Directory::Directory(params)<br>{<br>    std::size_t disks = tfs().numDisks(); // å°† tfs.numDisks() æ”¹ä¸º tfs().numDisks()<br>}<br>Directory&amp; tempDir() // ç°åœ¨ç”¨ Directory&amp; tempDir() å‡½æ•°æ¥æ›¿æ¢ tempDir å¯¹è±¡<br>{<br>    static Directory td;<br>    return td;<br>}</p>
<p>ä¸ºäº†é¿å…â€œè·¨å•å…ƒç¼–è¯‘ä¹‹åˆå§‹åŒ–â€é—®é¢˜ï¼Œæœ€å¥½ç”¨local staticå¯¹è±¡ æ›¿æ¢non-local staticå¯¹è±¡ã€‚</p>
<hr>
<p>05 äº†è§£ç¼–è¯‘å™¨é»˜é»˜ç¼–å†™å¹¶è°ƒç”¨äº†å“ªäº›å‡½æ•°</p>
<p>default æ„é€ å‡½æ•°<br>copy æ„é€ å‡½æ•°<br>copy assignment æ“ä½œç¬¦<br>ææ„å‡½æ•°</p>
<hr>
<p>06 è‹¥ä¸æƒ³ä½¿ç”¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°ï¼Œå°±åº”è¯¥æ˜ç¡®æ‹’ç»</p>
<p>æ–¹æ³•ä¸€ï¼š å°†å…¶ copy æ„é€ å‡½æ•° å’Œ copy assignment æ„é€ å‡½æ•°å£°æ˜ä¸º private è€Œä¸”ä¸éœ€è¦å°†å…¶å®šä¹‰<br>ï¼ˆå› ä¸ºä¸ä¼šä½¿ç”¨ï¼‰<br>class NoCopyable<br>{<br>public:<br>    â€¦<br>private:<br>    NoCopyable(const NoCopyable&amp;);<br>    NoCopyable&amp; operator=(const NoCopyable&amp;);<br>};</p>
<p>æ–¹æ³•äºŒï¼š ä¸ºäº†èƒ½åœ¨ç¼–è¯‘æœŸé—´æ‰¾åˆ°é”™è¯¯ï¼Œå¯ä»¥æ„é€ ä¸€ä¸ªä¸“é—¨é˜»æ­¢copyingåŠ¨ä½œçš„ base classã€‚<br>class Uncopyable<br>{<br>protected:<br>    Uncopyable();<br>    ~Uncopyable(); //å…è®¸derivedå¯¹è±¡æ„é€ å’Œææ„<br>private:<br>    Uncopyable(const Uncopyable&amp;);<br>    Uncopyable&amp; operator=(const Uncopyable&amp;);<br>};</p>
<p>ä½¿ç”¨æ—¶è‡ªéœ€è¦ç»§æ‰¿å®ƒå³å¯<br>class HomeForSale: private Uncopyable<br>{<br>    //     ä¸éœ€è¦æä¾› copy å’Œ assigned copy å‡½æ•°<br>};</p>
<hr>
<p>07 ä¸ºå¤šæ€åŸºç±»å£°æ˜ virtual ææ„å‡½æ•°</p>
<p>class TimeKeeper<br>{<br>public:<br>    TimeKeeper();<br>    ~TimeKeeper();<br>};</p>
<p>class AtomicClock: public TimeKeeper {};<br>class WaterClock: public TimeKeeper {};<br>class WristWatch: public TimeKeeper {};</p>
<p>TimeKeeper* getTimekeeper();</p>
<p>TimeKeeper* ptk = getTimekeeper();<br>â€¦<br>delete ptk;<br>// è¿™é‡ŒgetTimeKeeper() è¿”å›çš„æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª derived class å¯¹è±¡, ä½†æ˜¯è¯¥å¯¹è±¡å´ç»ç”±ä¸€ä¸ª<br>// bass class æŒ‡é’ˆæ¥åˆ é™¤ï¼Œå½“å‰bass class åªæœ‰ä¸€ä¸ª non-virtual ææ„å‡½æ•°ï¼Œå¯¼è‡´å…¶ç»“æœ<br>// æœªå®šä¹‰ã€‚ äº§ç”Ÿè¯¡å¼‚çš„ â€œå±€éƒ¨é”€æ¯å¯¹è±¡â€ï¼</p>
<p>è§£å†³åŠæ³•ï¼š å°†å…¶bass classçš„ææ„å‡½æ•°å£°æ˜ä¸º virtual<br>class TimerKeeper<br>{<br>public:<br>    TimerKeeper();<br>    virtual ~TimerKeeper();<br>};<br>TimerKeeper* ptk = getTimekeeper();<br>â€¦<br>delete ptk;</p>
<p>Tips: å¦‚æœä¸€ä¸ª class ä¸å« virtual å‡½æ•°ã€‚è¯´æ˜å®ƒå¹¶ä¸å¸Œæœ›è¢«ä½œä¸ºä¸€ä¸ª bass class æ¥ä½¿ç”¨ã€‚<br>è‹¥æ­¤æ—¶å†å°†å…¶ææ„å‡½æ•°å£°æ˜ä¸º virtual æ˜¯éå¸¸ä¸åˆé€‚çš„ã€‚ å°†ä¸€ä¸ªå‡½æ•°å£°æ˜ä¸º virtual çš„æ—¶å€™<br>ä¼šæ”¹å˜è¯¥classçš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ä¸”é™ä½å…¶å¯ç§»æ¤æ€§ï¼Œé€šç”¨æ€§ã€‚<br>é€šå¸¸åªæœ‰å½“classå†…è‡³å°‘æœ‰ä¸€ä¸ªè™šå‡½æ•°çš„æ—¶å€™ï¼Œæ‰å°†å…¶ææ„å‡½æ•°å£°æ˜ä¸º virtual</p>
<p>ç»™bass class ä¸€ä¸ª virtual ææ„å‡½æ•°ï¼Œè¿™ä¸ªè§„åˆ™åªé€‚ç”¨äºpolymorphic base class ä¸Šï¼Œ<br>è¿™ç±»classesçš„è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†é€šè¿‡bass class æ¥å£æ¥å¤„ç† derived class å¯¹è±¡ã€‚ å…¶å®ƒçš„classes<br>å°±ä¸åº”è¯¥å£°æ˜ virtual ææ„å‡½æ•°ã€‚</p>
<p>polymorphic base classes åº”è¯¥å£°æ˜ä¸€ä¸ª virtual  ææ„å‡½æ•°ã€‚å¦‚æœ class å¸¦ä»»ä½• virtual å‡½æ•°ï¼Œ<br>å®ƒå°±åº”è¯¥æ‹¥æœ‰ä¸€ä¸ª virtual ææ„å‡½æ•°ã€‚</p>
<hr>
<p>08 åˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•°</p>
<p>å½“ä½¿ç”¨ä¸‹é¢è¿™ä¸ªç±»æ¥ç®¡ç† DBConnection å¯¹è±¡;</p>
<p>class DBConn<br>{<br>public:<br>    â€¦<br>    ~DBConn()<br>    {<br>        db.close();     // ç¡®ä¿æ•°æ®åº“æ€»æ˜¯ä¼šè¢«å…³é—­ã€‚<br>    }<br>private:<br>    DBConnection db;<br>}</p>
<p>å¦‚æœ <code>~DBConn()</code> è°ƒç”¨æ­£å¸¸é‚£ä¹ˆä¾¿ä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯åªè¦æ²¡æœ‰è°ƒç”¨ <code>~DBConn()</code> é‚£ä¹ˆè¯¥ææ„å‡½æ•°ä¾¿ä¼š<br>ä¼ æ’­è¯¥å¼‚å¸¸ï¼Œå…è®¸å…¶ç¦»å¼€è¿™ä¸ªææ„å‡½æ•°ã€‚<br>æœ‰ä»¥ä¸‹ä¸¤ç§è§£å†³åŠæ³•ï¼š<br>1ï¼šå¦‚æœ close() æŠ›å‡ºå¼‚å¸¸å°±ç»“æŸç¨‹åºï¼Œé‚£ä¹ˆå°±é€šè¿‡è°ƒç”¨ abort() æ¥å®Œæˆ;<br>DBConn::~DBConn()<br>{<br>    try { db.close(); }<br>    catch (â€¦)<br>    {<br>        // åˆ¶ä½œè¿è½¬è®°å½•ï¼Œè®°å½•ä¸‹ close() çš„è°ƒç”¨å¤±è´¥<br>        std::abort();<br>    }<br>}<br>é˜»æ­¢å¼‚å¸¸ä» close() ä¼ æ’­å‡ºå»ï¼Œè°ƒç”¨ abort() æŠ¢å…ˆå°†â€œä¸æ˜ç¡®è¡Œä¸ºâ€ç½®äºæ­»åœ°</p>
<p>2ï¼šåä¸‹å› ä¸ºè°ƒç”¨ close() è€Œäº§ç”Ÿçš„å¼‚å¸¸<br>DBConn::~DBConn()<br>{<br>    try { db.close(); }<br>    catch (â€¦)<br>    {<br>        // åˆ¶ä½œè¿è½¬è®°å½•ï¼Œè®°å½•ä¸‹ close() çš„è°ƒç”¨å¤±è´¥<br>    }<br>}<br>è¯¥æ–¹æ³•ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯ç¨‹åºåœ¨é‡åˆ°å¼‚å¸¸æ—¶è¿˜èƒ½ç»§ç»­è¿è¡Œä¸‹å»è€Œåšçš„å¦¥åï¼Œå½“ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚<br>è¿™ä¸¤ç§æƒ…å†µéƒ½ä¸èƒ½å¯¹â€œå¯¼è‡´close()â€æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µåšå‡ºååº”</p>
<p>æœ€å¥½çš„è®¾è®¡æ–¹æ³•è¿˜æ˜¯æä¾›ä¸€ä¸ª close() å‡½æ•°ç»™å®¢æˆ·ä¸€ä¸ªè‡ªå·±å¤„ç†å‘ç”Ÿå¼‚å¸¸çš„ã€‚ å½“ç”¨æˆ·å®åœ¨æ˜¯ä¸æƒ³è‡ªå·±<br>å¤„ç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†ä½¿ç”¨ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p>class DBConn<br>{<br>public:<br>    â€¦<br>    void close()<br>    {<br>        db.close();<br>        closed = true;<br>    }<br>    ~DBConn()<br>    {<br>        if (!ifclose())<br>        {<br>            try<br>            {<br>                db.close();<br>            }<br>            catch (â€¦)<br>            {<br>                // åˆ¶ä½œè¿è½¬è®°å½•ï¼Œè®°å½•ä¸‹ close() çš„è°ƒç”¨å¤±è´¥<br>            }<br>        }<br>    }<br>private:<br>    DBConnection db;<br>    bool closed;<br>}</p>
<p><strong>** ææ„å‡½æ•°ç»å¯¹ä¸è¦åå‡ºå¼‚å¸¸ **</strong></p>
<hr>
<p>09 ç»ä¸åœ¨æ„é€ å’Œææ„è¿‡ç¨‹ä¸­è°ƒç”¨ virtual å‡½æ•°</p>
<p>class Transaction<br>{<br>public:<br>    Transaction();<br>    virtual void logTransaction() const = 0;<br>    â€¦<br>};<br>Transaction::Transaction<br>{<br>    â€¦<br>    logTransaction();<br>}<br>class BuyTransaction: public Transaction<br>{<br>public:<br>    virtual void logTransaction() const;<br>    â€¦<br>};<br>class SellTransaction: public Transaction<br>{<br>public:<br>    virtual void logTransaction() const;<br>};</p>
<p>å½“è¿è¡Œ BuyTransaction b;</p>
<p>æ—¶è°ƒç”¨çš„ logTransaction() çš„ç‰ˆæœ¬ä¸æ˜¯ BuyTransaction çš„ç‰ˆæœ¬è€Œæ˜¯ Transaction çš„ç‰ˆæœ¬ï¼›<br>åŸå› æ—¶ç”±äº base class åœ¨æ„é€ çš„æ—¶å€™å…¶ virtual å‡½æ•°ä¸ä¼šä¸‹é™åˆ° derived class é˜¶å±‚ã€‚ å…¶<br>å¯¹è±¡çš„è¡Œä¸ºå°±ä¼šç±»ä¼¼éš¶å±äº base ç±»å‹ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ææ„å’Œæ„é€ çš„æ—¶å€™ï¼Œvirtual å‡½æ•°ä¸æ˜¯<br>virtual;</p>
<p>base class çš„æ„é€ å‡½æ•°ä¼šå…ˆäº derived class æ„é€ å‡½æ•°ã€‚ åœ¨ base class æ„é€ å®Œæˆçš„æ—¶å€™<br>derived class è¿˜æ²¡æœ‰æ„é€ ï¼Œåœ¨C++ä¸­ç»å¯¹ä¸èƒ½è¦æ±‚ä½¿ç”¨å¯¹è±¡å†…éƒ¨å°šæœªåˆå§‹åŒ–çš„éƒ¨åˆ†ã€‚æ‰€ä»¥æ­¤æ—¶<br>bass class çš„ virtual å‡½æ•°ç»å¯¹ä¸ä¼šä¸‹é™åˆ° derived class é˜¶å±‚ã€‚</p>
<p>åŠå¯¹è±¡åœ¨ derived class çš„æ„é€ å‡½æ•°å¼€å§‹ä¹‹å‰ä¸ä¼šæˆä¸ºä¸€ä¸ª derived class å¯¹è±¡</p>
<p>è§£å†³æ–¹æ³•</p>
<p>class Transaction<br>{<br>public:<br>    explicit Transaction(const std::string&amp; logInfo);<br>    void logTransaction(const std::string&amp; logInfo) const; // ç°åœ¨æ˜¯ä¸€ä¸ª non-vitrual å‡½æ•°<br>};</p>
<p>Transaction::Transaction(const std::string&amp; logInfo)<br>{<br>    â€¦<br>    logTransaction(logInfo); // è®© derived class æ„é€ å‡½æ•°ä¼ é€’å¿…è¦ä¿¡æ¯ç»™ Transaction æ„é€ å‡½æ•°<br>                             // ç„¶åä¾¿å¯ä»¥å®‰å…¨çš„è°ƒç”¨ non-virtual logTransaction<br>}</p>
<p>class BuyTransaction<br>{<br>public:<br>    BuyTransaction(parameters)<br>    : Transaction(createLogString(parameters))  // å°† log ä¿¡æ¯ä¼ é€’ç»™ base class æ„é€ å‡½æ•°<br>    { â€¦ }<br>    â€¦<br>private:<br>    static std::string createLogString(parameters);<br>}</p>
<p>åœ¨æ„é€ å’Œææ„æœŸé—´ä¸è¦è°ƒç”¨ virtual å‡½æ•°</p>
<hr>
<p>10 ä»¤ operator= è¿”å›ä¸€ä¸ª reference to *this</p>
<p>ä¸ºäº†èƒ½å®ç°è¿é”èµ‹å€¼ï¼Œèµ‹å€¼æ“ä½œç¬¦å¿…é¡»è¿”å›ä¸€ä¸ª reference æŒ‡å‘æ“ä½œç¬¦å·¦ä¾§çš„å®å‚ã€‚<br>ä»¤èµ‹å€¼æ“ä½œç¬¦è¿”å›ä¸€ä¸ª reference to *this</p>
<p>class Widget<br>{<br>public:<br>    â€¦<br>    Widget&amp; operator+=(const Widget&amp; rhs)<br>    {<br>        â€¦<br>        return *this;<br>    }<br>    Widget&amp; operator=(int rhs)<br>    {<br>        â€¦<br>        return *this;<br>    }<br>} </p>
<hr>
<p>11 åœ¨ operator= ä¸­å¤„ç† â€œè‡ªæˆ‘èµ‹å€¼â€</p>
<p>è‡ªæˆ‘èµ‹å€¼çš„æƒ…å†µå¦‚ä¸‹ï¼š<br>class Widget { â€¦ };<br>Widget w;<br>â€¦<br>w = w;</p>
<p>è¿™ç§æƒ…å†µçœ‹ä¸Šå»éå¸¸å¥‡æ€ªï¼Œä½†æ˜¯ç¼–è¯‘å™¨å¹¶ä¸ä¼šé˜»æ­¢ï¼Œè€Œä¸”å­˜åœ¨å¾ˆå¤šçš„ â€œæ½œåœ¨è‡ªæˆ‘èµ‹å€¼â€ å½¢å¼ï¼Œå¦‚ä¸‹ï¼š<br>1.a[i] = a[j]; // i == j<br>2.*px = *py;   // px py å¯èƒ½æŒ‡å‘åŒä¸€ä¸ªä¸œè¥¿<br>3.class Base { â€¦ };<br>  class Derived: public Base { â€¦ };<br>  void doSomething (const Base&amp; rb, Derived *pd); // rb å’Œ pd æœ‰å¯èƒ½æ˜¯æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨C++è‡ªå·±æä¾›çš„èµ„æºç®¡ç†å¯¹è±¡çš„æ—¶å€™æ˜¯â€œè‡ªæˆ‘èµ‹å€¼å®‰å…¨â€çš„ï¼Œä½†æ˜¯å½“å†³å®šè‡ªå·±å†™ä¸€ä¸ª<br>èµ„æºç®¡ç†å¯¹è±¡çš„æ—¶å€™ï¼Œå¾ˆæœ‰å¯èƒ½çŠ¯ã€€â€œåœ¨åœæ­¢ä½¿ç”¨èµ„æºå‰æ„å¤–é‡Šæ”¾â€ã€€çš„é”™è¯¯ï¼Œè¯¥æƒ…å†µå¦‚ä¸‹ï¼š<br>class Bitmap { â€¦ };<br>class Widget<br>{<br>    â€¦<br>private:<br>    Bitmap* pb;<br>}</p>
<p>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>    delete pb;                    // åœæ­¢å½“å‰çš„bitmap<br>    pb = new Bitmap(*rhs.pb);    // ä½¿ç”¨ rhsâ€™s bitmap å‰¯æœ¬<br>    return *this;<br>}</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ rhs å’Œ bp å¯èƒ½æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œè¿™æ—¶ï¼Œå¦‚æœ delete pb åˆ™å¯èƒ½åŒæ—¶ delete äº† rhs<br>å¯¼è‡´æœ€å return *this; æŒ‡å‘äº†ä¸€å—å·²ç»è¢«åˆ é™¤äº†çš„åŒºåŸŸï¼Œè¿™æ˜¯éå¸¸å±é™©çš„æ“ä½œï¼ï¼</p>
<p>ä¼ ç»Ÿçš„è§£å†³æ–¹æ³•å¦‚ä¸‹æ˜¯ï¼Œåœ¨ operator= ä¸­æ·»åŠ  â€œè®¤åŒæµ‹è¯•â€</p>
<p>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>    if (this == &amp;rhs) return *this; // æ£€æŸ¥è¿™ä¸¤æŒ‡é’ˆæ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡<br>    delete pb;<br>    pb = new Bitmap(*rhs.pb);<br>    return *this;<br>}</p>
<p>è™½ç„¶è¿™ä¸ªç‰ˆæœ¬å¤„ç†äº† â€œèµ‹å€¼å®‰å…¨æ€§â€ ä½†æ˜¯åœ¨ â€œå¼‚å¸¸å®‰å…¨æ€§â€ ä¸Šå´å®Œå…¨æ²¡æœ‰åŠæ³•ã€‚ å¦‚æœ new Bitmap<br>å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆWidgetæœ€ç»ˆè¿˜æ˜¯ä¼šæŒ‡å‘ä¸€å—è¢«åˆ é™¤äº†çš„ Bitmap;</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œå¦‚æœå¤„ç†å®Œäº†â€œå¼‚å¸¸å®‰å…¨æ€§â€é‚£ä¹ˆWidgetä¼šè‡ªåŠ¨è·å¾— â€œè‡ªæˆ‘èµ‹å€¼å®‰å…¨æ€§â€</p>
<p>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>    Bitmap* pOrig = pb;                // å…ˆè®°ä½åŸå…ˆçš„ pb<br>    pb = new Bitmap(*rhs.pb);        // ä»¤ pb æŒ‡å‘ä¸€ä¸ª *pb çš„å‰¯æœ¬<br>    delete pOrig;                    // åˆ é™¤åŸæ¥çš„ pb<br>    return *this;<br>} </p>
<p>è¿™ç§æƒ…å†µä¸‹è™½ç„¶è·å¾—äº†ä¸¤ä¸ªå®‰å…¨æ€§ï¼Œä½†æ˜¯å´æœ‰äº†æ€§èƒ½ä¸Šçš„æŸå¤±ã€‚<br>ä½¿ç”¨ copy and swap æŠ€æœ¯<br>class Widget<br>{<br>    â€¦<br>    void swap(Widget&amp; rhs);<br>    â€¦<br>};<br>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>    Widget temp(rhs);   // ä¸ºrhsæ•°æ®åˆ¶ä½œä¸€ä»½é™„ä»¶<br>    swap(temp);            // å°† *this æ•°æ®å’Œä¸Šè¿°é™„ä»¶çš„æ•°æ®äº¤æ¢<br>    return *this;<br>}</p>
<p>ç¡®ä¿å½“å¯¹è±¡è‡ªæˆ‘å¤åˆ¶çš„æ—¶å€™ operator= æœ‰è‰¯å¥½è¡Œä¸ºã€‚</p>
<hr>
<p>12 å¤åˆ¶å¯¹è±¡æ—¶å‹¿å¿˜å…¶æ¯ä¸€éƒ¨åˆ†çš„ç»„æˆ </p>
<p>class Date { â€¦ };<br>class Customer<br>{<br>public:<br>    â€¦<br>private:<br>    std::string name;<br>    Date lastTransaction;<br>};</p>
<p>åœ¨è¿™ç§æƒ…å†µçš„ç±»çš„ç»“æ„ä¸‹ï¼Œä¸€æ—¦å‘ç”Ÿç»§æ‰¿å°†ä¼šäº§ç”Ÿéå¸¸å±é™©çš„ç»“æœ:</p>
<p>class PriorityCustomer: public Customer<br>{<br>public:<br>    â€¦<br>    PriorityCustomer(const PriorityCustomer&amp; rhs);<br>    PriorityCustomer&amp; operator=(const PriorityCustomer&amp; rhs);<br>    â€¦<br>private:<br>    int priority;<br>};</p>
<dl><dt>PriorityCustomer::PriorityCustomer(const PriorityCustomer&amp; rhs)</dt><dd>priority(rhs.priority)<br>{<br>    logCall(â€œâ€¦â€);<br>}<br>PriorityCustomer&amp; PriorityCustomer::PriorityCustomer operator=<br>(const PriorityCustomer&amp; rhs)<br>{<br>    logCall(â€œâ€¦â€);<br>    priority = rhs.priority;<br>    return *this;<br>}</dd></dl><p>æ³¨æ„ï¼Œè¿™é‡Œçš„copyæ„é€ å‡½æ•°å¹¶æ²¡æœ‰æŒ‡å®šå®å‚ä¼ é€’ç»™ base class çš„æ„é€ å‡½æ•°ã€‚<br>å› æ­¤ PriorityCustomer å¯¹è±¡çš„ Customer æˆåˆ†ä¼šè¢« Customer çš„ default æ„é€ å‡½æ•°<br>è¿›è¡Œç¼ºçœçš„åˆå§‹åŒ–ã€‚</p>
<p>æ‰€ä»¥åœ¨ä»»ä½•æ—¶å€™ï¼Œåªè¦æ‰¿æ‹…äº†ä¸º derived class æ’°å†™ copying å‡½æ•°çš„é‡å¤§è´£ä»»ï¼Œæˆ‘ä»¬å¿…é¡»<br>å°å¿ƒçš„å¤åˆ¶å…¶ base class æˆåˆ†ï¼</p>
<dl><dt>PriorityCustomer::PriorityCustomer(const PriorityCustomer&amp; rhs)</dt><dd>Customer(rhs),             // è°ƒç”¨ base class çš„ copy æ„é€ å‡½æ•°<br>  priority(rhs.priority)<br>{<br>    logCall(â€œâ€¦â€);<br>}</dd></dl><p>PriorityCustomer&amp; PriorityCustomer::operator=(const PriorityCustomer&amp; rhs)<br>{<br>    logCall(â€œâ€¦â€);<br>    Customer::operator=(rhs);        // å¯¹ base class è¿›è¡Œèµ‹å€¼<br>    priority = rhs.priority;<br>    return *this;<br>}</p>
<p>tips: ä¸è¦å°è¯•ç”¨æŸä¸ª copying å‡½æ•°å®ç°å¦ä¸€ä¸ª copying å‡½æ•°ã€‚å¦‚æœç¡®å®æƒ³è¦ç²¾ç®€ä»£ç ï¼Œé‚£ä¹ˆå°†<br>å…¶å…±åŒçš„æœºèƒ½æ”¾å…¥ç¬¬ä¸‰ä¸ªå‡½æ•°ä¸­ï¼Œå¹¶ç”±ä¸¤ä¸ª copying å‡½æ•°å…±åŒè°ƒç”¨ã€‚</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆå§‹åŒ– Direct3D 12</title>
    <url>/myblog/2021/04/19/C/%E5%88%9D%E5%A7%8B%E5%8C%96%20Direct3D/</url>
    <content><![CDATA[<h2 id="åˆå§‹åŒ–-Direct3D"><a href="#åˆå§‹åŒ–-Direct3D" class="headerlink" title="åˆå§‹åŒ– Direct3D"></a>åˆå§‹åŒ– Direct3D</h2><h3 id="å¯¹-DX3D-çš„åˆå§‹åŒ–åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š"><a href="#å¯¹-DX3D-çš„åˆå§‹åŒ–åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š" class="headerlink" title="å¯¹ DX3D çš„åˆå§‹åŒ–åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š"></a>å¯¹ DX3D çš„åˆå§‹åŒ–åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</h3><ol>
<li>ç”¨ D3D12CreateDevice å‡½æ•°åˆ›å»º ID3D12Device æ¥å£å®ä¾‹</li>
<li>åˆ›å»ºä¸€ä¸ª ID3D12Fence å¯¹è±¡ï¼Œå¹¶æŸ¥è¯¢æè¿°ç¬¦çš„å¤§å°</li>
<li>æ£€æŸ¥ç”¨æˆ·å¯¹ 4X MSAA è´¨é‡çº§åˆ«çš„æ”¯æŒæƒ…å†µ</li>
<li>ä¾æ¬¡åˆ›å»ºå‘½ä»¤é˜Ÿåˆ—ã€å‘½ä»¤åˆ—è¡¨åˆ†é…å™¨å’Œä¸»å‘½ä»¤åˆ—è¡¨</li>
<li>æè¿°å¹¶åˆ›å»ºäº¤æ¢é“¾</li>
<li>åˆ›å»ºåº”ç”¨ç¨‹åºæ‰€éœ€çš„æè¿°ç¬¦å †</li>
<li>è°ƒæ•´åå°ç¼“å†²åŒºçš„å¤§å°ï¼Œå¹¶ä¸ºå®ƒåˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾</li>
<li>åˆ›å»ºæ·±åº¦/æ¨¡æ¿ç¼“å†²åŒºåŠä¸ä¹‹å…³è”çš„æ·±åº¦/æ¨¡æ¿è§†å›¾</li>
<li>è®¾ç½®çª—å£(viewport)å’Œå‰ªè£çŸ©å½¢(scissor rectangle)</li>
</ol>
<h3 id="1-åˆ›å»ºè®¾å¤‡"><a href="#1-åˆ›å»ºè®¾å¤‡" class="headerlink" title="1. åˆ›å»ºè®¾å¤‡"></a>1. åˆ›å»ºè®¾å¤‡</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">HRESULT WINAPI <span class="title">D3D12CreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	IUnknown* pAdapter,</span></span></span><br><span class="line"><span class="function"><span class="params">    D3D_FEATURE_LEVEL MinimumFeatureLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">    REFIID riid,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span>** getDevice)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>pAdapter</code> :æŒ‡å®šåˆ›å»ºè®¾å¤‡æ—¶ä½¿ç”¨çš„æ˜¾ç¤ºé€‚é…å™¨ï¼Œnullper ä»£è¡¨é»˜è®¤ä½¿ç”¨ä¸»æ˜¾ç¤ºé€‚é…å™¨</p>
<p><code>MinimumFeatureLevel</code> :ç¨‹åºæ‰€éœ€è¦ç¡¬ä»¶æ”¯æŒçš„æœ€ä½åŠŸèƒ½çº§åˆ« (è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ D3D_FEATURE_LEVEL_11_0)</p>
<p><code>riid</code> :åˆ›å»ºçš„ ID3D12Device æ¥å£çš„ COM ID</p>
<p><code>ppDevice</code> :è¿”å›æ‰€åˆ›å»ºçš„ Direct3D 12 è®¾å¤‡</p>
<p><em>å‡½æ•°è°ƒç”¨ç¤ºä¾‹</em>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG)	||	defined(_DEBUG)</span></span><br><span class="line"><span class="comment">// å¯ç”¨ D3D12 çš„è°ƒè¯•å±‚</span></span><br><span class="line">&#123;</span><br><span class="line">	ComPtr&lt;ID3D12Debug&gt; debugController;</span><br><span class="line">    ThrowIfFailed(D3D12GetDebugInterface(IID_PPV_ARGS(&amp;debugcontroller)));</span><br><span class="line">    debugController-&gt;EnableDebugLayer();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">ThorwIfFailed(CreateDXGIFactory1(IID_PPV_ARGS(&amp;mdxgiFactory)));</span><br><span class="line"><span class="comment">// å°è¯•åˆ›å»ºç¡¬ä»¶è®¾å¤‡</span></span><br><span class="line">HRESULT hardwareResult = D3D12CreateDevice(</span><br><span class="line">	<span class="literal">nullptr</span>, <span class="comment">// ä½¿ç”¨é»˜è®¤é€‚é…å™¨</span></span><br><span class="line">    D3D_FEATURE_LEVEL_11_0,</span><br><span class="line">    IID_PPV_ARGS(&amp;md3dDevice));</span><br><span class="line"><span class="comment">// å›é€€åˆ° WARP è®¾å¤‡</span></span><br><span class="line"><span class="keyword">if</span> (Failed(hardwareResult))</span><br><span class="line">&#123;</span><br><span class="line">	ComPtr&lt;IDXGIAdapter&gt; pWarpAdapter; <span class="comment">// IID_PPV_ARGS() è¾…åŠ©å‡½æ•° å¤§å¤šæ•°æ—¶å€™æ˜¯å°† ppType ç±»å‹å¼ºåˆ¶è½¬æ¢ä¸º void** ç±»å‹çš„</span></span><br><span class="line">    								<span class="comment">// å¾…åˆ›å»ºæ¥å£ COM ID</span></span><br><span class="line">    ThrowIfFailed(mdxgiFactory-&gt;EnumWarpAdapter(IID_PPV_ARGS(&amp;pWrapAdapter)));</span><br><span class="line">    </span><br><span class="line">    ThrowIfFailed(D3D12CreateDevice(</span><br><span class="line">    	pWarpAdapter.Get(),</span><br><span class="line">        D3D_FEATURE_LEVEL_11_0,</span><br><span class="line">        IID_PPV_ARGS(&amp;md3dDevice()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“è°ƒç”¨ D3D12CreateDevice å¤±è´¥åï¼Œä¼šå›é€€åˆ° WARP <code>Windows Advanced Rasterization Platform</code> (Windows é«˜çº§å…‰æ …åŒ–å¹³å°)ã€‚</p>
<p><em>åˆ›å»º WARP é€‚é…å™¨</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…ˆåˆ›å»ºä¸€ä¸ª IDXGIFactory4 å¯¹è±¡ï¼Œé€šè¿‡å…¶æ¥æšä¸¾ WARP é€‚é…å™¨</span></span><br><span class="line">ComPtr&lt;IDXGIFactory4&gt; mdxgiFactory;</span><br><span class="line">CreateDXGIFactory1(IID_PPV_ARGS(&amp;mdxgiFactory));</span><br><span class="line">mdxgiFactory-&gt;EnumWrapAdapter(IID_PPV_ARGS(&amp;pWarpAdapter));</span><br><span class="line"><span class="comment">// ä½œä¸º DXGI çš„ä¸€éƒ¨åˆ† mdxgiFactory ä¹Ÿå¯ä»¥ç”¨äºåˆ›å»ºäº¤æ¢é“¾</span></span><br></pre></td></tr></table></figure>



<h3 id="2-åˆ›å»ºå›´æ å¹¶è·å–æè¿°ç¬¦çš„å¤§å°"><a href="#2-åˆ›å»ºå›´æ å¹¶è·å–æè¿°ç¬¦çš„å¤§å°" class="headerlink" title="2. åˆ›å»ºå›´æ å¹¶è·å–æè¿°ç¬¦çš„å¤§å°"></a>2. åˆ›å»ºå›´æ å¹¶è·å–æè¿°ç¬¦çš„å¤§å°</h3><p>åˆ›å»ºå¥½è®¾å¤‡ä¹‹åï¼Œå°±å¯ä»¥ä¸º CPU/GPU çš„åŒæ­¥æ¥åˆ›å»ºâ€å›´æ â€(Fence)äº†ã€‚</p>
<p><em>åˆ›å»ºå›´æ å¯¹è±¡å¦‚ä¸‹</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::CreateFence</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	UINT64 InitialValue,</span></span></span><br><span class="line"><span class="function"><span class="params">    D3D12_FENCE_FLAGS Flags,</span></span></span><br><span class="line"><span class="function"><span class="params">    REFIID riid,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> **ppFence)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">ThrowIfFailed(md3dDevice-&gt;createFence(</span><br><span class="line">	<span class="number">0</span>, D3D12_FENCE_FLAG_NONE, IID_PPV_ARGS(&amp;mFence)));</span><br><span class="line">mRtvDescriptorSize = md3dDevice-&gt;GetDescriptorHandleIncrementSize(</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br><span class="line">mDsvDescriptorSize = md3dDevice-&gt;GetDescriptorHandleIncrementSize(</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_TYPE_DSV);</span><br><span class="line">mCbvDescriptorSize = md3dDevice-&gt;GetDescriptorHandleIncrementSize(</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV);</span><br></pre></td></tr></table></figure>

<p>æè¿°ç¬¦åœ¨ä¸åŒçš„ GPU å¹³å°ä¸Šå¤§å°å„å¼‚ï¼Œæˆ‘ä»¬åœ¨æŸ¥è¯¢ç›¸å…³ä¿¡æ¯åï¼Œå°†å…¶ç¼“å­˜èµ·æ¥ï¼Œéœ€è¦æ—¶ç›´æ¥å¼•ç”¨ã€‚</p>
<h3 id="3-æ£€æµ‹å¯¹-4X-MSAA-è´¨é‡çº§åˆ«çš„æ”¯æŒ"><a href="#3-æ£€æµ‹å¯¹-4X-MSAA-è´¨é‡çº§åˆ«çš„æ”¯æŒ" class="headerlink" title="3. æ£€æµ‹å¯¹ 4X MSAA è´¨é‡çº§åˆ«çš„æ”¯æŒ"></a>3. æ£€æµ‹å¯¹ 4X MSAA è´¨é‡çº§åˆ«çš„æ”¯æŒ</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">D3D12_FEATURE_DATA_MULTISAMPLE_QUALITY_LEVELS msQualityLevels;</span><br><span class="line">msQualityLevels.Format = mBackBufferFormat;</span><br><span class="line">msQualityLevels.SampleCount = <span class="number">4</span>;</span><br><span class="line">msQualityLevels.Flags = D3D12_MULITISAMPLE_QUALITY_LEVELS_FLAG_NONE;</span><br><span class="line">msQualityLevels.NumQualityLevels = <span class="number">0</span>;</span><br><span class="line">ThrowIfFail(md3dDevice-&gt;CheckFeatureSupport(</span><br><span class="line">	D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS,</span><br><span class="line">	&amp;msQualityLevels,</span><br><span class="line">	<span class="keyword">sizeof</span>(msQualityLevels)));</span><br><span class="line">m4xMsaaQuality = msQualityLevels.NumQualityLevels;</span><br><span class="line">assert(m4xMsaaQuality &gt; <span class="number">0</span> &amp;&amp; <span class="string">&quot;Unexcepted MSAA quality level.&quot;</span>); <span class="comment">// è¿”å›å€¼å¿…é¡»å¤§äº 0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-åˆ›å»ºå‘½ä»¤é˜Ÿåˆ—å’Œå‘½ä»¤åˆ—è¡¨"><a href="#4-åˆ›å»ºå‘½ä»¤é˜Ÿåˆ—å’Œå‘½ä»¤åˆ—è¡¨" class="headerlink" title="4. åˆ›å»ºå‘½ä»¤é˜Ÿåˆ—å’Œå‘½ä»¤åˆ—è¡¨"></a>4. åˆ›å»ºå‘½ä»¤é˜Ÿåˆ—å’Œå‘½ä»¤åˆ—è¡¨</h3><p>ä¸‹é¢æ˜¯å¸¸ç”¨çš„æ¥å£</p>
<p><code>ID3D12CommandQueue</code> : å‘½ä»¤é˜Ÿåˆ—</p>
<p><code>ID3D12CommandAllocator</code> : å‘½ä»¤åˆ†é…å™¨</p>
<p><code>ID3D12GraphicsCommandList</code> : å‘½ä»¤åˆ—è¡¨</p>
<p><em>å®Œæ•´çš„åˆ›å»ºæµç¨‹</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;</span><br><span class="line">ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">ComPtr&lt;ID3D12GraphicsCommandList&gt; mCommandList;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateCommandObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">    queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">    queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">    ThrowIfFailed(md3dDevice-&gt;CreateCommandQueue(</span><br><span class="line">    	&amp;queueDesc, IID_PPV_ARGS(&amp;mCommandQueue)));</span><br><span class="line">    ThrowIfFailed(md3dDevice-&gt;CreateCommandAllocator(</span><br><span class="line">    	D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">    	IID_PPV_ARGS(mDirectCmdListAlloc.GetAddressOf())));</span><br><span class="line">    ThrowIfFailed(md3dDevice-&gt;CreateCommandList(</span><br><span class="line">    	<span class="number">0</span>,</span><br><span class="line">    	D3D12_COMMAND_LIST_DIRECT,</span><br><span class="line">    	mDirectCmdListAlloc.Get(),   <span class="comment">// å…³è”å‘½ä»¤åˆ†é…å™¨</span></span><br><span class="line">    	<span class="literal">nullptr</span>,				    <span class="comment">// åˆå§‹åŒ–æµæ°´çº¿çŠ¶æ€å¯¹è±¡ï¼ˆæ­¤æ—¶ä¸ä¼šå‘èµ·ä»»ä½•ç»˜åˆ¶å‘½ä»¤ï¼‰ pipeline state object</span></span><br><span class="line">    	IID_PPV_ARGS(mCommandList.GetAddressOf())));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ˆå°†å‘½ä»¤åˆ—è¡¨ç½®äºå…³é—­çŠ¶æ€ã€‚</span></span><br><span class="line">    mCommandList-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-æè¿°å¹¶åˆ›å»ºäº¤æ¢é“¾"><a href="#5-æè¿°å¹¶åˆ›å»ºäº¤æ¢é“¾" class="headerlink" title="5. æè¿°å¹¶åˆ›å»ºäº¤æ¢é“¾"></a>5. æè¿°å¹¶åˆ›å»ºäº¤æ¢é“¾</h3><p><em>å…ˆå¡«å†™ä¸€ä»½</em> DXGI_SWAP_CHAIN_DESC <em>ç»“æ„ä½“å®ä¾‹ç”¨æ¥æè¿°æ¬²åˆ›å»ºäº¤æ¢é“¾çš„ç‰¹æ€§</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_SWAP_CHAIN_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DXGI_MODE_DESC 		 BufferDesc;</span><br><span class="line">    DXGI_SAMPLE_DESC 	 SampleDesc;</span><br><span class="line">    DXGI_USAGE 		     BufferUsage;</span><br><span class="line">    UINT    		     BufferCount;</span><br><span class="line">    HWND 				OutPutWindow;</span><br><span class="line">    BOOL				Windowed;</span><br><span class="line">    DXGI_SWAP_EFFECT	 SwapEffect;</span><br><span class="line">    UINT 				Flags;</span><br><span class="line">    DXGI_SWAP_CHAIN_DESC;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„ <code> DXGI_MODE_DESC</code> æ˜¯å¦ä¸€ç§ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_MODE_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UINT				Width;</span><br><span class="line">    UINT				Height;</span><br><span class="line">    DXGI_PARTIONAL		 RefreshRate;</span><br><span class="line">    DXGI_FORMAT			 Format;</span><br><span class="line">    DXGI_MODE_SCANLINE_ORDER	Scaling;</span><br><span class="line">&#125; DXGI_MODE_DESC;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºä¸Šé¢çš„ä¸€äº›æ•°æ®æˆå‘˜ï¼Œå…¶å«ä¹‰å’Œè®¾å®šå¦‚ä¸‹:</p>
<p><code> BufferDesc</code> : å¸¦åˆ›å»ºçš„åå°ç¼“å†²åŒºå±æ€§</p>
<p><code> SampleDesc</code> : å¤šé‡é‡‡æ ·çš„è´¨é‡çº§åˆ«å’Œå¯¹æ¯ä¸ªåƒç´ çš„é‡‡æ ·æ¬¡æ•°</p>
<p><code> BufferUsage</code> : æ­¤æ—¶è¦å°†æ•°æ®æ¸²æŸ“è‡³åå°ç¼“å†²åŒºï¼Œæ‰€ä»¥è¿™é‡ŒæŒ‡å®šä¸º DXGI_USAGE_RENDER_TARGET_OUTPUT</p>
<p><code> OutPutWindow</code> : æ¸²æŸ“çª—å£çš„å¥æŸ„</p>
<p><code> Windowed</code> : true -&gt; çª—å£æ¨¡å¼è¿è¡Œ   false -&gt; å…¨å±æ¨¡å¼è¿è¡Œ</p>
<p><code> SwapEffect</code>:æŒ‡å®šä¸º DXGI_SWAP_EFFECT_FLIP_DISCARD</p>
<p><code> Falgs</code> : å¯é€‰æ ‡å¿— è‹¥æŒ‡å®šä¸º DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH  å½“ç¨‹åºåˆ‡æ¢ä¸ºå…¨å±æ¨¡å¼æ—¶ï¼Œå°†é€‰æ‹©æœ€é€‚äºå½“å‰åº”ç”¨ç¨‹åºçª—å£</p>
<p>å¤§å°çš„å°ºå¯¸æ˜¾ç¤ºæ¨¡å¼ã€‚ å¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œåˆ‡æ¢ä¸ºå…¨å±æ¨¡å¼çš„æ—¶å€™ï¼Œå°†é‡‡ç”¨å½“å‰æ¡Œé¢çš„æ˜¾ç¤ºæ¨¡å¼</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€‚ç”¨è¯¥æ–¹æ³•åˆ›å»ºäº¤æ¢é“¾</span></span><br><span class="line"><span class="function">HRESULT <span class="title">IDXGIFactory::CreateSwapChain</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">IUnknown *pDevice,					<span class="comment">// æŒ‡å‘ ID3D12CommamdQueue æ¥å£çš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="function"><span class="params">DXGI_SWAP_CHAIN_DESC *pDesc,		 <span class="comment">// æŒ‡å‘æè¿°äº¤æ¢é“¾çš„ç»“æ„ä½“æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="function"><span class="params">IDXGISwapChain **PPSwapChain)</span></span>;		 <span class="comment">// è¿”å›æ‰€åˆ›å»ºçš„äº¤æ¢é“¾æ¥å£</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">DXGI_FORMAT mBackBufferFormat = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3Dapp::CreateSwapChain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// é‡Šæ”¾ä¹‹å‰çš„äº¤æ¢é“¾ï¼Œéšåå†é‡æ–°åˆ›å»º</span></span><br><span class="line">    mSwapChain.Reset();</span><br><span class="line">    </span><br><span class="line">    DXGI_SWAP_CHAIN_DESC 						sd;</span><br><span class="line">    sd.BufferDesc.Width 		 	=  			mClinetWidth;</span><br><span class="line">    sd.BufferDesc.Height			= 		    mClientHeight;</span><br><span class="line">    sd.BufferDesc.RefreshRate.Numerator 	=     <span class="number">60</span>;</span><br><span class="line">    sd.BufferDesc.RefreshRate.Denomiator	= 	  <span class="number">1</span>;</span><br><span class="line">    sd.BufferDesc.Format			=			mBackBufferFormat;</span><br><span class="line">    sd.BufferDesc.ScanLineOrder      =     		  DXGI_MODE_SCANLINE_ORDER_UNSPECIFIED;</span><br><span class="line">    sd.BufferDesc.Scaling			= 			DXGI_MODE_SCALING_UNSPECIFIED;</span><br><span class="line">    sd.SampleDesc			        =            m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">    sd.SampleQuality			    =			m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">    sd.BufferUsage 				    = 			DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">    sd.BufferCount 				    =   		SwapChainBufferCount;</span><br><span class="line">    sd.OutPutWindow				    =			mhMainWnd;</span><br><span class="line">    sd.Windowed                      =			 <span class="literal">true</span>;</span><br><span class="line">    sd.SwapEffect 				    =		    DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">    sd.Flags					   =            DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH;</span><br><span class="line">   	<span class="comment">// äº¤æ¢é“¾éœ€è¦å‘½ä»¤é˜Ÿåˆ—å¯¹å…¶è¿›è¡Œåˆ·æ–°</span></span><br><span class="line">    ThrowIfFailed(mdxgiFactory-&gt;CreateSwapChain(</span><br><span class="line">    	mCommandQueue.Get(),</span><br><span class="line">    	&amp;sd,</span><br><span class="line">    	mSwapChain.GetAddressOf()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-åˆ›å»ºæè¿°ç¬¦å †"><a href="#6-åˆ›å»ºæè¿°ç¬¦å †" class="headerlink" title="6. åˆ›å»ºæè¿°ç¬¦å †"></a>6. åˆ›å»ºæè¿°ç¬¦å †</h3><p>æˆ‘ä»¬éœ€è¦é€šè¿‡åˆ›å»ºæè¿°ç¬¦å †æ¥å­˜å‚¨ç¨‹åºä¸­ç”¨åˆ°çš„ æè¿°ç¬¦/è§†å›¾ã€‚</p>
<p><code> ID3D12DescriptorHeap</code> : å †æè¿°ç¬¦æ¥å£</p>
<p><code> ID3D12DeviceCreateDescriptorHeap</code> : åˆ›å»ºå †æè¿°ç¬¦</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">Comptr&lt;ID3D12DescriptorHeap&gt; mRtvHeap; <span class="comment">// render target view</span></span><br><span class="line">Comptr&lt;ID3D12DescrtptorHeap&gt; mDsvHeap; <span class="comment">// depth / stencil view</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc;</span><br><span class="line">    rtvHeapDesc.NumDescriptors = SwapChainBufferCount;</span><br><span class="line">    rtvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">    rtvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	rtvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">    ThrowIfFailed(md3dDevice-&gt;CreateDescriptorHeap(</span><br><span class="line">        &amp;rtvHeapDesc, IID_PPV_ARGS(mRtvHeap.GetAddressOf())));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    D3D12_DESCRIPTOR_HEAP_DESC dsvHeapDesc;</span><br><span class="line">    dsvHeapDesc.NumDescriptors = <span class="number">1</span>;</span><br><span class="line">    dsvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_DSV;</span><br><span class="line">    dsvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	dsvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">    ThrowIfFailed(md3dDevice-&gt;CreateDescriptorHeap(</span><br><span class="line">        &amp;dsvHeapDesc, IID_PPV_ARGS(mDsvHeap.GetAddressOf())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬ä¹¦çš„åº”ç”¨æ¡†æ¶æœ‰ä»¥ä¸‹å®šä¹‰:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> SwapChainBufferCount = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> mCurrBackBuffer = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><code> mCurrBackBuffer</code> : ç”¨æ¥è®°å½•å½“å‰åå°ç¼“å†²åŒºçš„ç´¢å¼•ã€‚ (æˆ‘ä»¬å¿…é¡»çŸ¥é“å½“å‰æ­£åœ¨ç”¨äºæ¸²æŸ“æ•°æ®çš„åå°ç¼“å†²åŒº)</p>
<p>åœ¨ç¨‹åºä¸­æˆ‘ä»¬æ˜¯é€šè¿‡å¥æŸ„æ¥å¼•ç”¨æè¿°ç¬¦çš„ï¼Œå€ŸåŠ©ä¸‹åˆ—å‡½æ•°å³å¯è·å¾—ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">D3DApp::CurrentBackBufferView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> CD3DX12_CPU_DESCRIPTOR_HANDLE(</span><br><span class="line">		mRtvHeap-&gt;GetCPUDescriptorHandleForHeapStart(),   <span class="comment">// å †ä¸­çš„é¦–ä¸ªå¥æŸ„</span></span><br><span class="line">		mCurrBackBuffer,							   <span class="comment">// åç§»è‡³åå°ç¼“å†²åŒºæè¿°ç¬¦å¥æŸ„çš„ç´¢å¼•</span></span><br><span class="line">		mRtvDescriptorSize);						   <span class="comment">// æè¿°ç¬¦æ‰€å å­—èŠ‚çš„å¤§å°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">D3DApp::DepthStencilView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mDsvHeap-&gt;GetCPUDescriptorHandleForHeapStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´é€šè¿‡æè¿°ç¬¦çš„å¤§å°ï¼Œé€šè¿‡åç§»é‡æ‰¾åˆ°å½“å‰åå°ç¼“å†²åŒºçš„ RTV æè¿°ç¬¦</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ç›®æ ‡æè¿°ç¬¦å¥æŸ„ */</span> = GetCPUDescriptorHandleForHeapStart() + mCurrBackBuffer * mRTVDescriptorSize;</span><br></pre></td></tr></table></figure>



<h3 id="7-åˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾"><a href="#7-åˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾" class="headerlink" title="7. åˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾"></a>7. åˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾</h3><p>ç”±äºèµ„æºä¸èƒ½äºæ¸²æŸ“æµæ°´çº¿ä¸­çš„é˜¶æ®µç›´æ¥ç»‘å®šï¼Œå¿…é¡»ä¸ºå…¶åˆ›å»ºèµ„æºè§†å›¾æ‰èƒ½å®Œæˆç»‘å®šã€‚</p>
<ol>
<li><p>è·å–å­˜äºäº¤æ¢é“¾ä¸­çš„ç¼“å†²åŒºèµ„æº</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">IDXGISwapChain::GetBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	UINT Buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">	REFIID riid,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">void</span> **ppSurface)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code> Buffer</code> : ç¼“å†²åŒºç´¢å¼•</p>
<p><code> riid</code> : å¸Œæœ›è·å¾—çš„ ID3D12Resource æ¥å£çš„ COM ID  </p>
<p><code> ID3D12Resource</code> : è¯¥æ¥å£å°†ç‰©ç†å†…å­˜äºå †èµ„æºæŠ½è±¡ç»„ç»‡ä¸ºå¯å¤„ç†çš„æ•°ç»„äºå¤šç»´æ•°ç»„ï¼Œä½¿å¾— CPU/GPU å¯ä»¥å¯¹è¿™äº›èµ„æºè¿›è¡Œè¯»å†™</p>
<p><code> ppSurface</code> : è¿”å›ä¸€ä¸ªæŒ‡å‘ ID3D12Resource æ¥å£çš„æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä¾¿æ˜¯å¸Œæœ›è·å¾—çš„åå°ç¼“å†²åŒºã€‚</p>
<p>GetBuffer ä¼šå¢åŠ  COM çš„å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨åè¦å°†å…¶é‡Šæ”¾ã€‚ ComPtr å¯ä»¥è‡ªåŠ¨çš„åšåˆ°è¿™ç‚¹ã€‚</p>
</li>
<li><p>ä½¿ç”¨ ID3D12Device::CreateRenderTargetView æ¥ä¸ºè·å–çš„åå°ç¼“å†²åŒºåˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ID3D12Device::CreateRenderTargetView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	ID3D12Resource *pResource,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> D3D12_RENDER_TARGET_VIEW_DESC *pDesc,</span></span></span><br><span class="line">	D3D12_CPU_DESCRIPTOR_HANDLE DestDescriptor)ï¼›</span><br></pre></td></tr></table></figure>

<p><code> pResource</code> : æŒ‡å®šç”¨ä½œæ¸²æŸ“ç›®æ ‡çš„èµ„æºï¼ˆåœ¨è¿™é‡Œæ˜¯åå°ç¼“å†²åŒºï¼‰</p>
<p><code> pDesc</code> : æŒ‡å‘ D3D12_RENDER_TARGET_VIEW_DESC æ•°æ®ç»“æ„çš„å®ä¾‹æŒ‡é’ˆ</p>
<p><code> DestDescriptor</code> : å¼•ç”¨æ‰€åˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾çš„æè¿°ç¬¦</p>
</li>
<li><p>è°ƒç”¨ä¸Šé¢2ç§æ–¹æ³•ä¸ºäº¤æ¢é“¾çš„æ¯ä¸€ä¸ªç¼“å†²åŒºéƒ½åˆ›å»ºäº†ä¸€ä¸ª RTV</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">ComPtr&lt;ID3D12Resource&gt; <span class="title">mSwapChainBuffer</span><span class="params">(SwapChainBufferCount)</span></span>;</span><br><span class="line"><span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHeapHandle</span><span class="params">(mRtvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; SwapChainBufferCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// è·å¾—äº¤æ¢é“¾çš„ç¬¬ i ä¸ªç¼“å†²åŒº</span></span><br><span class="line">		ThrowIfFailed(mSwapChain-&gt;GetBuffer(i, IID_PPV_ARGS(&amp;mSwapChainBuffer[i])));</span><br><span class="line">        <span class="comment">// ä¸ºè¯¥ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ª RTV</span></span><br><span class="line">		md3dDevice-&gt;CreateRenderTargetView(mSwapChainBuffer[i].Get(), <span class="literal">nullptr</span>, rtvHeapHandle);</span><br><span class="line">        <span class="comment">// åç§»åˆ°æè¿°ç¬¦å †çš„ä¸‹ä¸€ä¸ªç¼“å†²åŒº</span></span><br><span class="line">		rtvHeapHandle.Offset(<span class="number">1</span>, mRtvDescriptorSize);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h3 id="8-åˆ›å»ºæ·±åº¦-æ¨¡æ¿ç¼“å†²åŒºåŠå…¶è§†å›¾"><a href="#8-åˆ›å»ºæ·±åº¦-æ¨¡æ¿ç¼“å†²åŒºåŠå…¶è§†å›¾" class="headerlink" title="8. åˆ›å»ºæ·±åº¦/æ¨¡æ¿ç¼“å†²åŒºåŠå…¶è§†å›¾"></a>8. åˆ›å»ºæ·±åº¦/æ¨¡æ¿ç¼“å†²åŒºåŠå…¶è§†å›¾</h3><p>æ·±åº¦ç¼“å†²æ˜¯ä¸€ç§2Dçº¹ç†ï¼Œå­˜å‚¨ç€å¯è§†å¯¹è±¡çš„æ·±åº¦ä¿¡æ¯ï¼Œç”±äºçº¹ç†æ˜¯ä¸€ç§ GPU èµ„æºï¼Œæˆ‘ä»¬é€šè¿‡ D3D12_RESOURCE_DESC ç»“æ„ä½“æ¥æè¿°ï¼Œç”¨ </p>
<p>ID3D12Device::CreateCommittedResource æ–¹æ³•æ¥åˆ›å»ºã€‚</p>
<p><em>D3D12_RESOURCE_DESC</em></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_RESOURCE_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_RESOURCE_DIMENSION Dimension;</span><br><span class="line">    UINT64 Alignment;</span><br><span class="line">    UINT64 Width;</span><br><span class="line">    UINT Height;</span><br><span class="line">    UINT16 DepthOrArraySize;</span><br><span class="line">    UINT16 MipLevels;</span><br><span class="line">    DXGI_FORMAT Format;</span><br><span class="line">    DXGI_SAMPLE_DESC SampleDesc;</span><br><span class="line">    D3D12_TEXTURE_LAYOUT Layout;</span><br><span class="line">    D3D12_RESOURCE_FLAGS Flags;</span><br><span class="line">    &#125; 	D3D12_RESOURCE_DESC;</span><br></pre></td></tr></table></figure>

<p><code> Dimension</code> : èµ„æºçš„ç»´åº¦ï¼Œé€‰æ‹©ä¸‹åˆ—ä¹‹ä¸€</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> D3D12_RESOURCE_DIMENSION</span><br><span class="line">    &#123;</span><br><span class="line">        D3D12_RESOURCE_DIMENSION_UNKNOWN	= <span class="number">0</span>,</span><br><span class="line">        D3D12_RESOURCE_DIMENSION_BUFFER	= <span class="number">1</span>,</span><br><span class="line">        D3D12_RESOURCE_DIMENSION_TEXTURE1D	= <span class="number">2</span>,</span><br><span class="line">        D3D12_RESOURCE_DIMENSION_TEXTURE2D	= <span class="number">3</span>,</span><br><span class="line">        D3D12_RESOURCE_DIMENSION_TEXTURE3D	= <span class="number">4</span></span><br><span class="line">    &#125; 	D3D12_RESOURCE_DIMENSION;</span><br></pre></td></tr></table></figure>

<p><code> Width</code> : çº¹ç†å®½åº¦ ï¼ˆä»¥çº¹ç´ ä¸ºå•ä½ï¼Œç‰¹åˆ«å¯¹äºç¼“å†²åŒºèµ„æºæ¥è¯´ï¼Œè¿™æ˜¯ç¼“å†²åŒºå æ®çš„å­—èŠ‚æ•°ï¼‰</p>
<p><code> Height</code> : çº¹ç†é«˜åº¦ (çº¹ç´ ä¸ºå•ä½)</p>
<p><code> DepthOrArraySize</code> : çº¹ç†æ·±åº¦ (çº¹ç´ ä¸ºå•ä½)ï¼Œå¯¹äº 1D/2D çº¹ç†æ¥è¯´æ˜¯çº¹ç†æ•°ç»„çš„å¤§å°ã€‚D3D ä¸­å¹¶ä¸å­˜åœ¨ 3D çº¹ç†æ•°ç»„çš„æ¦‚å¿µ</p>
<p><code> MipLevels</code> : mipmap å±‚çº§çš„æ•°é‡</p>
<p><code> Format</code> : DXGI_FORMAT æšä¸¾ç±»å‹çš„ä¸€ç§ï¼Œç”¨æ¥æŒ‡å®šçº¹ç´ çš„æ ¼å¼</p>
<p><code> SampleDesc</code> : å¤šé‡é‡‡æ ·çš„è´¨é‡çº§åˆ«ä»¥åŠå¯¹æ¯ä¸ªåƒç´ çš„é‡‡æ ·æ¬¡æ•° </p>
<p><code> Layout</code> : ç”¨äºæŒ‡å®šçº¹ç†çš„å¸ƒå±€ï¼Œè¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘ï¼Œè®¾å®šä¸º D3D12_TEXTURE_LAYOUT_UNKNOWN</p>
<p><code> Flags</code> : ä¸èµ„æºæœ‰å…³çš„æ‚é¡¹æ ‡å¿—ï¼Œå¯¹äºæ·±åº¦/æ¨¡æ¿ç¼“å†²èµ„æºæ¥è¯´è®¾å®šä¸º D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL</p>
<p>GPU èµ„æºéƒ½å­˜äºå †(Heap)ä¸­ï¼Œæœ¬è´¨æ˜¯å…·æœ‰ç‰¹å®šå±æ€§çš„ GPU æ˜¾å­˜å—ã€‚ ID3D12Device::CreateCommittedResource æ ¹æ®æˆ‘ä»¬æä¾›çš„å±æ€§åˆ›å»ºä¸€ä¸ªèµ„æºä¸ä¸€ä¸ªå †ï¼Œå¹¶æŠŠè¯¥èµ„æºæäº¤åˆ°è¿™ä¸ªå †ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">HRESULT STDMETHODCALLTYPE <span class="title">CreateCommittedResource</span><span class="params">( </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> D3D12_HEAP_PROPERTIES *pHeapProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">            D3D12_HEAP_FLAGS HeapFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> D3D12_RESOURCE_DESC *pDesc,</span></span></span><br><span class="line"><span class="function"><span class="params">            D3D12_RESOURCE_STATES InitialResourceState,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> D3D12_CLEAR_VALUE *pOptimizedClearValue,</span></span></span><br><span class="line"><span class="function"><span class="params">            REFIID riidResource,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">void</span> **ppvResource)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_HEAP_PROPERTIES</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_HEAP_TYPE Type;</span><br><span class="line">    D3D12_CPU_PAGE_PROPERTY CPUPageProperty;</span><br><span class="line">    D3D12_MEMORY_POOL MemoryPoolPreference;</span><br><span class="line">    UINT CreationNodeMask;</span><br><span class="line">    UINT VisibleNodeMask;</span><br><span class="line">    &#125; 	D3D12_HEAP_PROPERTIES;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code> pHeapProperties</code> : èµ„æºæ¬²æäº¤åˆ°çš„å †æ‰€å…·æœ‰çš„å±æ€§</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> </span><br><span class="line"><span class="keyword">enum</span> D3D12_HEAP_TYPE</span><br><span class="line">    &#123;</span><br><span class="line">        D3D12_HEAP_TYPE_DEFAULT	= <span class="number">1</span>,			<span class="comment">// é»˜è®¤ï¼Œå‘è¿™ä¸ªå †æäº¤çš„èµ„æºåªæœ‰ GPU ä¸èƒ½è®¿é—®</span></span><br><span class="line">        D3D12_HEAP_TYPE_UPLOAD	= <span class="number">2</span>,			<span class="comment">// ä¸Šä¼ å †ï¼Œéœ€è¦ç»è¿‡ CPU ä¸Šä¼ åˆ° GPU çš„èµ„æº</span></span><br><span class="line">        D3D12_HEAP_TYPE_READBACK	= <span class="number">3</span>,		<span class="comment">// å›è¯»å †ï¼Œéœ€è¦ CPU è¯»å–çš„èµ„æº</span></span><br><span class="line">        D3D12_HEAP_TYPE_CUSTOM	= <span class="number">4</span>			 	<span class="comment">// ç”¨äºé«˜çº§åœºæ™¯</span></span><br><span class="line">    &#125; 	D3D12_HEAP_TYPE;</span><br></pre></td></tr></table></figure>

<p><code> HeapFlags</code> : ä¸å †æœ‰å…³çš„é¢å¤–é€‰é¡¹æ ‡å¿—ã€‚é€šå¸¸è®¾ç½®ä¸º D3D12_HEAP_FLAG_NONE</p>
<p><code> pDesc</code> : æŒ‡å‘ä¸€ä¸ª D3D12_RESOURCE_DESC å®ä¾‹çš„æŒ‡é’ˆï¼Œç”¨å…¶æè¿°ä¸€ä¸ªå¸¦åˆ›å»ºçš„èµ„æº</p>
<p><code> InitialResourceState</code> : ç”¨è¯¥å‚æ•°æ¥è®¾ç½®æ¯ç§èµ„æºçš„åˆå§‹çŠ¶æ€</p>
<p><code> pOptimizedClearValue</code> : æŒ‡å‘ä¸€ä¸ª D3D12_CLEAR_VALUE å¯¹è±¡çš„æŒ‡é’ˆï¼Œæè¿°ä¸€ä¸ªç”¨äºæ¸…é™¤èµ„æºçš„ä¼˜åŒ–å€¼ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_CLEAR_VALUE</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    DXGI_FORMAT Format;</span><br><span class="line">    <span class="keyword">union</span> </span><br><span class="line">        &#123;</span><br><span class="line">        FLOAT Color[ <span class="number">4</span> ];</span><br><span class="line">        D3D12_DEPTH_STENCIL_VALUE DepthStencil;</span><br><span class="line">        &#125; 	;</span><br><span class="line">    &#125; 	D3D12_CLEAR_VALUE;</span><br></pre></td></tr></table></figure>

<p><code> riidResource</code> : æˆ‘ä»¬å¸Œæœ›è·å¾—çš„ ID3D12Resource æ¥å£çš„ COM ID </p>
<p><code> ppvResource</code> : è¿”å›ä¸€ä¸ªæŒ‡å‘ ID3Dd12Resource çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯æ–°å»ºçš„èµ„æºçš„æŒ‡é’ˆ</p>
<p><strong>ä¸ºäº†ä½¿æ€§èƒ½è¾¾åˆ°æœ€ä»·ï¼Œé€šå¸¸å°†èµ„æºæ”¾äºé»˜è®¤å †ä¸­ã€‚æœ‰å…¶ä»–éœ€æ±‚æ—¶å†ä½¿ç”¨å…¶ä»–ç±»å‹çš„å †</strong></p>
<p>åœ¨ä½¿ç”¨æ·±åº¦/æ¨¡æ¿ç¼“å†²ä¹‹å‰ä¸€å®šè¦åˆ›å»ºç›¸å…³çš„æ·±åº¦/æ¨¡æ¿è§†å›¾ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°æ¸²æŸ“æµæ°´çº¿ä¸Šã€‚è¿‡ç¨‹ç±»ä¼¼äºåˆ›å»ºæ¸²æŸ“ç›®æ ‡è§†å›¾</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">   <span class="comment">// Create the depth/stencil buffer and view.</span></span><br><span class="line">   D3D12_RESOURCE_DESC depthStencilDesc;</span><br><span class="line">   depthStencilDesc.Dimension = D3D12_RESOURCE_DIMENSION_TEXTURE2D;</span><br><span class="line">   depthStencilDesc.Alignment = <span class="number">0</span>;</span><br><span class="line">   depthStencilDesc.Width = mClientWidth;</span><br><span class="line">   depthStencilDesc.Height = mClientHeight;</span><br><span class="line">   depthStencilDesc.DepthOrArraySize = <span class="number">1</span>;</span><br><span class="line">   depthStencilDesc.MipLevels = <span class="number">1</span>;</span><br><span class="line">   depthStencilDesc.Format = mDepthStencilFormat;</span><br><span class="line">   depthStencilDesc.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">   depthStencilDesc.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">   depthStencilDesc.Layout = D3D12_TEXTURE_LAYOUT_UNKNOWN;</span><br><span class="line">   depthStencilDesc.Flags = D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL;</span><br><span class="line"></span><br><span class="line">   D3D12_CLEAR_VALUE optClear;</span><br><span class="line">   optClear.Format = mDepthStencilFormat;</span><br><span class="line">   optClear.DepthStencil.Depth = <span class="number">1.0f</span>;</span><br><span class="line">   optClear.DepthStencil.Stencil = <span class="number">0</span>;</span><br><span class="line">   ThrowIfFailed(md3dDevice-&gt;CreateCommittedResource(</span><br><span class="line">       &amp;CD3DX12_HEAP_PROPERTIES(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">	D3D12_HEAP_FLAG_NONE,</span><br><span class="line">       &amp;depthStencilDesc,</span><br><span class="line">	D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">       &amp;optClear,</span><br><span class="line">       IID_PPV_ARGS(mDepthStencilBuffer.GetAddressOf())));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create descriptor to mip level 0 of entire resource using the format of the resource.</span></span><br><span class="line">   md3dDevice-&gt;CreateDepthStencilView(mDepthStencilBuffer.Get(), <span class="literal">nullptr</span>, DepthStencilView());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Transition the resource from its initial state to be used as a depth buffer.</span></span><br><span class="line">mCommandList-&gt;ResourceBarrier(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::Transition(mDepthStencilBuffer.Get(),</span><br><span class="line">	D3D12_RESOURCE_STATE_COMMON, D3D12_RESOURCE_STATE_DEPTH_WRITE));</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ç”¨äº† CD3DX12_HEAP_PROPERTIES è¾…åŠ©å‡½æ•°æ¥æ„å»ºåˆ›å»ºå †çš„å±æ€§ç»“æ„ä½“ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">CD3DX12_HEAP_PROPERTIES</span><span class="params">( </span></span></span><br><span class="line"><span class="function"><span class="params">    D3D12_HEAP_TYPE type, </span></span></span><br><span class="line"><span class="function"><span class="params">    UINT creationNodeMask = <span class="number">1</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">    UINT nodeMask = <span class="number">1</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Type = type;</span><br><span class="line">    CPUPageProperty = D3D12_CPU_PAGE_PROPERTY_UNKNOWN;</span><br><span class="line">    MemoryPoolPreference = D3D12_MEMORY_POOL_UNKNOWN;</span><br><span class="line">    CreationNodeMask = creationNodeMask;</span><br><span class="line">    VisibleNodeMask = nodeMask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="9-ç»˜åˆ¶çª—å£"><a href="#9-ç»˜åˆ¶çª—å£" class="headerlink" title="9. ç»˜åˆ¶çª—å£"></a>9. ç»˜åˆ¶çª—å£</h3><p>æˆ‘ä»¬é€šå¸¸å°†3Dåœºæ™¯ç»˜åˆ¶åˆ°ä¸æ•´ä¸ªå±å¹•ï¼Œæˆ–è€…å’Œçª—å£å·¥ä½œåŒºå¤§å°ç›¸åŒçš„åå°ç¼“å†²åŒºä¸­ã€‚ä½†æ˜¯æœ‰æ—¶å€™åªæ˜¯éœ€è¦å°†å…¶ç»˜åˆ¶åˆ°åå°ç¼“å†²åŒºä¸­æŸä¸ªçŸ©å½¢åŒºåŸŸçš„å­åŒºåŸŸä¸­</p>
<p>æˆ‘ä»¬å°†è¿™ç§çŸ©å½¢å­åŒºåŸŸå«åšè§†å£( viewport )</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_VIEWPORT</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    FLOAT TopLeftX;</span><br><span class="line">    FLOAT TopLeftY;</span><br><span class="line">    FLOAT Width;</span><br><span class="line">    FLOAT Height;</span><br><span class="line">    FLOAT MinDepth;</span><br><span class="line">    FLOAT MaxDepth;</span><br><span class="line">    &#125; 	D3D12_VIEWPORT;</span><br></pre></td></tr></table></figure>

<p><code> MinDepth</code> , <code> MaxDepth</code> è¿™ä¸¤ä¸ªæˆå‘˜è´Ÿè´£å°†æ·±åº¦å€¼ä»åŒºé—´ [0, 1] è½¬æ¢åˆ°åŒºé—´ [MinDepth, MaxDepth]ã€‚</p>
<p>å¡«å¥½D3D12_VIEWPROT ç»“æ„ä½“ï¼Œä¾¿å¯ä»¥ä½¿ç”¨ ID3D12GraphicsCommandList::RSSetViewports æ¥è®¾ç½®è§†å£äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">D3D12_VIEWPORT vp;</span><br><span class="line">vp.TopLeftX = <span class="number">0.0f</span>;</span><br><span class="line">vp.TopRightY = <span class="number">0.0f</span>;</span><br><span class="line">vp.Width = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth);</span><br><span class="line">vp.Height = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientHeight);</span><br><span class="line">vp.MinDepth = <span class="number">0.0f</span>;</span><br><span class="line">vp.MaxDepth = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">mCommandList-&gt;RSSetViewports(<span class="number">1</span>, &amp;vp);   <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦ç»‘å®šçš„è§†å£æ•°é‡ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯æŒ‡å‘è§†å£æ•°ç»„çš„æŒ‡é’ˆã€‚</span></span><br></pre></td></tr></table></figure>

<p><strong>å‘½ä»¤åˆ—è¡¨ä¸€æ—¦é‡ç½®ï¼Œè§†å£ä¹Ÿè¦é‡ç½®</strong></p>
<h3 id="10-è®¾ç½®å‰ªè£çŸ©é˜µ"><a href="#10-è®¾ç½®å‰ªè£çŸ©é˜µ" class="headerlink" title="10. è®¾ç½®å‰ªè£çŸ©é˜µ"></a>10. è®¾ç½®å‰ªè£çŸ©é˜µ</h3><p>å‰ªè£çŸ©é˜µçš„ç±»å‹ä¸º RECT çš„ D3D12_RECT ç»“æ„ä½“å®šä¹‰è€Œæˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagRECT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LONG    left;</span><br><span class="line">    LONG    top;</span><br><span class="line">    LONG    right;</span><br><span class="line">    LONG    bottom;</span><br><span class="line">&#125; RECT, *PRECT, NEAR *NPRECT, FAR *LPRECT;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ¥è®¾ç½®å‰ªè£çŸ©é˜µ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">mScissorRect = &#123; <span class="number">0</span>, <span class="number">0</span>, mClientWidth/<span class="number">2</span>, mClientHeight/<span class="number">2</span> &#125;;</span><br><span class="line">mCommandList-&gt;RSSetScissorRects(<span class="number">1</span>, &amp;mScissorRect); <span class="comment">// éœ€è¦ç»‘å®šçš„å‰ªè£çŸ©é˜µæ•°é‡ï¼ŒæŒ‡å‘å‰ªè£çŸ©é˜µçš„æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure>

<p><strong>å‰ªè£çŸ©é˜µéœ€è¦éšç€å‘½ä»¤åˆ—è¡¨çš„é‡ç½®è€Œé‡ç½®</strong></p>
]]></content>
      <categories>
        <category>C/C++</category>
        <category>Direct3D</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨æ±‡ç¼–æ·±å…¥å­¦ä¹ C++</title>
    <url>/myblog/2020/09/26/C/%E5%88%A9%E7%94%A8%E6%B1%87%E7%BC%96%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0C++/</url>
    <content><![CDATA[<h1 id="ä¸€ã€åŸºç¡€å†…å®¹"><a href="#ä¸€ã€åŸºç¡€å†…å®¹" class="headerlink" title="ä¸€ã€åŸºç¡€å†…å®¹"></a>ä¸€ã€åŸºç¡€å†…å®¹</h1><h3 id="1ã€æ‚é¡¹"><a href="#1ã€æ‚é¡¹" class="headerlink" title="1ã€æ‚é¡¹"></a>1ã€æ‚é¡¹</h3><hr>
<h5 id="ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€"><a href="#ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€" class="headerlink" title="ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€"></a>ï¼ˆ1ï¼‰æ±‡ç¼–è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ï¼Œé«˜çº§è¯­è¨€</h5><p><code>æ±‡ç¼–è¯­è¨€</code>ä¸<code>æœºå™¨è¯­è¨€</code>ä¸€ä¸€å¯¹åº”ï¼Œæ¯ä¸€æ¡æœºå™¨æŒ‡ä»¤éƒ½æœ‰ä¸ä¹‹ç›¸å¯¹çš„æ±‡ç¼–æŒ‡ä»¤</p>
<p><code>æ±‡ç¼–è¯­è¨€</code>å¯ä»¥é€šè¿‡ç¼–è¯‘å¾—åˆ°<code>æœºå™¨è¯­è¨€</code>ï¼Œ<code>æœºå™¨è¯­è¨€</code>å¯ä»¥é€šè¿‡åæ±‡ç¼–å¾—åˆ°<code>æ±‡ç¼–è¯­è¨€</code></p>
<p><code>é«˜çº§è¯­è¨€</code>å¯ä»¥é€šè¿‡ç¼–è¯‘å¾—åˆ°<code>æ±‡ç¼–è¯­è¨€\æœºå™¨è¯­è¨€</code>ï¼Œä½†æ˜¯<code>æ±‡ç¼–è¯­è¨€\æœºå™¨è¯­è¨€</code>å‡ ä¹ä¸å¯èƒ½è¿˜åŸæˆ<code>é«˜çº§è¯­è¨€</code></p>
<p>â€‹&emsp;&emsp;&emsp;&emsp;&emsp;ç¼–è¯‘        </p>
<p>â€‹&emsp;æ±‡ç¼–è¯­è¨€ â€”â€”&gt; æœºå™¨è¯­è¨€</p>
<p>â€‹            mov ax, bx&lt;â€”â€” 0010101011</p>
<p>â€‹&emsp;&emsp;&emsp;&emsp;åç¼–è¯‘</p>
<p>egï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> year;</span><br><span class="line">    <span class="keyword">int</span> month;</span><br><span class="line">    <span class="keyword">int</span> day;</span><br><span class="line">&#125;;</span><br><span class="line">Date d = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">C7 <span class="number">45</span> F0 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-10</span>h],<span class="number">1</span></span><br><span class="line">C7 <span class="number">45</span> F4 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">2</span></span><br><span class="line">C7 <span class="number">45</span> F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-8</span>],<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">C7 <span class="number">45</span> F0 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-10</span>h],<span class="number">1</span></span><br><span class="line">C7 <span class="number">45</span> F4 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">2</span></span><br><span class="line">C7 <span class="number">45</span> F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov			dword ptr [ebp<span class="number">-8</span>],<span class="number">3</span></span><br><span class="line"><span class="comment">/*æ³¨æ„åˆ°ä¸¤è€…çš„æœºå™¨ç å’Œæ±‡ç¼–ç å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥åªç¡®å®šæ±‡ç¼–\æœºå™¨è¯­è¨€ä¸èƒ½è¿˜åŸä¸ºå”¯ä¸€ç¡®å®šçš„é«˜çº§è¯­è¨€ï¼Œå¦‚æœä¸€å®šéœ€è¦</span></span><br><span class="line"><span class="comment">ç›¸å…³é«˜çº§è¯­è¨€ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶è¿˜åŸä¸ºä¼ªä»£ç ï¼Œåœ¨äººä¸ºè¿˜åŸä¸ºé«˜çº§è¯­è¨€ã€‚*/</span></span><br></pre></td></tr></table></figure>

<p>â€‹    <strong>åœ¨ä¸åŒæ¶æ„çš„CPUä¸‹ï¼Œç”Ÿæˆçš„æ±‡ç¼–ç ä¸ä¸€æ ·</strong></p>
<h5 id="ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«"><a href="#ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«" class="headerlink" title="ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«"></a>ï¼ˆ2ï¼‰ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æœ¬è´¨åŒºåˆ«</h5><ul>
<li><p>C++</p>
<blockquote>
<p>è½»æ˜“åæ±‡ç¼–</p>
</blockquote>
<p>ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç ï¼Œå¯ä»¥å’Œæœºå™¨ç è¿›è¡Œè½¬æ¢</p>
</li>
<li><p>JavaScript</p>
<blockquote>
<p>è„šæœ¬è¯­è¨€ï¼Œç”±æµè§ˆå™¨è¿›è¡Œè§£æ</p>
</blockquote>
</li>
<li><p>PHP</p>
<blockquote>
<p>è„šæœ¬è¯­è¨€ï¼Œç”±Zend Engine(ZE)è¿›è¡Œè§£æ</p>
</blockquote>
<p>JS å’Œ PHP åœ¨é€šè¿‡å¼•æ“è§£æåå˜ä¸ºä¸­é—´ä»£ç ï¼Œç„¶åè½¬ä¸º<code>æœºå™¨ç (ä¸åŒè¯­è¨€çš„æœºå™¨ç ä¸åŒ)</code>ï¼Œæ‰€ä»¥ä¸å¥½æ¥è§¦åˆ°åº•å±‚</p>
</li>
<li><p>Java</p>
<blockquote>
<p>ç”±JVMè¿›è¡Œè£…è½½å­—èŠ‚ç </p>
</blockquote>
<p>ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºclassï¼ˆå­—èŠ‚ç ï¼‰ï¼Œç„¶åé€šè¿‡JVMè™šæ‹Ÿæœºå½¢è½¬ä¸ºå™¨ç </p>
</li>
</ul>
<p>æ— è®ºç”¨ä»€ä¹ˆè¯­è¨€ç¼–å†™ä»£ç ï¼Œæœ€ç»ˆä¼šå½¢æˆå‡ ä¹ç›¸åŒçš„æœºå™¨ç ã€‚</p>
<h3 id="2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰"><a href="#2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰" class="headerlink" title="2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰"></a>2ã€å‡½æ•°é‡è½½ï¼ˆOverloadï¼‰</h3><hr>
<ul>
<li><p>è§„åˆ™</p>
<blockquote>
<p>å‡½æ•°åç›¸åŒ</p>
<p>å‚æ•°ä¸ªæ•°ä¸åŒã€å‚æ•°ç±»å‹ä¸åŒã€å‚æ•°é¡ºåºä¸åŒ</p>
</blockquote>
</li>
<li><p>æ³¨æ„</p>
<blockquote>
<p>è¿”å›å€¼ç±»å‹ä¸å‡½æ•°é‡è½½æ— å…³</p>
<p>è°ƒç”¨å‡½æ•°æ—¶ï¼Œå®å‚çš„éšå¼ç±»å‹è½¬æ¢å¯èƒ½ä¼šäº§ç”ŸäºŒä¹‰æ€§</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>æœ¬è´¨</p>
<blockquote>
<p>é‡‡ç”¨äº†name manglingæˆ–è€…å«name decorationçš„æŠ€æœ¯ï¼ŒC++ç¼–è¯‘å™¨é»˜è®¤ä¼šå¯¹ç¬¦å·åï¼ˆæ¯”å¦‚å‡½æ•°åï¼‰è¿›è¡Œæ”¹å˜ï¼Œä¿®é¥°ã€‚</p>
<p>é‡è½½æ—¶äº§ç”Ÿçš„å‡½æ•°åå­—å’Œç¼–è¯‘å™¨æœ‰å…³ï¼Œä¸åŒç¼–è¯‘å™¨ä¸åŒï¼Œäº§ç”Ÿçš„åå­—ä¸åŒã€‚</p>
</blockquote>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>&#123;        			 		<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA1429h)</span>		</span></span><br><span class="line"><span class="function">    <span class="comment">//...</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;					<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA13F7h)</span></span></span><br><span class="line"><span class="function">    <span class="comment">//...</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">long</span> a)</span></span>&#123;					<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA1230h)</span></span></span><br><span class="line"><span class="function">    <span class="comment">//...</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(doble a)</span></span>&#123;					<span class="function">call		<span class="title">display</span><span class="params">(<span class="number">0</span>CA10B4h)</span>	</span></span><br><span class="line"><span class="function">    <span class="comment">//...																</span></span></span><br><span class="line">&#125;</span><br><span class="line">VSç®€åŒ–äº†å‡½æ•°åï¼Œä½¿å…¶çœ‹ä¸Šå»ä¸€æ ·ï¼Œä½†å‡½æ•°åé¢æ‹¬å·é‡Œçš„ä¸åŒæ•°å€¼è¡¨ç¤ºè°ƒç”¨çš„å‡½æ•°åœ°å€å¹¶ä¸ç›¸åŒã€‚</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨IDAè¿›è¡Œé€†å‘å·¥ç¨‹ï¼Œåœ¨mainæ–‡ä»¶é‡ŒæŸ¥çœ‹æ±‡ç¼–ç ï¼š</p>
<blockquote>
<p>è®°å¾—å°†ç¨‹åºä»¥releaseç‰ˆæœ¬ç”Ÿæˆï¼Œå»é™¤è°ƒè¯•ä¿¡æ¯ï¼Œä½¿æ–‡ä»¶ç²¾ç®€ã€‚ä½†æ˜¯ç›¸å¯¹çš„releaseä¼šå¯¹ç¨‹åºè¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¸Šé¢4ä¸ªæ‰“å°å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥å°†4ä¸ªå‡½æ•°æ”¹ä¸º4ä¸ªç›´æ¥è¾“å‡ºï¼Œä¸å†è¿›è¡Œå‡½æ•°è°ƒç”¨ã€‚æ‰€ä»¥è¦å°†ç¼–è¯‘å™¨çš„ä¼˜åŒ–é€‰é¡¹å…³é—­ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call		display</span><br><span class="line">call		display_1</span><br><span class="line">call		display_2</span><br><span class="line">call		display_3			å¯è§çš„ç¡®è¿›è¡Œäº†name manglingä½¿å‡½æ•°é‡è½½å¾—ä»¥å®ç°</span><br></pre></td></tr></table></figure>



<h3 id="3ã€é»˜è®¤å‚æ•°"><a href="#3ã€é»˜è®¤å‚æ•°" class="headerlink" title="3ã€é»˜è®¤å‚æ•°"></a>3ã€é»˜è®¤å‚æ•°</h3><hr>
<p>C++å…è®¸å‡½æ•°è®¾ç½®é»˜è®¤å‚æ•°ï¼Œåœ¨è°ƒç”¨æ—¶å¯ä»¥æ ¹æ®æƒ…å†µçœç•¥å®å‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1 = <span class="number">5</span>, <span class="keyword">int</span> v2 = <span class="number">6</span>)</span></span>&#123; <span class="comment">// é»˜è®¤å‚æ•°å€¼å¿…é¡»ä»å³è¾¹å¼€å§‹ int v1 = 10, int v2 ---&gt; ç¼–è¯‘ä¸é€šè¿‡</span></span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum() &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 11</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>) &lt;&lt;<span class="built_in">endl</span>;<span class="comment">// 16</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>, <span class="number">20</span>) &lt;&lt; <span class="built_in">endl</span>;<span class="comment">// 30</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//åŒæ—¶æœ‰å£°æ˜å’Œå®ç°çš„æ—¶å€™ï¼Œåªèƒ½åœ¨å£°æ˜å¤„å¡«é»˜è®¤å‚æ•°</span></span><br></pre></td></tr></table></figure>



<p>é»˜è®¤å‚æ•°çš„å€¼å¯ä»¥æ˜¯å¸¸é‡ã€å…¨å±€ç¬¦å·ï¼ˆå…¨å±€å˜é‡ã€å‡½æ•°åï¼‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1 = <span class="number">5</span>, <span class="keyword">int</span> v2 = <span class="number">6</span>)</span></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;test(int) - &quot;</span> &lt;&lt; a &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">void</span>(*p)(<span class="keyword">int</span>) = test)</span></span>&#123; <span class="comment">//å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    p(v1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>(*p)(<span class="keyword">int</span>) = test;</span><br><span class="line">    p(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum() &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 11</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>) &lt;&lt;<span class="built_in">endl</span>;<span class="comment">// 16</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; sum(<span class="number">10</span>, <span class="number">20</span>) &lt;&lt; <span class="built_in">endl</span>;<span class="comment">// 30</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœå‡½æ•°çš„å‚æ•°ç»å¸¸ä½¿ç”¨åŒä¸€ä¸ªå€¼ï¼Œæ¨èä½¿ç”¨é»˜è®¤å‚æ•°</strong></p>
<p>å‡½æ•°é‡è½½å’Œé»˜è®¤å‚æ•°å…±åŒä½¿ç”¨çš„æ—¶å€™ä¼šäº§ç”Ÿå†²çªã€äºŒä¹‰æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹å»ºè®®ä¼˜å…ˆé€‰æ‹©é»˜è®¤å‚æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b = <span class="number">10</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    display(<span class="number">10</span>); <span class="comment">//æŠ¥é”™ï¼Œç¼–è¯‘ä¸é€šè¿‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤å‚æ•°çš„æœ¬è´¨ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line">sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">push		<span class="number">2</span></span><br><span class="line">push		<span class="number">1</span>    <span class="comment">//ä¼ å‚</span></span><br><span class="line"><span class="function">call		<span class="title">sum</span><span class="params">(<span class="number">0F</span>E1424h)</span></span></span><br><span class="line">add			esp,8</span><br><span class="line"></span><br><span class="line">sum(<span class="number">2</span>, <span class="number">4</span>); </span><br><span class="line">push		<span class="number">4</span></span><br><span class="line">push		<span class="number">2</span></span><br><span class="line"><span class="function">call		<span class="title">sum</span><span class="params">(<span class="number">0F</span>E1424h)</span> <span class="comment">//è°ƒç”¨ç›¸åŒçš„å‡½æ•°åœ°å€</span></span></span><br><span class="line">add			esp,8</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ é»˜è®¤å‚æ•°</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2 = <span class="number">4</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line">sum(<span class="number">1</span>);</span><br><span class="line">push		<span class="number">4</span></span><br><span class="line">push		<span class="number">1</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¹Ÿå°±æ˜¯è¯´ sum(1); å’Œ sum(1, 4); æ˜¯å®Œå…¨ä¸€æ ·çš„åŠŸèƒ½ï¼Œç»éªŒè¯æœºå™¨ç ä¹Ÿæ˜¯å‡ ä¹ä¸€æ ·ã€‚</span></span><br><span class="line"><span class="function">E8 A3 F2 FF FF			call		<span class="title">sum</span><span class="params">(<span class="number">01271424</span>h)</span></span></span><br><span class="line">E8 97 F2 FF FF			call		sum(01271424h)  ä»…æœ‰E8 åé¢è®¡ç®—å‡ºçš„åœ°å€å€¼æœ‰ç»†å¾®åŒºåˆ« (è¯¦è§Intelæœºå™¨ç ç™½çš®ä¹¦)</span><br></pre></td></tr></table></figure>



<h3 id="4ã€extern-â€œCâ€"><a href="#4ã€extern-â€œCâ€" class="headerlink" title="4ã€extern â€œCâ€"></a>4ã€extern â€œCâ€</h3><hr>
<p>è¢«<code>extern &quot;C&quot;</code>ä¿®é¥°çš„ä»£ç ä¼šæŒ‰ç…§Cè¯­è¨€çš„è§„èŒƒå»ç¼–è¯‘</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line">exterm <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> v)</span></span>&#123; <span class="comment">//æŠ¥é”™ï¼Œå› ä¸ºCä¸æ”¯æŒé‡è½½</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå‡½æ•°åŒæ—¶æœ‰å£°æ˜ä¸å®ç°ï¼Œè¦åœ¨å£°æ˜å¤„ä½¿ç”¨<code>extern &quot;C&quot;</code>ï¼Œåœ¨å®ç°å¤„å¯ä»¥ä¸ç”¨æ·»åŠ ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> v)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä¸ºæ–¹ä¾¿ä½¿ç”¨ç›´æ¥åœ¨å¤´æ–‡ä»¶ä½¿ç”¨</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;****.h&quot;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ç”¨Cè¯­è¨€å¼€å‘çš„ç¬¬ä¸‰æ–¹æ¡†æ¶\åº“</li>
</ul>
<p>åœ¨C\C++æ··åˆå¼€å‘çš„æ—¶å€™ä¼šå‡ºç°å¤§é‡é—®é¢˜ï¼Œæ¨èæŒ‰ä¸€ä¸‹æ–¹å¼ä½¿ç”¨<code>extern &quot;C&quot;</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus <span class="comment">//ä½¿ç”¨å®</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†é¿å…é‡å¤å¼•ç”¨ï¼Œç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ***</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ***</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸€å®šè¦ä¿è¯æ¯ä¸€ä¸ªæ–‡ä»¶é‡Œçš„å®éƒ½ä¸ç›¸åŒï¼Œæ¨èå°†å®å’Œæ–‡ä»¶åå­—ç›¸åŒã€‚<code>#pragma once</code> å¯ä»¥ä¿è¯æ•´ä¸ªæ–‡ä»¶å†…å®¹åªè¢«ç¼–è¯‘ä¸€æ¬¡ï¼Œé¿å…é‡å¤åŒ…å«ï¼Œä½†æ˜¯ <code>#pragma once</code>ä¸è¢«æŸäº›ç¼–è¯‘å™¨æ”¯æŒã€‚</p>
<h3 id="5ã€å†…è”å‡½æ•°"><a href="#5ã€å†…è”å‡½æ•°" class="headerlink" title="5ã€å†…è”å‡½æ•°"></a>5ã€å†…è”å‡½æ•°</h3><hr>
<p>ä½¿ç”¨<code>inline</code>å…³é”®å­—å°†å…¶å˜ä¸ºå†…è”å‡½æ•°ã€‚ç¼–è¯‘å™¨ç›´æ¥å°†å‡½æ•°è°ƒç”¨å±•å¼€ä¸ºå‡½æ•°ä½“ä»£ç ã€‚</p>
<p>åœ¨å‡½æ•°å¼€å§‹çš„æ—¶å€™ä¼šå¼€è¾Ÿæ ˆç©ºé—´ï¼Œå‡½æ•°ç»“æŸçš„æ—¶å€™å›æ”¶æ ˆç©ºé—´ã€‚å†…è”å‡½æ•°åœ¨ä»£ç ä½“ç§¯ä¸å¤§å’Œä½¿ç”¨æ¬¡æ•°è¿‡å¤šçš„æ—¶å€™æ¨èä½¿ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">    run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    func();</span><br><span class="line">    <span class="keyword">int</span> c = sum(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    ä¸å†…è”</span><br><span class="line">    push		<span class="number">14</span>h</span><br><span class="line">    push		<span class="number">0</span>Ah</span><br><span class="line">    <span class="function">call		<span class="title">sum</span><span class="params">(<span class="number">08110</span>A0h)</span></span></span><br><span class="line">    åœ¨releaseæ¨¡å¼ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥å°†sumå‡½æ•°ä¼˜åŒ–ï¼Œç›´æ¥ç»™å‡ºè¿”å›å€¼ï¼Œä¸å†è°ƒç”¨å‡½æ•°ã€‚</span><br><span class="line">    æŠŠä¼˜åŒ–å…³é—­ï¼Œè¿›è¡Œç›¸å…³è°ƒæ•´å</span><br><span class="line">    mov			eax,<span class="number">0</span>Ah</span><br><span class="line">   	add 		eax,<span class="number">14</span>h</span><br><span class="line">    mov			dword ptr [c],eax  <span class="comment">//ç­‰åŒäºç›´æ¥å®ç° 10 + 20 </span></span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; c &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    </span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…è”å‡½æ•°ä¸å®å¯¹æ¯”ï¼š</p>
<ul>
<li>ä¸¤è€…éƒ½èƒ½å‡å°‘å‡½æ•°è°ƒç”¨</li>
<li>ç›¸æ¯”äºå®å†…è”å‡½æ•°å…·æœ‰å‡½æ•°ç‰¹æ€§ï¼Œæ‹¥æœ‰è¯­æ³•æ£€æµ‹å’Œä»£ç æç¤ºåŠŸèƒ½</li>
</ul>
<h3 id="6ã€è¡¨è¾¾å¼"><a href="#6ã€è¡¨è¾¾å¼" class="headerlink" title="6ã€è¡¨è¾¾å¼"></a>6ã€è¡¨è¾¾å¼</h3><hr>
<ul>
<li><p>C++æœ‰äº›è¡¨è¾¾å¼èƒ½è¢«èµ‹å€¼</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">(a = b) = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// a = 4; b = 2;</span></span><br><span class="line">(a &gt; b ? a : b) = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// b = 4</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="7ã€const"><a href="#7ã€const" class="headerlink" title="7ã€const"></a>7ã€const</h3><hr>
<ul>
<li><p>constæ˜¯å¸¸é‡çš„æ„æ€ï¼Œè¢«ä¿®é¥°çš„å˜é‡ä¸å¯ä¿®æ”¹</p>
<p>å¦‚æœä¿®é¥°çš„æ˜¯ç±»ã€ç»“æ„ä½“(çš„æŒ‡é’ˆ)ï¼Œæˆå‘˜å‡½æ•°ä¸å¯ä»¥æ›´æ”¹</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> *p0 = &amp;age;</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> *p1 = &amp;age; <span class="comment">// p0 p1 ç­‰ä»·ï¼Œéƒ½è¢«constä¿®é¥°</span></span><br><span class="line"><span class="keyword">int</span> * <span class="keyword">const</span> p2 = &amp;age;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> * <span class="keyword">const</span> p3 = &amp;age;</span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> * <span class="keyword">const</span> p4 = &amp;age; <span class="comment">// p3 p4 ç­‰ä»·</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºconstæœ‰ä»¥ä¸‹ç»“è®ºï¼š</p>
<ul>
<li><p>constä¿®é¥°çš„æ˜¯å…¶å³è¾¹çš„å†…å®¹ </p>
<blockquote>
<p>const int * <code>const p3</code> = &age;  æ„å‘³ç€p3ä¸ºå¸¸é‡ä½†æ˜¯*p3ä¸æ˜¯å¸¸é‡ï¼Œå¯ä»¥å¯¹ *p3è¿›è¡Œä¿®æ”¹</p>
</blockquote>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span>&#123;</span> <span class="keyword">int</span> age; &#125;;</span><br><span class="line">Student stu1 = &#123;<span class="number">20</span>&#125;;</span><br><span class="line">Student stu2 = &#123;<span class="number">20</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Student *pStu1 = &amp;stu1;</span><br><span class="line">*pStu1 = stu2; <span class="comment">// æŠ¥é”™ï¼Œconstä¿®é¥°*pStu1ä¸èƒ½è¢«èµ‹å€¼</span></span><br><span class="line">(*pStu1).age = <span class="number">30</span>; </span><br><span class="line">pStu1-&gt;age = <span class="number">30</span>; <span class="comment">// æŠ¥é”™ï¼Œä¸ºäº†ä¿è¯constçš„ä¸¥è°¨æ€§ï¼Œä¸å…è®¸é€šè¿‡æŒ‡é’ˆè®¿é—®æˆå‘˜å±æ€§</span></span><br><span class="line">pStu1 = &amp;stu2;</span><br><span class="line"></span><br><span class="line">Student * <span class="keyword">const</span> pStu2 = &amp;stu2;</span><br><span class="line">*pStu2 = stu1;</span><br><span class="line">(*pStu2).age = <span class="number">30</span>;</span><br><span class="line">pStu2-&gt;age = <span class="number">30</span>;</span><br><span class="line">pStu2 = &amp;stu1; <span class="comment">// æŠ¥é”™ï¼Œä¸èƒ½ä¿®æ”¹pStu2çš„å†…å®¹</span></span><br></pre></td></tr></table></figure>

<h3 id="8ã€å¼•ç”¨-Reference"><a href="#8ã€å¼•ç”¨-Reference" class="headerlink" title="8ã€å¼•ç”¨(Reference)"></a>8ã€å¼•ç”¨(Reference)</h3><hr>
<p>åœ¨Cè¯­è¨€ä¸­ï¼Œä½¿ç”¨<code>æŒ‡é’ˆ(Pointer)</code>å¯ä»¥é—´æ¥è·å–ã€ä¿®æ”¹æŸä¸ªå˜é‡çš„å€¼</p>
<p>åœ¨C++ä¸­ï¼Œä½¿ç”¨<code>å¼•ç”¨(Reference)</code>å¯ä»¥èµ·åˆ°æ›´æŒ‡é’ˆç±»ä¼¼çš„åŠŸèƒ½</p>
<p>å¼•ç”¨çš„æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>å¼•ç”¨ç›¸å½“äºå˜é‡çš„åˆ«å</li>
<li>å¯¹å¼•ç”¨åšè®¡ç®—ç­‰äºå¯¹å…¶æŒ‡å‘çš„å˜é‡åšè¿ç®—</li>
<li>å¿…é¡»åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ï¼Œè€Œä¸”ä¸€æ—¦æŒ‡å‘æŸä¸ªå˜é‡å°±ä¸å¯ä»¥å†æ”¹å˜</li>
<li>å¯ä»¥åˆ©ç”¨ä¸€ä¸ªå¼•ç”¨åˆå§‹åŒ–å¦ä¸€ä¸ªå¼•ç”¨ï¼Œç›¸å½“äºä¸€ä¸ªå˜é‡æœ‰å¤šä¸ªåˆ«å</li>
<li>ä¸å­˜åœ¨<code>å¼•ç”¨çš„å¼•ç”¨</code>ã€<code>æŒ‡å‘å¼•ç”¨çš„æŒ‡é’ˆ</code>ã€<code>å¼•ç”¨æ•°ç»„</code></li>
</ul>
<p>å¼•ç”¨çš„ä»·å€¼ï¼šæ¯”æŒ‡é’ˆæ›´å®‰å…¨ã€å‡½æ•°è¿”å›å€¼å¯ä»¥è¢«èµ‹å€¼</p>
<h5 id="å¼•ç”¨çš„æœ¬è´¨"><a href="#å¼•ç”¨çš„æœ¬è´¨" class="headerlink" title="å¼•ç”¨çš„æœ¬è´¨"></a>å¼•ç”¨çš„æœ¬è´¨</h5><ul>
<li>å¼•ç”¨çš„æœ¬è´¨å°±æ˜¯æŒ‡é’ˆï¼Œåªæ˜¯ç¼–è¯‘å™¨å‰Šå¼±äº†å®ƒçš„åŠŸèƒ½ï¼Œå¼•ç”¨å°±æ˜¯å¼±åŒ–äº†çš„æŒ‡é’ˆ</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> &amp;age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="keyword">sizeof</span>(student) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 8 X64ç¯å¢ƒ ä¹Ÿå°±æ˜¯ä»ä¾§é¢è¯æ˜äº†å¼•ç”¨çš„å¤§å°ä¸º8bit</span></span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ±‡ç¼–ç (å…³é—­æ˜¾ç¤ºç¬¦å·):</p>
<ul>
<li>æŒ‡é’ˆ</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> *p = &amp;age;</span><br><span class="line">lea			eax,[ebp<span class="number">-18</span>h],eax</span><br><span class="line">mov			dword ptr [ebp<span class="number">-18</span>h],eax</span><br><span class="line">*p = <span class="number">30</span>;</span><br><span class="line">mov 		eax,dword ptr [ebp<span class="number">-18</span>h]</span><br><span class="line">mov 		dword ptr [eax],<span class="number">1</span>Eh</span><br></pre></td></tr></table></figure>

<ul>
<li>å¼•ç”¨</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> &amp;ref = age;</span><br><span class="line">lea			eax,[ebp<span class="number">-18</span>h],eax</span><br><span class="line">mov			dword ptr [ebp<span class="number">-18</span>h],eax</span><br><span class="line">ref = <span class="number">30</span>;</span><br><span class="line">mov 		eax,dword ptr [ebp<span class="number">-18</span>h]</span><br><span class="line">mov 		dword ptr [eax],<span class="number">1</span>Eh</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å¯¹æ¯”å‘ç°ä¸¤è€…çš„æ±‡ç¼–ç å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥ä¸€ä¸ªå¼•ç”¨ä¹Ÿå°±å ç”¨ä¸€ä¸ªæŒ‡é’ˆçš„å¤§å°</p>
<h1 id="äºŒã€åŸºç¡€è¯­æ³•"><a href="#äºŒã€åŸºç¡€è¯­æ³•" class="headerlink" title="äºŒã€åŸºç¡€è¯­æ³•"></a>äºŒã€åŸºç¡€è¯­æ³•</h1><h3 id="1ã€x86ï¼Œx64æ±‡ç¼–"><a href="#1ã€x86ï¼Œx64æ±‡ç¼–" class="headerlink" title="1ã€x86ï¼Œx64æ±‡ç¼–"></a>1ã€x86ï¼Œx64æ±‡ç¼–</h3><hr>
<p>æ±‡ç¼–è¯­è¨€çš„ç§ç±»</p>
<ul>
<li>8086æ±‡ç¼–</li>
<li>x86æ±‡ç¼–</li>
<li>x64æ±‡ç¼–</li>
<li>ï¼¡ï¼²ï¼­æ±‡ç¼–</li>
<li>ï¼ï¼ï¼ï¼ï¼ï¼</li>
</ul>
<p>æ ¹æ®ç¼–è¯‘å™¨ä¸åŒï¼Œæœ‰ä¸¤ç§ä¹¦å†™æ ¼å¼</p>
<ul>
<li>Intel(Visual Studio)</li>
<li>AT&amp;T(Mac)</li>
</ul>
<h5 id="x64æ±‡ç¼–-å¯„å­˜å™¨"><a href="#x64æ±‡ç¼–-å¯„å­˜å™¨" class="headerlink" title="x64æ±‡ç¼–- å¯„å­˜å™¨"></a>x64æ±‡ç¼–- å¯„å­˜å™¨</h5><p>ä¸åŒæ±‡ç¼–çš„å¯„å­˜å™¨ä¸åŒ</p>
<p>å¸¸ç”¨å¯„å­˜å™¨ï¼š</p>
<table>
<thead>
<tr>
<th align="left">æ ‡è¯†ç¬¦</th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>RAX\RBX\RCX\RDX</strong></td>
<td align="left"><strong>(64bitä¸‹å¸¸è§)é€šç”¨å¯„å­˜å™¨</strong></td>
</tr>
<tr>
<td align="left"><strong>EAX\EBXECX\EDX</strong></td>
<td align="left"><strong>(32bitä¸‹å¸¸è§))é€šç”¨å¯„å­˜å™¨</strong></td>
</tr>
<tr>
<td align="left"><strong>AX\BX\CX\DX</strong></td>
<td align="left"><strong>(16bitä¸‹å¸¸è§)é€šç”¨å¯„å­˜å™¨</strong></td>
</tr>
</tbody></table>
<p>tipsï¼š</p>
<blockquote>
<ul>
<li><p>ä¸€ä¸ªå¯„å­˜å™¨èƒ½å­˜8ä¸ªå­—èŠ‚(x64)</p>
</li>
<li><p>ä¸ºäº†ä½¿æ–°çš„å¯„å­˜å™¨å…¼å®¹è€æ—§çš„å¯„å­˜å™¨å°†æ–°å¯„å­˜å™¨åˆ†æˆæ›´å°çš„åŒºå—æ¥å­˜å‚¨æ—§çš„å¯„å­˜å™¨</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>63â€¦32</th>
<th>31â€¦16</th>
<th>15â€¦8</th>
<th>7â€¦0</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td><strong>AHâ€¦</strong></td>
<td><strong>ALâ€¦</strong></td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>AXâ€¦</strong></td>
<td><strong>â€¦</strong></td>
</tr>
<tr>
<td></td>
<td><strong>EAXâ€¦</strong></td>
<td><strong>â€¦</strong></td>
<td><strong>â€¦</strong></td>
</tr>
<tr>
<td><strong>RAXâ€¦</strong></td>
<td><strong>â€¦</strong></td>
<td><strong>â€¦</strong></td>
<td><strong>â€¦</strong></td>
</tr>
</tbody></table>
<p>AH H high</p>
<p>AL  L low</p>
</blockquote>
<h3 id="2ã€å†…è”æ±‡ç¼–"><a href="#2ã€å†…è”æ±‡ç¼–" class="headerlink" title="2ã€å†…è”æ±‡ç¼–"></a>2ã€å†…è”æ±‡ç¼–</h3><hr>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    __asm&#123; <span class="comment">//x86</span></span><br><span class="line">        mov eax, a  <span class="comment">//çœŸå®çš„æ±‡ç¼–ä¸ä¼šå­˜åœ¨aè¿™ä¸ªç¬¦å·  å®é™…çš„æ±‡ç¼–ç ä¸º eax,dword ptr[ebp-oCh]</span></span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;		</span><br></pre></td></tr></table></figure>

<h3 id="3ã€å¸¸è§æŒ‡ä»¤"><a href="#3ã€å¸¸è§æŒ‡ä»¤" class="headerlink" title="3ã€å¸¸è§æŒ‡ä»¤"></a>3ã€å¸¸è§æŒ‡ä»¤</h3><hr>
<ul>
<li><p>mov              dest, src</p>
<blockquote>
<p>å°†srcå†…å®¹èµ‹å€¼ç»™destï¼Œç±»ä¼¼äºdest = src</p>
</blockquote>
</li>
<li><p>[åœ°å€å€¼]</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">int</span> b = a + <span class="number">1</span>ï¼›</span><br><span class="line">    </span><br><span class="line">mov           dword ptr [ebp<span class="number">-8</span>], <span class="number">3</span></span><br><span class="line"><span class="comment">//mov [1122h], 3 æ„å‘³ç€å°†3æ”¾å…¥[1122h]æ‰€åœ¨çš„åœ°å€ç©ºé—´</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><strong>mov                 [1128h], 3</strong></p>
<p><strong><code>word</code>æ˜¯2ä¸ªå­—èŠ‚ï¼Œ<code>dword</code>æ˜¯4ä¸ªå­—èŠ‚ï¼Œ<code>qword</code>æ˜¯8ä¸ªå­—èŠ‚</strong></p>
<p><strong>mov                 dword ptr [1128h], 3</strong>  //å°†3æ”¾åˆ°åœ°å€ä»¥1128hå¼€å§‹çš„å†…å­˜ä¸­ï¼Œå¹¶å ç”¨dwordä¸ªå†…å­˜åœ°å€**(å‘é«˜åœ°å€åˆå¹¶)**</p>
<p>4ä¸ªå­—èŠ‚å­˜å‚¨3ï¼š</p>
<blockquote>
<p>16è¿›åˆ¶: 00 00 00 03H </p>
<p>2è¿›åˆ¶: 00000000 00000000 00000000 00000011</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å†…å­˜åœ°å€</th>
<th align="center">å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1122h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1123h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1124h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1125h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1126h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1127h</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1128h</td>
<td align="center">3     (00 00 00 11) å°ç«¯æ¨¡å¼</td>
</tr>
<tr>
<td align="center">1129h</td>
<td align="center">|      (00 00 00 00)</td>
</tr>
<tr>
<td align="center">112Ah</td>
<td align="center">|      (00 00 00 00)</td>
</tr>
<tr>
<td align="center">112Bh</td>
<td align="center">|      (00 00 00 00)</td>
</tr>
</tbody></table>
<p>å¤§éƒ¨åˆ†æ—¶å€™æ˜¯å°ç«¯æ¨¡å¼(é«˜å­—èŠ‚æ”¾é«˜åœ°å€ï¼Œä½å­—èŠ‚æ”¾ä½åœ°å€)ï¼Œæ³¨æ„åœ¨è¯»åœ°å€çš„æ—¶å€™ä¸è®ºå¤§å°ç«¯æ¨¡å¼ï¼Œéƒ½æ˜¯ä»ä½åœ°å€å¼€å§‹è¯»ï¼Œè¯»å–è®¾å®šçš„å­—èŠ‚åï¼Œå¦‚ä½•æ’åˆ—é¡ºåºå†è€ƒè™‘å¤§å°ç«¯æ¨¡å¼é—®é¢˜</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">4</span>;</span><br><span class="line"><span class="number">0x007DF968</span>		<span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> cc cc cc cc <span class="comment">//8ä¸ªå­—èŠ‚ï¼Œ aå ç”¨äº†4ä¸ªå­—èŠ‚</span></span><br><span class="line"><span class="number">0x007DF970</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªå˜é‡çš„åœ°å€å€¼ï¼Œæ˜¯ä»–æ‰€æœ‰å­—èŠ‚åœ°å€ä¸­çš„æœ€å°å€¼</p>
</li>
</ul>
  <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line">mov 	dword ptr [ebp<span class="number">-8</span>], <span class="number">3</span></span><br><span class="line"><span class="comment">//[ebp-8] å³ä¸ºå˜é‡açš„åœ°å€</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;ã€€&amp;a &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">//açš„åœ°å€ä¸º 010FFE4C</span></span><br><span class="line">æ±‡ç¼–ç ä¸º:</span><br><span class="line">mov		dword ptr [ebp<span class="number">-0</span>Ch], <span class="number">3</span> <span class="comment">//è¿™é‡Œçš„å€¼ä¸èƒ½å†™æ­»ï¼Œå› ä¸ºæ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶å¼€è¾Ÿæ ˆç©ºé—´</span></span><br><span class="line">    						 <span class="comment">//è€Œä¸”æ¯ä¸€æ¬¡åˆ†é…çš„åœ°å€ä¸åŒï¼Œé‡Œé¢çš„å±€éƒ¨å˜é‡çš„åœ°å€ä¼šä¸€ç›´æ”¹å˜</span></span><br><span class="line">    						 <span class="comment">//æ¯æ¬¡è°ƒç”¨éƒ½ä¸åŒï¼Œ -0ch åˆ™æ¶‰åŠåˆ°å‡½æ•°æ ˆçš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="comment">//ebpçš„å€¼ä¸º 010FFE58</span></span><br><span class="line">a - ebp = c (<span class="number">16</span>è¿›åˆ¶)</span><br><span class="line">    </span><br><span class="line">å¦‚æœæ˜¯å…¨å±€å˜é‡çš„åœ°å€å€¼,è¯¥å˜é‡çš„åœ°å€å€¼æ˜¯å†™æ­»çš„</span><br><span class="line">age = <span class="number">3</span>;</span><br><span class="line">mov			dword ptr ds:[<span class="number">00F</span>DA008h] <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">å¸¸é‡çš„è¯åœ°å€å€¼ä¹Ÿä¼šå˜åŠ¨</span><br></pre></td></tr></table></figure>

<ul>
<li>call å‡½æ•°åœ°å€</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"> 	test();   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">é¦–å…ˆ:</span><br><span class="line">call		<span class="number">003713</span>A2 <span class="comment">//å¹¶éçœŸæ­£å‡½æ•°åœ°å€ æŒ‰F11</span></span><br><span class="line"></span><br><span class="line">jmp			<span class="number">00371780</span> <span class="comment">//è·³è½¬åˆ°çœŸæ­£çš„å‡½æ•°åœ°å€ è¿›å…¥è¿™ä¸ªåœ°å€</span></span><br><span class="line">    </span><br><span class="line"><span class="number">00371780</span> <span class="number">55</span>			push		ebp</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ul>
<li>lea               eax, [1122h]     //load effect address è£…è½½ä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€å€¼</li>
</ul>
<blockquote>
<p>ç­‰åŒäº mov             eax, 1122h</p>
</blockquote>
<ul>
<li>ret</li>
</ul>
<blockquote>
<p>å‡½æ•°è¿”å›</p>
</blockquote>
<ul>
<li>xor</li>
</ul>
<blockquote>
<p>å¼‚æˆ– xor            op1, op2å°†op1å’Œop2å¼‚æˆ–çš„ç»“æœèµ‹å€¼ç»™op1</p>
</blockquote>
<ul>
<li>addï¼Œsub</li>
</ul>
<blockquote>
<p>åŠ æ³•ï¼Œå‡æ³•</p>
</blockquote>
<ul>
<li>incï¼Œdec</li>
</ul>
<blockquote>
<p>è‡ªå¢ï¼Œè‡ªå‡</p>
</blockquote>
<ul>
<li>jmp</li>
</ul>
<blockquote>
<p>jmp             å†…å­˜åœ°å€      è·³è½¬åˆ°æŒ‡å®šçš„å†…å­˜åœ°å€å¼€å§‹æ‰§è¡Œ(æ— æ¡ä»¶è·³è½¬)</p>
<p>ä»¥ j å¼€å¤´çš„æ±‡ç¼–æŒ‡ä»¤ä¸€èˆ¬éƒ½æ˜¯è·³è½¬ï¼Œä¸€èˆ¬è·Ÿtestã€cmpç­‰æŒ‡ä»¤é…åˆä½¿ç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(a == b)&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="number">007118F</span>8  mov         dword ptr [ebp<span class="number">-8</span>],<span class="number">0</span>Ah  </span><br><span class="line">	<span class="keyword">int</span> b = <span class="number">20</span>;</span><br><span class="line"><span class="number">007118F</span>F  mov         dword ptr [ebp<span class="number">-14</span>h],<span class="number">14</span>h  </span><br><span class="line"><span class="keyword">if</span> (a == b) &#123;</span><br><span class="line"><span class="number">00711906</span>  mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line"><span class="number">00711909</span>  cmp         eax,dword ptr [ebp<span class="number">-14</span>h]  </span><br><span class="line"><span class="number">0071190</span>C  jne         <span class="number">0071191</span>D  </span><br><span class="line"><span class="comment">// jump not equal</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="number">0071190</span>E  push        <span class="number">717B</span>30h  </span><br><span class="line"><span class="number">00711913</span>  call        <span class="number">00711046</span>  </span><br><span class="line"><span class="number">00711918</span>  add         esp,<span class="number">4</span>  </span><br><span class="line">	&#125;</span><br><span class="line"><span class="number">0071191B</span>  jmp         <span class="number">0071192</span>A  </span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="number">0071191</span>D  push        <span class="number">717B</span>34h  <span class="comment">// jne è·³è½¬çš„åœ°å€</span></span><br><span class="line"><span class="number">00711922</span>  call        <span class="number">00711046</span>  </span><br><span class="line"><span class="number">00711927</span>  add         esp,<span class="number">4</span>  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0071192</span>A  <span class="keyword">xor</span>         eax,eax <span class="comment">// jmp è·³è½¬çš„åœ°å€</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>æ±‡ç¼–æƒå¨å‚è€ƒï¼š Intel ç™½çš®ä¹¦</strong></p>
<h3 id="4ã€å¼•ç”¨"><a href="#4ã€å¼•ç”¨" class="headerlink" title="4ã€å¼•ç”¨"></a>4ã€å¼•ç”¨</h3><hr>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> age = <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">int</span> *p = &amp;age;</span><br><span class="line">	*p = <span class="number">5</span>;</span><br><span class="line">	</span><br><span class="line"><span class="number">007</span>D17F2  mov         dword ptr [ebp<span class="number">-0</span>C h],<span class="number">3</span>  </span><br><span class="line"><span class="number">007</span>D17F9  lea         eax,[ebp<span class="number">-0</span>Ch]  <span class="comment">// eax å­˜æ”¾ageçš„åœ°å€å€¼</span></span><br><span class="line"><span class="number">007</span>D17FC  mov         dword ptr [ebp<span class="number">-18</span>h],eax  </span><br><span class="line"><span class="comment">//å°†ageçš„åœ°å€å€¼å­˜æ”¾åˆ°æŒ‡é’ˆå˜é‡pæ‰€åœ¨çš„å­˜å‚¨ç©ºé—´</span></span><br><span class="line"><span class="number">007</span>D17FF  mov         eax,dword ptr [ebp<span class="number">-18</span>h]  </span><br><span class="line"><span class="comment">//å°†ageçš„åœ°å€å€¼å­˜æ”¾åˆ° eax</span></span><br><span class="line"><span class="number">007</span>D1802  mov         dword ptr [eax],<span class="number">5</span>  </span><br><span class="line"><span class="comment">//å°†5æ”¾åˆ°ageçš„åœ°å€å€¼</span></span><br><span class="line"><span class="number">007</span>D1808  mov         esi,esp  </span><br><span class="line">    </span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¦‚æœä»£ç ç‰µæ‰¯åˆ°æŒ‡é’ˆï¼Œé‚£ä¹ˆä¸€å®šä¼šç‰µæ‰¯åˆ°æ±‡ç¼–çš„ <code>lea</code> æŒ‡ä»¤</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">lea 		eax,[ebp<span class="number">-0</span>Ch] <span class="comment">// [ebp-0Ch]æ•°æ®åœ°å€å€¼</span></span><br><span class="line">mov 		dword ptr [ebp<span class="number">-18</span>h],eax <span class="comment">//[ebp-18h]æŒ‡é’ˆå˜é‡è‡ªå·±çš„åœ°å€å€¼</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯å¼•ç”¨çš„è¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">3</span></span><br><span class="line"><span class="keyword">int</span> &amp;ref = age;</span><br><span class="line">ref = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">00B</span>817F2  mov         dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">3</span>  </span><br><span class="line"><span class="number">00B</span>817F9  lea         eax,[ebp<span class="number">-0</span>Ch]  </span><br><span class="line"><span class="number">00B</span>817FC  mov         dword ptr [ebp<span class="number">-18</span>h],eax  </span><br><span class="line"><span class="number">00B</span>817FF  mov         eax,dword ptr [ebp<span class="number">-18</span>h]  </span><br><span class="line"><span class="number">00B</span>81802  mov         dword ptr [eax],<span class="number">5</span></span><br><span class="line"><span class="comment">// å’ŒæŒ‡é’ˆçš„æ±‡ç¼–ç å®Œå…¨ä¸€æ ·</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‡é’ˆå¼•ç”¨</span></span><br><span class="line">*<span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> *p = &amp;age;</span><br><span class="line"><span class="keyword">int</span> *&amp;ref = p;</span><br><span class="line">*ref = <span class="number">30</span>; <span class="comment">// ref == f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> height = <span class="number">30</span>;</span><br><span class="line">ref = &amp;height; <span class="comment">// p = 30;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„å¼•ç”¨</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> (&amp;ref)[<span class="number">3</span>] = <span class="built_in">array</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line"><span class="keyword">int</span> *arr[<span class="number">3</span>]; <span class="comment">//æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„å†…éƒ¨èƒ½æ”¾3ä¸ªint*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> (*arr)[<span class="number">3</span>]; <span class="comment">//æ•°ç»„æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ  ----&gt;  æ¨å‡ºæ•°ç»„æŒ‡é’ˆçš„ä¸€ç§å†™æ³• int (&amp;arr)[3] = array;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="å¸¸å¼•ç”¨"><a href="#å¸¸å¼•ç”¨" class="headerlink" title="å¸¸å¼•ç”¨"></a>å¸¸å¼•ç”¨</h5><p>constå¿…é¡»å†™åœ¨&amp;ç¬¦å·çš„å·¦è¾¹æ‰æ˜¯å¸¸é¥®ç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> &amp; <span class="keyword">const</span> ref = age;</span><br><span class="line">ref = <span class="number">30</span>;</span><br><span class="line"><span class="comment">//ref ä¸èƒ½ä¿®æ”¹æŒ‡å‘ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡refé—´æ¥ä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹æ¯”æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">int</span> * <span class="keyword">const</span> p1 = &amp;age; <span class="comment">// p1 = &amp;height</span></span><br><span class="line">*p1 = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// p2å¯ä»¥ä¿®æ”¹æŒ‡å‘ï¼Œä¸å¯ä»¥åˆ©ç”¨p2é—´æ¥ä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> *p2 = &amp;age;</span><br></pre></td></tr></table></figure>

<h5 id="const-å¼•ç”¨çš„ç‰¹ç‚¹"><a href="#const-å¼•ç”¨çš„ç‰¹ç‚¹" class="headerlink" title="const å¼•ç”¨çš„ç‰¹ç‚¹"></a>const å¼•ç”¨çš„ç‰¹ç‚¹</h5><ul>
<li>constå¼•ç”¨å¯ä»¥æŒ‡å‘ä¸´æ—¶æ•°æ®(å¸¸é‡ã€è¡¨è¾¾å¼ã€å‡½æ•°è¿”å›å€¼ç­‰ç­‰)</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = <span class="number">30</span>; <span class="comment">//å¸¸é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = a + b; <span class="comment">// è¡¨è¾¾å¼</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> &amp;ref = func(); <span class="comment">// å‡½æ•°è¿”å›å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½œä¸ºå‡½æ•°å‚æ•°æ—¶(åŒæ—¶é€‚ç”¨äºconstæŒ‡é’ˆ)</li>
</ul>
<blockquote>
<p>å¯ä»¥æ¥å—constå’Œéconstå®å‚(éconstå¼•ç”¨ï¼Œåªèƒ½æ¥å—éconstå®å‚)</p>
<p>å¯ä»¥è·Ÿéconstå¼•ç”¨æ„æˆé‡è½½</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;v1, <span class="keyword">const</span> <span class="keyword">int</span> &amp;v2)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> v1 + v2;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> &amp;v1, <span class="keyword">int</span> &amp;v2)</span></span>&#123; <span class="comment">// æ„æˆé‡è½½</span></span><br><span class="line">    <span class="keyword">return</span> v1 + v2;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// éconstå®å‚</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">20</span>;</span><br><span class="line">    <span class="comment">//constå®å‚</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> c = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> d = <span class="number">20</span></span><br><span class="line">    sum(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    sum(c, d);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å¸¸å¼•ç”¨æŒ‡å‘äº†ä¸åŒçš„æ•°æ®æ—¶ï¼Œä¼šäº§ç”Ÿ<code>ä¸´æ—¶å˜é‡</code>ï¼Œå³å¼•ç”¨æŒ‡å‘çš„å¹¶ä¸æ˜¯åˆå§‹åŒ–æ—¶çš„é‚£ä¸ªå˜é‡</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">long</span> &amp;rAge = age;</span><br><span class="line">age = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; age; <span class="comment">// 30</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; rAge; <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="number">00</span>CB17F2  mov         dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">0</span>Ah  <span class="comment">// </span></span><br><span class="line"><span class="number">00</span>CB17F9  mov         eax,dword ptr [ebp<span class="number">-0</span>Ch]  <span class="comment">// 10 æ”¾åˆ° eax</span></span><br><span class="line"><span class="number">00</span>CB17FC  mov         dword ptr [ebp<span class="number">-24</span>h],eax  <span class="comment">// 10 æ”¾åˆ°å¦å¤–ä¸€ä¸ªå­˜å‚¨ç©ºé—´</span></span><br><span class="line">ç›¸å½“äº <span class="keyword">const</span> <span class="keyword">long</span> &amp;rAge = temp;</span><br><span class="line"><span class="number">00</span>CB17FF  lea         ecx,[ebp<span class="number">-24</span>h]  </span><br><span class="line"><span class="number">00</span>CB1802  mov         dword ptr [ebp<span class="number">-18</span>h],ecx  </span><br><span class="line"><span class="number">00</span>CB1805  mov         dword ptr [ebp<span class="number">-0</span>Ch],<span class="number">1</span>Eh  </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> arr[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> (&amp;ref)[<span class="number">3</span>]arr = arr;</span><br><span class="line"><span class="keyword">int</span> * <span class="keyword">const</span> &amp;ref = arr;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>æ±‡ç¼–</tag>
      </tags>
  </entry>
  <entry>
    <title>å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°</title>
    <url>/myblog/2020/10/07/C/%E5%B9%B6%E5%8F%91%EF%BC%9A%E4%BA%92%E6%96%A5%E4%B8%8E%E5%90%8C%E6%AD%A5%E7%9A%84%E5%90%84%E7%A7%8D%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°"><a href="#å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°" class="headerlink" title="å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°"></a>å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç°</h1><hr>
<p>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œæ ¸å¿ƒçš„è®¾è®¡é—®é¢˜åœ¨ä¸è¿›ç¨‹å’Œçº¿ç¨‹çš„ç®¡ç†ã€‚è€Œåœ¨å¯¹äºåœ¨<code>å¤šé“ç¨‹åºå¤„ç†</code>, <code>å¤šå¤„ç†å™¨ç¯å¢ƒ</code>ï¼Œ<code>åˆ†å¸ƒå¼ç³»ç»Ÿ</code>ç­‰ç›¸å…³é¢†åŸŸçš„åº”ç”¨ï¼Œä»¥åŠæ“ä½œç³»ç»Ÿè®¾è®¡çš„æœ¬èº«ï¼Œæœ€åŸºç¡€çš„é—®é¢˜å°±æ˜¯å¹¶å‘(Concurrency)ã€‚</p>
<p><em>ç”±äºç¯‡å¹…é—®é¢˜ï¼Œåœ¨è¿™é‡Œåªè®¨è®ºå„ç§å®ç°ï¼Œä¸å¯¹å…¶å„ç§æ–¹æ¡ˆçš„ä¼˜åŠ£è¿›è¡Œè¿‡å¤šè®¨è®ºï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒ ã€Šæ“ä½œç³»ç»Ÿ ç²¾é«“ä¸è®¾è®¡åŸç†ã€‹</em></p>
<h3 id="ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ"><a href="#ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ" class="headerlink" title="ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ"></a>ä¸€ã€äº’æ–¥çš„ç¡¬ä»¶æ”¯æŒæ–¹æ¡ˆ</h3><hr>
<h5 id="1ã€å…³ä¸­æ–­"><a href="#1ã€å…³ä¸­æ–­" class="headerlink" title="1ã€å…³ä¸­æ–­"></a>1ã€å…³ä¸­æ–­</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* disable interrupts */</span></span><br><span class="line">    <span class="comment">/* critical section */</span>  ä¸´ç•ŒåŒºæ‰§è¡Œ</span><br><span class="line">    <span class="comment">/* enable interrupts */</span></span><br><span class="line">    <span class="comment">/* remainder */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡é‡‡ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åŸè¯­çš„æ–¹å¼å¯ä»¥ä½¿ä¸´ç•ŒåŒºçš„æ‰§è¡Œä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œè¾¾åˆ°äº†äº’æ–¥çš„æ•ˆæœã€‚</p>
<p>ä½†æ˜¯è¯¥æ–¹æ¡ˆæœ‰ä¸¤ä¸ªæ˜æ˜¾ç¼ºé™·ï¼š</p>
<ul>
<li>ç”±äºä¸´ç•ŒåŒºçš„æ‰§è¡Œï¼Œå¯¼è‡´å¤„ç†å™¨ä¸èƒ½éšæ„ç©¿æ’æ‰§è¡Œè¿›ç¨‹ï¼Œå¯¼è‡´å¤„ç†å™¨æ•ˆç‡æ˜æ˜¾é™ä½</li>
<li>è¯¥æ–¹æ¡ˆä¸èƒ½ç›´æ¥ç”¨äºå¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå› ä¸ºåœ¨åŒä¸€æ—¶é—´é‡Œï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªè¿›ç¨‹åœ¨åŒæ—¶è¿›è¡Œï¼Œåªå¯¹ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå…³ä¸­æ®µä¸ä¸€å®šèƒ½ä¿è¯äº’æ–¥</li>
</ul>
<h5 id="2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤"><a href="#2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤" class="headerlink" title="2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤"></a>2ã€ç‰¹æ®Šæœºå™¨æŒ‡ä»¤</h5><p>å½“å¤„ç†å™¨è®¿é—®æŸä¸€å†…å­˜åœ°å€çš„æ—¶å€™ï¼Œä¸ºäº†é€šè¿‡ç¡¬ä»¶æ‰‹æ®µé¿å…å…¶ä»–å¤„ç†å™¨å¯¹è¯¥å†…å­˜åœ°å€çš„è®¿é—®ï¼Œè®¾è®¡äº†å‡ æ¡æœºå™¨æŒ‡ä»¤æ¥å®ç°ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸ŠåŠ¨ä½œçš„åŸå­æ€§ã€‚</p>
<p>1&gt; æ¯”è¾ƒæ›¿æ¢æŒ‡ä»¤</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">compare_and_swap</span><span class="params">(<span class="keyword">int</span> *word, <span class="keyword">int</span> testVal, <span class="keyword">int</span> newVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oldVal;</span><br><span class="line">    oldVal = *word;</span><br><span class="line">    <span class="keyword">if</span>(oldVal == testVal)</span><br><span class="line">    &#123;</span><br><span class="line">        *word = testVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldVal;</span><br><span class="line">&#125; <span class="comment">// è¿™ä¸ªå‡½æ•°çš„æ“ä½œä¸å¯è¢«å¹²æ‰°æˆ–è€…æ‰“æ–­ï¼Œå…·æœ‰åŸå­æ€§ã€‚</span></span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusion */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n = <span class="comment">/* number of process */</span> è¿›ç¨‹çš„æ•°é‡</span><br><span class="line"><span class="keyword">int</span> bolt; å…±äº«å˜é‡åˆå€¼ä¸º <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(compare_and_swap(bolt, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>) åªæœ‰å½“å‘ç°boltä¸º<span class="number">0</span>çš„è¿›ç¨‹æ‰èƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼Œè€Œå…¶ä»–çš„è¿›ç¨‹ä¸åœçš„æ¯”è¾ƒæ›¿æ¢ç”³è¯·è¿›å…¥ä¸´ç•ŒåŒº</span><br><span class="line">            								  ä¼šé€ æˆå¿™ç­‰ç°è±¡</span><br><span class="line">            <span class="comment">/* do nothing */</span>;</span><br><span class="line">        <span class="comment">/* critical section */</span>;</span><br><span class="line">        bolt = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* remainder */</span>; boltè¢«ç½®é›¶åå…¶ä»–è¿›ç¨‹æ‰æœ‰ä¸€ä¸ªæœºä¼šå°†boltç½®<span class="number">1</span>è¿›å…¥ä¸´ç•ŒåŒº</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bolt = <span class="number">0</span>;</span><br><span class="line">    parbeging( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>) ......);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2&gt; äº¤æ¢æŒ‡ä»¤</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exchange</span><span class="params">(<span class="keyword">int</span> *<span class="keyword">register</span>, <span class="keyword">int</span> *memory)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    temp = *memory;</span><br><span class="line">    *memory = *<span class="keyword">register</span>;</span><br><span class="line">    *<span class="keyword">register</span> = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusin */</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">const</span> n = <span class="comment">/* number of process */</span>;</span><br><span class="line"><span class="keyword">int</span> bolt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> keyi = <span class="number">1</span>;</span><br><span class="line">        do exchange(&amp;key1, &amp;bolt) å¦‚æœäº¤æ¢åkey = 1, é‚£ä¹ˆå°±è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¦åˆ™åœ¨ä¸´ç•ŒåŒºå¤–å¿™ç­‰</span><br><span class="line">        <span class="keyword">while</span>(keyi != <span class="number">0</span>);</span><br><span class="line">        <span class="comment">/* critical section */</span></span><br><span class="line">        bolt = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* remainder */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bolt = <span class="number">0</span>;</span><br><span class="line">    parbegin( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>) ......);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºå…±äº«å˜é‡å’Œå±€éƒ¨å˜é‡çš„äº¤æ¢æ–¹å¼ï¼Œä»¥ä¸‹çš„è¡¨è¾¾å¼å§‹ç»ˆæˆç«‹<br>$$<br>bolt + \sum_ikey_{i} = 1<br>$$<br>bolt = 0 æ²¡æœ‰è¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œblot = 1 æœ‰ä¸”åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸´ç•ŒåŒº</p>
<h3 id="äºŒã€ä¿¡å·ç¯-Semaphore"><a href="#äºŒã€ä¿¡å·ç¯-Semaphore" class="headerlink" title="äºŒã€ä¿¡å·ç¯(Semaphore)"></a>äºŒã€ä¿¡å·ç¯(Semaphore)</h3><hr>
<p>ä¿¡å·ç¯æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•´å‹å˜é‡ã€‚å‘ä¿¡å·ç¯ <code>s</code> å‘é€ä¿¡å·ï¼Œè¿›ç¨‹å¯ä»¥è°ƒç”¨ <code>semSignal(s)</code> åŸè¯­ã€‚ä»ä¿¡å·ç¯å¤„æ¥æ”¶ä¿¡å·ï¼Œè¿›ç¨‹å¯ä»¥è°ƒç”¨<code>semWait(s)</code> åŸè¯­ã€‚å¦‚æœè¿›ç¨‹æ‰“ç®—æ¥å—æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¶ˆæ¯å°šæœªåˆ°è¾¾ï¼Œåˆ™è¯¥è¿›ç¨‹å¿…é¡»åœ¨ä¿¡å·ç¯ä¸Šç­‰å¾…ã€‚å› æ­¤å¯¹ä¿¡å·ç¯åšä»¥ä¸‹å®šä¹‰ï¼š</p>
<ol>
<li><strong>ä¿¡å·ç¯åˆå€¼ä¸ºéè´Ÿæ•´æ•°ã€‚</strong></li>
<li><strong>semWait æ“ä½œå°†ä¿¡å·ç¯çš„å€¼å‡1ã€‚å¦‚æœå…¶å€¼ä¸ºè´Ÿæ•°ï¼Œè°ƒç”¨semWaitçš„è¿›ç¨‹æ‰§è¡Œå°†è¢«é˜»å¡ã€‚å¦åˆ™è¿›ç¨‹å°†ç»§ç»­æ‰§è¡Œã€‚</strong></li>
<li><strong>semSignalæ“ä½œå°†ä¿¡å·ç¯çš„å€¼åŠ 1ã€‚å¦‚æœä¹‹åå…¶å€¼å°äºç­‰äº0ï¼Œåˆ™è¿›ç¨‹å”¤é†’åœ¨è¯¥ä¿¡å·ç¯ä¸Šç­‰å¾…çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ç»§ç»­è‡ªå·±çš„æ‰§è¡Œã€‚</strong></li>
</ol>
<p>ï¼ˆé™¤äº†ä»¥ä¸Šçš„3ç§æ“ä½œä»¥å¤–ä¸å…è®¸å¯¹ä¿¡å·ç¯åšå…¶ä»–çš„æ“ä½œï¼‰</p>
<p>ä¿¡å·ç¯çš„å®šä¹‰å’Œæ“ä½œçš„å®šä¹‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    queueType <span class="built_in">queue</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semWait</span><span class="params">(semaphore s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s.count--;</span><br><span class="line">    <span class="keyword">if</span>(count &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span>;</span><br><span class="line">        <span class="comment">/* block this process */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semSignal</span><span class="params">(semaphore s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s.count++;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">/* remove a process P from s.queue */</span>;</span><br><span class="line">        <span class="comment">/* palce process P on ready list */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>01ä¿¡å·ç¯ï¼Œ01ä¿¡å·ç¯åªæœ‰ä¸¤ä¸ªå–å€¼ï¼š0å’Œ1ï¼Œå…¶æ“ä½œåŸè¯­å®šä¹‰å¦‚ä¸‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binary_semaphore</span>&#123;</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;zero, oen&#125; value; åˆå€¼å¯ä»¥å–<span class="number">0</span>æˆ–<span class="number">1</span></span><br><span class="line">    queueType <span class="built_in">queue</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semWaitB</span><span class="params">(binary_semaphore s)</span> <span class="comment">//æ£€æµ‹ä¿¡å·ç¯çš„å–å€¼ï¼Œå¦‚æœå€¼ä¸º0ï¼Œæ‰§è¡ŒsemWaitBæ“ä½œçš„è¿›ç¨‹å°†è¢«é˜»å¡ã€‚å¦‚æœå€¼ä¸º1ï¼Œä¿¡å·ç¯çš„å€¼å°†è¢«ç½®0ï¼Œå¹¶ä¸”è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s.value == one)</span><br><span class="line">        s.value = zero;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span></span><br><span class="line">        <span class="comment">/* block this process */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> semSignalB(semaphore s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(s.<span class="built_in">queue</span> is empty()) <span class="comment">//æ£€æµ‹æ˜¯å¦æœ‰è¿›ç¨‹è¢«é˜»å¡åœ¨ä¿¡å·ç¯ä¸Šï¼Œå¦‚æœæœ‰å°†å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„è¿›ç¨‹ã€‚å¦‚æœæ²¡æœ‰åˆ™å°†ä¿¡å·ç¯çš„å€¼ç½®1ã€‚</span></span><br><span class="line">        s.value = one;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">/* remove a process P from s.queue */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1ã€äº’æ–¥çš„å®ç°"><a href="#1ã€äº’æ–¥çš„å®ç°" class="headerlink" title="1ã€äº’æ–¥çš„å®ç°"></a>1ã€äº’æ–¥çš„å®ç°</h5><p>é‡‡ç”¨ä¿¡å·ç¯å®ç°äº’æ–¥çš„ä¾‹å­</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusion */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n = <span class="comment">/* number of processes */</span>;</span><br><span class="line">semaphore s = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(s); <span class="comment">//è¿›ç¨‹åœ¨è¿›å…¥critical sectionå‰è°ƒç”¨semWait(s)åŸè¯­ï¼Œå¦‚æœs&lt;0,è¿›ç¨‹é˜»å¡ã€‚å¦‚æœs=1, s-1åï¼Œè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºè®¿é—®å…¬å…±èµ„æº</span></span><br><span class="line">        <span class="comment">/* critical section */</span>;</span><br><span class="line">        semSignal(s); <span class="comment">//æœ€å¼€å§‹è¿›å…¥çš„è¿›ç¨‹æ‰§è¡Œå®Œä¸´ç•ŒåŒºåå°†ä¿¡å·ç¯çš„å€¼åŠ 1ï¼Œå¹¶å°†ä¿¡å·ç¯ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„ä¸€ä¸ªç­‰å¾…è¿›ç¨‹å”¤é†’ï¼Œå¹¶ç½®ä¸ºå°±ç»ªæ€</span></span><br><span class="line">        <span class="comment">/* remainder */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>)...... );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸºäºä»¥ä¸Šçš„å®ç°ï¼Œä¿¡å·ç¯çš„å–å€¼ <code>s.count</code> å¯ä»¥è¿™æ ·ç†è§£ï¼š</p>
<ul>
<li>s.count &gt;= 0ï¼šèƒ½å¤Ÿé€šè¿‡è°ƒç”¨semWait(s)åŸè¯­ï¼Œè€Œæ— éœ€é˜»å¡å°±èƒ½è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹ä¸ªæ•°ã€‚ä¿¡å·ç¯çš„è¿™ä¸€ç‰¹æ€§ï¼Œè¿˜èƒ½ç”¨äºå®ç°è¿›ç¨‹åä½œã€‚</li>
<li>s.count &lt; 0ï¼šå…¶ç»å¯¹å€¼å°±æ˜¯åœ¨s.queueä¸Šç­‰å¾…ä¿¡å·ç¯çš„è¿›ç¨‹çš„ä¸ªæ•°ã€‚</li>
</ul>
<h5 id="2ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#2ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="2ã€ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜"></a>2ã€ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜</h5><p>ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…å°†æ•°æ®ä»ç¼“å†²åŒºå–å‡ºï¼Œä¸€æ¬¡å–ä¸€ä¸ªï¼Œä¸å…è®¸ä¸¤è€…å¯¹ç¼“å†²åŒºåŒæ—¶æ“ä½œã€‚</p>
<p>å‡è®¾ç¼“å†²åŒºçš„ç»“æ„æ˜¯ä¸€ä¸ªçº¿æ€§è¡¨ã€‚</p>
<p>é‡‡ç”¨01ä¿¡å·ç¯å’Œæ— çº¿ç¼“å†²æ¥è§£å†³ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„ï¼ˆ<strong>é”™è¯¯</strong>ï¼‰æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program producer&amp;consumer */</span></span><br><span class="line"><span class="keyword">int</span> n; <span class="comment">//è®°å½•ç¼“å†²åŒºä¸­â€œäº§å“â€çš„ä¸ªæ•° n = in - out</span></span><br><span class="line">binary_semaphore s = <span class="number">1</span>, delay = <span class="number">0</span>; <span class="comment">//é‡‡ç”¨delayç”¨äºåœ¨ç¼“å†²åŒºä¸º0çš„æ—¶å€™è¿«ä½¿æ¶ˆè´¹è€…ç­‰å¾…</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWaitB(s); <span class="comment">//ç”Ÿäº§è€…å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å‘ç¼“å†²åŒºæ”¾å…¥ç”Ÿäº§çš„æ•°æ®</span></span><br><span class="line">       	append();</span><br><span class="line">        n++;</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>) semSignalB(delay); <span class="comment">//n = 1, ä¹‹å‰ç¼“å†²åŒºä¸º0ï¼Œå”¤é†’æ¶ˆè´¹è€…</span></span><br><span class="line">        semSignalB(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semWaitB(delay); <span class="comment">//ç­‰å¾…ç¬¬ä¸€ä¸ªå¯ä»¥â€œæ¶ˆè´¹â€çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(B); </span><br><span class="line">        take();</span><br><span class="line">        n--;</span><br><span class="line">        semSignalB(B);</span><br><span class="line">        consume();</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>) semWaitB(delay);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    parbegin(producer, consumer);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é”™è¯¯ç‚¹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">semWait(B); <span class="comment">//æ¶ˆè´¹è€…æ¶ˆè´¹å®Œæ‰€æœ‰çš„æ•°æ®åï¼Œéœ€è¦é‡ç½®delayä¿¡å·ï¼Œåœ¨ç”Ÿäº§è€…æœªäº§ç”Ÿå‡ºæ–°çš„æ•°æ®å‰ç­‰å¾…</span></span><br><span class="line">		   <span class="comment">//å°±æ˜¯ if(n == 0) semWaitB(delay); è¯­å¥çš„ä½œç”¨ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶æ²¡æœ‰æ‰§è¡Œè¯¥è¯­å¥ï¼Œå¯¼è‡´æ¶ˆè´¹è€…æ¶ˆè´¹äº†ä¸å­˜åœ¨çš„æ•°æ®</span></span><br><span class="line">take();</span><br><span class="line">n--;</span><br><span class="line">semSignalB(B);</span><br></pre></td></tr></table></figure>

<p>åŸå› æ˜¯ç”Ÿäº§è€…åœ¨æ¶ˆè´¹è€…å¯¹nå†æ¬¡åˆ¤æ–­ä¹‹å‰å¯¹nè¿›è¡Œäº†åŠ 1æ“ä½œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">n++;</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">1</span>) semSignalB(delay); <span class="comment">//è¯¯ä»¥ä¸ºæ˜¯æ”¾å…¥çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œå…¶å®æ˜¯å‰©ä½™çš„æœ€åä¸€ä¸ªæ•°æ® </span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡è°ƒç”¨äº†semSignal(delay)å‘delayä¿¡å·ç¯å‘é€äº†ä¿¡å·ï¼Œè€Œåœ¨è¿™ä¹‹å‰æ²¡æœ‰ä¸ä¹‹é…å¯¹çš„semWait(delay)è°ƒç”¨ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ­£ç¡®æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program producer&amp;consumer */</span></span><br><span class="line"><span class="keyword">int</span> n; </span><br><span class="line">binary_semaphore s = <span class="number">1</span>, delay = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWaitB(s); </span><br><span class="line">       	append(); </span><br><span class="line">        n++; </span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>) semSignalB(delay); </span><br><span class="line">        semSignalB(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m; <span class="comment">/* a local variable */</span></span><br><span class="line">    semWaitB(delay); </span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(B); </span><br><span class="line">        take(); </span><br><span class="line">        n--; </span><br><span class="line">        m = n;</span><br><span class="line">        semSignalB(B);</span><br><span class="line">        consume();</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>) semWaitB(delay);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    parbegin(producer, consumer);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡‡ç”¨<code>ä¿¡å·ç¯å’Œæ— çº¿ç¼“å†²</code>æ¥è§£å†³ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program producer&amp;consumer */</span></span><br><span class="line">semphore n = <span class="number">0</span>, s = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWait(s);</span><br><span class="line">        append();</span><br><span class="line">        semSignal(s); <span class="comment">//ç”Ÿäº§è€…çš„semSignal(s)å’ŒsemSignal(n)å¯¹æ¢ï¼Œå°†å¯¼è‡´ç”Ÿäº§è€…åœ¨ä¸´ç•ŒåŒºå†…å¯¹nä¿¡å·ç¯è¿›è¡ŒsemSignalæ“ä½œï¼Œä¸ä¼šæœ‰ä¸å¥½çš„å½±å“</span></span><br><span class="line">        semSignal(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            semWait(n);</span><br><span class="line">            semWait(s); <span class="comment">//å¦‚æœå°†semWait(s)ä¸semWait(n)å¯¹æ¢çš„è¯ï¼Œå¦‚æœnä¸º0ï¼Œç¼“å†²åŒºä¸ºç©ºé‚£ä¹ˆä¼šé˜»å¡åœ¨ä¿¡å·ç¯nä¸Šï¼ŒåŒæ—¶ç”Ÿäº§è€…çš„æ‰§è¡Œä¹Ÿè¢«é˜»å¡ï¼Œå¯¼è‡´æ­»é”ã€‚</span></span><br><span class="line">            take();</span><br><span class="line">            semSignal(s);</span><br><span class="line">            consume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin (producer, consumer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åè€ƒè™‘å®é™…æƒ…å†µï¼Œå½“ç¼“å†²åŒºæœ‰é™çš„æ—¶å€™ï¼Œå°†ç¼“å†²åŒºè®¾ç½®ä¸ºä¸€ä¸ªç¯å½¢çš„ç»“æ„ï¼ŒæŒ‡é’ˆçš„å€¼ä¸ºå¯¹ç¼“å†²åŒºå¤§å°å–æ¨¡çš„å€¼ï¼Œå¹¶ä¸”è€ƒè™‘ä»¥ä¸‹çš„é˜»å¡å”¤é†’å…³ç³»</p>
<table>
<thead>
<tr>
<th align="center">é˜»å¡æ—¶æœº</th>
<th align="center">å”¤é†’æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç”Ÿäº§è€…ï¼šå¾€æ»¡çš„ç¼“å†²åŒºä¸­æ”¾æ•°æ®</td>
<td align="center">æ¶ˆè´¹è€…ï¼šæ•°æ®è¢«æ”¾å…¥</td>
</tr>
<tr>
<td align="center">æ¶ˆè´¹è€…ï¼šä»ç©ºçš„ç¼“å†²åŒºä¸­åŒºæ•°æ®</td>
<td align="center">ç”Ÿäº§è€…ï¼šæ•°æ®è¢«å–å‡º</td>
</tr>
</tbody></table>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program boundedBuffer */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> sizeofbuffer = <span class="comment">/* buffer size */</span>;</span><br><span class="line">semaphore s = <span class="number">1</span>, n = <span class="number">0</span>, e = sizeofbuffer; <span class="comment">//ç”¨ä¿¡å·ç¯eæ¥ä»£è¡¨ç¼“å†²åŒºçš„å¤§å°</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce();</span><br><span class="line">        semWait(e);</span><br><span class="line">        semWait(s);</span><br><span class="line">        append();</span><br><span class="line">        semSignal(s);</span><br><span class="line">        semSignal(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(n);</span><br><span class="line">        semWait(s);</span><br><span class="line">        take();</span><br><span class="line">        semSignal(s);</span><br><span class="line">        semSignal(e);</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin( producer, consumer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3ã€ä¿¡å·ç¯çš„å®ç°"><a href="#3ã€ä¿¡å·ç¯çš„å®ç°" class="headerlink" title="3ã€ä¿¡å·ç¯çš„å®ç°"></a>3ã€ä¿¡å·ç¯çš„å®ç°</h5><p>æ¯”è¾ƒå’Œæ›¿æ¢æŒ‡ä»¤å®ç°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">semWait(s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(compare_and_swap(s.flag, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">    	<span class="comment">/* do nothing */</span>;</span><br><span class="line">    s.count--;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span>;</span><br><span class="line">        <span class="comment">/* block this process(must also set s.flag to 0) */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s.flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">semSignal(s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(compare_and_swap(s.flag, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">        <span class="comment">/* do nothing */</span>;</span><br><span class="line">    s.count++;</span><br><span class="line">   	<span class="keyword">if</span>(s.count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* remove a process in form s.queue */</span>;</span><br><span class="line">        <span class="comment">/* place a process P on ready list */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s.flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸­æ–­å®ç°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">semWait(s)</span><br><span class="line">&#123;</span><br><span class="line">    inhibit interrupts;</span><br><span class="line">    s.count--;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* place this process in s.queue */</span>;</span><br><span class="line">        <span class="comment">/* block this process and allow interrupts */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        allow interrupts;</span><br><span class="line">&#125;</span><br><span class="line">semSignal(s)</span><br><span class="line">&#123;</span><br><span class="line">    inhibit interrupts;</span><br><span class="line">    s.count++;</span><br><span class="line">    <span class="keyword">if</span>(s.count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* remove a process P from s.queue */</span>;</span><br><span class="line">        <span class="comment">/* place process P on ready list */</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    allow interrupts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ä¸‰ã€ç®¡ç¨‹-Monitor"><a href="#ä¸‰ã€ç®¡ç¨‹-Monitor" class="headerlink" title="ä¸‰ã€ç®¡ç¨‹(Monitor)"></a>ä¸‰ã€ç®¡ç¨‹(Monitor)</h3><hr>
<p>é‡‡ç”¨ä¿¡å·ç¯çš„æ–¹å¼å®ç°æ­£ç¡®çš„ç¨‹åºå¹¶ä¸å®¹æ˜“ï¼Œå› ä¸ºsemWaitå’ŒsemSignalæ“ä½œåˆ†å¸ƒäºæ“ä½œç³»ç»Ÿçš„å„ä¸ªåœ°æ–¹ï¼Œä»è€Œå¾ˆéš¾çœ‹åˆ°è¿™äº›ä¿¡å·ç¯æ“ä½œçš„æ•´ä½“æ•ˆæœæ‰€å¯¼è‡´çš„ã€‚</p>
<p><code>ç®¡ç¨‹</code> çš„æå‡ºå°±æ˜¯å¸Œæœ›è®¾è®¡ä¸€ç§ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå®ƒèƒ½å¤Ÿæä¾›å’Œä¿¡å·ç¯ç›¸åŒçš„åŠŸèƒ½ä¸”æ˜“äºæ§åˆ¶ã€‚</p>
<h5 id="1ã€ç®¡ç¨‹å’Œä¿¡å·"><a href="#1ã€ç®¡ç¨‹å’Œä¿¡å·" class="headerlink" title="1ã€ç®¡ç¨‹å’Œä¿¡å·"></a>1ã€ç®¡ç¨‹å’Œä¿¡å·</h5><p>ç®¡ç¨‹å¯ä»¥çœ‹ä½œæ˜¯åŒ…å«äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‡½æ•°ï¼Œä¸€ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œä»¥åŠæœ¬åœ°æ•°æ®çš„è½¯ä»¶æ¨¡å—ã€‚ä¸»è¦ç‰¹å¾å¦‚ä¸‹</p>
<ul>
<li>æœ¬åœ°æ•°æ®åªèƒ½å¤Ÿè¢«ç®¡ç¨‹çš„å†…éƒ¨å‡½æ•°æ‰€è®¿é—®ï¼Œå¤–éƒ¨å‡½æ•°æ— æ³• è®¿é—®å…¶æœ¬åœ°</li>
<li>è¿›ç¨‹åªèƒ½é€šè¿‡è°ƒç”¨ç®¡ç¨‹è‡ªå·±å®šä¹‰çš„å‡½æ•°æ¥è¿›å…¥ç®¡ç¨‹</li>
<li>åœ¨ç®¡ç¨‹å†…æ‰§è¡Œçš„è¿›ç¨‹ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªï¼›å½“ç®¡ç¨‹è¢«å ç”¨ï¼Œå…¶ä»–è¯•å›¾è¿›å…¥çš„è¿›ç¨‹å°†è¢«é˜»å¡ï¼Œç­‰å¾…ç®¡ç¨‹é‡æ–°å¯ç”¨åæ‰èƒ½è¿›å…¥ã€‚</li>
</ul>
<p>ç®¡ç¨‹å®šä¹‰äº†ä¸€ä¸ªåŒæ­¥å·¥å…·ç”¨æ¥æ›´å¥½åœ°æ”¯æŒå¹¶å‘å¤„ç†ã€‚å½“æŸä¸€ä¸ªè¿›å…¥ç®¡ç¨‹çš„è¿›ç¨‹å› ä¸ºä¸æ»¡è¶³æŸä¸ªæ‰§è¡Œæ¡ä»¶è€Œå¿…é¡»è¢«é˜»å¡çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¾¿éœ€è¦æŸç§æœºåˆ¶(åŒæ­¥å·¥å…·)ä½¿å¾—è¯¥è¿›ç¨‹åœ¨è¢«é˜»å¡åé‡Šæ”¾ç®¡ç¨‹ï¼Œä¹‹ååœ¨å…¶æ»¡è¶³è¿è¡Œæ¡ä»¶åï¼Œè¯¥è¿›ç¨‹èƒ½å¤Ÿé‡æ–°å›åˆ°ç®¡ç¨‹ä¸­ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ç®¡ç¨‹é‡‡ç”¨äº† <code>æ¡ä»¶å˜é‡(Condition Variables)</code> æ–¹æ³•æ¥å®ç°è¿™ç§åŒæ­¥å·¥å…·ï¼Œå¹¶ä¸”åªèƒ½ç”¨ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°æ¥è®¿é—®ã€‚</p>
<ul>
<li>cwait(c)ï¼šå°†è°ƒç”¨è¯¥å‡½æ•°è®¿é—®æ¡ä»¶å˜é‡cçš„è¿›ç¨‹é˜»å¡ï¼Œå¹¶ä¸”é‡Šæ”¾ç®¡ç¨‹ç»™å…¶ä»–çš„è¿›ç¨‹ä½¿ç”¨ã€‚</li>
<li>csignal(c)ï¼šç»§ç»­æ‰§è¡Œä¹‹å‰å› ä¸ºè°ƒç”¨cwaitå‡½æ•°è®¿é—®æ¡ä»¶å˜é‡cè€Œé˜»å¡çš„è¿›ç¨‹ã€‚å¦‚æœè¿™ç±»è¿›ç¨‹æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆé€‰æ‹©å…¶ä¸­ä¹‹ä¸€ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œã€‚</li>
</ul>
<p>é‡‡ç”¨ç®¡ç¨‹æ¥è§£å†³æœ‰é™ç¼“å†²åŒºç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program production&amp;consumer */</span></span><br><span class="line">monitor bunderbuffer;</span><br><span class="line"><span class="keyword">char</span> buffer [N];</span><br><span class="line"><span class="keyword">int</span> nextin, next out;</span><br><span class="line"><span class="keyword">int</span> count;</span><br><span class="line">cond notfull, notempty;</span><br><span class="line"><span class="comment">//notfull: ç¼“å†²åŒºæœ‰å‰©ä½™ç©ºé—´æ—¶ä¸ºçœŸ notemptyï¼šç¼“å†²åŒºä¸­æœ‰æœ‰æ•ˆè®¡ç®—ç»“æœæ—¶ä¸ºçœŸ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">append</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(count == N) cwait(notfull); <span class="comment">// bufferæ»¡äº†ï¼Œè¦é¿å…overflow</span></span><br><span class="line">    buffer[nextin] = x;</span><br><span class="line">    nextin = (nextin + <span class="number">1</span>) % N;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="comment">/* one more item in buffer */</span></span><br><span class="line">    csignal(notempty); <span class="comment">// resume any waiting consumer</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">take</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(count == <span class="number">0</span>) cwait(notempty); <span class="comment">//bufferç©ºï¼Œé¿å…underflow</span></span><br><span class="line">    x = buffer[nextout];</span><br><span class="line">    nextout = (nextout + <span class="number">1</span>) % N;</span><br><span class="line">    count--;</span><br><span class="line">    csignal(notfull); <span class="comment">//resume any waiting producer</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    nextin = <span class="number">0</span>; nextout = <span class="number">0</span>; count = <span class="number">0</span>; <span class="comment">//buffer åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        produce(x);</span><br><span class="line">        append(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        take(x);</span><br><span class="line">        consume(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    parbegin( producer, consumer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®¡ç¨‹çš„çœŸæ­£ä¼˜åŠ¿å°±åœ¨äºå®ƒæ‰€æœ‰çš„æ“ä½œéƒ½è¢«é™åˆ¶åœ¨ç®¡ç¨‹å†…éƒ¨ï¼Œè¿™æ ·å°±æ›´å®¹æ˜“æ£€æŸ¥è®¾è®¡æ˜¯å¦æ­£ç¡®ã€‚</p>
<h5 id="2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹"><a href="#2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹" class="headerlink" title="2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹"></a>2ã€é‡‡ç”¨é€šçŸ¥å’Œå¹¿æ’­çš„ç®¡ç¨‹æ¨¡å‹</h5><p>åœ¨ <code>Mesa</code> è¯­è¨€ä¸­ï¼ŒcsignalåŸè¯­è¢«cnotifyåŸè¯­æ›¿ä»£ï¼Œå½“ç®¡ç¨‹è°ƒç”¨äº†cnotify(x)åŸè¯­åï¼Œå®ƒå°†å¯¼è‡´æ¡ä»¶å˜é‡xçš„ç­‰å¾…é˜Ÿåˆ—æ”¶åˆ°é€šçŸ¥ï¼Œä¸”è°ƒç”¨cnotify(x)åŸè¯­çš„è¿›ç¨‹å°†ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ç”¨whileè¯­å¥æ›¿æ¢ifè¯­å¥ï¼Œè¿™æ ·å°±ä¿è¯äº†æ¡ä»¶å˜é‡çš„é‡æ–°æ£€æµ‹ã€‚åŒæ—¶é¿å…äº†è¿›ç¨‹çš„é¢å¤–åˆ‡æ¢</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">append</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(count == N) cwait(notfull); <span class="comment">/* buffer is full avoid overflow */</span></span><br><span class="line">    buffer[nextin] = x;</span><br><span class="line">    nextin = &#123;nextin + <span class="number">1</span>&#125; % N;</span><br><span class="line">    count++;</span><br><span class="line">    cnotify(notempty); <span class="comment">/* notify any waiting consumer */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">take</span><span class="params">(<span class="keyword">char</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(count == <span class="number">0</span>) cwait(notempty); <span class="comment">/* buffer is empty; avoid underflow */</span></span><br><span class="line">    x = buffer[nextout];</span><br><span class="line">    nextout = (nextout + <span class="number">1</span>) % N; <span class="comment">/* one fewer item in buffer */</span></span><br><span class="line">    cnotify[notfull]; <span class="comment">/* notify ant waiting producer */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å››ã€æ¶ˆæ¯é€šä¿¡"><a href="#å››ã€æ¶ˆæ¯é€šä¿¡" class="headerlink" title="å››ã€æ¶ˆæ¯é€šä¿¡"></a>å››ã€æ¶ˆæ¯é€šä¿¡</h3><hr>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿›ç¨‹çš„äº¤äº’å’Œåä½œéœ€è¦ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ï¼šåŒæ­¥å’Œé€šä¿¡ã€‚åŒæ­¥ç”¨äºè¿›ç¨‹çš„äº’æ–¥ï¼Œé€šä¿¡åˆ™ç”¨äºè¿›ç¨‹é—´çš„åä½œã€‚ <code> æ¶ˆæ¯é€šä¿¡</code> å°±èƒ½æä¾›è¿™ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ï¼Œè€Œä¸”åº”ç”¨èŒƒå›´å¾ˆå¹¿ã€‚ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯¹æ¶ˆæ¯é€šä¿¡çš„å®ç°çš„ç»†èŠ‚ä¸Šæœ‰æ‰€å‡ºå…¥ã€‚ä»¥ä¸‹å†…å®¹è®¨è®ºå…¶å®ç°çš„å…±æ€§çš„éƒ¨åˆ†ã€‚</p>
<p>æ¶ˆæ¯é€šä¿¡çš„åŸºæœ¬å½¢å¼ä¸ºä»¥ä¸‹ä¸¤ä¸ªåŸè¯­ï¼š</p>
<ul>
<li>send(destination, message)</li>
<li>receive(source, message)</li>
</ul>
<p>é‡‡ç”¨sendåŸè¯­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å°†æ¶ˆæ¯å‘é€ç»™å¦ä¸€ä¸ªè¿›ç¨‹(destination)ï¼›é‡‡ç”¨receiveåŸè¯­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ¥æ”¶æ¥è‡ªæ¶ˆæ¯æºçš„æ¶ˆæ¯ã€‚</p>
<h5 id="1ã€åŒæ­¥"><a href="#1ã€åŒæ­¥" class="headerlink" title="1ã€åŒæ­¥"></a>1ã€åŒæ­¥</h5><p>æ— è®ºæ¶ˆæ¯å‘é€è¿˜æ˜¯æ¶ˆæ¯æ¥å—éƒ½æœ‰é˜»å¡å’Œéé˜»å¡ä¸¤ç§å¯èƒ½ã€‚åœ¨å…·ä½“çš„ç³»ç»Ÿè®¾è®¡ä¸­æœ‰ä»¥ä¸‹3ä¸­ç»„åˆã€‚</p>
<ul>
<li><p>å‘é€ç«¯é˜»å¡ï¼Œæ¥æ”¶ç«¯é˜»å¡</p>
<p>ä¸¤ç«¯éƒ½é˜»å¡ï¼Œæ¶ˆæ¯è¢«æ¥æ”¶åå†å°†ä¸¤ç«¯å”¤é†’ã€‚è¿™ä¸€ç»„åˆåˆè¢«ç§°ä¸ºäº¤æ±‡ç‚¹(rendzvous)æ–¹æ¡ˆï¼Œå¸¸è¢«ç”¨äºè¦æ±‚è¿›ç¨‹å¼ºè¡ŒåŒæ­¥é€šä¿¡çš„åœºåˆ</p>
</li>
<li><p>å‘é€ç«¯ä¸é˜»å¡ï¼Œæ¥æ”¶ç«¯é˜»å¡</p>
<p>å‘é€ç«¯åœ¨å‘é€å®Œæ¶ˆæ¯åç»§ç»­æ‰§è¡Œï¼Œè€Œæ¥æ”¶ç«¯å¿…é¡»é˜»å¡ï¼Œç›´åˆ°æ¥æ”¶åˆ°æ¶ˆæ¯åæ‰è¢«å”¤é†’ã€‚è¿™ä¸€æ–¹æ¡ˆæ˜¯æ˜¯è¢«æœ€å¹¿æ³›åº”ç”¨çš„ï¼Œèƒ½å¤Ÿæœ€å¿«çš„å°†æ¶ˆæ¯å‘é€ç»™å¤šä¸ªç›®çš„è¿›ç¨‹ï¼Œè€Œæ¥æ”¶ç«¯å¿…é¡»ç­‰å¾…æ¶ˆæ¯åˆ°è¾¾åæ‰èƒ½åšæœ‰ç”¨çš„å·¥ä½œã€‚</p>
</li>
<li><p>å‘é€ç«¯ä¸é˜»å¡ï¼Œæ¥æ”¶ç«¯é˜»å¡</p>
</li>
</ul>
<h5 id="2ã€äº’æ–¥çš„å®ç°"><a href="#2ã€äº’æ–¥çš„å®ç°" class="headerlink" title="2ã€äº’æ–¥çš„å®ç°"></a>2ã€äº’æ–¥çš„å®ç°</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program mutualexclusion */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n = <span class="comment">/* number of process */</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">p</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message msg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        receive(box, msg); <span class="comment">// ä»»ä½•å¸Œæœ›è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹éƒ½å¿…é¡»å…ˆè·å¾—ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¦‚æœé‚®ç®±ä¸ºç©º</span></span><br><span class="line">        <span class="comment">/* critical section */</span>;</span><br><span class="line">        send(box, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">create <span class="title">mailbox</span><span class="params">(box)</span></span>; <span class="comment">//åˆå§‹åŒ–é˜¶æ®µï¼Œé‚®ç®±ä¸­åªå­˜æ”¾äº†ä¸€ä¸ªå†…å®¹ä¸ºnullçš„æ¶ˆæ¯</span></span><br><span class="line">    send(box, null);</span><br><span class="line">    parbegin( p(<span class="number">1</span>), p(<span class="number">2</span>), p(<span class="number">3</span>)...... );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå¹¶å‘åœ°è°ƒç”¨æ¶ˆæ¯æ¥æ”¶åŸè¯­ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ï¼š</p>
<ul>
<li>å¦‚æœé‚®ç®±ä¸­æœ‰ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯å°†è¢«ä¸€ä¸ªè¿›ç¨‹æ¥æ”¶ï¼Œè€Œå…¶ä»–çš„è¿›ç¨‹éƒ½å°†é˜»å¡</li>
<li>å¦‚æœé‚®ç®±ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½å°†è¢«é˜»å¡ã€‚è€Œå½“ä¹‹åæœ‰ä¸€ä¸ªæ¶ˆæ¯ä¼ å…¥é‚®ç®±åï¼Œåªæœ‰ä¸€ä¸ªç­‰å¾…æ€çš„è¿›ç¨‹è¢«å”¤é†’ï¼Œå¹¶è·å¾—è¯¥æ¶ˆæ¯</li>
</ul>
<p>é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³æœ‰é™ç¼“å†²çš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ¡ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span></span><br><span class="line">    capacity = <span class="comment">/* buffering capacity */</span>;</span><br><span class="line">	null = <span class="comment">/* empty message */</span>;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    message pmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        receive(mayproduce, pmsg); <span class="comment">//ç”Ÿäº§è€…æ¥æ”¶åˆ°ç”Ÿäº§çš„æ¶ˆæ¯</span></span><br><span class="line">        pmsg = produce(); <span class="comment">//pmsg è¡¨ç¤ºç”Ÿäº§å®Œæˆ,ç­‰åŒäºå®Œæˆä¸´ç•ŒåŒº</span></span><br><span class="line">        send(mayconsume, pmsg);  <span class="comment">//å‘æ¶ˆè´¹è€…å‘é€å‘æ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message cmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        receive(mayproduce, cmsg); <span class="comment">//ä»mayproduceæ¥æ”¶åˆ°æœ‰æ•°æ®çš„æ¶ˆæ¯cmsg</span></span><br><span class="line">        consume(cmsg); <span class="comment">//è¿›å…¥æ¶ˆè´¹çš„ä¸´ç•ŒåŒº</span></span><br><span class="line">        send(mayproduce, null); <span class="comment">//æ¶ˆè´¹å®Œæˆï¼Œå‘mayproduceå‘é€ç©ºæ¶ˆæ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    create_mailbox(mayproduce); <span class="comment">//è¯¥æ–¹æ¡ˆè®¾è®¡äº†ä¸¤ä¸ªé‚®ç®±</span></span><br><span class="line">    create_mailbox(mayconsume);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; capacity; i++)	send(mayproduce, null);</span><br><span class="line">    parbegin( producer, consumer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ¡ˆéå¸¸çµæ´»ï¼Œå¯ä»¥å®¹çº³å¤šä¸ªç”Ÿäº§è€…ä»¥åŠå¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶å·¥ä½œã€‚å¦å¤–ï¼Œè¯¥æ–¹æ¡ˆä¹Ÿå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°æœ‰é™ç¼“å†²çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œå…¶ä¸­ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ä»¥åŠä¸¤ä¸ªé‚®ç®±éƒ½å¯ä»¥æ”¾ç½®åœ¨ä¸åŒçš„æœºå™¨ä¸Šé¢ã€‚</p>
<h3 id="äº”ã€è¯»è€…-å†™è€…é—®é¢˜"><a href="#äº”ã€è¯»è€…-å†™è€…é—®é¢˜" class="headerlink" title="äº”ã€è¯»è€…/å†™è€…é—®é¢˜"></a>äº”ã€è¯»è€…/å†™è€…é—®é¢˜</h3><hr>
<p>è¯»è€…/å†™è€…é—®é¢˜æ˜¯å¦ä¸€ä¸ªç»å…¸çš„åŒæ­¥å’Œå¹¶å‘é—®é¢˜ï¼Œæè¿°å¦‚ä¸‹ï¼š</p>
<p>æœ‰ä¸€å—å…±äº«çš„æ•°æ®åŒºåŸŸ(è¯¥åŒºåŸŸå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€å—å†…å­˜æˆ–å¤„ç†å™¨ä¸­çš„ä¸€ç»„å¯„å­˜å™¨)ï¼Œæœ‰ä¸€ç»„è¿›ç¨‹(è¯»è€…)ï¼Œå®ƒä»¬å¯¹è¯¥å…±äº«æ•°æ®åŒºçš„è®¿é—®éƒ½æ˜¯åªè¯»çš„ï¼Œå¦å¤–è¿˜æœ‰ä¸€ç»„è¿›ç¨‹(å†™è€…)ï¼Œå®ƒä»¬å¯¹è¯¥å…±äº«æ•°æ®çš„è®¿é—®åªæ˜¯åªå†™ã€‚è®¿é—®è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯ä»¥æœ‰ä»»æ„å¤šä¸ªè¯»è€…åŒæ—¶è¯»å–æ•°æ®åŒºçš„å†…å®¹ï¼›</li>
<li>ä¸€æ¬¡åªæœ‰ä¸€ä¸ªå†™è€…å…è®¸å‘æ•°æ®åŒºä¸­å†™ï¼›</li>
<li>å†™è€…åœ¨å‘æ•°æ®åŒºä¸­å†™æ—¶ï¼Œä¸å…è®¸è¯»è€…åŒæ—¶è¯»å–ï¼›</li>
</ol>
<p>è¯»è€…å¯¹å…±äº«æ•°æ®åŒºçš„è®¿é—®ä¸æ˜¯ç‹¬å çš„ï¼Œä½†å†™è€…å¯¹å…±äº«æ•°æ®åŒºçš„è®¿é—®æ˜¯ç‹¬å çš„ï¼Œæ— è®ºè¯»è€…æˆ–è€…å†™è€…éƒ½ä¸å…è®¸åŒæ—¶è®¿é—®è¯¥å…±äº«æ•°æ®åŒºã€‚</p>
<h5 id="1ã€è¯»è€…ä¼˜å…ˆ"><a href="#1ã€è¯»è€…ä¼˜å…ˆ" class="headerlink" title="1ã€è¯»è€…ä¼˜å…ˆ"></a>1ã€è¯»è€…ä¼˜å…ˆ</h5><p>é‡‡ç”¨ä¿¡å·ç¯è§£å†³è¯»è€…/å†™è€…é—®é¢˜çš„æ–¹æ¡ˆï¼šè¯»è€…ä¼˜å…ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* program readers&amp;writers */</span></span><br><span class="line"><span class="keyword">int</span> readcount;</span><br><span class="line">semaphore x = <span class="number">1</span>, wsem = <span class="number">1</span>; <span class="comment">//ä¿¡å·ç¯wsemç”¨äºäº’æ–¥è®¿é—®ã€‚å½“æœ‰å†™è€…åœ¨è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œä¸å…è®¸è¯»è€…æˆ–è€…å†™è€…åŒæ—¶è®¿é—®å…±äº«æ•°æ®ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(x);</span><br><span class="line">        readcount++;</span><br><span class="line">        <span class="keyword">if</span>(readcount == <span class="number">1</span>) <span class="comment">//ä¸ºäº†ä½¿å¤šä¸ªè¯»è€…èƒ½å¤ŸåŒæ—¶è®¿é—®å…±äº«æ•°æ®è€Œä¸”ä¸ä¼šäºå†™è€…å†²çªï¼Œè¯¥æ–¹æ¡ˆè¦æ±‚ç¬¬ä¸€ä¸ªè¯»è€…å¿…é¡»ç­‰å¾…wsem</span></span><br><span class="line">   	    	semWait(wsem); <span class="comment">//ä¿¡å·ç¯ï¼Œä½†æ˜¯åç»­åˆ°è¾¾çš„è¯»è€…å¯ä»¥ä¸ç”¨ç­‰å¾…åˆ°è¾¾çš„ä¿¡å·ç¯å°±ç›´æ¥è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">        semSignal(x);</span><br><span class="line">        READUNIT();</span><br><span class="line">        semWait(x);</span><br><span class="line">        readcount--;</span><br><span class="line">        <span class="keyword">if</span>(readcount == <span class="number">0</span>)</span><br><span class="line">            semSignal(wsem);</span><br><span class="line">        semSignal(x); <span class="comment">// ä¿¡å·ç¯xç”¨äºä¿è¯å¯¹readcountçš„æ›´æ–°æ“ä½œçš„æ­£ç¡®æ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(wsem);</span><br><span class="line">        WRITEUNIT();</span><br><span class="line">        semSignal(wsem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    readcount = <span class="number">0</span>;</span><br><span class="line">    parbegin( reader, writer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ¡ˆçš„æœ€å¤§é—®é¢˜æ˜¯å¦‚æœè¯»è€…è¿‡å¤šçš„è¯ä¼šé€ æˆå†™è€…çš„é¥¥é¥¿é—®é¢˜ã€‚</p>
<p>é‡‡ç”¨å†™è€…ä¼˜å…ˆæ–¹æ¡ˆå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<h5 id="2ã€å†™è€…ä¼˜å…ˆ"><a href="#2ã€å†™è€…ä¼˜å…ˆ" class="headerlink" title="2ã€å†™è€…ä¼˜å…ˆ"></a>2ã€å†™è€…ä¼˜å…ˆ</h5><ul>
<li>åªè¦å†™è€…ç”³è¯·è®¿é—®æ•°æ®åŒºæ—¶ï¼Œé˜»æ­¢æ‰€æœ‰è¯»è€…å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼›</li>
<li>å…¨å±€å˜é‡writecountï¼Œç”¨äºæ§åˆ¶å¯¹rsemçš„è®¾ç½®</li>
<li>ä¿¡å·ç¯yï¼Œç”¨äºæ§åˆ¶å¯¹writecountçš„æ›´æ–°</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> readcount, writecount, semphore x = <span class="number">1</span>, y = <span class="number">1</span>, z = <span class="number">1</span>, wsem = <span class="number">1</span>, rsem = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(z);</span><br><span class="line">        	semWait(rsem); <span class="comment">// å†™è€…å¯¹rsemè¿›è¡Œäº†è®¾ç½®ï¼Œä¸€ä¸ªè¯»è€…åœ¨rsemä¸Šç­‰å¾…ï¼Œå…¶ä»–è¯»è€…å…¨åœ¨zä¸Šç­‰å¾…</span></span><br><span class="line">        		semWait(x);</span><br><span class="line">        			readcount++;</span><br><span class="line">        			<span class="keyword">if</span>(readcount == <span class="number">1</span>) <span class="comment">//æ–°çš„æ–¹æ¡ˆåªå…è®¸ä¸€ä¸ªè¯»è€…åœ¨rsemä¸Šç­‰å¾…ï¼Œåç»­åˆ°è¾¾çš„è¯»è€…å¿…é¡»åœ¨zä¸Šç­‰å¾…</span></span><br><span class="line">                 		semWait(wsem); </span><br><span class="line">        		semSignal(x);</span><br><span class="line">        	semSignal(rsem);</span><br><span class="line">        semSignal(z);</span><br><span class="line">        READUNIT();</span><br><span class="line">        semWait(x);</span><br><span class="line">        	readcount--;</span><br><span class="line">        	<span class="keyword">if</span>(readcount == <span class="number">0</span>) semSignal(wsem);</span><br><span class="line">        semSignal(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semWait(y);</span><br><span class="line">        	writecount++;</span><br><span class="line">        	<span class="keyword">if</span>(writecount == <span class="number">1</span>) </span><br><span class="line">                semWait(rsem);</span><br><span class="line">        semSignal(y);</span><br><span class="line">        semWait(wsem); <span class="comment">// å†™è€…å…¨åœ¨wsemä¸Šæ’é˜Ÿ</span></span><br><span class="line">        WRITEUNIT();</span><br><span class="line">        semSignal(wsem);</span><br><span class="line">        semWait(y);</span><br><span class="line">        	writecount--;</span><br><span class="line">        	<span class="keyword">if</span>(writecount == <span class="number">0</span>)		semSignal (rsem); <span class="comment">//</span></span><br><span class="line">        semSignal(y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    readcount = writecount = <span class="number">0</span>;</span><br><span class="line">    parbegin( reader, writer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ç¤ºæ–¹æ¡ˆä¸­è¿›ç¨‹é˜Ÿåˆ—æƒ…å†µ</p>
<table>
<thead>
<tr>
<th align="center">è¯»å†™è€…æƒ…å†µ</th>
<th align="center">ä¿¡å·ç¯è®¾ç½®ä»¥åŠæ’é˜Ÿæƒ…å†µ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç³»ç»Ÿä¸­åªæœ‰è¯»è€…</td>
<td align="center">1ã€wsemè®¾ç½®  2ã€æ— æ’é˜Ÿ</td>
</tr>
<tr>
<td align="center">ç³»ç»Ÿä¸­åªæœ‰å†™è€…</td>
<td align="center">1ã€wsemå’Œrsemè®¾ç½®  2ã€å†™è€…åœ¨wsemä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center">æœ‰è¯»è€…å’Œå†™è€…ï¼Œè¯»è€…åœ¨å‰</td>
<td align="center">1ã€wsemè¢«è¯»è€…è®¾ç½®  2ã€rsemè¢«å†™è€…è®¾ç½®  3ã€æ‰€æœ‰å†™è€…åœ¨wsemä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">4ã€ä¸€ä¸ªè¯»è€…åœ¨resmä¸Šæ’é˜Ÿ  5ã€å…¶ä»–è¯»è€…åœ¨zä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center">æœ‰è¯»è€…å’Œå†™è€…ï¼Œå†™è€…åœ¨å‰</td>
<td align="center">1ã€wsemè¢«å†™è€…è®¾ç½®  2ã€rsemè¢«å†™è€…è®¾ç½®  3ã€å†™è€…åœ¨wsemä¸Šæ’é˜Ÿ</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">4ã€ä¸€ä¸ªè¯»è€…åœ¨rsemä¸Šæ’é˜Ÿ  5ã€å…¶ä»–è¯»è€…åœ¨zä¸Šæ’é˜Ÿ</td>
</tr>
</tbody></table>
<h5 id="3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…-å†™è€…é—®é¢˜-å†™è€…ä¼˜å…ˆ"><a href="#3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…-å†™è€…é—®é¢˜-å†™è€…ä¼˜å…ˆ" class="headerlink" title="3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…/å†™è€…é—®é¢˜(å†™è€…ä¼˜å…ˆ)"></a>3ã€é‡‡ç”¨æ¶ˆæ¯é€šä¿¡æ¥è§£å†³è¯»è€…/å†™è€…é—®é¢˜(å†™è€…ä¼˜å…ˆ)</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message rmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send(readrequest, rmsg);</span><br><span class="line">        receive(mbox[i], rmsg);</span><br><span class="line">        READUNIT();</span><br><span class="line">        send(finished, rmsg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">(<span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    message rmsg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send(writerequest, rmsg);</span><br><span class="line">        receive(mbox[j], rmsg);</span><br><span class="line">        WRITEUNIT();</span><br><span class="line">        rmsg = j;</span><br><span class="line">        send(finished, rmsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">controller</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(count &gt; <span class="number">0</span>) <span class="comment">// count&gt;0ï¼Œè¯´æ˜æ²¡æœ‰å†™è€…åœ¨ç­‰å¾…ï¼Œä¸”æœ‰è¯»è€…åœ¨ä¸´ç•ŒåŒºã€‚æ­¤æ—¶å…ˆå¤„ç†finishæ¶ˆæ¯ï¼Œç„¶åæ˜¯å†™è¯·æ±‚ï¼Œæœ€åæ˜¯è¯»è€…è¯·æ±‚</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!empty(finshed))</span><br><span class="line">            &#123;</span><br><span class="line">                recevie(finished, msg);</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!empty(writerequest))</span><br><span class="line">            &#123;</span><br><span class="line">                receive(writerequest, msg);</span><br><span class="line">                write_id = msg.id;</span><br><span class="line">                count = count - <span class="number">100</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!empty(readrequest))</span><br><span class="line">            &#123;</span><br><span class="line">                receive(readrequest, msg);</span><br><span class="line">                count--;</span><br><span class="line">                send(msg.id, <span class="string">&quot;OK&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="number">0</span>) <span class="comment">//count=0ï¼Œè¯´æ˜æ”¶åˆ°äº†å†™è€…çš„è¯·æ±‚ï¼Œå…è®¸å†™è€…è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¹¶ä¸”ç­‰å¾…â€œfinishâ€æ¶ˆæ¯</span></span><br><span class="line">        &#123;</span><br><span class="line">            send (write_id, <span class="string">&quot;OK&quot;</span>);</span><br><span class="line">            receive(finished, msg);</span><br><span class="line">            count = <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(count &lt; <span class="number">0</span>) <span class="comment">//count&lt;0ï¼Œè¯´æ˜æ”¶åˆ°äº†å†™è€…çš„è¯·æ±‚ï¼Œä½†æ­¤æ—¶æœ‰è¯»è€…æ­£åœ¨ä¸´ç•ŒåŒºä¸­ã€‚æ­¤æ—¶ï¼Œå°±åªå¤„ç†â€œfinishâ€æ¶ˆæ¯</span></span><br><span class="line">        &#123;</span><br><span class="line">            receive(finshed, msg);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; <strong>fine~~</strong></p>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>æ“ä½œç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>æ“ä½œç³»ç»Ÿå¤ä¹ </title>
    <url>/myblog/2020/11/04/C/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%BB%E8%A6%81%E8%80%83%E5%AF%9F%E7%82%B9/</url>
    <content><![CDATA[<h3 id="æ“ä½œç³»ç»Ÿä¸»è¦è€ƒå¯Ÿç‚¹-æœŸä¸­"><a href="#æ“ä½œç³»ç»Ÿä¸»è¦è€ƒå¯Ÿç‚¹-æœŸä¸­" class="headerlink" title="æ“ä½œç³»ç»Ÿä¸»è¦è€ƒå¯Ÿç‚¹(æœŸä¸­)"></a>æ“ä½œç³»ç»Ÿä¸»è¦è€ƒå¯Ÿç‚¹(æœŸä¸­)</h3><hr>
<h4 id="1ã€æ“ä½œç³»ç»Ÿä¸»è¦åŠŸèƒ½åŠä¸»è¦ç‰¹å¾"><a href="#1ã€æ“ä½œç³»ç»Ÿä¸»è¦åŠŸèƒ½åŠä¸»è¦ç‰¹å¾" class="headerlink" title="1ã€æ“ä½œç³»ç»Ÿä¸»è¦åŠŸèƒ½åŠä¸»è¦ç‰¹å¾"></a>1ã€æ“ä½œç³»ç»Ÿä¸»è¦åŠŸèƒ½åŠä¸»è¦ç‰¹å¾</h4><p>æ“ä½œç³»ç»Ÿæ˜¯<strong>æ§åˆ¶åº”ç”¨ç¨‹åºçš„æ‰§è¡Œç¨‹åº</strong>ï¼ŒåŒæ—¶ä¹Ÿæ˜¯<strong>åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿç¡¬ä»¶ä¹‹é—´çš„æ¥å£</strong>ã€‚OS çš„è®¾è®¡åº”è¯¥åŠªåŠ›æ»¡è¶³ä»¥ä¸‹3ä¸ªç›®æ ‡:</p>
<ul>
<li>ä¾¿åˆ©æ€§ï¼šä½¿è®¡ç®—æœºä¾¿äºä½¿ç”¨</li>
<li>æœ‰æ•ˆæ€§ï¼šä»¥æ›´æœ‰æ•ˆçš„æ–¹å¼ä½¿ç”¨ç³»ç»Ÿèµ„æº</li>
<li>æ‰©å±•èƒ½åŠ›ï¼šåœ¨ä¸å½±å“æ­£å¸¸æœåŠ¡çš„å‰æä¸‹è¿›è¡Œæœ‰æ•ˆçš„å¼€å‘ã€æµ‹è¯•ï¼Œå¹¶å¼•å…¥æ–°çš„ç³»ç»ŸåŠŸèƒ½</li>
</ul>
<h5 id="ä½œä¸ºç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æ¥å£çš„æ“ä½œç³»ç»Ÿ"><a href="#ä½œä¸ºç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æ¥å£çš„æ“ä½œç³»ç»Ÿ" class="headerlink" title="ä½œä¸ºç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æ¥å£çš„æ“ä½œç³»ç»Ÿ"></a>ä½œä¸ºç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æ¥å£çš„æ“ä½œç³»ç»Ÿ</h5><p>ä¸€èˆ¬æ¥è¯´ OS é€šå¸¸ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æä¾›æœåŠ¡ï¼š</p>
<ul>
<li>ç¨‹åºå¼€å‘</li>
<li>ç¨‹åºè¿è¡Œ</li>
<li>I/O è®¾å¤‡çš„è®¿é—®</li>
<li>ç³»ç»Ÿçš„è®¿é—®</li>
<li>é”™è¯¯æ£€æµ‹å’Œå“åº”</li>
<li>æ—¥å¿—</li>
</ul>
<p>å…¸å‹çš„è®¡ç®—æœºç³»ç»Ÿä¸­æœ‰ä»¥ä¸‹3ç§ä¸»è¦æ¥å£ï¼š</p>
<ul>
<li>æŒ‡ä»¤é›†æ¶æ„ ISAï¼šå®šä¹‰äº†è®¡ç®—æœºçš„æœºå™¨è¯­è¨€æŒ‡ä»¤ç³»ç»Ÿï¼Œæ˜¯<strong>è®¡ç®—æœºç¡¬ä»¶å’Œè½¯ä»¶çš„åˆ†å‰²çº¿</strong>ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„æ˜¯å…¶å­é›†ï¼ˆç”¨æˆ·çº§ISAï¼‰ï¼ŒOS èƒ½ä½¿ç”¨å…¶ä»–çš„ä¸€äº›æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼ˆç³»ç»Ÿçº§ISAï¼‰ã€‚</li>
<li>åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ ABIï¼šå®šä¹‰äº†åœ¨ç¨‹åºé—´è¿›è¡ŒäºŒè¿›åˆ¶ç§»æ¤çš„æ ‡å‡†ï¼Œå®šä¹‰äº† OS çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼Œä»¥åŠåœ¨ç³»ç»Ÿä¸­é€šè¿‡ç”¨æˆ·çº§ ISA èƒ½å¤Ÿä½¿ç”¨çš„ç¡¬ä»¶èµ„æºå’ŒæœåŠ¡ã€‚</li>
<li>åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ API ï¼šAPI å…è®¸åº”ç”¨ç¨‹åºè®¿é—®ç³»ç»Ÿçš„ç¡¬ä»¶èµ„æºå’ŒæœåŠ¡ï¼Œè¿™äº›æœåŠ¡ç”±ç”¨æˆ·çº§ ISA å’Œé«˜çº§è¯­è¨€åº“ï¼ˆHHLï¼‰æ¥æä¾›ã€‚</li>
</ul>
<h5 id="ä½œä¸ºèµ„æºç®¡ç†å™¨çš„æ“ä½œç³»ç»Ÿ"><a href="#ä½œä¸ºèµ„æºç®¡ç†å™¨çš„æ“ä½œç³»ç»Ÿ" class="headerlink" title="ä½œä¸ºèµ„æºç®¡ç†å™¨çš„æ“ä½œç³»ç»Ÿ"></a>ä½œä¸ºèµ„æºç®¡ç†å™¨çš„æ“ä½œç³»ç»Ÿ</h5><p>ä¸èƒ½ç®€å•çš„è¯´æ“ä½œç³»ç»Ÿåœ¨æ§åˆ¶æ•°æ®çš„ç§»åŠ¨ã€å‚¨å­˜å’Œå¤„ç†</p>
<p>OS ä½œä¸ºæ§åˆ¶æœºåˆ¶å’Œå…¶ä»–çš„æ§åˆ¶æœºåˆ¶æœ‰ä»¥ä¸‹çš„åŒºåˆ«ï¼š</p>
<ul>
<li>æ“ä½œç³»ç»Ÿå’Œå…¶ä»–çš„æ™®é€šè½¯ä»¶ä¸€æ ·ï¼Œä¹Ÿæ˜¯å¤„ç†å™¨æ‰§è¡Œçš„ä¸€ç»„ç¨‹åº</li>
<li>æ“ä½œç³»ç»Ÿç»å¸¸è½¬äº¤æ§åˆ¶æƒï¼ˆç»™å…¶ä»–ç¨‹åºï¼‰ï¼Œç„¶åéœ€è¦å€ŸåŠ©å¤„ç†å™¨æ¢å¤å¾—åˆ°æ§åˆ¶æƒ</li>
</ul>
<p>OS çš„å†…æ ¸ç¨‹åºï¼šåŒ…å«æ“ä½œç³»ç»Ÿä¸­æœ€ç»å¸¸ä½¿ç”¨çš„åŠŸèƒ½</p>
<h5 id="æ“ä½œç³»ç»Ÿçš„æ˜“æ‰©å±•æ€§"><a href="#æ“ä½œç³»ç»Ÿçš„æ˜“æ‰©å±•æ€§" class="headerlink" title="æ“ä½œç³»ç»Ÿçš„æ˜“æ‰©å±•æ€§"></a>æ“ä½œç³»ç»Ÿçš„æ˜“æ‰©å±•æ€§</h5><p>æ“ä½œç³»ç»Ÿçš„å‘å±•ç”±ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¨åŠ¨ï¼š</p>
<ul>
<li>ç¡¬ä»¶å‡çº§å’Œæ–°å‹ç¡¬ä»¶çš„å‡ºç°</li>
<li>æ–°è®¾å¤‡çš„å‡ºç°</li>
<li>é”™è¯¯ä¿®å¤</li>
</ul>
<h4 id="2ã€å¹¶è¡Œä¸å¹¶å‘çš„æ¦‚å¿µä¸åŒºåˆ«"><a href="#2ã€å¹¶è¡Œä¸å¹¶å‘çš„æ¦‚å¿µä¸åŒºåˆ«" class="headerlink" title="2ã€å¹¶è¡Œä¸å¹¶å‘çš„æ¦‚å¿µä¸åŒºåˆ«"></a>2ã€å¹¶è¡Œä¸å¹¶å‘çš„æ¦‚å¿µä¸åŒºåˆ«</h4><p>å¦‚æœæŸä¸ªç³»ç»Ÿæ”¯æŒä¸¤ä¸ªæˆ–è€…å¤šä¸ªåŠ¨ä½œï¼ˆActionï¼‰<strong>åŒæ—¶å­˜åœ¨</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªç³»ç»Ÿå°±æ˜¯ä¸€ä¸ª<strong>å¹¶å‘ç³»ç»Ÿ</strong>ã€‚å¦‚æœæŸä¸ªç³»ç»Ÿæ”¯æŒä¸¤ä¸ªæˆ–è€…å¤šä¸ªåŠ¨ä½œ<strong>åŒæ—¶æ‰§è¡Œ</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªç³»ç»Ÿå°±æ˜¯ä¸€ä¸ª<strong>å¹¶è¡Œç³»ç»Ÿ</strong>ã€‚å¹¶å‘ç³»ç»Ÿä¸å¹¶è¡Œç³»ç»Ÿè¿™ä¸¤ä¸ªå®šä¹‰ä¹‹é—´çš„å…³é”®å·®å¼‚åœ¨äº<strong>â€œå­˜åœ¨â€</strong>è¿™ä¸ªè¯ã€‚</p>
<p>åœ¨å¹¶å‘ç¨‹åºä¸­å¯ä»¥åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœç¨‹åºåœ¨å•æ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹å°†äº¤æ›¿åœ°æ¢å…¥æˆ–è€…æ¢å‡ºå†…å­˜ã€‚è¿™äº›çº¿ç¨‹æ˜¯åŒæ—¶â€œå­˜åœ¨â€çš„â€”â€”æ¯ä¸ªçº¿ç¨‹éƒ½å¤„äºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸ªçŠ¶æ€ã€‚å¦‚æœç¨‹åºèƒ½å¤Ÿå¹¶è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¸€å®šæ˜¯è¿è¡Œåœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šã€‚æ­¤æ—¶ï¼Œç¨‹åºä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½å°†åˆ†é…åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨æ ¸ä¸Šï¼Œå› æ­¤å¯ä»¥åŒæ—¶è¿è¡Œã€‚</p>
<p><strong>â€œå¹¶è¡Œâ€æ¦‚å¿µæ˜¯â€œå¹¶å‘â€æ¦‚å¿µçš„ä¸€ä¸ªå­é›†</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªæ‹¥æœ‰å¤šä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹çš„å¹¶å‘ç¨‹åºï¼Œä½†å¦‚æœæ²¡æœ‰å¤šæ ¸å¤„ç†å™¨æ¥æ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä»¥å¹¶è¡Œæ–¹å¼æ¥è¿è¡Œä»£ç ã€‚å› æ­¤ï¼Œå‡¡æ˜¯åœ¨æ±‚è§£å•ä¸ªé—®é¢˜æ—¶æ¶‰åŠå¤šä¸ªæ‰§è¡Œæµç¨‹çš„ç¼–ç¨‹æ¨¡å¼æˆ–è€…æ‰§è¡Œè¡Œä¸ºï¼Œéƒ½å±äºå¹¶å‘ç¼–ç¨‹çš„èŒƒç•´ã€‚</p>
<h4 id="3ã€è¿›ç¨‹çš„æ¦‚å¿µåŠç»„æˆï¼Œè¿›ç¨‹çš„ä¸‰ç¨‹çŠ¶æ€åŠè½¬ç§»"><a href="#3ã€è¿›ç¨‹çš„æ¦‚å¿µåŠç»„æˆï¼Œè¿›ç¨‹çš„ä¸‰ç¨‹çŠ¶æ€åŠè½¬ç§»" class="headerlink" title="3ã€è¿›ç¨‹çš„æ¦‚å¿µåŠç»„æˆï¼Œè¿›ç¨‹çš„ä¸‰ç¨‹çŠ¶æ€åŠè½¬ç§»"></a>3ã€è¿›ç¨‹çš„æ¦‚å¿µåŠç»„æˆï¼Œè¿›ç¨‹çš„ä¸‰ç¨‹çŠ¶æ€åŠè½¬ç§»</h4><p>ç°ä»£æ“ä½œç³»ç»Ÿçš„è®¾è®¡ã€‚ä¸ºäº†èƒ½æ»¡è¶³ç³»ç»Ÿä¸­å¤šä¸ªåº”ç”¨ç¨‹åºçš„æ‰§è¡Œçš„éœ€è¦ï¼Œä¸”è¾¾åˆ°ä»¥ä¸‹çš„è®¾è®¡ç›®æ ‡ï¼š</p>
<ul>
<li>èµ„æºèƒ½è¢«å¤šä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨</li>
<li>å¤„ç†å™¨éœ€è¦åœ¨å¤šä¸ªå¤šä¸ªåº”ç”¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ‡æ¢ï¼Œä»¥ä½¿è¿™äº›åº”ç”¨ç¨‹åºçš„æ‰§è¡Œçœ‹ä¸Šå»å¥½åƒåœ¨åŒæ—¶è¿›è¡Œ</li>
<li>å°½å¯èƒ½çš„æé«˜å¤„ç†å™¨å’ŒI/O è®¾å¤‡çš„åˆ©ç”¨ç‡</li>
</ul>
<p>ä¸ºäº†èƒ½è¾¾åˆ°è¿™äº›è®¾è®¡ç›®æ ‡ï¼Œæ‰€æœ‰çš„ç°ä»£æ“ä½œç³»ç»Ÿéƒ½å°†åº”ç”¨ç¨‹åºæŠ½è±¡ä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿›ç¨‹</p>
<p>å¯¹äºè¿›ç¨‹å¯ä»¥æœ‰ä»¥ä¸‹å‡ ä¸ªä¸åŒçš„å®šä¹‰ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åº</li>
<li>ä¸€ä¸ªæ‰§è¡Œåœ¨è®¡ç®—æœºä¸Šçš„åº”ç”¨ç¨‹åºå®ä¾‹</li>
<li>ä¸€ä¸ªèƒ½å¤Ÿè°ƒåº¦åˆ°å¤„ç†å™¨ä¸Šæ‰§è¡Œçš„å®ä½“</li>
<li>ä¸€ä¸ªæ´»åŠ¨å•å…ƒï¼ŒåŒ…æ‹¬ä¸€ä¸²æŒ‡ä»¤çš„æ‰§è¡Œã€å½“å‰çŠ¶æ€ï¼Œä»¥åŠä¸€ç»„æ­£åœ¨ä½¿ç”¨çš„èµ„æº</li>
</ul>
<p>æˆ‘ä»¬è¿˜å¯ä»¥æŠŠè¿›ç¨‹å½“ä½œä¸€ä¸ªåŒ…å«å¤šä¸ªå…ƒç´ çš„ç‹¬ç«‹ä¸ªä½“ï¼Œå…¶ä¸­æœ€åŸºæœ¬çš„ä¸¤ä¸ªå…ƒç´ â€”&gt; <strong>ç¨‹åºä»£ç </strong>ï¼ˆå¯ä»¥åœ¨åŒä¸€åº”ç”¨ä¸­åˆ›å»ºçš„å¤šä¸ªè¿›ç¨‹é—´å…±äº«ï¼‰ å’Œ ä¸<strong>ç¨‹åºä»£ç ç›¸å…³çš„ä¸€ç»„æ•°æ®</strong> </p>
<p>åœ¨å…¶æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ‰€å¯¹åº”çš„è¿›ç¨‹æ‹¥æœ‰å”¯ä¸€æ ‡è¯†å…¶å­˜åœ¨çš„å…ƒç´ ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>æ ‡è¯†ç¬¦</li>
<li>è¿›ç¨‹çŠ¶æ€</li>
<li>ä¼˜å…ˆçº§</li>
<li>è¿›ç¨‹è®¡æ•°å™¨</li>
<li>å†…å­˜æŒ‡é’ˆ</li>
<li>ä¸Šä¸‹æ–‡</li>
<li>I/O çŠ¶æ€</li>
<li>è®°è´¦ä¿¡æ¯</li>
</ul>
<p>è¿™äº›ä¿¡æ¯è¢«æ”¾åœ¨ä¸€ä¸ªå«åš <strong>è¿›ç¨‹æ§åˆ¶å—</strong> çš„æ•°æ®ç»“æ„ä¸­ï¼Œå¾€å¾€ç”± OS åˆ›å»º</p>
<p>è¿›ç¨‹çš„ä¸‰çŠ¶æ€ï¼š 1ã€å°±ç»ªæ€     2ã€è¿è¡Œæ€     3ã€é˜»å¡æ€</p>
<ul>
<li>è¿è¡Œæ€ï¼šè¿›ç¨‹æ­£åœ¨è¿è¡Œ</li>
<li>å°±ç»ªæ€ï¼šè¿›ç¨‹å·²ç»å‡†å¤‡å¥½æ‰§è¡Œï¼Œå¦‚æœåˆ†é…äº†å¤„ç†å™¨ï¼Œå®ƒå¯ä»¥ç«‹å³æŠ•å…¥æ‰§è¡Œ</li>
<li>é˜»å¡æ€ï¼šè¿›ç¨‹åœ¨ç­‰å¾…æŸäº‹ä»¶çš„å‘ç”Ÿ</li>
</ul>
<p><strong>å°±ç»ªæ€ â€”-&gt; è¿è¡Œæ€</strong>ï¼šå¤„ç†å™¨ç©ºé—²çš„æ—¶å€™ï¼Œå¤„ç†å™¨ä»å°±ç»ªçš„è¿›ç¨‹ä¸­æŒ‘é€‰ä¸€ä¸ªè¿›ç¨‹å°†å…¶æŠ•å…¥è¿è¡Œï¼Œå…¶çŠ¶æ€ä¹Ÿå˜ä¸ºè¿è¡Œæ€</p>
<p><strong>è¿è¡Œæ€ â€”-&gt; å°±ç»ªæ€</strong>ï¼š1ã€ç”¨å®Œæ—¶é—´ç‰‡ 2ã€ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆæŠ¢å å’Œè‡ªæ„¿ï¼‰</p>
<p><strong>è¿è¡Œæ€ â€”-&gt; é˜»å¡æ€</strong>ï¼šè¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºè¯·æ±‚ä¸€äº›æš‚æ—¶å¾—ä¸åˆ°è€Œå¿…é¡»ç­‰å¾…çš„æœåŠ¡æ—¶ï¼Œä»è¿è¡Œæ€è½¬ç§»åˆ°é˜»å¡æ€ï¼ˆi.e. 1ã€è¿›ç¨‹è°ƒç”¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿæä¾›çš„çš„æœåŠ¡ï¼šè¯»å†™æ–‡ä»¶ï¼Œè®¿é—®å…±äº«å†…å­˜â€¦â€¦è¿™äº›æœåŠ¡OSæœ‰å¯èƒ½ä¸èƒ½åŠæ—¶æä¾›ã€‚2ã€æˆ–è€…è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘å‡ºäº†I/Oè¯·æ±‚ã€‚ 3ã€ç”±äºè¿›ç¨‹é—´é€šä¿¡çš„åŸå› ï¼Œä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹å¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªè¿›ç¨‹çš„ä¿¡æ¯ã€‚ï¼‰</p>
<p><strong>é˜»å¡æ€ â€”-&gt; å°±ç»ªæ€</strong>ï¼šå½“è¿›ç¨‹æ‰€ç­‰å¾…çš„äº‹ä»¶åˆ°è¾¾åï¼Œå®ƒçš„çŠ¶æ€å°†ä»é˜»å¡æ€è½¬ç§»åˆ°å°±ç»ªæ€</p>
<h4 id="4ã€è¿›ç¨‹é€šä¿¡æ–¹å¼"><a href="#4ã€è¿›ç¨‹é€šä¿¡æ–¹å¼" class="headerlink" title="4ã€è¿›ç¨‹é€šä¿¡æ–¹å¼"></a>4ã€è¿›ç¨‹é€šä¿¡æ–¹å¼</h4><p>è¿›ç¨‹çš„äº¤äº’åä½œéœ€è¦ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ï¼šåŒæ­¥å’Œé€šä¿¡</p>
<p>åŒæ­¥ç”¨äºè¿›ç¨‹çš„äº’æ–¥ï¼Œé€šä¿¡åˆ™ç”¨äºè¿›ç¨‹é—´çš„åä½œã€‚æ¶ˆæ¯é€šä¿¡å°±èƒ½æä¾›è¿™ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ã€‚</p>
<h4 id="5ã€è¿›ç¨‹é—´çš„åˆ¶çº¦å…³ç³»"><a href="#5ã€è¿›ç¨‹é—´çš„åˆ¶çº¦å…³ç³»" class="headerlink" title="5ã€è¿›ç¨‹é—´çš„åˆ¶çº¦å…³ç³»"></a>5ã€è¿›ç¨‹é—´çš„åˆ¶çº¦å…³ç³»</h4><p>è¿›ç¨‹é—´çš„åˆ¶çº¦å…³ç³»å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li>èµ„æºå…±äº«ï¼šé—´æ¥åˆ¶çº¦å…³ç³»</li>
<li>è¿›ç¨‹åˆä½œï¼šç›´æ¥åˆ¶çº¦å…³ç³»</li>
</ul>
<h4 id="6ã€è¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„åŒºåˆ«"><a href="#6ã€è¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="6ã€è¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„åŒºåˆ«"></a>6ã€è¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„åŒºåˆ«</h4><p>ä¹‹å‰å¯¹è¿›ç¨‹æ¦‚å¿µçš„è®¨è®ºä½“ç°äº†ä»¥ä¸‹ä¸¤ä¸ªæ¦‚å¿µï¼š<strong>èµ„æºå ç”¨</strong>ï¼Œ<strong>è°ƒåº¦/æ‰§è¡Œ</strong></p>
<p>è¿™ä¸¤ä¸ªæ¦‚å¿µåœ¨è¿›ç¨‹çš„æ¦‚å¿µä¸­å¾—åˆ°äº†ç»Ÿä¸€ï¼Œä½†æ˜¯åœ¨ç°ä»£çš„æ“ä½œç³»ç»Ÿè®¾è®¡ä¸Šï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ä¸ºäº†åŒºåˆ†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼ŒæŠŠè¿›ç¨‹è°ƒåº¦çš„å®ä½“ç§°ä¸ºï¼š<strong>çº¿ç¨‹æˆ–è€…è½»é‡çº§è¿›ç¨‹ï¼ˆLightweight Processï¼‰</strong>ï¼Œè€Œåœ¨è€ƒè™‘èµ„æºçš„æƒå±ä¸ŠæŠŠæ‹¥æœ‰èµ„æºçš„ä¸ªä½“ç§°ä¸º<strong>è¿›ç¨‹</strong>æˆ–è€…<strong>ä»»åŠ¡(Task)</strong></p>
<p>åœ¨å¤šçº¿ç¨‹ç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹æ˜¯å‚ä¸èµ„æºåˆ†é…ï¼Œä»¥åŠæƒé™ä¿æŠ¤çš„åŸºæœ¬å•ä½ï¼Œå®ƒåŒ…æ‹¬ï¼š</p>
<ul>
<li>å®¹çº³è¿›ç¨‹é•œåƒçš„è™šæ‹Ÿåœ°å€ç©ºé—´</li>
<li>å¤„ç†å™¨çš„å—ä¿æŠ¤è®¿é—®ï¼Œå…¶ä»–è¿›ç¨‹ä¿¡æ¯ï¼ˆç”¨äºé€šä¿¡ï¼‰ï¼Œä¸€ç»„æ–‡ä»¶å’ŒI/Oèµ„æº(è®¾å¤‡å’Œé€šé“)</li>
</ul>
<p>è¿›ç¨‹å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>çº¿ç¨‹çš„çŠ¶æ€ï¼ˆè¿è¡Œæ€ã€å°±ç»ªæ€ç­‰ï¼‰</li>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆæœªæ‰§è¡Œæ—¶ï¼‰ï¼Œä»¥åŠçº¿ç¨‹åœ¨è¿›ç¨‹ä¸­çš„æ‰§è¡Œçš„ä½ç½®</li>
<li>ç§æœ‰çš„æ‰§è¡Œæ ˆ</li>
<li>é™æ€å­˜å‚¨ç©ºé—´å’Œå±€éƒ¨å˜é‡</li>
<li>å¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®æƒé™</li>
</ul>
<p>è¿›ç¨‹çš„çº¿ç¨‹å…±äº«å®ƒä»¬çˆ¶è¿›ç¨‹çš„çŠ¶æ€ï¼Œä»¥åŠå®ƒä»¬æ‹¥æœ‰çš„ç³»ç»Ÿèµ„æºï¼Œå¹¶ä¸”å®ƒä»¬å…±å¤„äºåŒä¸€åœ°å€ç©ºé—´ï¼Œè®¿é—®åŒä¸€ç»„æ•°æ®ã€‚</p>
<p>çº¿ç¨‹æ¦‚å¿µçš„äº§ç”Ÿå®é™…ä¸Šæ˜¯å¯¹è®¡ç®—æœºç³»ç»Ÿæ€§èƒ½è¿›è¡Œä¼˜åŒ–çš„ç»“æœ</p>
<h4 id="7ã€è¿›ç¨‹è°ƒåº¦çš„åŸå› ï¼Œæ“ä½œç³»ç»Ÿçš„ä¸‰çº§è°ƒåº¦"><a href="#7ã€è¿›ç¨‹è°ƒåº¦çš„åŸå› ï¼Œæ“ä½œç³»ç»Ÿçš„ä¸‰çº§è°ƒåº¦" class="headerlink" title="7ã€è¿›ç¨‹è°ƒåº¦çš„åŸå› ï¼Œæ“ä½œç³»ç»Ÿçš„ä¸‰çº§è°ƒåº¦"></a>7ã€è¿›ç¨‹è°ƒåº¦çš„åŸå› ï¼Œæ“ä½œç³»ç»Ÿçš„ä¸‰çº§è°ƒåº¦</h4><p>åœ¨å¤šé“ç¨‹åºç³»ç»Ÿä¸­ï¼Œå†…å­˜ä¸­åŒæ—¶å­˜åœ¨å¤šä¸ªè¿›ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹è¦ä¹ˆåœ¨ä½¿ç”¨å¤„ç†å™¨ï¼Œè¦ä¹ˆåœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿï¼ˆå¦‚I/Oæ“ä½œçš„å®Œæˆï¼‰å‘ç”Ÿã€‚å¦‚æœåœ¨å¤„ç†å™¨æˆ–è€…å¤„ç†å™¨ç»„æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œè¿˜æœ‰å…¶ä»–è¿›åœ¨ç­‰å¾…æ‰§è¡Œï¼Œé‚£ä¹ˆå¤„ç†å™¨å°±å¯ä»¥ä¿æŒåœ¨å¿™ç¢ŒçŠ¶æ€ã€‚</p>
<p>å¤„ç†å™¨è°ƒåº¦çš„ç›®çš„ï¼šä»¥ç¬¦åˆç³»ç»Ÿç›®æ ‡çš„æ–¹å¼å°†è¿›ç¨‹åˆ†é…åˆ°å¤„ç†å™¨æˆ–è€…å¤„ç†å™¨ç»„ä¸Šæ‰§è¡Œï¼Œè¿™äº›ç³»ç»Ÿç›®æ ‡åŒ…æ‹¬ï¼Œå“åº”æ—¶é—´ã€ååç‡ï¼Œä»¥åŠå¤„ç†å™¨çš„åˆ©ç”¨ç‡ç­‰ç­‰ã€‚</p>
<p>è°ƒåº¦æ´»åŠ¨è¢«åˆ†è§£ä¸º3ä¸ªç›¸äº’ç‹¬ç«‹çš„åŠŸèƒ½ï¼šé•¿æœŸè°ƒåº¦ï¼Œä¸­æœŸè°ƒåº¦ï¼ŒçŸ­æœŸè°ƒåº¦</p>
<table>
<thead>
<tr>
<th align="center">è°ƒåº¦ç±»å‹</th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">é•¿æœŸè°ƒåº¦</td>
<td align="center">å†³å®šæ˜¯å¦å°†ä¸€ä¸ªæ–°è¿›ç¨‹åŠ å…¥å°†å¾…æ‰§è¡Œçš„è¿›ç¨‹æ± ä¸­</td>
</tr>
<tr>
<td align="center">ä¸­æœŸè°ƒåº¦</td>
<td align="center">å†³å®šå“ªä¸ªå°±ç»ªè¿›ç¨‹éƒ¨åˆ†æˆ–è€…å…¨éƒ¨è½½å…¥å†…å­˜</td>
</tr>
<tr>
<td align="center">çŸ­æœŸè°ƒåº¦</td>
<td align="center">å†³å®šå“ªä¸ªå°±ç»ªè¿›ç¨‹å°†è¢«å¤„ç†å™¨æ‰§è¡Œ</td>
</tr>
</tbody></table>
<h4 id="8ã€è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼ˆFCFSï¼ŒSPFï¼ŒRRï¼‰ï¼Œå‘¨è½¬æ—¶é—´çš„æ¦‚å¿µ"><a href="#8ã€è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼ˆFCFSï¼ŒSPFï¼ŒRRï¼‰ï¼Œå‘¨è½¬æ—¶é—´çš„æ¦‚å¿µ" class="headerlink" title="8ã€è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼ˆFCFSï¼ŒSPFï¼ŒRRï¼‰ï¼Œå‘¨è½¬æ—¶é—´çš„æ¦‚å¿µ"></a>8ã€è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼ˆFCFSï¼ŒSPFï¼ŒRRï¼‰ï¼Œå‘¨è½¬æ—¶é—´çš„æ¦‚å¿µ</h4><p>å„ç§è°ƒåº¦ç­–ç•¥çš„ç‰¹å¾</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">FCFS</th>
<th align="center">RR</th>
<th align="center">SPN</th>
</tr>
</thead>
<tbody><tr>
<td align="center">é€‰æ‹©å‡½æ•°</td>
<td align="center">max[w]</td>
<td align="center">å¸¸é‡</td>
<td align="center">min[s]</td>
</tr>
<tr>
<td align="center">ç­–ç•¥æ¨¡å¼</td>
<td align="center">éæŠ¢å </td>
<td align="center">æŠ¢å ï¼ˆç”¨å®Œæ—¶é—´ç‰‡ï¼‰</td>
<td align="center">éæŠ¢å </td>
</tr>
<tr>
<td align="center">ååé‡</td>
<td align="center">ä¸å¼ºè°ƒ</td>
<td align="center">å¦‚æœæ—¶é—´ç‰‡å¤ªå°ï¼Œååé‡ä¼šé™ä½</td>
<td align="center">é«˜</td>
</tr>
<tr>
<td align="center">å“åº”æ—¶é—´</td>
<td align="center">å¯èƒ½å¾ˆé«˜ï¼Œç‰¹åˆ«æ˜¯è¿›ç¨‹æ—¶é—´å·®åˆ«å¾ˆå¤§çš„æ—¶å€™</td>
<td align="center">ä¸ºçŸ­è¿›ç¨‹æä¾›è‰¯å¥½çš„ç›¸åº”æ—¶é—´</td>
<td align="center">ä¸ºçŸ­è¿›ç¨‹æä¾›è‰¯å¥½çš„ç›¸åº”æ—¶é—´</td>
</tr>
<tr>
<td align="center">å¼€é”€</td>
<td align="center">æœ€å°</td>
<td align="center">æœ€å°</td>
<td align="center">å¯èƒ½é«˜</td>
</tr>
<tr>
<td align="center">å¯¹è¿›ç¨‹çš„å½±å“</td>
<td align="center">å¯¹çŸ­è¿›ç¨‹å’ŒI/Oå‹è¿›ç¨‹ä¸åˆ©</td>
<td align="center">å…¬å¹³å¯¹å¾…</td>
<td align="center">å¯¹é•¿è¿›ç¨‹ä¸åˆ©</td>
</tr>
<tr>
<td align="center">é¥¥é¥¿ç°è±¡</td>
<td align="center">æ— </td>
<td align="center">æ— </td>
<td align="center">å¯èƒ½</td>
</tr>
</tbody></table>
<p>ä¸éæŠ¢å å¼ç­–ç•¥ç›¸æ¯”ï¼ŒæŠ¢å å¼ç­–ç•¥ä¼šå¯¼è‡´æ›´å¤§çš„å¼€é”€ï¼Œä½†æ˜¯å¯ä»¥ä»æ•´ä½“ä¸Šä¸ºè¿›ç¨‹æä¾›æ›´å¥½çš„æœåŠ¡ã€‚æ­¤å¤–ï¼Œé‡‡ç”¨é«˜æ•ˆçš„è¿›ç¨‹åˆ‡æ¢æœºåˆ¶ï¼ˆå¯èƒ½æœ‰æ±‚äºç¡¬ä»¶ï¼‰ï¼Œæä¾›å¤§å®¹é‡çš„å†…å­˜ä»¥ä¾¿å°†æ›´å¤šçš„è¿›ç¨‹æ”¾å…¥å†…å­˜ä¸­â€¦â€¦é€šè¿‡è¿™äº›æ–¹æ³•å¯ä»¥æœ‰æ•ˆé™ä½æŠ¢å å¼çš„å¼€é”€ã€‚</p>
<p>æ ¹æ®æ’é˜Ÿæ¨¡å‹ï¼Œå‘¨è½¬æ—¶é—´(Turnaround Time, TAT)ç­‰äºé©»ç•™æ—¶é—´Trï¼Œæˆ–è€…è¿™ä¸€è¿›ç¨‹åœ¨ç³»ç»Ÿä¸­èŠ±è´¹çš„æ€»æ—¶é—´(ç­‰å¾…æ—¶é—´ + æœåŠ¡æ—¶é—´)ã€‚å¦ä¸€ä¸ªæ›´æœ‰ç”¨çš„æ•°æ®ç§°ä¸ºå¸¦æƒå‘¨è½¬æ—¶é—´(Normalized Turnaround Time)ï¼Œå®ƒæ˜¯å‘¨è½¬æ—¶é—´ä¸æœåŠ¡æ—¶é—´çš„æ¯”å€¼ã€‚è¿™ä¸ªå€¼åæ˜ äº†è¿›ç¨‹çš„ç›¸å¯¹å»¶è¿Ÿã€‚é€šå¸¸æ¥è¯´ï¼Œè¿›ç¨‹çš„æ‰§è¡Œæ—¶é—´è¶Šé•¿ï¼Œå¯ä»¥å®¹å¿çš„å»¶è¿Ÿæ—¶é—´ä¹Ÿè¶Šé•¿ã€‚å¸¦æƒå‘¨è½¬æ—¶é—´çš„æœ€å°å€¼ä¸º1ï¼Œè¯¥å€¼å¢åŠ ï¼Œåˆ™æ„å‘³ç€æœåŠ¡æ°´å¹³çš„å¢åŠ ã€‚</p>
<h4 id="9ã€æ­»é”æ¦‚å¿µï¼ŒåŸå› ï¼Œå¿…è¦æ¡ä»¶ï¼Œé¢„é˜²åŠé¿å…ç®—æ³•"><a href="#9ã€æ­»é”æ¦‚å¿µï¼ŒåŸå› ï¼Œå¿…è¦æ¡ä»¶ï¼Œé¢„é˜²åŠé¿å…ç®—æ³•" class="headerlink" title="9ã€æ­»é”æ¦‚å¿µï¼ŒåŸå› ï¼Œå¿…è¦æ¡ä»¶ï¼Œé¢„é˜²åŠé¿å…ç®—æ³•"></a>9ã€æ­»é”æ¦‚å¿µï¼ŒåŸå› ï¼Œå¿…è¦æ¡ä»¶ï¼Œé¢„é˜²åŠé¿å…ç®—æ³•</h4><p>æ­»é”æ˜¯æŒ‡<strong>ä¸€ç»„è¿›ç¨‹å› ä¸ºç«äº‰ç³»ç»Ÿèµ„æºæˆ–ç›¸äº’ç­‰å¾…æ¶ˆæ¯</strong>ï¼Œè€Œæ— æ³•å‘å‰æ¨è¿›çš„çŠ¶æ€ã€‚</p>
<p>æ­»é”ä¸€èˆ¬éƒ½æ¶‰åŠä¸¤ä¸ªæˆ–æ›´å¤šè¿›ç¨‹ä¹‹é—´çš„ç›¸äº’å†²çªçš„èµ„æºè¯·æ±‚ã€‚æ­»é”çš„å‘ç”Ÿä¸ä»…å–å†³äºè¿›ç¨‹çš„åŠ¨æ€æ‰§è¡Œè·¯å¾„ï¼Œè¿˜å–å†³äºåº”ç”¨å®ç°çš„å…·ä½“ç»†èŠ‚ã€‚</p>
<p>æ­»é”å‘ç”Ÿçš„æ¡ä»¶ï¼š</p>
<p>(1) äº’æ–¥ï¼šèµ„æºåªèƒ½ç”±ä¸€ä¸ªè¿›ç¨‹å ç”¨ï¼Œå¦‚æœèµ„æºè¢«åˆ†é…ç»™äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ™å…¶ä»–è¿›ç¨‹ä¸å¯ä½¿ç”¨è¯¥è¿›ç¨‹</p>
<p>(2) å ç”¨å¹¶ç­‰å¾…ï¼šè¿›ç¨‹å¿…é¡»å ç”¨åˆ†é…ç»™å®ƒçš„èµ„æºï¼Œä¸”åŒæ—¶ç”³è¯·å’Œç­‰å¾…å…¶ä»–èµ„æº</p>
<p>(3) ä¸å¯å‰¥å¤ºï¼šå¦‚æœèµ„æºè¢«æŸäº›è¿›ç¨‹å ç”¨ï¼Œé‚£ä¹ˆåˆ™ä¸å¯èƒ½å°†å…¶ä»è¿›ç¨‹ä¸­å¼ºè¡Œå‰¥å¤ºå‡ºæ¥</p>
<p>æ³¨æ„ï¼š ä»¥ä¸Š3ä¸ªæ¡ä»¶åªæ˜¯ å¿…è¦æ¡ä»¶ å¹¶éå……åˆ†æ¡ä»¶æ­»é”çš„å‘ç”Ÿè¿˜éœ€è¦ç¬¬4ä¸ªæ¡ä»¶ï¼š</p>
<p>(4) ç¯è·¯ç­‰å¾…ï¼šèµ„æºå’Œè¿›ç¨‹çš„åˆ†é…å…³ç³»åœ¨èµ„æºåˆ†é…å›¾ä¸Šè¡¨ç°ä¸ºä¸€ä¸ªå°é—­çš„ç¯è·¯ï¼Œå…¶ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹è‡³å°‘å ç”¨ä¸€ä¸ªèµ„æºï¼Œä¸”è¯¥èµ„æºåŒæ—¶è¢«ç¯è·¯ä¸­çš„å…¶ä»–è¿›ç¨‹æ‰€ç”³è¯·</p>
<p>å¯¼è‡´æ­»é”çš„æ¡ä»¶</p>
<table>
<thead>
<tr>
<th align="center">å¯èƒ½å¯¼è‡´æ­»é”</th>
<th align="center">æ­»é”å‘ç”Ÿ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1ã€äº’æ–¥</td>
<td align="center">1ã€äº’æ–¥</td>
</tr>
<tr>
<td align="center">2ã€ä¸å¯æŠ¢å </td>
<td align="center">2ã€ä¸å¯æŠ¢å </td>
</tr>
<tr>
<td align="center">3ã€å ç”¨å¹¶ç­‰å¾…</td>
<td align="center">3ã€å ç”¨å¹¶ç­‰å¾…</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">4ã€ç¯è·¯ç­‰å¾…</td>
</tr>
</tbody></table>
<p>è§£å†³æ­»é”é—®é¢˜æœ‰3ä¸ªæ–¹æ¡ˆï¼š</p>
<p>ä¸€ã€æ­»é”é¢„é˜²ï¼šæ–¹æ¡ˆæ˜¯ç ´é™¤æ­»é”å‘ç”Ÿçš„4ä¸ªæ¡ä»¶ä¹‹ä¸€</p>
<p>äºŒã€æ­»é”é¿å…ï¼šæ–¹æ¡ˆæ˜¯åŸºäºèµ„æºåˆ†é…çš„å½“å‰çŠ¶å†µï¼ŒåŠ¨æ€çš„åšå‡ºèµ„æºåˆ†é…å†³ç­–</p>
<p>ä¸‰ã€æ­»é”æ£€æµ‹ï¼šæ–¹æ¡ˆæ£€æµ‹ç³»ç»Ÿä¸­å·²ç»å‘ç”Ÿçš„æ­»é”ï¼Œå¹¶æƒ³åŠæ³•æ‰“ç ´è¿›ç¨‹é—´çš„æ­»é”çŠ¶æ€</p>
<h5 id="æ­»é”é¢„é˜²"><a href="#æ­»é”é¢„é˜²" class="headerlink" title="æ­»é”é¢„é˜²"></a>æ­»é”é¢„é˜²</h5><p>ç®€å•çš„è¯´ï¼Œæ­»é”çš„é¢„é˜²æ–¹æ¡ˆæ€æƒ³æ˜¯è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿèƒ½å¤Ÿ<strong>å»é™¤æ­»é”å‘ç”Ÿçš„å¯èƒ½</strong>ã€‚å¯ä»¥å°†æ­»é”é¢„é˜²çš„æ–¹æ¡ˆå¯ä»¥å½’çº³ä¸º2ç§ï¼šä¸€ç§æ˜¯<strong>ç›´æ¥æ–¹æ¡ˆ</strong>ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯<strong>é—´æ¥æ–¹æ¡ˆ</strong>ã€‚é—´æ¥æ–¹æ¡ˆæ˜¯ç ´é™¤æ­»é”å‘ç”Ÿæ¡ä»¶çš„å‰3æ¡ä¸­çš„ä»»æ„ä¸€æ¡ï¼Œè€Œç›´æ¥æ–¹æ¡ˆæ˜¯é¢„é˜²ç¯è·¯ç­‰å¾…æ¡ä»¶çš„å‘ç”Ÿã€‚</p>
<p>1ã€äº’æ–¥æ¡ä»¶ï¼š</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œäº’æ–¥æ¡ä»¶ä¸å…·ä½“çš„èµ„æºå±æ€§æœ‰å…³ï¼Œæ˜¯å¾ˆéš¾ç ´é™¤çš„ã€‚å¦‚æœå¯¹æŸäº›èµ„æºçš„è®¿é—®éœ€è¦äº’æ–¥ï¼Œåˆ™<strong>æ“ä½œç³»ç»Ÿå¿…é¡»æä¾›æŸç§äº’æ–¥æœºåˆ¶</strong>ã€‚å¦‚æ–‡ä»¶çš„è¯»å†™é™åˆ¶ã€‚ä½†æ˜¯å½“æœ‰å¤šä¸ªè¿›ç¨‹åœ¨å¯¹è¯¥æ–‡ä»¶å¹¶å‘çš„å†™çš„æ—¶å€™</p>
<p>2ã€å æœ‰å¹¶ç­‰å¾…æ¡ä»¶ï¼š</p>
<p>å¯ä»¥é‡‡ç”¨ä»¥ä¸‹çš„æ–¹æ³•æ¥ç ´é™¤ï¼š</p>
<p>è¦æ±‚è¿›ç¨‹åœ¨æ‰§è¡Œå‰ï¼Œä¸€æ¬¡æ€§ç”³è¯·å®Œå®ƒåœ¨æ‰§è¡Œè¿‡ç¨‹ç§æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„èµ„æºã€‚å¦‚æœç³»ç»Ÿæš‚æ—¶æ— æ³•æ»¡è¶³å®ƒçš„èµ„æºç”³è¯·è¦æ±‚ï¼Œåˆ™è¿›ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°ç³»ç»Ÿæ‹¥æœ‰è¶³å¤Ÿå¤šçš„èµ„æºï¼Œå¹¶å°†èµ„æºä¸€æ¬¡æ€§å…¨éƒ¨åˆ†é…ç»™å®ƒæ‰èƒ½å¼€å§‹è¿è¡Œã€‚</p>
<p>æ³¨æ„ï¼šè¯¥æ–¹æ¡ˆå¯èƒ½å¯¼è‡´ç³»ç»Ÿçš„æ•ˆç‡é™ä½ï¼š</p>
<ul>
<li>è¿›ç¨‹å¯èƒ½åœ¨è·å¾—å®ƒè¿è¡Œæ‰€éœ€çš„å…¨éƒ¨èµ„æºå‰éœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´ã€‚ç„¶è€Œå®é™…ä¸Šï¼Œå¦‚æœç»™å®ƒä¸€éƒ¨åˆ†èµ„æºï¼Œå®ƒä¾¿å¯ä»¥å¼€å§‹è¿è¡Œäº†</li>
<li>åˆ†é…ç»™è¿›ç¨‹çš„èµ„æºå¯èƒ½é•¿æ—¶é—´å¾—ä¸åˆ°ä½¿ç”¨ï¼Œä½†åˆ«çš„è¿›ç¨‹ä¹Ÿæ— æ³•åˆ©ç”¨è¿™äº›èµ„æºï¼Œç„¶è€Œï¼Œè¿™äº›èµ„æºå¯èƒ½åœ¨å®ƒå®é™…çš„æ‰§è¡Œè·¯å¾„ä¸­æ ¹è¢«æ²¡æœ‰è¢«ä½¿ç”¨</li>
</ul>
<p>3ã€ä¸å¯æŠ¢å æ¡ä»¶ï¼š</p>
<p>ç ´é™¤è¯¥æ¡ä»¶çš„æ–¹æ³•æœ‰ï¼š</p>
<ul>
<li>å¦‚æœè¿›ç¨‹å ç”¨äº†ä¸€äº›èµ„æºï¼Œä¸”åœ¨åç»­èµ„æºè¯·æ±‚ä¸‹å¾—ä¸åˆ°æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œå®ƒå°±å¿…é¡»é‡Šæ”¾å®ƒå·²ç»å ç”¨çš„èµ„æºï¼Œå¹¶åœ¨åç»­çš„æ‰§è¡Œä¸­ä¸€æ¬¡æ€§ç”³è¯·å…¨éƒ¨çš„èµ„æº(åŒ…æ‹¬ä¹‹å‰é‡Šæ”¾çš„å’Œç”³è¯·ä¸åˆ°çš„èµ„æº)</li>
<li>å¦‚æœä¸€ä¸ª(é«˜ä¼˜å…ˆçº§)è¿›ç¨‹ç”³è¯·å·²ç»è¢«ä¸€ä¸ª(ä½ä¼˜å…ˆçº§)è¿›ç¨‹æŠŠèµ„æºå ç”¨äº†ã€‚é‚£ä¹ˆOSå°†ä»åè€…æŠ¢å èµ„æºå°†å…¶åˆ†é…ç»™å‰è€…ï¼Œè¯¥æ–¹æ³•ä»…ä»…é€‚ç”¨äºä»»æ„ä¸¤ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ä¸åŒä¼˜å…ˆçº§çš„æƒ…å†µï¼Œè€Œä¸”åªèƒ½ç”¨åœ¨èµ„æºçŠ¶æ€å¾ˆå®¹æ˜“ä¿å­˜å’Œæ¢å¤çš„æƒ…å†µã€‚(i.e. å¤„ç†å™¨ä¸­çš„èµ„æº)</li>
</ul>
<p>4ã€ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼š</p>
<p>å¯ä»¥ç”¨æœ‰åºèµ„æºåˆ†é…çš„æ–¹æ³•ç ´é™¤ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼šå…ˆå°†èµ„æºè¿›è¡Œçº¿æ€§ç¼–åºï¼Œå¦‚æœè¿›ç¨‹è·å¾—èµ„æºRï¼Œé‚£ä¹ˆåç»­è¯·æ±‚çš„èµ„æºåºå·éƒ½åªèƒ½å¤§äºæˆ–è€…éƒ½å°äºRã€‚</p>
<p>ç„¶è€Œç ´é™¤ç¯è·¯ç­‰å¾…æ¡ä»¶è¿˜æ˜¯å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿæ•ˆç‡çš„é™ä½ï¼Œæˆ–è€…è¿›ç¨‹çš„æ‰§è¡Œé€Ÿåº¦é™ä½ï¼Œäº¦æˆ–ä¸å¿…è¦çš„èµ„æºåˆ†é…è¯·æ±‚æ‹’ç»ç­‰é—®é¢˜ã€‚</p>
<h5 id="æ­»é”é¿å…"><a href="#æ­»é”é¿å…" class="headerlink" title="æ­»é”é¿å…"></a>æ­»é”é¿å…</h5><p>æ­»é”é¢„é˜²çš„æ–¹æ³•å®é™…ä¸Šæ˜¯åœ¨æ»¡è¶³èµ„æºè¯·æ±‚çš„æ–¹å¼ä¸Šåšå‡ºæŸç§é™åˆ¶ï¼Œä½¿å…¶ç ´é™¤æ­»é”å‘ç”Ÿçš„æŸä¸€ä¸ªæ¡ä»¶ï¼Œä»è€Œä½¿å¾—æ­»é”ä¸å¯èƒ½å‘ç”Ÿã€‚ç ´é™¤æ­»é”æ¡ä»¶çš„æ–¹æ³•ä¸Šé¢å·²ç»è®¨è®ºè¿‡äº†ï¼Œæ­£å¦‚è®¨è®ºçš„é‚£æ ·ï¼Œè¿™äº›æ–¹æ³•éƒ½ä¼šå¯¼è‡´èµ„æºåˆ©ç”¨ç‡çš„ä¸‹é™ï¼Œæˆ–è€…è¿›ç¨‹æ‰§è¡Œé€Ÿåº¦çš„é™ä½ã€‚æ­»é”é¿å…çš„æ–¹æ³•ä¸ä¹‹æœ‰ç»†å¾®çš„å·®åˆ«ï¼Œè¯¥æ–¹æ¡ˆå…è®¸æ­»é”å‘ç”Ÿçš„å‰ä¸‰ä¸ªå¿…è¦æ¡ä»¶çš„å­˜åœ¨ï¼Œä½†æ˜¯åœ¨èµ„æºåˆ†é…çš„æ—¶å€™åšå‡ºè°¨æ…çš„å†³ç­–ï¼Œä»¥é¿å…æ­»é”çš„å‘ç”Ÿã€‚</p>
<p>åœ¨æ­»é”é¿å…æ–¹æ¡ˆä¸­ï¼Œèµ„æºåˆ†é…å†³ç­–çš„åˆ¶è®¢ï¼Œæ˜¯åŸºäº(å‡å¦‚å°†èµ„æºåˆ†é…å‡ºå»)åœ¨æœªæ¥æ˜¯å¦ä¼šå‘ç”Ÿæ­»é”æ¥åˆ¤æ–­çš„ã€‚æ‰€ä»¥ï¼Œæ­»é”é¿å…æ–¹æ¡ˆéœ€è¦çŸ¥é“è¿›ç¨‹æœªæ¥çš„èµ„æºè¯·æ±‚ã€‚è¿™ç§æ–¹æ¡ˆæœ‰å¾ˆå¤šç§è§£æ³•ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸¤ç§ï¼š</p>
<ul>
<li>(å¦‚æœä¼šå¯¼è‡´æ­»é”)æ‹’ç»åˆ›å»ºè¿›ç¨‹</li>
</ul>
<p>$$<br>è€ƒè™‘ä¸€ä¸ªæœ‰nä¸ªå¤„ç†å™¨ï¼Œmç§ä¸åŒç±»å‹èµ„æºçš„ç³»ç»Ÿï¼šR = (R_1, R_2,â€¦â€¦, R_m)ç³»ç»Ÿç§çš„å…¨éƒ¨èµ„æº<br>$$</p>
<p>èµ„æºç”³è¯·çŸ©é˜µï¼š(è¿™ä¸ªæ¨¡æ¿ä¸æ”¯æŒçŸ©é˜µï¼Œå¾ˆçƒ¦ï¼Œè¯·è‡ªè¡Œæƒ³è±¡)<br>$$<br>\begin{bmatrix}<br>C_{11} &amp; C_{12} &amp; \ldots &amp; C_{1n} \<br>C_{21} &amp; C_{22} &amp; \ldots &amp; C_{2n} \<br>\vdots &amp; \vdots &amp; \ddots &amp; \vdots \<br>C_{n1} &amp; C_{n2} &amp; \ldots &amp; C_{nn} \<br>\end{bmatrix}<br>$$</p>
<p>$$<br>C_{ij} = è¿›ç¨‹iç”³è¯·èµ„æºjçš„æ€»æ•°é‡,æ­»é”é¿å…æ–¹æ¡ˆå¯ä»¥è¦æ±‚åœ¨åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹çš„P(n + 1)æ—¶æœ‰ï¼š<br>$$</p>
<p>$$<br>R \geq C_{(n+1)j} + \sum_{i=1}^{n}C_{ij}<br>$$</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä»…å½“æ‰€åˆ›å»ºçš„è¿›ç¨‹å¯¹å„ç±»èµ„æºçš„æœ€å¤§èµ„æºéœ€æ±‚é‡åŠ ä¸Šç³»ç»Ÿä¸­å·²æœ‰è¿›ç¨‹å¯¹å„ç±»èµ„æºçš„ç”³è¯·é‡çš„æ€»å’Œï¼Œå°äºç³»ç»Ÿä¸­å„ç±»èµ„æºçš„æ€»é‡æ—¶ï¼Œè¯¥è¿›ç¨‹æ‰è¢«å…è®¸åˆ›å»ºã€‚</p>
<p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªç­–ç•¥å¹¶ä¸æ˜¯æœ€æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒå‡è®¾çš„æ˜¯æœ€åæƒ…å†µï¼šæ‰€æœ‰è¿›ç¨‹åŒæ—¶ç”³è¯·æœ€å¤§æ•°é‡çš„èµ„æºã€‚</p>
<ul>
<li>(å¦‚æœä¼šå¯¼è‡´æ­»é”)æ‹’ç»åˆ†é…èµ„æº â€”-&gt; åˆç§°ä¸ºé“¶è¡Œå®¶ç®—æ³•</li>
</ul>
<h4 id="10ã€ä¿¡å·é‡æœºåˆ¶ï¼ŒPVæ“ä½œåŸºæœ¬æ¦‚å¿µ"><a href="#10ã€ä¿¡å·é‡æœºåˆ¶ï¼ŒPVæ“ä½œåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="10ã€ä¿¡å·é‡æœºåˆ¶ï¼ŒPVæ“ä½œåŸºæœ¬æ¦‚å¿µ"></a>10ã€ä¿¡å·é‡æœºåˆ¶ï¼ŒPVæ“ä½œåŸºæœ¬æ¦‚å¿µ</h4><p>ï¼ˆæƒ³è¦è¯¦ç»†äº†è§£è¿›ç¨‹çš„åŒæ­¥ï¼Œé€šä¿¡ï¼Œä¿¡å·é‡ç­‰æœºåˆ¶è¯¦è§æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ å¹¶å‘ï¼šäº’æ–¥ä¸åŒæ­¥çš„å„ç§å®ç° ï¼‰</p>
<p>å½“ç„¶ï¼Œè¿™äº›ä¸œè¥¿ä»…ä¾›å‚è€ƒï¼Œ60åˆ†å·¦å³æ²¡æœ‰é—®é¢˜å§ã€‚ã€‚ã€‚<strong>æƒ³è¦è€ƒå¥½è¿˜æ˜¯å¾—å»èƒŒä¹¦</strong>(å»ºè®®è¿˜æ˜¯å»çœ‹è¯¾æœ¬)</p>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>æ“ä½œç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>Get Started with Win32 and C++</title>
    <url>/myblog/2021/04/24/C/Get%20Started%20with%20Win32%20and%20C++/</url>
    <content><![CDATA[<h2 id="Get-Started-with-Win32-and-C"><a href="#Get-Started-with-Win32-and-C" class="headerlink" title="Get Started with Win32 and C++"></a>Get Started with Win32 and C++</h2><p>åŸæ–‡çš„é“¾æ¥ï¼š<a href="https://docs.microsoft.com/en-us/windows/win32/learnwin32/learn-to-program-for-windows">https://docs.microsoft.com/en-us/windows/win32/learnwin32/learn-to-program-for-windows</a></p>
<h3 id="1-OverView"><a href="#1-OverView" class="headerlink" title="1. OverView"></a>1. OverView</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">wWinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, <span class="keyword">int</span> nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Register the window class.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">wchar_t</span> CLASS_NAME[]  = <span class="string">L&quot;Sample Window Class&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    WNDCLASS wc = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    wc.lpfnWndProc   = WindowProc;</span><br><span class="line">    wc.hInstance     = hInstance;</span><br><span class="line">    wc.lpszClassName = CLASS_NAME;</span><br><span class="line"></span><br><span class="line">    RegisterClass(&amp;wc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the window.</span></span><br><span class="line"></span><br><span class="line">    HWND hwnd = CreateWindowEx(</span><br><span class="line">        <span class="number">0</span>,                              <span class="comment">// Optional window styles.</span></span><br><span class="line">        CLASS_NAME,                     <span class="comment">// Window class</span></span><br><span class="line">        <span class="string">L&quot;Learn to Program Windows&quot;</span>,    <span class="comment">// Window text</span></span><br><span class="line">        WS_OVERLAPPEDWINDOW,            <span class="comment">// Window style</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Size and position</span></span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line"></span><br><span class="line">        <span class="literal">NULL</span>,       <span class="comment">// Parent window    </span></span><br><span class="line">        <span class="literal">NULL</span>,       <span class="comment">// Menu</span></span><br><span class="line">        hInstance,  <span class="comment">// Instance handle</span></span><br><span class="line">        <span class="literal">NULL</span>        <span class="comment">// Additional application data</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hwnd == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ShowWindow(hwnd, nCmdShow);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run the message loop.</span></span><br><span class="line"></span><br><span class="line">    MSG msg = &#123; &#125;;</span><br><span class="line">    <span class="keyword">while</span> (GetMessage(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        PostQuitMessage(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> WM_PAINT:</span><br><span class="line">        &#123;</span><br><span class="line">            PAINTSTRUCT ps;</span><br><span class="line">            HDC hdc = BeginPaint(hwnd, &amp;ps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            FillRect(hdc, &amp;ps.rcPaint, (HBRUSH) (COLOR_WINDOW+<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">            EndPaint(hwnd, &amp;ps);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DefWindowProc(hwnd, uMsg, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ Win32 çª—å£åº”ç”¨ç¨‹åº</p>
<p><code>WindowProc</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºå¹¶æ²¡æœ‰æ˜æ˜¾çš„è°ƒç”¨ WindowProc å‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„é€»è¾‘å¤„ç†åŒºåŸŸ Windows é€šè¿‡ä¼ é€’ä¸€ç³»åˆ—çš„ message æ¥è¿›è¡Œé€šä¿¡ã€‚</p>
<p>æ¯å½“ç¨‹åºè°ƒç”¨ä¸€æ¬¡ <code>DispatchMessage</code> åˆ†å‘ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œç¨‹åºä¼šç›´æ¥çš„è°ƒç”¨ä¸€æ¬¡ WindowProcå‡½æ•°ã€‚</p>
<p><code> wWinMain</code> æ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£ç‚¹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">wWinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, <span class="keyword">int</span> nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œä¸€ç³»åˆ—çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯ WindowProc çš„å‡½æ•°åœ°å€</span></span><br><span class="line">    WNDCLASS wc = &#123; &#125;;</span><br><span class="line">    ...</span><br><span class="line">    wc.lpfnWndProc   = WindowProc;</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ç„¶åæ˜¯åˆ›å»ºçª—å£è®¾ç½®ç›¸å…³å±æ€§å¹¶ä¸”è¿”å›ä¸€ä¸ªå”¯ä¸€æŒ‡å‘è¯¥çª—å£çš„å¥æŸ„</span></span><br><span class="line">    HWND hwnd = CreateWindowEx(</span><br><span class="line">        ...</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœçª—å£åˆ›å»ºæˆåŠŸï¼Œé‚£ä¹ˆä¾¿è¦è¿›å…¥æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—ï¼Œç›´åˆ°ç”¨æˆ·é€€å‡ºè¯¥çª—å£å¹¶å…³é—­è¯¥ç¨‹åºä¹‹å‰ï¼Œç¨‹åºä¸€ç›´è¿è¡Œåœ¨è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    MSG msg = &#123; &#125;;</span><br><span class="line">    <span class="keyword">while</span> (GetMessage(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-Creating-A-Window"><a href="#2-Creating-A-Window" class="headerlink" title="2. Creating A Window"></a>2. Creating A Window</h3><p>æ¯ä¸€ä¸ª Window éƒ½éœ€è¦ç»‘å®šä¸€ä¸ª Window class ç±»ï¼Œä½†æ˜¯è¿™ä¸ª â€˜classâ€™ å’Œå¸¸è§„çš„ C++ class å«ä¹‰å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªç”¨äºæ“ä½œç³»ç»Ÿåœ¨è¿è¡Œæ—¶è°ƒç”¨ç”¨äºåˆ›å»ºçª—å£çš„æ•°æ®ç»“æ„ï¼Œæ³¨å†Œä¸€ä¸ª Window class è¦å¡«å……ä¸€ä¸ª WNDCLASS æ•°æ®ç»“æ„</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Register the window class.</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">wchar_t</span> CLASS_NAME[]  = <span class="string">L&quot;Sample Window Class&quot;</span>;</span><br><span class="line"></span><br><span class="line">WNDCLASS wc = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">wc.lpfnWndProc   = WindowProc;</span><br><span class="line">wc.hInstance     = hInstance;</span><br><span class="line">wc.lpszClassName = CLASS_NAME;</span><br></pre></td></tr></table></figure>

<p>â€‹    </p>
<p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å±æ€§å¯ä»¥è®¾ç½®ï¼Œåœ¨å®Œæˆè®¾ç½®åå°† WNDCLASS çš„åœ°å€ä¼ é€’ç»™æ“ä½œç³»ç»Ÿæ¥å®Œæˆå¯¹Windowçš„æ³¨å†Œ</p>
<p><code> RegisterClass(&amp;wc);</code></p>
<p>åœ¨å®Œæˆå¯¹ WNDCLASS çš„æ³¨å†Œä¹‹åä½¿ç”¨ <code> CreateWindowEx</code> æ¥åˆ›å»ºä¸€ä¸ªçª—å£çš„å®ä¾‹ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªå¥æŸ„è¡¨ç¤ºåˆ›å»ºæˆåŠŸï¼Œè¿”å› 0 è¡¨ç¤ºå¤±è´¥</p>
<p>ä¹‹åå†è°ƒç”¨ </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">ShowWindow(hwnd, nCmdShow); <span class="comment">// hwnd: çª—å£å¥æŸ„ nCmdShow: mininize or maxmize a window </span></span><br></pre></td></tr></table></figure>

<p>ä¾¿å¯ä»¥åˆ›å»ºçª—å£äº†ã€‚ </p>
<h3 id="3-Window-Messages"><a href="#3-Window-Messages" class="headerlink" title="3. Window Messages"></a>3. Window Messages</h3><p>windows ä½¿ç”¨çš„æ˜¯æ¶ˆæ¯ä¼ é€’æ¨¡å‹æ¥å®Œæˆç”¨æˆ·å’Œæ“ä½œç³»ç»Ÿçš„é€šä¿¡ã€‚æ“ä½œç³»ç»Ÿé€šè¿‡è°ƒç”¨ window procedure registered for that window æ¥ä¼ é€’æ¶ˆæ¯ã€‚</p>
<p> windows é€šè¿‡ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥ç®¡ç†æ‰€æœ‰çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ“ä½œè¿™ä¸ªé˜Ÿåˆ—è€Œæ˜¯ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°å°†æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­æå–å‡ºæ¥</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">MSG msg;</span><br><span class="line">GetMessage(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>è¦å®Œæˆå¯¹æ¶ˆæ¯çš„å¤„ç†æ¥ä¸‹æ¥ä¾¿è¦è°ƒç”¨ä¸‹é¢çš„ä¸¤ä¸ªå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">TranslateMessage(&amp;msg); <span class="comment">// å°†æ¶ˆæ¯å¤„ç†ä¸ºç¨‹åºèƒ½å¤„ç†çš„æ ¼å¼</span></span><br><span class="line">DispatchMessage(&amp;msg); 	<span class="comment">// å‘Šè¯‰æ“ä½œç³»ç»Ÿå»è°ƒç”¨å’Œè¯¥æ¶ˆæ¯è”ç³»çš„windows procedureï¼ˆå‡½æ•°è°ƒç”¨è¿‡ç¨‹åœ¨è¿™ä¹‹ä¸­å‘ç”Ÿï¼‰</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³è¦å…³é—­çª—å£é€€å‡ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè°ƒç”¨ä¸‹é¢çš„å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">PostQuitMessage(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// è¯¥å‡½æ•°å°†ä¸€ä¸ª WM_QUIT æ¶ˆæ¯æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span></span><br></pre></td></tr></table></figure>

<p>WM_QUIT å°†å¯¼è‡´ <code> GetMessage</code> è¿”å›ä¸€ä¸ª 0ï¼Œç„¶åé€€å‡ºæ¶ˆæ¯å¾ªç¯</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®Œæ•´æµç¨‹</span></span><br><span class="line">MSG msg = &#123; &#125;;</span><br><span class="line"><span class="keyword">while</span> (GetMessage(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    TranslateMessage(&amp;msg);</span><br><span class="line">    DispatchMessage(&amp;msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-Writing-the-Windows-Procedure"><a href="#4-Writing-the-Windows-Procedure" class="headerlink" title="4.  Writing the Windows Procedure"></a>4.  Writing the Windows Procedure</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>CALLBACK </code> : ä¸€ä¸ªè°ƒç”¨çº¦å®š</p>
<p><code> uMsg</code> : ä¼ é€’çš„æ¶ˆæ¯</p>
<p><code> wParam, lParam</code> : å±äºæ¶ˆæ¯çš„é¢å¤–æ•°æ®ï¼Œå…¶å‡†ç¡®å«ä¹‰å–å†³äº uMsg</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_SIZE:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> width = LOWORD(lParam);  <span class="comment">// Macro to get the low-order word.</span></span><br><span class="line">            <span class="keyword">int</span> height = HIWORD(lParam); <span class="comment">// Macro to get the high-order word.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Respond to the message:</span></span><br><span class="line">            OnSize(hwnd, (UINT)wParam, width, height);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnSize</span><span class="params">(HWND hwnd, UINT flag, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Handle resizing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„æ¶ˆæ¯éœ€è¦å¤„ç†å¯ä»¥ç®€å•çš„ä½¿ç”¨é»˜è®¤çš„ WindowProc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> DefWindowProc(hwnd, uMsg, wParam, lParam);</span><br></pre></td></tr></table></figure>

<p>ç”±äºæ¶ˆæ¯é˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œåœ¨å¤„ç†å½“å‰æ¶ˆæ¯çš„æ—¶å€™ä¸èƒ½å¤„ç†å…¶ä»–çš„æ¶ˆæ¯ï¼Œä¸€å®šè¦æ³¨æ„çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>é€šå¸¸æ¥è¯´æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•é¿å…è¿™ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹</li>
<li>ä½¿ç”¨çº¿ç¨‹æ± </li>
<li>ä½¿ç”¨å¼‚æ­¥</li>
</ul>
<h3 id="5-Painting-the-Window"><a href="#5-Painting-the-Window" class="headerlink" title="5. Painting the Window"></a>5. Painting the Window</h3><h3 id="6-Closing-the-Window"><a href="#6-Closing-the-Window" class="headerlink" title="6. Closing the Window"></a>6. Closing the Window</h3><p>åœ¨åšå‡ºä¸€äº›åˆ—çš„å…³é—­çª—å£çš„è¡Œä¸ºå Windows ä¼šå‘é€ä¸€ä¸ªå…³é—­çª—å£çš„æ¶ˆæ¯ <code> WM_CLOSE</code> ï¼Œ WM_CLOSE å¹¶ä¸ä¼šç›´æ¥å…³é—­ä½ çš„çª—å£ï¼Œè°ƒç”¨ <code> DestoryWindow</code> æ‰ä¼šå…³é—­ä½ çš„çª—å£ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè°ƒç”¨çš„å®ä¾‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> WM_CLOSE:</span><br><span class="line">    <span class="keyword">if</span> (MessageBox(hwnd, <span class="string">L&quot;Really quit?&quot;</span>, <span class="string">L&quot;My application&quot;</span>, MB_OKCANCEL) == IDOK)</span><br><span class="line">    &#123;</span><br><span class="line">        DestroyWindow(hwnd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Else: User canceled. Do nothing.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>å½“ä½ çš„çª—å£å°†è¦è¢«å…³é—­çš„æ—¶å€™çª—å£ä¼šæ”¶åˆ° <code> WM_DESTORY</code> æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œä¸‹é¢çš„è°ƒç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">    PostQuitMessage(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªçš„è°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="C:\Users\28594\OneDrive\åšå®¢ç”¨å›¾\WM_DESTORY.PNG" alt="https://1drv.ms/u/s!Ak-edkVXxLEUlCTS1JDm1G1w04Q6?e=Z2E69e"></p>
<h3 id="7-Managing-Application-State"><a href="#7-Managing-Application-State" class="headerlink" title="7. Managing Application State"></a>7. Managing Application State</h3><p>ç”±äºçª—å£çš„è¿‡ç¨‹å‡½æ•°ä»…ä»…æ¯æ¡æ¶ˆæ¯è°ƒç”¨çš„å‡½æ•°ï¼Œæœ¬è´¨ä¸Šæ˜¯æ— çŠ¶æ€çš„ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿè·Ÿè¸ªåº”ç”¨ç¨‹åºçŠ¶æ€çš„æ–¹æ³•</p>
<p><code> CreateWindowEx</code> æä¾›äº†ä¸€ä¸ªå°†ä»»ä½•æ•°æ®ç»“æ„ä¼ é€’ç»™çª—å£çš„æ–¹æ³•ã€‚å½“è°ƒç”¨ <code> CreateWindowEx</code> çš„æ—¶å€™å®ƒå°†ä¼šå‘é€ä¸‹é¢çš„ä¸¤ä¸ªæ¶ˆæ¯åˆ°çª—å£ procdure </p>
<p><code> WM_NCCREATE,WM_CREATE</code> : å®ƒä»¬åœ¨çª—å£å¯ä»¥çœ‹è§ä¹‹å‰å°±å·²ç»å‘é€ï¼Œå› æ­¤è¿™ä¸¤ä¸ªæ¶ˆæ¯å¯ä»¥ç”¨æ¥åˆå§‹åŒ–çª—å£ã€‚</p>
<p>CreateWindowEx çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯ <code>void*</code>  ï¼Œå½“çª—å£è¿‡ç¨‹å¤„ç† WM_NCCREATE, WM_CREATE çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å®ƒè·å–é¢å¤–çš„æ•°æ®</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Define a structure to hold some state information.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">StateInfo</span> &#123;</span></span><br><span class="line">    <span class="comment">// ... (struct members not shown)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">StateInfo *pState = <span class="keyword">new</span> (<span class="built_in">std</span>::nothrow) StateInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pState == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize the structure members (not shown).</span></span><br><span class="line"></span><br><span class="line">HWND hwnd = CreateWindowEx(</span><br><span class="line">    <span class="number">0</span>,                              <span class="comment">// Optional window styles.</span></span><br><span class="line">    CLASS_NAME,                     <span class="comment">// Window class</span></span><br><span class="line">    <span class="string">L&quot;Learn to Program Windows&quot;</span>,    <span class="comment">// Window text</span></span><br><span class="line">    WS_OVERLAPPEDWINDOW,            <span class="comment">// Window style</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Size and position</span></span><br><span class="line">    CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line"></span><br><span class="line">    <span class="literal">NULL</span>,       <span class="comment">// Parent window    </span></span><br><span class="line">    <span class="literal">NULL</span>,       <span class="comment">// Menu</span></span><br><span class="line">    hInstance,  <span class="comment">// Instance handle</span></span><br><span class="line">    pState      <span class="comment">// Additional application data</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>å½“æ”¶åˆ° WM_NCCREATE å’Œ WM_CREATE æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¯ä¸ªæ¶ˆæ¯çš„ lParam å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘ CREATESTRUCT çš„æŒ‡é’ˆï¼Œè¿™ä¸ª CREATESTRUCT æ•°æ®ç»“æ„åŒæ—¶åŒ…å«äº†ä¼ é€’ç»™ CreateWindowEx çš„æŒ‡é’ˆ</p>
<p><img src="C:\Users\28594\OneDrive\åšå®¢ç”¨å›¾\CreateStruct.PNG" alt="https://1drv.ms/u/s!Ak-edkVXxLEUlCTS1JDm1G1w04Q6?e=Z2E69e"></p>
<p>ä¸‹é¢æ˜¯ä»è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­è·å–æŒ‡é’ˆçš„è¿‡ç¨‹:</p>
<ol>
<li><p>é€šè¿‡è½¬æ¢ lParam å‚æ•°è·å– CREATESTRUCT</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">CREATESTRUCT *pCreate = <span class="keyword">reinterpret_cast</span>&lt;CREATESTRUCT*&gt;(lParam);</span><br></pre></td></tr></table></figure>
</li>
<li><p>åº”ä¸º lpCreateParams æ˜¯ è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œè½¬æ¢ lpCreateParams è·å¾—éœ€è¦çš„æŒ‡é’ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">pState = <span class="keyword">reinterpret_cast</span>&lt;StateInfo*&gt;(pCreate-&gt;lpCreateParams);</span><br></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ SetWindowLongPtr å‡½æ•°å¹¶ä¸”ä¼ å…¥ è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SetWindowLongPtr(hwnd, GWLP_USERDATA, (LONG_PTR)pState);</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ€åæ˜¯å°† Stateinfo çš„æŒ‡é’ˆå­˜åœ¨çª—å£æ˜¯å®ä¾‹æ•°æ®ä¸­</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">LONG_PTR ptr = GetWindowLongPtr(hwnd, GWLP_USERDATA);</span><br><span class="line">StateInfo *pState = <span class="keyword">reinterpret_cast</span>&lt;StateInfo*&gt;(ptr);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>è¯¥è¿‡ç¨‹æœ€å¤§çš„æ„ä¹‰æ˜¯åˆ›å»ºå¤šä¸ªçª—å£ï¼Œå¹¶ä¸ºæ¯ä¸ªçª—å£æä¾›å…¶è‡ªå·±çš„æ•°æ®ç»“æ„å®ä¾‹ã€‚å¦‚æœæ‚¨å®šä¹‰ä¸€ç±»çª—å£å¹¶åˆ›å»ºè¯¥ç±»çš„å¤šä¸ªçª—å£ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ§ä»¶ç±»ï¼Œåˆ™æ­¤æ–¹æ³•ç‰¹åˆ«æœ‰ç”¨ã€‚å°† GetWindowLongPtr è°ƒç”¨åŒ…è£…åœ¨ä¸€ä¸ªå°çš„è¾…åŠ©å‡½æ•°ä¸­éå¸¸æ–¹ä¾¿ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> StateInfo* <span class="title">GetAppState</span><span class="params">(HWND hwnd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LONG_PTR ptr = GetWindowLongPtr(hwnd, GWLP_USERDATA);</span><br><span class="line">    StateInfo *pState = <span class="keyword">reinterpret_cast</span>&lt;StateInfo*&gt;(ptr);</span><br><span class="line">    <span class="keyword">return</span> pState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„çª—å£è¿‡ç¨‹äº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    StateInfo *pState;</span><br><span class="line">    <span class="keyword">if</span> (uMsg == WM_CREATE)</span><br><span class="line">    &#123;</span><br><span class="line">        CREATESTRUCT *pCreate = <span class="keyword">reinterpret_cast</span>&lt;CREATESTRUCT*&gt;(lParam);</span><br><span class="line">        pState = <span class="keyword">reinterpret_cast</span>&lt;StateInfo*&gt;(pCreate-&gt;lpCreateParams);</span><br><span class="line">        SetWindowLongPtr(hwnd, GWLP_USERDATA, (LONG_PTR)pState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        pState = GetAppState(hwnd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (uMsg)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remainder of the window procedure not shown ...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="é¢å‘å¯¹è±¡çš„æ–¹æ³•"><a href="#é¢å‘å¯¹è±¡çš„æ–¹æ³•" class="headerlink" title="é¢å‘å¯¹è±¡çš„æ–¹æ³•"></a>é¢å‘å¯¹è±¡çš„æ–¹æ³•</h4><p>æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ‰©å±•æ­¤æ–¹æ³•ã€‚æˆ‘ä»¬å·²ç»å®šä¹‰äº†ä¸€ä¸ªæ•°æ®ç»“æ„æ¥ä¿å­˜æœ‰å…³çª—å£çš„çŠ¶æ€ä¿¡æ¯ã€‚ä¸ºè¿™ç§æ•°æ®ç»“æ„æä¾›å¯¹æ•°æ®è¿›è¡Œæ“ä½œçš„æˆå‘˜å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚è¿™è‡ªç„¶å¯¼è‡´äº†ä¸€ç§è®¾è®¡ï¼Œå…¶ä¸­ç»“æ„ï¼ˆæˆ–ç±»ï¼‰è´Ÿè´£çª—å£ä¸Šçš„æ‰€æœ‰æ“ä½œã€‚ç„¶åï¼Œçª—å£è¿‡ç¨‹å°†æˆä¸ºè¯¥ç±»çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„æ­¥éª¤å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„çª—å£</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pseudocode</span></span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    StateInfo *pState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get pState from the HWND. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (uMsg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_SIZE:</span><br><span class="line">            HandleResize(pState, ...);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> WM_PAINT:</span><br><span class="line">            HandlePaint(pState, ...);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// And so forth.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯å¦‚ä½•æ‰¾åˆ° <code> MyWindow::WinProc</code> æ–¹æ³•ã€‚ RegisterClass å‡½æ•°éœ€è¦çª—å£è¿‡ç¨‹æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨ä¸èƒ½å°†æŒ‡é’ˆä¼ é€’ç»™ï¼ˆéé™æ€ï¼‰æˆå‘˜å‡½æ•°ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥å°†æŒ‡é’ˆä¼ é€’ç»™<em>é™æ€</em>æˆå‘˜å‡½æ•°ï¼Œç„¶åå†å§”æ‰˜ç»™æˆå‘˜å‡½æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ˜¾ç¤ºæ­¤æ–¹æ³•çš„ç±»æ¨¡æ¿ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">DERIVED_TYPE</span>&gt; </span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">BaseWindow</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DERIVED_TYPE *pThis = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uMsg == WM_NCCREATE)</span><br><span class="line">        &#123;</span><br><span class="line">            CREATESTRUCT* pCreate = (CREATESTRUCT*)lParam;</span><br><span class="line">            pThis = (DERIVED_TYPE*)pCreate-&gt;lpCreateParams;</span><br><span class="line">            SetWindowLongPtr(hwnd, GWLP_USERDATA, (LONG_PTR)pThis);</span><br><span class="line"></span><br><span class="line">            pThis-&gt;m_hwnd = hwnd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            pThis = (DERIVED_TYPE*)GetWindowLongPtr(hwnd, GWLP_USERDATA);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pThis)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> pThis-&gt;HandleMessage(uMsg, wParam, lParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> DefWindowProc(hwnd, uMsg, wParam, lParam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BaseWindow() : m_hwnd(<span class="literal">NULL</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">BOOL <span class="title">Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        PCWSTR lpWindowName,</span></span></span><br><span class="line"><span class="function"><span class="params">        DWORD dwStyle,</span></span></span><br><span class="line"><span class="function"><span class="params">        DWORD dwExStyle = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> x = CW_USEDEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> y = CW_USEDEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> nWidth = CW_USEDEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> nHeight = CW_USEDEFAULT,</span></span></span><br><span class="line"><span class="function"><span class="params">        HWND hWndParent = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        HMENU hMenu = <span class="number">0</span></span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        WNDCLASS wc = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">        wc.lpfnWndProc   = DERIVED_TYPE::WindowProc;</span><br><span class="line">        wc.hInstance     = GetModuleHandle(<span class="literal">NULL</span>);</span><br><span class="line">        wc.lpszClassName = ClassName();</span><br><span class="line"></span><br><span class="line">        RegisterClass(&amp;wc);</span><br><span class="line"></span><br><span class="line">        m_hwnd = CreateWindowEx(</span><br><span class="line">            dwExStyle, ClassName(), lpWindowName, dwStyle, x, y,</span><br><span class="line">            nWidth, nHeight, hWndParent, hMenu, GetModuleHandle(<span class="literal">NULL</span>), <span class="keyword">this</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (m_hwnd ? TRUE : FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">HWND <span class="title">Window</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_hwnd; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> PCWSTR  <span class="title">ClassName</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> LRESULT <span class="title">HandleMessage</span><span class="params">(UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    HWND m_hwnd;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>æ‰€è¿°<code>BaseWindow</code>ç±»æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œä»è¯¥ç‰¹å®šçª—å£ç±»è¡ç”Ÿçš„ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯æ´¾ç”Ÿè‡ªçš„ç®€å•ç±»çš„å£°æ˜<code>BaseWindow</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span> :</span> <span class="keyword">public</span> BaseWindow&lt;MainWindow&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">PCWSTR  <span class="title">ClassName</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> <span class="string">L&quot;Sample Window Class&quot;</span>; &#125;</span><br><span class="line">    <span class="function">LRESULT <span class="title">HandleMessage</span><span class="params">(UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¦åˆ›å»ºçª—å£ï¼Œè°ƒç”¨ <code> BaseWindow::Create</code> :</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">wWinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE, PWSTR pCmdLine, <span class="keyword">int</span> nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MainWindow win;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!win.Create(<span class="string">L&quot;Learn to Program Windows&quot;</span>, WS_OVERLAPPEDWINDOW))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ShowWindow(win.Window(), nCmdShow);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run the message loop.</span></span><br><span class="line"></span><br><span class="line">    MSG msg = &#123; &#125;;</span><br><span class="line">    <span class="keyword">while</span> (GetMessage(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çº¯è™šå‡½æ•° <code> BaseWindow::HandleMessage</code> ç”¨æ¥å®ç°çª—å£è¿‡ç¨‹ï¼Œä¸‹é¢çš„å®ç°å°±å’Œæœ€å¼€å§‹çš„ç¤ºä¾‹å®ç°ç­‰ä»·ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">LRESULT <span class="title">MainWindow::HandleMessage</span><span class="params">(UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        PostQuitMessage(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> WM_PAINT:</span><br><span class="line">        &#123;</span><br><span class="line">            PAINTSTRUCT ps;</span><br><span class="line">            HDC hdc = BeginPaint(m_hwnd, &amp;ps);</span><br><span class="line">            FillRect(hdc, &amp;ps.rcPaint, (HBRUSH) (COLOR_WINDOW+<span class="number">1</span>));</span><br><span class="line">            EndPaint(m_hwnd, &amp;ps);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> DefWindowProc(m_hwnd, uMsg, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œçª—å£å¥æŸ„å­˜å‚¨åœ¨æˆå‘˜å˜é‡ï¼ˆ<em>m_hwnd</em>ï¼‰ä¸­ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>HandleMessage</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> PCWSTR  <span class="title">ClassName</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> LRESULT <span class="title">HandleMessage</span><span class="params">(UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    HWND m_hwnd;</span><br></pre></td></tr></table></figure>























]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>GameDev</tag>
      </tags>
  </entry>
</search>
